Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:   1


PC     Object              I  Line    Source 
                           A     1    
                           A     2    ; PROSE for EZ80P by Phil Ruston 2011
                           A     3    ; Compile with Zilog ZDS II
                           A     4    
                           A     5    ;----------------------------------------------
                           A     6    	.assume ADL = 1
                           A     7    ;----------------------------------------------
                           A     8    
                           B     0    	include	'ez80_cpu_equates.asm'
                           B     1    ;--- EZ80 Internal Ports ----------------------
                           B     2    
       0000009A            B     3    PB_DR			equ 09ah
       0000009B            B     4    PB_DDR			equ 09bh
       0000009C            B     5    PB_ALT1			equ 09ch
       0000009D            B     6    PB_ALT2			equ 09dh
                           B     7    
       0000009E            B     8    PC_DR			equ 09eh
       0000009F            B     9    PC_DDR			equ 09fh
       000000A0            B    10    PC_ALT1			equ 0a0h
       000000A1            B    11    PC_ALT2			equ 0a1h
                           B    12    
       000000A2            B    13    PD_DR			equ 0a2h
       000000A3            B    14    PD_DDR			equ 0a3h
       000000A4            B    15    PD_ALT1			equ 0a4h
       000000A5            B    16    PD_ALT2			equ 0a5h
                           B    17    
       000000C0            B    18    UART0_RBR		equ 0c0h
       000000C0            B    19    UART0_THR		equ 0c0h
       000000C0            B    20    UART0_BRG_L		equ 0c0h
       000000C1            B    21    UART0_BRG_H		equ 0c1h
       000000C1            B    22    UART0_IER		equ 0c1h
       000000C2            B    23    UART0_FCTL		equ 0c2h
       000000C3            B    24    UART0_LCTL		equ 0c3h
       000000C4            B    25    UART0_MCTL		equ 0c4h
       000000C5            B    26    UART0_LSR		equ 0c5h
                           B    27    
       000000A8            B    28    CS0_LBR			equ 0a8h			;eZ80 wait 
       000000A9            B    29    CS0_UBR			equ 0a9h
       000000AA            B    30    CS0_CTL			equ 0aah			
       000000AB            B    31    CS1_LBR			equ 0abh			;eZ80 wait 
       000000AC            B    32    CS1_UBR			equ 0ach
       000000AD            B    33    CS1_CTL			equ 0adh
                           B    34    
       00000080            B    35    TMR0_CTL		equ 080h			;timer 0 eq
       00000081            B    36    TMR0_DR_L		equ 081h
       00000081            B    37    TMR0_RR_L		equ 081h
       00000082            B    38    TMR0_DR_H		equ 082h
       00000082            B    39    TMR0_RR_H		equ 082h
       00000092            B    40    TMR_ISS			equ 092h
                           B    41    
       000000ED            B    42    RTC_CTRL		equ 0edh			;RTC equate
       000000EC            B    43    RTC_ACTRL		equ 0ech
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:   2


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80_cpu_equates.asm
       000000E0            B    44    RTC_SEC			equ 0e0h
       000000E1            B    45    RTC_MIN			equ 0e1h
       000000E2            B    46    RTC_HRS			equ 0e2h
       000000E3            B    47    RTC_DOW			equ 0e3h
       000000E4            B    48    RTC_DOM			equ 0e4h
       000000E5            B    49    RTC_MON			equ 0e5h
       000000E6            B    50    RTC_YR			equ 0e6h
       000000E7            B    51    RTC_CEN			equ 0e7h
                           B    52    
                           B    53    ;----------------------------------------------
                           B     0    	include	'ez80p_hardware_equates.asm'
                           B     1    
                           B     2    ;-- EZ80P Hardware equates --------------------
                           B     3    
       00000000            B     4    port_pic_data  			equ 000h
       00000001            B     5    port_pic_ctrl			equ 001h
       00000001            B     6    port_hw_flags			equ 001h
       00000002            B     7    port_sdc_ctrl			equ 002h	; this is a
       00000002            B     8    port_keyboard_data		equ 002h
       00000003            B     9    port_sdc_data		 	equ 003h	
       00000004            B    10    port_memory_paging		equ 004h
       00000005            B    11    port_irq_ctrl			equ 005h
       00000006            B    12    port_nmi_ack			equ 006h
       00000007            B    13    port_ps2_ctrl			equ 007h
       00000008            B    14    port_selector			equ 008h
       00000006            B    15    port_mouse_data			equ 006h
       00000009            B    16    port_clear_flags		equ 009h
                           B    17    
       00000000            B    18    sdc_power				equ 0		;(port_sd_c
       00000001            B    19    sdc_cs					equ 1		;(port_sd_c
       00000002            B    20    sdc_speed				equ 2 		;(port_sd_c
                           B    21    
       00000004            B    22    sdc_serializer_busy		equ 4 		;(port_hw_f
       00000005            B    23    vrt						equ 5		;(port_hw_f
                           B    24    
                           B    25    
                           B    26    ;-- Memory locations --------------------------
                           B    27    
       00800000            B    28    vram_a_addr				equ 0800000h
       00C00000            B    29    vram_b_addr				equ 0c00000h
                           B    30    
                           B    31    ;-- Hardware registers ------------------------
                           B    32    
       00FF0000            B    33    hw_palette				equ 0ff0000h
       00FF0800            B    34    hw_sprite_registers		equ 0ff0800h
       00FF1000            B    35    hw_video_parameters		equ 0ff1000h
       00FF1400            B    36    hw_audio_registers		equ 0ff1400h
       00FF1800            B    37    hw_video_settings		equ 0ff1800h
                           B    38    
       00FF1000            B    39    tilemap_parameters		equ hw_video_parameters
       00FF1020            B    40    bitmap_parameters		equ hw_video_parameters
                           B    41    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:   3


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_hardware_equates.asm
       00FF1800            B    42    video_control			equ hw_video_settings+0
       00FF1801            B    43    sprite_control			equ hw_video_settings+0
       00FF1802            B    44    bgnd_palette_select		equ hw_video_settings+0
       00FF1803            B    45    sprite_palette_select	equ hw_video_settings+0
       00FF1804            B    46    right_border_position	equ hw_video_settings+0
                           B    47    
                           B    48    ;----------------------------------------------
                           A    11    
                           A    12    ;----------------------------------------------
                           A    13    
       00000A00            A    14    os_location	 	equ 0a00h
       0007FFFF            A    15    sys_mem_top		equ 07ffffh
                           A    16    
       0000002C            A    17    prose_version	equ 2ch
                           A    18    
                           A    19    ;----------------------------------------------
                           A    20    ; Assembly options
                           A    21    ;----------------------------------------------
                           A    22    
       00000008            A    23    max_volumes				equ 8
                           A    24    
       00000050            A    25    max_buffer_chars		equ 80		; applies t
                           A    26    
                           A    27    ;----------------------------------------------
                           A    28    			
000A00                     A    29    			org os_location
                           A    30    			
000A00 00 00 00 00 00 00   A    31    				blkb 16,0						000A06 00 00 00 00 00 00 
000A0C 00 00 00 00 
                           A    32    			
                           A    33    ;----------------------------------------------
                           A    34    			
000A10 C3 40 0A 00         A    35    				jp os_first_run					000A14 C3 AE 0E 00         A    36    				jp extcmd_return				000A18 C3000000            A    37    				jp 0							000A1C C3000000            A    38    				jp 0							                           A    39    				
                           A    40    ;----------------------------------------------
                           A    41    
000A20                     A    42    prose_kernal
                           A    43    
                           A    44    ; External apps can call kernal routines by doi
                           A    45    ; Set A to kernal routine number required (see 
                           A    46    ; (this routine is always located at os_locatio
                           A    47    
000A20 D9                  A    48    				exx		
000A21 DD21 96 53 00       A    49    				ld ix,kernal_table				000A26 11030000            A    50    				ld de,3
000A2A 57                  A    51    				ld d,a
000A2B ED5C                A    52    				mlt de
000A2D DD19                A    53    				add ix,de						Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:   4


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
000A2F DD3700              A    54    				ld ix,(ix)						                           A    55    				
000A32 E3                  A    56    				ex (sp),hl
000A33 7D                  A    57    				ld a,l							000A34 E601                A    58    				and 1							000A36 E3                  A    59    				ex (sp),hl
000A37 D9                  A    60    				exx
000A38 CD 3E 0A 00         A    61    				call kr_jump					000A3C 5BC9                A    62    				ret.l							                           A    63    				
000A3E DDE9                A    64    kr_jump			jp (ix)							                           A    65    						
                           A    66    ;----------------------------------------------
                           A    67    
                           A    68    ; *******************
                           A    69    ; *   START UP OS   *
                           A    70    ; *******************
                           A    71    
000A40                     A    72    os_first_run
                           A    73    	
000A40 B7                  A    74    				or a							000A41 20 05               A    75    				jr nz,os_cold_start		
000A43 78                  A    76    				ld a,b
000A44 32 D4 5D 00         A    77    				ld (boot_drive),a				                           A    78    
000A48                     A    79    os_cold_start
000A48 ED7D                A    80    				stmix							000A4A F3                  A    81    				di								000A4B ED5E                A    82    				im 2							000A4D AF                  A    83    				xor a
000A4E ED6D                A    84    				ld MB,a							000A50 4031FFFF            A    85    				ld.sis sp,0ffffh				000A54 31FFFF07            A    86    				ld sp,sys_mem_top				                           A    87    
000A58 CD BE 38 00         A    88    				call disable_irqs
000A5C CD 46 3A 00         A    89    				call disable_nmi
                           A    90    				
000A60 3A 19 5F 00         A    91    				ld a,(first_run)				000A64 B7                  A    92    				or a
000A65 28 11               A    93    				jr z,dont_resetkb
000A67 CD 6B 40 00         A    94    				call init_keyboard
000A6B 28 06               A    95    				jr z,kb_ok
000A6D 21 1A 5F 00         A    96    				ld hl,devices_connected
000A71 CB86                A    97    				res 0,(hl)
000A73 AF                  A    98    kb_ok			xor a
000A74 32 19 5F 00         A    99    				ld (first_run),a
000A78                     A   100    dont_resetkb
                           A   101    
000A78 21 49 5F 00         A   102    				ld hl,os_variables				000A7C 01 E7 01 00         A   103    				ld bc,last_os_var-os_variables
000A80 AF                  A   104    				xor a
000A81 CD 4B 15 00         A   105    				call os_bchl_memfill
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:   5


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A   106    
000A85 21010000            A   107    				ld hl,1
000A89 22 70 5D 00         A   108    				ld (font_length),hl				                           A   109    	
000A8D CD AC 3F 00         A   110    				call hwsc_default_hw_settings
                           A   111    				
000A91 3A 33 5D 00         A   112    				ld a,(video_mode)
000A95 CD 5B 33 00         A   113    				call set_vmode					                           A   114    
000A99 21 3E 62 00         A   115    				ld hl,packed_font_start
000A9D ED5B 6D 5D 00       A   116    				ld de,(font_addr)
000AA2 01 DF 02 00         A   117    				ld bc,packed_font_end-packed_fo
000AA6 CD A9 15 00         A   118    				call unpack_rle
                           A   119    
000AAA 3E5F                A   120    				ld a,5fh
000AAC 32 59 5D 00         A   121    				ld (req_cursor_image),a
                           A   122    
000AB0 21 65 54 00         A   123    				ld hl,welcome_message			000AB4 CD 25 0F 00         A   124    				call os_print_string
000AB8 CD AD 34 00         A   125    				call os_get_mem_high			000ABC EB                  A   126    				ex de,hl
000ABD CD F0 12 00         A   127    				call os_show_hex_address
                           A   128    
000AC1 CD B8 13 00         A   129    				call os_new_line
000AC5 CD B8 13 00         A   130    				call os_new_line
000AC9 CD 94 31 00         A   131    				call os_cmd_vers				000ACD CD 88 31 00         A   132    				call os_cmd_remount				                           A   133    
000AD1 CD B8 13 00         A   134    				call os_new_line				                           A   135    
000AD5 CD 29 41 00         A   136    				call purge_keyboard
                           A   137    				
000AD9 CD 89 38 00         A   138    				call set_irq_vector
000ADD CD 9B 38 00         A   139    				call enable_os_irqs
000AE1 FB                  A   140    				ei
000AE2 CD 2E 3A 00         A   141    				call set_nmi_vector
                           A   142    				
000AE6 21 1A 5F 00         A   143    				ld hl,devices_connected			000AEA CB46                A   144    				bit 0,(hl)
000AEC 20 08               A   145    				jr nz,kb_present
000AEE 21 BE 59 00         A   146    				ld hl,no_keyboard_msg
000AF2 CD EF 13 00         A   147    				call os_show_packed_text
000AF6                     A   148    kb_present				
000AF6 21 B5 54 00         A   149    				ld hl,startup_script_fn
000AFA 22 72 60 00         A   150    				ld (os_args_loc),hl
000AFE CD C5 31 00         A   151    				call os_cmd_exec				000B02 AF                  A   152    				xor a
000B03 32 7E 60 00         A   153    				ld (in_script_flag),a
                           A   154    									
000B07 3A 18 5F 00         A   155    				ld a,(frozen)					000B0B B7                  A   156    				or a
000B0C 28 11               A   157    				jr z,os_main_loop
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:   6


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
000B0E AF                  A   158    				xor a
000B0F 32 18 5F 00         A   159    				ld (frozen),a
000B13 21 0D 55 00         A   160    				ld hl,nmi_freeze_txt
000B17 CD 25 0F 00         A   161    				call os_print_string
000B1B CD DF 2C 00         A   162    				call os_cmd_r
                           A   163    				
                           A   164    	
                           A   165    ;==============================================
                           A   166    
000B1F                     A   167    os_main_loop
                           A   168    								
000B1F CD 9C 3F 00         A   169    				call hwsc_wait_vrt				                           A   170    
000B23 CD 76 0F 00         A   171    				call os_cursor_flash
                           A   172    
000B27 CD F9 42 00         A   173    				call os_get_key_press
000B2B 20 F2               A   174    				jr nz,os_main_loop
                           A   175    	
000B2D 32 05 61 00         A   176    				ld (current_scancode),a
000B31 78                  A   177    				ld a,b
000B32 32 06 61 00         A   178    				ld (current_asciicode),a		                           A   179    	
000B36 CD E4 3D 00         A   180    				call hwsc_remove_cursor
000B3A 3E18                A   181    				ld a,24							000B3C 32 B3 5F 00         A   182    				ld (cursorflashtimer),a			000B40 AF                  A   183    				xor a
000B41 32 B4 5F 00         A   184    				ld (cursor_status),a
                           A   185    				
000B45 3A 05 61 00         A   186    				ld a,(current_scancode)			000B49 FE70                A   187    				cp 70h
000B4B 20 16               A   188    				jr nz,os_notins
000B4D 3A 04 61 00         A   189     				ld a,(insert_mode)
000B51 EE01                A   190    				xor 1
000B53 32 04 61 00         A   191    				ld (insert_mode),a
000B57 3E5F                A   192    				ld a,5fh
000B59 28 02               A   193    				jr z,linecurs
000B5B 3E7F                A   194    				ld a,7fh
000B5D 32 59 5D 00         A   195    linecurs		ld (req_cursor_image),a
000B61 18 BC               A   196    				jr os_main_loop
                           A   197    
000B63 21 B1 5F 00         A   198    os_notins		ld hl,cursor_x					000B67 FE6B                A   199    				cp 06bh			
000B69 20 0E               A   200    				jr nz,os_ntlft
000B6B 35                  A   201    				dec (hl)
000B6C 7E                  A   202    				ld a,(hl)
000B6D FEFF                A   203    				cp 0ffh	
000B6F 20 AE               A   204    				jr nz,os_main_loop
000B71 3A 5E 5D 00         A   205    				ld a,(window_columns)
000B75 3D                  A   206    				dec a
000B76 77                  A   207    				ld (hl),a						000B77 18 A6               A   208    				jr os_main_loop
                           A   209    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:   7


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
000B79 FE74                A   210    os_ntlft		cp 074h							000B7B 20 0C               A   211    				jr nz,os_ntrig
000B7D 34                  A   212    				inc (hl)
000B7E 3A 5E 5D 00         A   213    				ld a,(window_columns)
000B82 BE                  A   214    				cp (hl)
000B83 20 9A               A   215    				jr nz,os_main_loop
000B85 3600                A   216    				ld (hl),0						000B87 18 96               A   217    				jr os_main_loop
                           A   218    
000B89 21 B0 5F 00         A   219    os_ntrig		ld hl,cursor_y
000B8D FE75                A   220    				cp 075h							000B8F 20 09               A   221    				jr nz,os_ntup
000B91 35                  A   222    				dec (hl)
000B92 CB7E                A   223    				bit 7,(hl)
000B94 28 89               A   224    				jr z,os_main_loop
000B96 3600                A   225    				ld (hl),0						000B98 18 85               A   226    				jr os_main_loop
                           A   227    
000B9A FE72                A   228    os_ntup			cp 072h
000B9C 20 14               A   229    				jr nz,os_ntdwn					000B9E 34                  A   230    				inc (hl)
000B9F 3A 5B 5D 00         A   231    				ld a,(window_rows)
000BA3 BE                  A   232    				cp (hl)
000BA4 C2 1F 0B 00         A   233    				jr nz,os_main_loop
000BA8 3D                  A   234    				dec a
000BA9 77                  A   235    				ld (hl),a						000BAA CD 13 3C 00         A   236    				call hwsc_scroll_up
000BAE C3 1F 0B 00         A   237    				jr os_main_loop
                           A   238    
000BB2 FE71                A   239    os_ntdwn		cp 071h							000BB4 20 08               A   240    				jr nz,os_nodel		
000BB6 3A B1 5F 00         A   241    				ld a,(cursor_x)					000BBA 47                  A   242    				ld b,a
000BBB 04                  A   243    				inc b
000BBC 18 13               A   244    				jr os_chrbk
                           A   245    
000BBE FE66                A   246    os_nodel		cp 066h							000BC0 20 17               A   247    				jr nz,os_nbksp
000BC2 3A B1 5F 00         A   248    				ld a,(cursor_x)					000BC6 B7                  A   249    				or a							000BC7 CA 1F 0B 00         A   250    				jp z,os_main_loop
000BCB 47                  A   251    				ld b,a
000BCC 3D                  A   252    				dec a
000BCD 32 B1 5F 00         A   253    				ld (cursor_x),a					000BD1 CD AD 3E 00         A   254    os_chrbk		call hwsc_chars_left			000BD5 C3 1F 0B 00         A   255    				jp os_main_loop
                           A   256    
000BD9 FE5A                A   257    os_nbksp		cp 05ah							000BDB CA 22 0C 00         A   258    				jp z,os_enter_pressed
                           A   259    	
000BDF 3A 06 61 00         A   260    				ld a,(current_asciicode)		000BE3 B7                  A   261    				or a							Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:   8


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
000BE4 28 38               A   262    				jr z,os_nvdun					                           A   263    
000BE6 FE7B                A   264    				cp 07bh							000BE8 30 12               A   265    				jr nc,os_gtcha					000BEA FE61                A   266    				cp 061h
000BEC 38 04               A   267    				jr c,os_ntupc
000BEE D620                A   268    				sub 020h
000BF0 18 0A               A   269    				jr os_gtcha
000BF2 FE5B                A   270    os_ntupc		cp 05bh
000BF4 30 06               A   271    				jr nc,os_gtcha
000BF6 FE41                A   272    				cp 041h
000BF8 38 02               A   273    				jr c,os_gtcha
000BFA C620                A   274    				add a,020h
000BFC 57                  A   275    os_gtcha		ld d,a							000BFD 3A 04 61 00         A   276    				ld a,(insert_mode)				000C01 B7                  A   277    				or a
000C02 CC F4 3E 00         A   278    				call z,hwsc_chars_right
                           A   279    				
000C06 ED4B B0 5F 00       A   280    os_schi			ld bc,(cursor_pos)				000C0B 7A                  A   281    				ld a,d							000C0C CD B7 3C 00         A   282    				call hwsc_plot_char		
000C10 21 B1 5F 00         A   283    				ld hl,cursor_x					000C14 34                  A   284    				inc (hl)
000C15 3A 5E 5D 00         A   285    				ld a,(window_columns)
000C19 BE                  A   286    				cp (hl)							000C1A 20 02               A   287    				jr nz,os_nvdun
000C1C 3600                A   288    				ld (hl),0
                           A   289    
000C1E C3 1F 0B 00         A   290    os_nvdun		jp os_main_loop
                           A   291    	
                           A   292    
                           A   293    ;----------------------------------------------
                           A   294    
000C22                     A   295    os_enter_pressed
                           A   296    	
000C22 CD 7F 3F 00         A   297    				call hwsc_charline_to_command_s
                           A   298    
000C26 AF                  A   299    				xor a
000C27 32 B1 5F 00         A   300    				ld (cursor_x),a					000C2B 21 B0 5F 00         A   301    				ld hl,cursor_y					000C2F 34                  A   302    				inc (hl)
000C30 3A 5B 5D 00         A   303    				ld a,(window_rows)
000C34 BE                  A   304    				cp (hl)
000C35 20 06               A   305    				jr nz,os_esdok
000C37 3D                  A   306    				dec a
000C38 77                  A   307    				ld (hl),a
000C39 CD 13 3C 00         A   308    				call hwsc_scroll_up
                           A   309    
000C3D CD 4A 0C 00         A   310    os_esdok		call os_parse_cmd_chk_ps		                           A   311    
000C41 AF                  A   312    post_csb		xor a
000C42 32 7E 60 00         A   313    				ld (in_script_flag),a
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:   9


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
000C46 C3 1F 0B 00         A   314    				jp os_main_loop
                           A   315    
                           A   316    	
                           A   317    ;----------------------------------------------
                           A   318    
                           A   319    
000C4A                     A   320    os_parse_cmd_chk_ps
                           A   321    
000C4A CD 5D 0C 00         A   322    				call os_parse_command_line
000C4E FEFE                A   323    				cp 0feh							000C50 C0                  A   324    				ret nz
000C51 01500000            A   325    				ld bc,max_buffer_chars			000C55 11 CE 5F 00         A   326    				ld de,commandstring				000C59 EDB0                A   327    				ldir
000C5B 18 ED               A   328    				jr os_parse_cmd_chk_ps
                           A   329    
                           A   330    	
                           A   331    ;----------------------------------------------
                           A   332    	
000C5D                     A   333    os_parse_command_line
                           A   334    
000C5D 3E01                A   335    				ld a,1
000C5F 32 49 5F 00         A   336    				ld (store_registers),a			                           A   337    
000C63 21 CE 5F 00         A   338    				ld hl,commandstring				000C67 0650                A   339    				ld b,max_buffer_chars			000C69 CD BB 0F 00         A   340    				call os_scan_for_non_space		000C6D B7                  A   341    				or a							000C6E C8                  A   342    				ret z
000C6F 11 2A 55 00         A   343    				ld de,dictionary-1				000C73 D5                  A   344    				push de
000C74 D1                  A   345    compcstr		pop de
000C75 E5                  A   346    				push hl
000C76 FDE1                A   347    				pop iy
000C78 13                  A   348    notacmd			inc de
000C79 1A                  A   349    				ld a,(de)
000C7A FE01                A   350    				cp 1							000C7C CA 16 0D 00         A   351    				jp z,os_no_kernal_command_found
000C80 CB7F                A   352    				bit 7,a
000C82 28 F4               A   353    				jr z,notacmd					000C84 E67F                A   354    				and 07fh
000C86 4F                  A   355    				ld c,a							000C87 D5                  A   356    				push de
000C88 13                  A   357    cmdnscan		inc de
000C89 FD7E00              A   358    				ld a,(iy)						000C8C CD 19 12 00         A   359    				call os_uppercasify
000C90 47                  A   360    				ld b,a
000C91 1A                  A   361    				ld a,(de)						000C92 B8                  A   362    				cp b
000C93 FD23                A   363    				inc iy
000C95 28 F1               A   364    				jr z,cmdnscan					000C97 1A                  A   365    nomatch			ld a,(de)						Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  10


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
000C98 B7                  A   366    				or a
000C99 28 04               A   367    				jr z,posmatch					000C9B CB7F                A   368    				bit 7,a			
000C9D 28 D5               A   369    				jr z,compcstr					000C9F FD7EFF              A   370    posmatch		ld a,(iy-1)						000CA2 FE20                A   371    				cp 32
000CA4 20 CE               A   372    				jr nz,compcstr					                           A   373    	
000CA6 D1                  A   374    				pop de				
000CA7 FDE5                A   375    				push iy							000CA9 E1                  A   376    				pop hl
000CAA CD BB 0F 00         A   377    				call os_scan_for_non_space
000CAE 22 72 60 00         A   378    				ld (os_args_loc),hl				                           A   379    	
000CB2 21 C2 5A 00         A   380    				ld hl,os_cmd_locs
000CB6 11030000            A   381    				ld de,3
000CBA 51                  A   382    				ld d,c
000CBB ED5C                A   383    				mlt de							000CBD 19                  A   384    				add hl,de
000CBE ED37                A   385    				ld ix,(hl)						                           A   386    
000CC0 2A 72 60 00         A   387    				ld hl,(os_args_loc)				000CC4 CD F8 0E 00         A   388    				call os_run_command				                           A   389    
000CC8 C8                  A   390    				ret z							000CC9 B7                  A   391    				or a
000CCA 20 13               A   392    				jr nz,show_erm
000CCC 78                  A   393    os_hwe1			ld a,b							000CCD 21 2A 58 00         A   394    os_hwerr		ld hl,hex_byte_txt		
000CD1 CD 68 10 00         A   395    				call hexbyte_to_ascii	
000CD5 21 B1 59 00         A   396    				ld hl,hw_err_msg
000CD9 CD EF 13 00         A   397    				call os_show_packed_text
000CDD AF                  A   398    				xor a
000CDE C9                  A   399    				ret
                           A   400    
000CDF 01000000            A   401    show_erm		ld bc,0							000CE3 4F                  A   402    				ld c,a
000CE4 D680                A   403    				sub 080h						000CE6 38 11               A   404    				jr c,no_trans					000CE8 21 E4 5B 00         A   405    				ld hl,kernal_error_code_transla
000CEC CB77                A   406    				bit 6,a							000CEE 28 06               A   407    				jr z,not_fs_err					000CF0 21 F0 5B 00         A   408    				ld hl,fs_error_code_translation
000CF4 D640                A   409    				sub 040h
000CF6 4F                  A   410    not_fs_err		ld c,a
000CF7 09                  A   411    				add hl,bc
000CF8 4E                  A   412    				ld c,(hl)
000CF9 0600                A   413    no_trans		ld b,0
000CFB 21 28 5B 00         A   414    				ld hl,packed_msg_list
000CFF 7E                  A   415    findmsg			ld a,(hl)
000D00 FEFF                A   416    				cp 0ffh
000D02 C8                  A   417    				ret z							Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  11


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
000D03 23                  A   418    				inc hl
000D04 B7                  A   419    				or a
000D05 20 F8               A   420    				jr nz,findmsg					000D07 04                  A   421    				inc b
000D08 79                  A   422    				ld a,c							000D09 B8                  A   423    				cp b
000D0A 20 F3               A   424    				jr nz,findmsg
000D0C CD EF 13 00         A   425    				call os_show_packed_text
000D10 CD B8 13 00         A   426    				call os_new_line
000D14 AF                  A   427    				xor a
000D15 C9                  A   428    				ret
                           A   429    	
                           A   430    
000D16                     A   431    os_no_kernal_command_found
                           A   432    
000D16 3E30                A   433    				ld a,030h						000D18 32 DD 5D 00         A   434    fvolcmd			ld (vol_txt+4),a				000D1C F5                  A   435    				push af			
000D1D 11 DA 5D 00         A   436    				ld de,vol_txt+1		
000D21 0605                A   437    				ld b,5			
000D23 CD DF 11 00         A   438    				call os_compare_strings	
000D27 28 08               A   439    				jr z,gotvolcmd		
000D29 F1                  A   440    				pop af				
000D2A 3C                  A   441    				inc a			
000D2B FE38                A   442    				cp 030h+max_volumes		
000D2D 20 E9               A   443    				jr nz,fvolcmd		
000D2F 18 0B               A   444    				jr novolcmd		
000D31 F1                  A   445    gotvolcmd		pop af
000D32 D630                A   446    				sub 030h
000D34 CD 96 1A 00         A   447    				call os_change_volume
000D38 C3 DD 0E 00         A   448    				jp extcmderf					                           A   449    		
                           A   450    
                           A   451    
000D3C 7E                  A   452    novolcmd		ld a,(hl)						000D3D FE47                A   453    				cp 'G'							000D3F 20 29               A   454    				jr nz,not_g_cmd					000D41 23                  A   455    				inc hl
000D42 7E                  A   456    				ld a,(hl)
000D43 2B                  A   457    				dec hl
000D44 FE20                A   458    				cp ' '
000D46 20 22               A   459    				jr nz,not_g_cmd
000D48 23                  A   460    				inc hl
000D49 CD BB 0F 00         A   461    				call os_scan_for_non_space
000D4D 22 72 60 00         A   462    				ld (os_args_loc),hl				000D51 B7                  A   463    				or a
000D52 20 04               A   464    				jr nz,gotgargs
000D54 3E1F                A   465    				ld a,01fh						000D56 18 87               A   466    				jr show_erm
000D58 CD A7 10 00         A   467    gotgargs		call ascii_to_hex_no_scan		000D5C B7                  A   468    				or a
000D5D 20 80               A   469    				jr nz,show_erm
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  12


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
000D5F CD 3D 3A 00         A   470    				call enable_nmi					000D63 D5                  A   471    				push de
000D64 DDE1                A   472    				pop ix			
000D66 C3 F8 0E 00         A   473    				jp os_run_command				                           A   474    				
                           A   475    				
                           A   476    
000D6A 22 72 60 00         A   477    not_g_cmd		ld (os_args_loc),hl				000D6E 22 75 60 00         A   478    				ld (os_args_pos_cache),hl
000D72 CD EF 0F 00         A   479    				call os_args_to_fn_append_ezp	                           A   480    	
000D76 CD 02 0F 00         A   481    				call cache_dir_block			                           A   482    
000D7A CD 0C 47 00         A   483    				call fs_check_disk_format		000D7E 38 3C               A   484    				jr c,os_ndfxc
000D80 B7                  A   485    				or a							000D81 20 39               A   486    				jr nz,os_ndfxc
                           A   487    	
000D83 CD AE 48 00         A   488    				call fs_open_file_command		000D87 DA CD 0C 00         A   489    				jp c,os_hwerr			 		000D8B B7                  A   490    				or a
000D8C 28 38               A   491    				jr z,os_gecmd					                           A   492    
000D8E CD 7F 48 00         A   493    				call fs_goto_root_dir_command	000D92 21 AC 54 00         A   494    				ld hl,os_dos_cmds_txt
000D96 CD 0D 51 00         A   495    				call fs_hl_to_filename
000D9A CD 5A 48 00         A   496    				call fs_change_dir_command		000D9E DA CD 0C 00         A   497    				jp c,os_hwerr
000DA2 B7                  A   498    				or a
000DA3 20 17               A   499    				jr nz,os_ndfxc					                           A   500    	
000DA5 2A 75 60 00         A   501    				ld hl,(os_args_pos_cache)		000DA9 22 72 60 00         A   502    				ld (os_args_loc),hl
000DAD CD EF 0F 00         A   503    				call os_args_to_fn_append_ezp	000DB1 CD AE 48 00         A   504    				call fs_open_file_command		000DB5 DA CD 0C 00         A   505    				jp c,os_hwerr
000DB9 B7                  A   506    				or a
000DBA 28 0A               A   507    				jr z,os_gecmd
000DBC CD 0E 0F 00         A   508    os_ndfxc		call restore_dir_block			000DC0 3E0B                A   509    				ld a,0bh						000DC2 C3 DF 0C 00         A   510    				jp show_erm
                           A   511    
000DC6 2A 72 60 00         A   512    os_gecmd		ld hl,(os_args_loc)				000DCA CD BB 0F 00         A   513    				call os_scan_for_non_space		000DCE 22 72 60 00         A   514    				ld (os_args_loc),hl
                           A   515    
000DD2 11100000            A   516    				ld de,16
000DD6 CD 0E 16 00         A   517    				call os_set_load_length			000DDA 21 1D 67 00         A   518    				ld hl,scratch_pad
000DDE 22 6D 53 00         A   519    				ld (fs_ez80_address),hl
000DE2 CD F9 48 00         A   520    				call fs_read_data_command
000DE6 DA CD 0C 00         A   521    				jp c,os_hwerr					Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  13


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
000DEA B7                  A   522    				or a
000DEB C2 DF 0C 00         A   523    				jp nz,show_erm					000DEF 2A 1F 67 00         A   524    				ld hl,(scratch_pad+2)
000DF3 1150524F            A   525    				ld de,04f5250h					000DF7 AF                  A   526    				xor a	
000DF8 ED52                A   527    				sbc hl,de
000DFA 28 0A               A   528    				jr z,loc_header
000DFC CD 0E 0F 00         A   529    				call restore_dir_block			000E00 3E1A                A   530    				ld a,01ah						000E02 C3 DF 0C 00         A   531    				jp show_erm						                           A   532    				
000E06 3A 2C 67 00         A   533    loc_header		ld a,(scratch_pad+15)			000E0A 32 48 5F 00         A   534    				ld (store_adl),a			
000E0E CD AE 48 00         A   535    				call fs_open_file_command		000E12 DA CD 0C 00         A   536    				jp c,os_hwerr
000E16 B7                  A   537    				or a	
000E17 20 A3               A   538    				jr nz,os_ndfxc
000E19 2A 22 67 00         A   539    				ld hl,(scratch_pad+5)			000E1D 22 6D 53 00         A   540    				ld (fs_ez80_address),hl
000E21 ED5B 1B 5F 00       A   541    				ld de,(sys_ram_high)
000E26 AF                  A   542    				xor a
000E27 E5                  A   543    				push hl
000E28 ED52                A   544    				sbc hl,de
000E2A E1                  A   545    				pop hl
000E2B 30 0A               A   546    				jr nc,osmemok
000E2D CD 0E 0F 00         A   547    				call restore_dir_block			000E31 3E26                A   548    				ld a,026h
000E33 C3 DF 0C 00         A   549    				jp show_erm
                           A   550    
000E37 ED5B 28 67 00       A   551    osmemok			ld de,(scratch_pad+11)			000E3C 7B                  A   552    				ld a,e
000E3D B2                  A   553    				or d
000E3E 28 14               A   554    				jr z,noprov_spec				000E40 212C0000            A   555    				ld hl,prose_version
000E44 AF                  A   556    				xor a
000E45 40ED52              A   557    				sbc.sis hl,de					000E48 30 0A               A   558    				jr nc,noprov_spec
000E4A CD 0E 0F 00         A   559    				call restore_dir_block
000E4E 3E1B                A   560    				ld a,01bh						000E50 C3 DF 0C 00         A   561    				jp show_erm
                           A   562    				
000E54 CD EF 3F 00         A   563    noprov_spec		call hwsc_get_version			000E58 2A 2A 67 00         A   564    				ld hl,(scratch_pad+13)			000E5C EB                  A   565    				ex de,hl						000E5D 7B                  A   566    				ld a,e
000E5E B2                  A   567    				or d
000E5F 28 10               A   568    				jr z,nohwv_spec					000E61 AF                  A   569    				xor a
000E62 40ED52              A   570    				sbc.sis hl,de					000E65 30 0A               A   571    				jr nc,nohwv_spec
000E67 CD 0E 0F 00         A   572    				call restore_dir_block
000E6B 3E2B                A   573    				ld a,02bh						Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  14


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
000E6D C3 DF 0C 00         A   574    				jp show_erm
                           A   575    
000E71 ED5B 25 67 00       A   576    nohwv_spec		ld de,(scratch_pad+8)			000E76 3A 27 67 00         A   577    				ld a,(scratch_pad+10)			000E7A B2                  A   578    				or d
000E7B B3                  A   579    				or e
000E7C 28 04               A   580    				jr z,readcode					000E7E CD 0E 16 00         A   581    				call os_set_load_length			                           A   582    		
000E82 2A 22 67 00         A   583    readcode		ld hl,(scratch_pad+5)
000E86 22 7B 60 00         A   584    				ld (os_extcmd_jmp_addr),hl		000E8A CD F9 48 00         A   585    				call fs_read_data_command
000E8E F5                  A   586    				push af
000E8F CD 0E 0F 00         A   587    				call restore_dir_block			000E93 F1                  A   588    				pop af
000E94 DA CD 0C 00         A   589    				jp c,os_hwerr					000E98 B7                  A   590    				or a
000E99 C2 DF 0C 00         A   591    				jp nz,show_erm					                           A   592    	
000E9D CD 3D 3A 00         A   593    				call enable_nmi					000EA1 DD2A 7B 60 00       A   594    				ld ix,(os_extcmd_jmp_addr)		000EA6 2A 72 60 00         A   595    				ld hl,(os_args_loc)				000EAA C3 F8 0E 00         A   596    				jp os_run_command				                           A   597    
000EAE F5                  A   598    extcmd_return	push af							000EAF CD AC 3F 00         A   599    				call hwsc_default_hw_settings	000EB3 3A 49 5F 00         A   600    				ld a,(store_registers)
000EB7 B7                  A   601    				or a
000EB8 28 06               A   602    				jr z,skp_strg
000EBA F1                  A   603    				pop af
000EBB CD 31 13 00         A   604    				call os_store_CPU_regs			000EBF F5                  A   605    				push af
000EC0 F1                  A   606    skp_strg		pop af
                           A   607    
000EC1 F5                  A   608    cntuasr			push af
000EC2 21 1D 67 00         A   609    				ld hl,scratch_pad				000EC6 CD 68 10 00         A   610    				call hexbyte_to_ascii
000ECA 3600                A   611    				ld (hl),0
000ECC 11 1D 67 00         A   612    				ld de,scratch_pad
000ED0 21 25 55 00         A   613    				ld hl,error_txt
000ED4 CD 41 1B 00         A   614    				call os_set_envar
000ED8 CD 46 3A 00         A   615    				call disable_nmi				000EDC F1                  A   616    				pop af
000EDD 28 12               A   617    extcmderf		jr z,not_errc					000EDF B7                  A   618    				or a
000EE0 CA CC 0C 00         A   619    				jp z,os_hwe1					000EE4 FEFF                A   620    				cp 0ffh							000EE6 CA 48 0A 00         A   621    				jp z,os_cold_start
000EEA FEFE                A   622    				cp 0feh							000EEC C8                  A   623    				ret z
000EED C3 DF 0C 00         A   624    				jp show_erm						000EF1 FEFF                A   625    not_errc		cp 0ffh							Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  15


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
000EF3 CA 48 0A 00         A   626    				jp z,os_cold_start
000EF7 C9                  A   627    				ret
                           A   628    				
                           A   629    ;----------------------------------------------
                           A   630    
000EF8                     A   631    os_run_command									000EF8 ED3906              A   632    				out0 (port_nmi_ack),a			000EFB DD22 4A 5F 00       A   633    				ld (com_start_addr),ix			000F00 DDE9                A   634    				jp (ix)							                           A   635    
                           A   636    ;----------------------------------------------
                           A   637    
000F02                     A   638    cache_dir_block
                           A   639    
                           A   640    	
000F02 D5                  A   641    				push de
000F03 CD 3A 1A 00         A   642    				call fs_get_dir_cluster	
000F07 ED53 78 60 00       A   643    				ld (os_dir_block_cache),de
000F0C D1                  A   644    				pop de	
000F0D C9                  A   645    				ret
                           A   646    		
                           A   647    
000F0E                     A   648    restore_dir_block
                           A   649    
000F0E D5                  A   650    				push de
000F0F ED5B 78 60 00       A   651    				ld de,(os_dir_block_cache)
000F14 CD 46 1A 00         A   652    				call fs_update_dir_cluster
000F18 D1                  A   653    				pop de
000F19 C9                  A   654    				ret
                           A   655    		
                           A   656    ;==============================================
                           A   657    ; Routines called by command line
                           A   658    ;==============================================
                           A   659    
                           A   660    ; Set:-
                           A   661    ; HL to address of string
                           A   662    ; c = y
                           A   663    ; b = x
                           A   664    
000F1A                     A   665    ext_print_string
                           A   666    
000F1A CC 72 15 00         A   667    				call z,mbase_hl
000F1E 18 05               A   668    				jr os_print_string
                           A   669    
000F20                     A   670    os_print_string_cond
                           A   671    
000F20 CD ED 19 00         A   672    				call test_quiet_mode
000F24 C0                  A   673    				ret nz
                           A   674    
000F25                     A   675    os_print_string
                           A   676    
000F25 D5                  A   677    				push de
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  16


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
000F26 C5                  A   678    				push bc
000F27 ED4B B0 5F 00       A   679    				ld bc,(cursor_pos)				000F2C 7E                  A   680    prstr_lp		ld a,(hl)
000F2D 23                  A   681    				inc hl
000F2E B7                  A   682    				or a
000F2F 20 09               A   683    				jr nz,prstr_ne
000F31 ED43 B0 5F 00       A   684    				ld (cursor_pos),bc
000F36 C1                  A   685    				pop bc
000F37 D1                  A   686    				pop de
000F38 AF                  A   687    				xor a							000F39 C9                  A   688    				ret
                           A   689    
000F3A FE0D                A   690    prstr_ne		cp 13
000F3C 20 04               A   691    				jr nz,not_cr
000F3E 0600                A   692    				ld b,0
000F40 18 EA               A   693    				jr prstr_lp
000F42 FE0A                A   694    not_cr			cp 10
000F44 28 12               A   695    				jr z,line_feed				
000F46 FE0B                A   696    				cp 11
000F48 28 0C               A   697    				jr z,next_line
000F4A CD B7 3C 00         A   698    				call hwsc_plot_char
000F4E 04                  A   699    				inc b
000F4F 3A 5E 5D 00         A   700    				ld a,(window_columns)
000F53 B8                  A   701    				cp b
000F54 20 D6               A   702    				jr nz,prstr_lp
000F56 0600                A   703    next_line		ld b,0
000F58 0C                  A   704    line_feed		inc c
000F59 3A 5B 5D 00         A   705    				ld a,(window_rows)
000F5D B9                  A   706    				cp c
000F5E 20 CC               A   707    				jr nz,prstr_lp
000F60 0D                  A   708    				dec c
000F61 CD 13 3C 00         A   709    				call hwsc_scroll_up
000F65 18 C5               A   710    				jr prstr_lp
                           A   711    
                           A   712    ;----------------------------------------------
                           A   713    
000F67 21 DD 60 00         A   714    os_print_char	ld hl,char_to_print
000F6B 77                  A   715    				ld (hl),a
000F6C 18 B7               A   716    				jr os_print_string
                           A   717    
                           A   718    ;----------------------------------------------
                           A   719    
000F6E F5                  A   720    home_cursor		push af
000F6F AF                  A   721    				xor a
000F70 32 B1 5F 00         A   722    				ld (cursor_x),a
000F74 F1                  A   723    				pop af
000F75 C9                  A   724    				ret
                           A   725    				
                           A   726    ;----------------------------------------------
                           A   727    
000F76                     A   728    os_cursor_flash
                           A   729    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  17


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
000F76 21 B3 5F 00         A   730    				ld hl,cursorflashtimer
000F7A 34                  A   731    				inc (hl)
000F7B 7E                  A   732    				ld a,(hl)
000F7C FE19                A   733    				cp 25
000F7E C0                  A   734    				ret nz
000F7F 3600                A   735    				ld (hl),0
000F81 3A B4 5F 00         A   736    				ld a,(cursor_status)
000F85 EE01                A   737    				xor 1
000F87 32 B4 5F 00         A   738    				ld (cursor_status),a
000F8B 28 05               A   739    				jr z,no_cursor
000F8D CD F7 3D 00         A   740    				call hwsc_draw_cursor			000F91 C9                  A   741    				ret
000F92 CD E4 3D 00         A   742    no_cursor		call hwsc_remove_cursor
000F96 C9                  A   743    				ret
                           A   744    
                           A   745    ;----------------------------------------------
                           A   746    
000F97                     A   747    os_refresh_screen
                           A   748    
000F97 0E00                A   749    				ld c,0							000F99 CD 57 3F 00         A   750    rs_yloop		call hwsc_redraw_ui_line
000F9D 0C                  A   751    				inc c
000F9E 3A 5B 5D 00         A   752    				ld a,(window_rows)		
000FA2 B9                  A   753    				cp c
000FA3 20 F4               A   754    				jr nz,rs_yloop
000FA5 C9                  A   755    				ret
                           A   756    
                           A   757    ;----------------------------------------------
                           A   758    
000FA6                     A   759    os_next_arg
                           A   760    
000FA6 CD B2 0F 00         A   761    				call os_scan_for_space
000FAA B7                  A   762    				or a
000FAB C8                  A   763    				ret z
000FAC CD BB 0F 00         A   764    				call os_scan_for_non_space
000FB0 B7                  A   765    				or a
000FB1 C9                  A   766    				ret
                           A   767    
                           A   768    
                           A   769    ;----------------------------------------------
                           A   770    	
                           A   771    
000FB2                     A   772    os_scan_for_space
                           A   773    
000FB2 7E                  A   774    os_sfspl 		ld a,(hl)						000FB3 B7                  A   775    				or a							000FB4 C8                  A   776    				ret z
000FB5 FE20                A   777    				cp ' '
000FB7 C8                  A   778    				ret z
000FB8 23                  A   779    				inc hl
000FB9 18 F7               A   780    				jr os_sfspl
                           A   781    	
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  18


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A   782    
                           A   783    ;----------------------------------------------
                           A   784    	
                           A   785    
000FBB                     A   786    os_scan_for_non_space
                           A   787    
000FBB 2B                  A   788    				dec hl							000FBC 23                  A   789    os_nsplp		inc hl			
000FBD 7E                  A   790    				ld a,(hl)			
000FBE B7                  A   791    				or a			
000FBF C8                  A   792    				ret z							000FC0 FE20                A   793    				cp ' '
000FC2 28 F8               A   794    				jr z,os_nsplp
000FC4 C9                  A   795    				ret
                           A   796    	
                           A   797    	
                           A   798    ;----------------------------------------------
                           A   799    
000FC5                     A   800    os_args_to_alt_filename
                           A   801    
000FC5 CD 1F 10 00         A   802    				call os_atfn_pre				000FC9 C8                  A   803    				ret z
000FCA CD 07 51 00         A   804    				call fs_hl_to_alt_filename
000FCE 18 09               A   805    				jr os_atfrl
                           A   806    	
                           A   807    	
                           A   808    	
                           A   809    		
000FD0                     A   810    os_args_to_filename
                           A   811    
000FD0 CD 1F 10 00         A   812    				call os_atfn_pre				000FD4 C8                  A   813    				ret z
000FD5 CD 0D 51 00         A   814    				call fs_hl_to_filename	
                           A   815    
000FD9 7E                  A   816    os_atfrl		ld a,(hl)						000FDA B7                  A   817    				or a							000FDB 28 0B               A   818    				jr z,os_cfne
000FDD FE20                A   819    				cp 32
000FDF 28 07               A   820    				jr z,os_cfne
000FE1 FE2F                A   821    				cp 02fh
000FE3 28 03               A   822    				jr z,os_cfne
000FE5 23                  A   823    				inc hl
000FE6 18 F1               A   824    				jr os_atfrl	
000FE8 22 72 60 00         A   825    os_cfne			ld (os_args_loc),hl				000FEC 79                  A   826    				ld a,c			
000FED B7                  A   827    				or a							000FEE C9                  A   828    				ret
                           A   829    
                           A   830    
                           A   831    
                           A   832    
000FEF                     A   833    os_args_to_fn_append_ezp
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  19


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A   834    
                           A   835    	
000FEF CD 1F 10 00         A   836    				call os_atfn_pre				000FF3 C8                  A   837    				ret z
000FF4 11 4D 5F 00         A   838    				ld de,temp_string
000FF8 7E                  A   839    ccmdtlp			ld a,(hl)						000FF9 B7                  A   840    				or a
000FFA 28 0D               A   841    				jr z,goteocmd
000FFC FE20                A   842    				cp ' '
000FFE 28 09               A   843    				jr z,goteocmd
001000 FE2E                A   844    				cp '.'
001002 28 05               A   845    				jr z,goteocmd
001004 12                  A   846    				ld (de),a
001005 13                  A   847    				inc de
001006 23                  A   848    				inc hl
001007 18 EF               A   849    				jr ccmdtlp
                           A   850    	
001009 E5                  A   851    goteocmd		push hl
00100A 21 FF 54 00         A   852    				ld hl,ezp_extension_txt
00100E 01050000            A   853    				ld bc,5
001012 EDB0                A   854    				ldir 
001014 21 4D 5F 00         A   855    				ld hl,temp_string
001018 CD 0D 51 00         A   856    				call fs_hl_to_filename
00101C E1                  A   857    				pop hl
00101D 18 BA               A   858    				jr os_atfrl
                           A   859    	
                           A   860    
                           A   861    
                           A   862    
00101F                     A   863    os_atfn_pre
                           A   864    
00101F 2A 72 60 00         A   865    				ld hl,(os_args_loc)				001023 CD BB 0F 00         A   866    				call os_scan_for_non_space
001027 B7                  A   867    				or a
001028 C8                  A   868    				ret z
001029 7E                  A   869    				ld a,(hl)
00102A FE2F                A   870    				cp 02fh							00102C 20 01               A   871    				jr nz,notfsl1
00102E 23                  A   872    				inc hl
00102F AF                  A   873    notfsl1			xor a
001030 3C                  A   874    				inc a
001031 C9                  A   875    				ret
                           A   876    
                           A   877    
                           A   878    ;--------- Number <-> String functions --------
                           A   879    
                           A   880    
001032                     A   881    os_clear_output_line
                           A   882    
001032 C5                  A   883    				push bc
001033 E5                  A   884    				push hl			
001034 21 20 60 00         A   885    				ld hl,output_line
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  20


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
001038 01500000            A   886    				ld bc,max_buffer_chars
00103C 3E20                A   887    				ld a,32
00103E CD 4B 15 00         A   888    				call os_bchl_memfill
001042 E1                  A   889    				pop hl
001043 C1                  A   890    				pop bc
001044 C9                  A   891    				ret
                           A   892    	
                           A   893    	
                           A   894    	
001045                     A   895    os_skip_leading_ascii_zeros
                           A   896    
001045 7E                  A   897    slazlp			ld a,(hl)						001046 FE30                A   898    				cp '0'							001048 C0                  A   899    				ret nz
001049 23                  A   900    				inc hl
00104A 10 F9               A   901    				djnz slazlp
00104C C9                  A   902    				ret
                           A   903    	
                           A   904    
                           A   905    
00104D                     A   906    os_leading_ascii_zeros_to_spaces
                           A   907    
00104D E5                  A   908    				push hl
00104E 7E                  A   909    clazlp			ld a,(hl)						00104F FE30                A   910    				cp '0'							001051 20 05               A   911    				jr nz,claze	
001053 3620                A   912    				ld (hl),' '
001055 23                  A   913    				inc hl
001056 10 F6               A   914    				djnz clazlp
001058 E1                  A   915    claze			pop hl
001059 C9                  A   916    				ret
                           A   917    	
                           A   918    
                           A   919    
                           A   920    		
00105A                     A   921    n_hexbytes_to_ascii
                           A   922    
00105A 1A                  A   923    				ld a,(de)						00105B CD 68 10 00         A   924    				call hexbyte_to_ascii			00105F 1B                  A   925    				dec de
001060 10 F8               A   926    				djnz n_hexbytes_to_ascii
001062 C9                  A   927    				ret
                           A   928    			
                           A   929    			
                           A   930    
001063                     A   931    ext_hexbyte_to_ascii
                           A   932    
001063 CC 72 15 00         A   933    				call z,mbase_hl
001067 7B                  A   934    				ld a,e
                           A   935    
001068                     A   936    hexbyte_to_ascii
                           A   937    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  21


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
001068 C5                  A   938    				push bc
001069 47                  A   939    				ld b,a							00106A CB3F                A   940    				srl a							00106C CB3F                A   941    				srl a
00106E CB3F                A   942    				srl a
001070 CB3F                A   943    				srl a
001072 CD 84 10 00         A   944    				call hxdigconv
001076 77                  A   945    				ld (hl),a
001077 23                  A   946    				inc hl
001078 78                  A   947    				ld a,b
001079 E60F                A   948    				and 0fh
00107B CD 84 10 00         A   949    				call hxdigconv
00107F 77                  A   950    				ld (hl),a
001080 23                  A   951    				inc hl
001081 C1                  A   952    				pop bc
001082 AF                  A   953    				xor a							001083 C9                  A   954    				ret
                           A   955    				
001084 C630                A   956    hxdigconv		add a,030h
001086 FE3A                A   957    				cp 03ah
001088 38 02               A   958    				jr c,hxdone
00108A C607                A   959    				add a,7
00108C C9                  A   960    hxdone			ret
                           A   961    
                           A   962    
                           A   963    
                           A   964    
00108D                     A   965    hexword_to_ascii	
                           A   966    
00108D 7A                  A   967    				ld a,d							00108E CD 68 10 00         A   968    				call hexbyte_to_ascii
001092 7B                  A   969    				ld a,e
001093 CD 68 10 00         A   970    				call hexbyte_to_ascii
001097 C9                  A   971    				ret
                           A   972    	
                           A   973    
                           A   974    
                           A   975    
001098                     A   976    ext_ascii_to_hexword
                           A   977    		
001098 CC 72 15 00         A   978    				call z,mbase_hl
                           A   979    
00109C                     A   980    ascii_to_hexword
                           A   981    	
00109C CD BB 0F 00         A   982    				call os_scan_for_non_space		0010A0 B7                  A   983    				or a
0010A1 20 04               A   984    				jr nz,ascii_to_hex_no_scan
0010A3 3E81                A   985    				ld a,081h						0010A5 B7                  A   986    				or a
0010A6 C9                  A   987    				ret	
                           A   988    
                           A   989    	
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  22


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
0010A7                     A   990    ascii_to_hex_no_scan
                           A   991    
0010A7 DDE5                A   992    				push ix
0010A9 C5                  A   993    				push bc
0010AA DD210000 00         A   994    				ld ix,0
0010AF 0606                A   995    				ld b,6							0010B1 CD DD 10 00         A   996    athlp			call ascii_to_hex_digit
0010B5 FEF0                A   997    				cp 0f0h							0010B7 28 17               A   998    				jr z,athend
0010B9 FED0                A   999    				cp 0d0h
0010BB 28 13               A  1000    				jr z,athend						0010BD FE10                A  1001    				cp 16
0010BF 30 17               A  1002    				jr nc,badhex					0010C1 DD29                A  1003    				add ix,ix						0010C3 DD29                A  1004    				add ix,ix
0010C5 DD29                A  1005    				add ix,ix
0010C7 DD29                A  1006    				add ix,ix
0010C9 DDB5                A  1007    				or a,ixl
0010CB DD6F                A  1008    				ld ixl,a
0010CD 23                  A  1009    				inc hl
0010CE 10 E1               A  1010    				djnz athlp
0010D0 DDE5                A  1011    athend			push ix
0010D2 D1                  A  1012    				pop de
0010D3 AF                  A  1013    				xor a
0010D4 C1                  A  1014    ath_quit		pop bc
0010D5 DDE1                A  1015    				pop ix							0010D7 C9                  A  1016    				ret
                           A  1017    		
0010D8 3E82                A  1018    badhex			ld a,82h						0010DA B7                  A  1019    				or a
0010DB 18 F7               A  1020    				jr ath_quit
                           A  1021    				
                           A  1022    	
                           A  1023    		
0010DD                     A  1024    ascii_to_hex_digit
                           A  1025    
0010DD 7E                  A  1026    				ld a,(hl)						0010DE FE61                A  1027    				cp 061h
0010E0 38 02               A  1028    				jr c,hc_uppercase
0010E2 D620                A  1029    				sub 020h						0010E4 D63A                A  1030    hc_uppercase	sub 03ah						0010E6 38 02               A  1031    				jr c,zeronine
0010E8 C6F9                A  1032    				add a,0f9h
0010EA C60A                A  1033    zeronine		add a,0ah
0010EC C9                  A  1034    				ret
                           A  1035    
                           A  1036    
                           A  1037    ;--------- Text Input / Non-numeric string func
                           A  1038    
                           A  1039    ; Waits for user to enter a string of character
                           A  1040    ; Before calling, set:  HL = destination of str
                           A  1041    ;                        E = max number of char
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  23


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A  1042    ; Returns:   A  = number of characters in enter
                           A  1043    
                           A  1044    
0010ED                     A  1045    ext_user_input
0010ED CC 72 15 00         A  1046    				call z,mbase_hl
                           A  1047    				
0010F1                     A  1048    os_user_input
0010F1 AF                  A  1049    				xor a
0010F2 32 2E 5D 00         A  1050    				ld (ui_index),a
0010F6 22 30 5D 00         A  1051    				ld (ui_string_addr),hl
0010FA 7B                  A  1052    				ld a,e
0010FB 32 2F 5D 00         A  1053    				ld (ui_maxchars),a
                           A  1054    				
0010FF 3A 04 61 00         A  1055    				ld a,(insert_mode)
001103 32 CD 5F 00         A  1056    				ld (ui_im_cache),a
001107 AF                  A  1057    				xor a
001108 32 04 61 00         A  1058    				ld (insert_mode),a				                           A  1059    				
00110C CD F7 3D 00         A  1060    ui_loop			call hwsc_draw_cursor			001110 CD B2 42 00         A  1061    				call os_wait_key_press			001114 32 05 61 00         A  1062    				ld (current_scancode),a
001118 78                  A  1063    				ld a,b
001119 32 06 61 00         A  1064    				ld (current_asciicode),a		00111D CD E4 3D 00         A  1065    				call hwsc_remove_cursor
                           A  1066    	
001121 3A 05 61 00         A  1067    				ld a,(current_scancode)
001125 FE66                A  1068    				cp 066h							001127 20 1F               A  1069    				jr nz,os_nuibs
001129 3A 2E 5D 00         A  1070    				ld a,(ui_index)
00112D B7                  A  1071    				or a
00112E 28 DC               A  1072    				jr z,ui_loop					001130 21 B1 5F 00         A  1073    				ld hl,cursor_x					001134 35                  A  1074    				dec (hl)						001135 46                  A  1075    os_uixok		ld b,(hl)		
001136 3A B0 5F 00         A  1076    				ld a,(cursor_y)
00113A 4F                  A  1077    				ld c,a
00113B 3E20                A  1078    				ld a,32
00113D CD B7 3C 00         A  1079    				call hwsc_plot_char
001141 21 2E 5D 00         A  1080    				ld hl,ui_index
001145 35                  A  1081    				dec (hl)						001146 18 C4               A  1082    				jr ui_loop
                           A  1083    
001148 FE76                A  1084    os_nuibs		cp 076h							00114A 28 5E               A  1085    				jr z,ui_aborted
00114C FE5A                A  1086    				cp 05ah							00114E 28 45               A  1087    				jr z,ui_enter_pressed
                           A  1088    	
001150 3A 2E 5D 00         A  1089    				ld a,(ui_index)					001154 21 2F 5D 00         A  1090    				ld hl,ui_maxchars
001158 BE                  A  1091    				cp (hl)
001159 28 B1               A  1092    				jr z,ui_loop	
                           A  1093    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  24


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
00115B 3A 06 61 00         A  1094    				ld a,(current_asciicode)		00115F B7                  A  1095    				or a							001160 28 AA               A  1096    				jr z,ui_loop					                           A  1097    
001162 57                  A  1098    ui_gtcha		ld d,a
001163 2A 30 5D 00         A  1099    				ld hl,(ui_string_addr)
001167 3A 2E 5D 00         A  1100    				ld a,(ui_index)
00116B 01000000            A  1101    				ld bc,0
00116F 4F                  A  1102    				ld c,a
001170 09                  A  1103    				add hl,bc
001171 72                  A  1104    				ld (hl),d						001172 3C                  A  1105    				inc a
001173 32 2E 5D 00         A  1106    				ld (ui_index),a					                           A  1107    				
001177 ED4B B0 5F 00       A  1108    				ld bc,(cursor_y)				00117C 7A                  A  1109    				ld a,d
00117D CD B7 3C 00         A  1110    				call hwsc_plot_char		
001181 21 B1 5F 00         A  1111    				ld hl,cursor_x					001185 34                  A  1112    				inc (hl)
001186 3A 5E 5D 00         A  1113    				ld a,(window_columns)			00118A BE                  A  1114    				cp (hl)
00118B C2 0C 11 00         A  1115    				jp nz,ui_loop
00118F 3600                A  1116    				ld (hl),0
001191 C3 0C 11 00         A  1117    				jp ui_loop
                           A  1118    
001195                     A  1119    ui_enter_pressed
                           A  1120    				
001195 3A CD 5F 00         A  1121    				ld a,(ui_im_cache)				001199 32 04 61 00         A  1122    				ld (insert_mode),a
00119D 3A 2E 5D 00         A  1123    				ld a,(ui_index)					0011A1 B7                  A  1124    				or a
0011A2 20 04               A  1125    				jr nz,ui_data
0011A4 3E81                A  1126    				ld a,081h						0011A6 B7                  A  1127    				or a
0011A7 C9                  A  1128    				ret
0011A8 BF                  A  1129    ui_data			cp a							0011A9 C9                  A  1130    				ret
                           A  1131    
0011AA 3A CD 5F 00         A  1132    ui_aborted		ld a,(ui_im_cache)				0011AE 32 04 61 00         A  1133    				ld (insert_mode),a
0011B2 3E80                A  1134    				ld a,080h						0011B4 B7                  A  1135    				or a							0011B5 C9                  A  1136    				ret
                           A  1137    		
                           A  1138    ;----------------------------------------------
                           A  1139    	
0011B6                     A  1140    os_count_lines
                           A  1141    
0011B6 E5                  A  1142    				push hl							0011B7 0679                A  1143    				ld b,'y'						0011B9 21 B5 5F 00         A  1144    				ld hl,os_linecount			
0011BD 34                  A  1145    				inc (hl)						Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  25


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
0011BE 3A 5B 5D 00         A  1146    				ld a,(window_rows)
0011C2 D604                A  1147    				sub 4
0011C4 BE                  A  1148    				cp (hl)
0011C5 20 0E               A  1149    				jr nz,os_nntpo
0011C7 3600                A  1150    				ld (hl),0
0011C9 21 04 55 00         A  1151    				ld hl,os_more_txt
0011CD CD 25 0F 00         A  1152    				call os_print_string
0011D1 CD B2 42 00         A  1153    				call os_wait_key_press	
0011D5 E1                  A  1154    os_nntpo		pop hl
0011D6 C9                  A  1155    				ret
                           A  1156    
                           A  1157    ;----------------------------------------------
                           A  1158    
0011D7                     A  1159    ext_compare_strings
                           A  1160    	
0011D7 CC 72 15 00         A  1161    				call z,mbase_hl
0011DB CC 83 15 00         A  1162    				call z,mbase_de
                           A  1163    				
0011DF                     A  1164    os_compare_strings
                           A  1165    
                           A  1166    ; both strings at HL/DE should be zero terminat
                           A  1167    ; compare will fail if string lengths are diffe
                           A  1168    ; unless count (B) is reached first
                           A  1169    ; Case is ignored
                           A  1170    ; Zero flag set on return if same
                           A  1171    
0011DF E5                  A  1172    				push hl							0011E0 D5                  A  1173    				push de							0011E1 1A                  A  1174    ocslp			ld a,(de)						0011E2 B7                  A  1175    				or a
0011E3 28 0C               A  1176    				jr z,ocsbt
0011E5 CD 22 12 00         A  1177    				call case_insensitive_compare	0011E9 20 0E               A  1178    				jr nz,ocs_diff
0011EB 13                  A  1179    				inc de
0011EC 23                  A  1180    				inc hl
0011ED 10 F2               A  1181    				djnz ocslp
0011EF 18 04               A  1182    				jr ocs_same
0011F1 1A                  A  1183    ocsbt			ld a,(de)						0011F2 B6                  A  1184    				or (hl)
0011F3 20 04               A  1185    				jr nz,ocs_diff
0011F5 D1                  A  1186    ocs_same		pop de
0011F6 E1                  A  1187    				pop hl
0011F7 AF                  A  1188    				xor a							0011F8 C9                  A  1189    				ret
0011F9 D1                  A  1190    ocs_diff		pop de
0011FA E1                  A  1191    				pop hl
0011FB AF                  A  1192    				xor a							0011FC 3C                  A  1193    				inc a
0011FD C9                  A  1194    				ret
                           A  1195    
                           A  1196    
                           A  1197    ;----------------------------------------------
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  26


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A  1198    
0011FE                     A  1199    os_copy_ascii_run
                           A  1200    
                           A  1201    ;INPUT HL = source ($00 or $20 terminates)
                           A  1202    ;      DE = dest
                           A  1203    ;       b = max chars
                           A  1204    
                           A  1205    ;OUTPUT HL/DE = end of runs
                           A  1206    ;           c = char count
                           A  1207    	
0011FE 0E00                A  1208    				ld c,0
001200 7E                  A  1209    cpyar_lp		ld a,(hl)
001201 B7                  A  1210    				or a
001202 C8                  A  1211    				ret z
001203 FE20                A  1212    				cp 32
001205 C8                  A  1213    				ret z
001206 12                  A  1214    				ld (de),a
001207 23                  A  1215    				inc hl
001208 13                  A  1216    				inc de
001209 0C                  A  1217    				inc c
00120A 10 F4               A  1218    				djnz cpyar_lp
00120C C9                  A  1219    				ret
                           A  1220    
                           A  1221    ;----------------------------------------------
                           A  1222    
00120D                     A  1223    uppercasify_string
                           A  1224    
                           A  1225    ; Set HL to string location ($00 quits)
                           A  1226    ; Set B to max number of chars
                           A  1227    
00120D 7E                  A  1228    				ld a,(hl)
00120E B7                  A  1229    				or a
00120F C8                  A  1230    				ret z
001210 CD 19 12 00         A  1231    				call os_uppercasify
001214 77                  A  1232    				ld (hl),a
001215 23                  A  1233    				inc hl
001216 10 F5               A  1234    				djnz uppercasify_string	
001218 C9                  A  1235    				ret
                           A  1236    	
                           A  1237    
001219                     A  1238    os_uppercasify
                           A  1239    
                           A  1240    ; INPUT/OUTPUT A = ascii char to make uppercase
                           A  1241    
001219 FE61                A  1242    				cp 061h			
00121B D8                  A  1243    				ret c
00121C FE7B                A  1244    				cp 07bh
00121E D0                  A  1245    				ret nc
00121F D620                A  1246    				sub 020h				
001221 C9                  A  1247    				ret
                           A  1248    
                           A  1249    ;----------------------------------------------
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  27


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A  1250    
001222                     A  1251    case_insensitive_compare
                           A  1252    
                           A  1253    ; compares A with (HL) disregarding the case of
                           A  1254    ; Zero flag set if the characters are the same
                           A  1255    ; all registers are preserved.
                           A  1256    
001222 C5                  A  1257    				push bc					
001223 4F                  A  1258    				ld c,a
                           A  1259    
001224 CD 19 12 00         A  1260    				call os_uppercasify				001228 47                  A  1261    				ld b,a
001229 7E                  A  1262    				ld a,(hl)
00122A CD 19 12 00         A  1263    				call os_uppercasify
00122E B8                  A  1264    				cp b
                           A  1265    
00122F 79                  A  1266    				ld a,c
001230 C1                  A  1267    				pop bc
001231 C9                  A  1268    				ret
                           A  1269    
                           A  1270    ;----------------------------------------------
                           A  1271    
001232                     A  1272    os_decimal_add
                           A  1273    
                           A  1274    ;INPUT HL = source LSB, DE = dest LSB, b = numb
                           A  1275    
001232 C5                  A  1276    				push bc
001233 0E00                A  1277    				ld c,0
001235 1A                  A  1278    decdlp			ld a,(de)
001236 86                  A  1279    				add a,(hl)
001237 81                  A  1280    				add a,c
001238 FE0A                A  1281    				cp 10
00123A 38 0B               A  1282    				jr c,daddnc
00123C D60A                A  1283    				sub 10
00123E 0E01                A  1284    				ld c,1
001240 12                  A  1285    decnclp			ld (de),a
001241 23                  A  1286    				inc hl
001242 13                  A  1287    				inc de
001243 10 F0               A  1288    				djnz decdlp
001245 C1                  A  1289    				pop bc
001246 C9                  A  1290    				ret
001247 0E00                A  1291    daddnc			ld c,0
001249 18 F5               A  1292    				jr decnclp
                           A  1293    	
                           A  1294    ;----------------------------------------------
                           A  1295    
00124B                     A  1296    os_hex_to_decimal
                           A  1297    
                           A  1298    ; INPUT xDE hex longword
                           A  1299    ; OUTPUT xHL = decimal LSB address (8 digits) 
                           A  1300    
       0000671D            A  1301    hex_to_convert		equ scratch_pad
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  28


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
       00006720            A  1302    decimal_digits		equ scratch_pad+3
       00006728            A  1303    decimal_add_digits	equ scratch_pad+3+8
                           A  1304    
00124B ED53 1D 67 00       A  1305    				ld (hex_to_convert),de
                           A  1306    		
001250 21 28 67 00         A  1307    				ld hl,decimal_add_digits
001254 E5                  A  1308    				push hl
001255 11 20 67 00         A  1309    				ld de,decimal_digits
001259 AF                  A  1310    				xor a
00125A 0608                A  1311    				ld b,8
00125C 12                  A  1312    setupdec		ld (de),a
00125D 77                  A  1313    				ld (hl),a
00125E 23                  A  1314    				inc hl
00125F 13                  A  1315    				inc de
001260 10 FA               A  1316    				djnz setupdec
001262 E1                  A  1317    				pop hl
001263 3601                A  1318    				ld (hl),1
                           A  1319    	
001265 21 1D 67 00         A  1320    				ld hl,hex_to_convert
001269 0603                A  1321    				ld b,3
00126B C5                  A  1322    decconvlp		push bc
00126C 7E                  A  1323    				ld a,(hl)
00126D CD 8B 12 00         A  1324    				call decadder
001271 CD A4 12 00         A  1325    				call decaddx16
001275 7E                  A  1326    				ld a,(hl)
001276 0F                  A  1327    				rrca
001277 0F                  A  1328    				rrca
001278 0F                  A  1329    				rrca
001279 0F                  A  1330    				rrca
00127A CD 8B 12 00         A  1331    				call decadder
00127E CD A4 12 00         A  1332    				call decaddx16
001282 C1                  A  1333    				pop bc
001283 23                  A  1334    				inc hl
001284 10 E5               A  1335    				djnz decconvlp
001286 21 20 67 00         A  1336    				ld hl,decimal_digits
00128A C9                  A  1337    				ret
                           A  1338    
                           A  1339    
                           A  1340    
00128B E60F                A  1341    decadder		and 15
00128D C8                  A  1342    				ret z
00128E 47                  A  1343    				ld b,a
00128F E5                  A  1344    				push hl
001290 C5                  A  1345    daddlp			push bc
001291 11 20 67 00         A  1346    				ld de,decimal_digits
001295 21 28 67 00         A  1347    				ld hl,decimal_add_digits
001299 0608                A  1348    				ld b,8
00129B CD 32 12 00         A  1349    				call os_decimal_add
00129F C1                  A  1350    				pop bc
0012A0 10 EE               A  1351    				djnz daddlp	
0012A2 E1                  A  1352    				pop hl
0012A3 C9                  A  1353    				ret
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  29


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A  1354    			
                           A  1355    				
0012A4 E5                  A  1356    decaddx16		push hl
0012A5 0604                A  1357    				ld b,4							0012A7 C5                  A  1358    x16loop			push bc
0012A8 11 28 67 00         A  1359    				ld de,decimal_add_digits
0012AC 21 28 67 00         A  1360    				ld hl,decimal_add_digits
0012B0 0608                A  1361    				ld b,8
0012B2 CD 32 12 00         A  1362    				call os_decimal_add
0012B6 C1                  A  1363    				pop bc
0012B7 10 EE               A  1364    				djnz x16loop	
0012B9 E1                  A  1365    				pop hl
0012BA C9                  A  1366    				ret
                           A  1367    	
                           A  1368    	
                           A  1369    ;----------------------------------------------
                           A  1370    
0012BB                     A  1371    os_show_decimal
                           A  1372    
0012BB 11 20 60 00         A  1373    				ld de,output_line				0012BF 01090000            A  1374    				ld bc,9
0012C3 09                  A  1375    				add hl,bc
0012C4 060A                A  1376    				ld b,10
0012C6 7E                  A  1377    shdeclp			ld a,(hl)
0012C7 B7                  A  1378    				or a
0012C8 28 04               A  1379    				jr z,dnodigit
0012CA C630                A  1380    				add a,030h
0012CC 12                  A  1381    				ld (de),a
0012CD 13                  A  1382    				inc de
0012CE 2B                  A  1383    dnodigit		dec hl
0012CF 10 F5               A  1384    				djnz shdeclp
0012D1 AF                  A  1385    				xor a
0012D2 12                  A  1386    				ld (de),a
0012D3 CD 1B 13 00         A  1387    				call os_print_output_line
0012D7 C9                  A  1388    				ret
                           A  1389    				
                           A  1390    ;----------------------------------------------
                           A  1391    		
0012D8                     A  1392    os_copy_to_output_line
                           A  1393    	
0012D8 D5                  A  1394    				push de
0012D9 C5                  A  1395    				push bc
0012DA 11 20 60 00         A  1396    				ld de,output_line				0012DE 01510000            A  1397    				ld bc,max_buffer_chars+1		0012E2 EDA0                A  1398    os_cloll		ldi
0012E4 7E                  A  1399    				ld a,(hl)
0012E5 B7                  A  1400    				or a
0012E6 28 04               A  1401    				jr z,os_clold
0012E8 78                  A  1402    				ld a,b
0012E9 B1                  A  1403    				or c
0012EA 20 F6               A  1404    				jr nz,os_cloll
0012EC 12                  A  1405    os_clold		ld (de),a
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  30


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
0012ED C1                  A  1406    				pop bc
0012EE D1                  A  1407    				pop de
0012EF C9                  A  1408    				ret
                           A  1409    
                           A  1410    
                           A  1411    ;----------------------------------------------
                           A  1412    
0012F0                     A  1413    os_show_hex_address
                           A  1414    
0012F0 E5                  A  1415    				push hl							0012F1 21 20 60 00         A  1416    				ld hl,output_line
0012F5 ED53 C2 5F 00       A  1417    				ld (hex_address),de
0012FA 3A C4 5F 00         A  1418    				ld a,(hex_address+2)
0012FE CD 68 10 00         A  1419    				call hexbyte_to_ascii
001302 18 10               A  1420    				jr shw_nt
                           A  1421    				
                           A  1422    
001304                     A  1423    os_show_hex_byte
                           A  1424    
001304 E5                  A  1425    				push hl							001305 21 20 60 00         A  1426    				ld hl,output_line
001309 CD 68 10 00         A  1427    				call hexbyte_to_ascii
00130D 18 09               A  1428    				jr shb_nt
                           A  1429    
                           A  1430    
                           A  1431    
00130F                     A  1432    os_show_hex_word
                           A  1433    
00130F E5                  A  1434    				push hl							001310 21 20 60 00         A  1435    				ld hl,output_line
001314 CD 8D 10 00         A  1436    shw_nt			call hexword_to_ascii
001318 3600                A  1437    shb_nt			ld (hl),0
00131A E1                  A  1438    				pop hl
                           A  1439    
                           A  1440    	
                           A  1441    
00131B                     A  1442    os_print_output_line
                           A  1443    
00131B E5                  A  1444    				push hl
00131C 21 20 60 00         A  1445    				ld hl,output_line
001320 CD 25 0F 00         A  1446    cproline		call os_print_string
001324 E1                  A  1447    				pop hl
001325 C9                  A  1448    				ret
                           A  1449    
                           A  1450    
                           A  1451    
001326                     A  1452    os_print_output_line_skip_zeroes
                           A  1453    
001326 E5                  A  1454    				push hl
001327 21 20 60 00         A  1455    				ld hl,output_line
00132B CD 45 10 00         A  1456    				call os_skip_leading_ascii_zero
00132F 18 EF               A  1457    				jr cproline
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  31


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A  1458    				
                           A  1459    		
                           A  1460    ;----------------------------------------------
                           A  1461    
001331                     A  1462    os_store_CPU_regs
                           A  1463    
001331 F3                  A  1464    				di								                           A  1465    
001332 33                  A  1466    				inc sp							001333 33                  A  1467    				inc sp
001334 33                  A  1468    				inc sp
001335 ED73 41 5F 00       A  1469    				ld (store_spl),sp
00133A 3B                  A  1470    				dec sp							00133B 3B                  A  1471    				dec sp
00133C 3B                  A  1472    				dec sp
                           A  1473    				
00133D F5                  A  1474    				push af
00133E 32 24 5F 00         A  1475    				ld (store_a1),a					001342 08                  A  1476    				ex af,af'
001343 32 2E 5F 00         A  1477    				ld (store_a2),a
001347 08                  A  1478    				ex af,af'
001348 ED43 25 5F 00       A  1479    				ld (store_bc1),bc		
00134D ED53 28 5F 00       A  1480    				ld (store_de1),de
001352 22 2B 5F 00         A  1481    				ld (store_hl1),hl
001356 D9                  A  1482    				exx
001357 ED43 2F 5F 00       A  1483    				ld (store_bc2),bc
00135C ED53 32 5F 00       A  1484    				ld (store_de2),de
001361 22 35 5F 00         A  1485    				ld (store_hl2),hl
001365 D9                  A  1486    				exx
001366 DD22 38 5F 00       A  1487    				ld (store_ix),ix
00136B FD22 3B 5F 00       A  1488    				ld (store_iy),iy
                           A  1489    				
001370 ED6E                A  1490    			    ld a,MB
001372 32 46 5F 00         A  1491    				ld (store_mbase),a
                           A  1492    								
001376 C5                  A  1493    				push bc
001377 0600                A  1494    				ld b,0
001379 20 02               A  1495    				jr nz,zfstzero					00137B CBF0                A  1496    				set 6,b
                           A  1497    
00137D 30 02               A  1498    zfstzero		jr nc,cfstzero					00137F CBC0                A  1499    				set 0,b
                           A  1500    
001381 F2 87 13 00         A  1501    cfstzero		jp p,sfstzero					001385 CBF8                A  1502    				set 7,b
                           A  1503    
001387 EA 8D 13 00         A  1504    sfstzero		jp pe,pfstzero					00138B CBD0                A  1505    				set 2,b
                           A  1506    
00138D ED57                A  1507    pfstzero		ld a,i			
00138F EA 95 13 00         A  1508    				jp pe,ifstzero					001393 CBE0                A  1509    				set 4,b
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  32


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A  1510    
001395 78                  A  1511    ifstzero		ld a,b
001396 32 47 5F 00         A  1512    				ld (store_f),a
                           A  1513    				
00139A 3E00                A  1514    				ld a,os_location/65536			00139C ED6D                A  1515    				ld MB,a							00139E 40ED73 44 5F        A  1516    				ld.sis (store_sps),sp
0013A3 3A 46 5F 00         A  1517    				ld a,(store_mbase)				0013A7 ED6D                A  1518    				ld MB,a
                           A  1519    				
0013A9 C1                  A  1520    				pop bc
0013AA F1                  A  1521    				pop af
0013AB FB                  A  1522    				ei
0013AC C9                  A  1523    				ret
                           A  1524    
                           A  1525    
                           A  1526    
0013AD                     A  1527    os_dont_store_registers
                           A  1528    
0013AD AF                  A  1529    				xor a
0013AE 32 49 5F 00         A  1530    				ld (store_registers),a			0013B2 C9                  A  1531    				ret
                           A  1532    	
                           A  1533    	
                           A  1534    ;----------------------------------------------
                           A  1535    
0013B3                     A  1536    os_new_line_cond
                           A  1537    
0013B3 CD ED 19 00         A  1538    				call test_quiet_mode
0013B7 C0                  A  1539    				ret nz
                           A  1540    
                           A  1541    	
0013B8                     A  1542    os_new_line
                           A  1543    
0013B8 E5                  A  1544    				push hl
0013B9 21 1C 55 00         A  1545    				ld hl,crlfx2_txt+1
0013BD CD 25 0F 00         A  1546    				call os_print_string
0013C1 E1                  A  1547    				pop hl
0013C2 C9                  A  1548    				ret
                           A  1549    				
                           A  1550    ;----------------------------------------------
                           A  1551    
0013C3                     A  1552    os_set_cursor_position
                           A  1553    				
                           A  1554    												0013C3 3A 5B 5D 00         A  1555    				ld a,(window_rows)				0013C7 3D                  A  1556    				dec a							0013C8 B9                  A  1557    				cp c
0013C9 38 14               A  1558    				jr c,badpos
0013CB 79                  A  1559    				ld a,c
0013CC 32 B0 5F 00         A  1560    				ld (cursor_y),a
                           A  1561    				
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  33


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
0013D0 3A 5E 5D 00         A  1562    				ld a,(window_columns)
0013D4 3D                  A  1563    				dec a
0013D5 B8                  A  1564    				cp b
0013D6 38 07               A  1565    				jr c,badpos
0013D8 78                  A  1566    				ld a,b
0013D9 32 B1 5F 00         A  1567    				ld (cursor_x),a
0013DD AF                  A  1568    				xor a
0013DE C9                  A  1569    				ret				
                           A  1570    
0013DF 3E82                A  1571    badpos			ld a,82h
0013E1 B7                  A  1572    				or a
0013E2 C9                  A  1573    				ret
                           A  1574    
                           A  1575    
                           A  1576    					
                           A  1577    	
                           A  1578    	
0013E3                     A  1579    os_get_cursor_position
                           A  1580    
0013E3 ED4B B0 5F 00       A  1581    				ld bc,(cursor_pos)				0013E8 BF                  A  1582    				cp a							0013E9 C9                  A  1583    				ret
                           A  1584    
                           A  1585    
                           A  1586    ;----------------------------------------------
                           A  1587    
0013EA                     A  1588    os_show_packed_text_cond
                           A  1589    
0013EA CD ED 19 00         A  1590    				call test_quiet_mode
0013EE C0                  A  1591    				ret nz
                           A  1592    
                           A  1593    	
0013EF                     A  1594    os_show_packed_text
                           A  1595    
                           A  1596    ; Construct sentence from internal dictionary u
                           A  1597    	
0013EF C5                  A  1598    				push bc
0013F0 D5                  A  1599    				push de
0013F1 DDE5                A  1600    				push ix
0013F3 DD21 20 60 00       A  1601    				ld ix,output_line
0013F8 7E                  A  1602    readpind		ld a,(hl)
0013F9 B7                  A  1603    				or a
0013FA 20 10               A  1604    				jr nz,getword					0013FC DD2B                A  1605    				dec ix							0013FE DD7700              A  1606    				ld (ix),a						                           A  1607    			
001401 E5                  A  1608    				push hl
001402 CD 1B 13 00         A  1609    				call os_print_output_line
001406 E1                  A  1610    				pop hl
                           A  1611    			
001407 DDE1                A  1612    				pop ix
001409 D1                  A  1613    				pop de
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  34


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
00140A C1                  A  1614    				pop bc
00140B C9                  A  1615    				ret
                           A  1616    				
00140C 11 2A 55 00         A  1617    getword			ld de,dictionary-1
001410 0E00                A  1618    				ld c,0
001412 13                  A  1619    dictloop		inc de
001413 1A                  A  1620    				ld a,(de)
001414 B7                  A  1621    				or a							001415 28 04               A  1622    				jr z,faword
001417 CB7F                A  1623    				bit 7,a							001419 28 F7               A  1624    				jr z,dictloop	
                           A  1625    			
00141B 0C                  A  1626    faword			inc c							00141C 79                  A  1627    				ld a,c
00141D BE                  A  1628    				cp (hl)
00141E 20 F2               A  1629    				jr nz,dictloop
001420 13                  A  1630    copytol			inc de							001421 1A                  A  1631    				ld a,(de)
001422 B7                  A  1632    				or a
001423 28 0B               A  1633    				jr z,eoword						001425 CB7F                A  1634    				bit 7,a
001427 20 07               A  1635    				jr nz,eoword
001429 DD7700              A  1636    				ld (ix),a						00142C DD23                A  1637    				inc ix
00142E 18 F0               A  1638    				jr copytol
001430 DD360020            A  1639    eoword			ld (ix),32						001434 DD23                A  1640    				inc ix
001436 23                  A  1641    				inc hl
001437 18 BF               A  1642    				jr readpind
                           A  1643    
                           A  1644    
                           A  1645    		
                           A  1646    ;--------- Mouse functions --------------------
                           A  1647    
001439                     A  1648    os_set_mouse_window
                           A  1649    
                           A  1650    ; Set: HL/DE = window size mouse pointer is to 
                           A  1651    	
001439 22 17 61 00         A  1652    				ld (mouse_window_size_x),hl	 
00143D ED53 1A 61 00       A  1653    				ld (mouse_window_size_y),de
001442 21000000            A  1654    				ld hl,0
001446 22 1D 61 00         A  1655    				ld (mouse_abs_x),hl
00144A 22 20 61 00         A  1656    				ld (mouse_abs_y),hl
00144E 3E01                A  1657    				ld a,1
001450 32 2F 61 00         A  1658    				ld (mouse_new_window),a
001454 AF                  A  1659    				xor a
001455 C9                  A  1660    				ret
                           A  1661    				
                           A  1662    			
001456                     A  1663    os_get_mouse_motion
                           A  1664    			
                           A  1665    ; Returns: ZF = Set: Relative X coord in HL, Re
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  35


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A  1666    ;          ZF = Not set: Mouse driver not initi
                           A  1667    			
001456 3A 1A 5F 00         A  1668    				ld a,(devices_connected)
00145A E602                A  1669    				and 2
00145C EE02                A  1670    				xor 2
00145E C0                  A  1671    				ret nz
00145F AF                  A  1672    ms_reread		xor a
001460 32 16 61 00         A  1673    				ld (mouse_updated),a
001464 2A 0F 61 00         A  1674    				ld hl,(mouse_disp_x)			001468 ED5B 12 61 00       A  1675    				ld de,(mouse_disp_y)
00146D 3A 16 61 00         A  1676    				ld a,(mouse_updated)			001471 B7                  A  1677    				or a
001472 20 EB               A  1678    				jr nz,ms_reread
001474 AF                  A  1679    mouse_end		xor a
001475 3A 15 61 00         A  1680    				ld a,(mouse_wheel)
001479 47                  A  1681    				ld b,a
00147A 3A 0E 61 00         A  1682    				ld a,(mouse_buttons)
00147E C9                  A  1683    				ret
                           A  1684    			
                           A  1685    			
00147F                     A  1686    os_get_mouse_position
                           A  1687    
                           A  1688    ; Returns: ZF = Set: Abolute X coord in HL, Abs
                           A  1689    ;          ZF = Not set: Mouse driver not initi
                           A  1690    				
00147F CD 56 14 00         A  1691    				call os_get_mouse_motion
001483 C0                  A  1692    				ret nz
001484 22 29 61 00         A  1693    				ld (mouse_disp_x_buffer),hl
001488 ED53 2C 61 00       A  1694    				ld (mouse_disp_y_buffer),de
00148D 3A 2F 61 00         A  1695    				ld a,(mouse_new_window)
001491 B7                  A  1696    				or a
001492 20 6C               A  1697    				jr nz,ms_nmw
                           A  1698    
001494 ED5B 23 61 00       A  1699    				ld de,(mouse_disp_x_old)
001499 AF                  A  1700    				xor a
00149A ED52                A  1701    				sbc hl,de
00149C EB                  A  1702    				ex de,hl
00149D 2A 1D 61 00         A  1703    				ld hl,(mouse_abs_x)
0014A1 19                  A  1704    				add hl,de
0014A2 E5                  A  1705    				push hl
0014A3 C1                  A  1706    				pop bc
0014A4 DD210000 80         A  1707    				ld ix,800000h					0014A9 DD09                A  1708    				add ix,bc
0014AB 30 06               A  1709    				jr nc,ms_x_ok1
0014AD 01000000            A  1710    				ld bc,0
0014B1 18 10               A  1711    				jr ms_x_ok2
0014B3 ED5B 17 61 00       A  1712    ms_x_ok1		ld de,(mouse_window_size_x)
0014B8 AF                  A  1713    				xor a
0014B9 ED52                A  1714    				sbc hl,de
0014BB 38 06               A  1715    				jr c,ms_x_ok2
0014BD ED4B 17 61 00       A  1716    				ld bc,(mouse_window_size_x)		0014C2 0B                  A  1717    				dec bc
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  36


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
0014C3 ED43 1D 61 00       A  1718    ms_x_ok2		ld (mouse_abs_x),bc
                           A  1719    					
0014C8 2A 2C 61 00         A  1720    				ld hl,(mouse_disp_y_buffer)
0014CC ED5B 26 61 00       A  1721    				ld de,(mouse_disp_y_old)
0014D1 AF                  A  1722    				xor a
0014D2 ED52                A  1723    				sbc hl,de
0014D4 EB                  A  1724    				ex de,hl
0014D5 2A 20 61 00         A  1725    				ld hl,(mouse_abs_y)
0014D9 19                  A  1726    				add hl,de
0014DA E5                  A  1727    				push hl
0014DB C1                  A  1728    				pop bc
0014DC DD210000 80         A  1729    				ld ix,800000h					0014E1 DD09                A  1730    				add ix,bc
0014E3 30 06               A  1731    				jr nc,ms_y_ok1
0014E5 01000000            A  1732    				ld bc,0
0014E9 18 10               A  1733    				jr ms_y_ok2
0014EB ED5B 1A 61 00       A  1734    ms_y_ok1		ld de,(mouse_window_size_y)
0014F0 AF                  A  1735    				xor a
0014F1 ED52                A  1736    				sbc hl,de
0014F3 38 06               A  1737    				jr c,ms_y_ok2
0014F5 ED4B 1A 61 00       A  1738    				ld bc,(mouse_window_size_y)		0014FA 0B                  A  1739    				dec bc
0014FB ED43 20 61 00       A  1740    ms_y_ok2		ld (mouse_abs_y),bc
                           A  1741    
                           A  1742    				
001500 2A 29 61 00         A  1743    ms_nmw			ld hl,(mouse_disp_x_buffer)
001504 22 23 61 00         A  1744    				ld (mouse_disp_x_old),hl
001508 2A 2C 61 00         A  1745    				ld hl,(mouse_disp_y_buffer)
00150C 22 26 61 00         A  1746    				ld (mouse_disp_y_old),hl
                           A  1747    				
001510 2A 1D 61 00         A  1748    				ld hl,(mouse_abs_x)
001514 ED5B 20 61 00       A  1749    				ld de,(mouse_abs_y)
                           A  1750    				
001519 AF                  A  1751    				xor a
00151A 32 2F 61 00         A  1752    				ld (mouse_new_window),a
00151E C3 74 14 00         A  1753    				jp mouse_end
                           A  1754    				
                           A  1755    	
                           A  1756    ;==============================================
                           A  1757    ;----- General Subroutines --------------------
                           A  1758    ;==============================================
                           A  1759    
                           A  1760    ; .--------------.
                           A  1761    ; ! CRC Checksum !
                           A  1762    ; '--------------'
                           A  1763    
                           A  1764    ; makes 16 bit checksum in HL, src addr = DE, l
                           A  1765    
001522                     A  1766    crc_checksum
                           A  1767    
001522 21FFFF00            A  1768    				ld hl,0ffffh		
001526 1A                  A  1769    crcloop			ld a,(de)			
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  37


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
001527 AC                  A  1770    				xor h			
001528 67                  A  1771    				ld h,a			
001529 0608                A  1772    				ld b,8
00152B 4029                A  1773    crcbyte			add.sis hl,hl					00152D 30 08               A  1774    				jr nc,crcnext
00152F 7C                  A  1775    				ld a,h
001530 EE10                A  1776    				xor 10h
001532 67                  A  1777    				ld h,a
001533 7D                  A  1778    				ld a,l
001534 EE21                A  1779    				xor 21h
001536 6F                  A  1780    				ld l,a
001537 10 F2               A  1781    crcnext			djnz crcbyte
001539 13                  A  1782    				inc de
00153A 0D                  A  1783    				dec c
00153B 20 E9               A  1784    				jr nz,crcloop
00153D C9                  A  1785    				ret
                           A  1786    
                           A  1787    
                           A  1788    ;----------------------------------------------
                           A  1789    
00153E                     A  1790    os_get_key_mod_flags
                           A  1791    
00153E 3A 03 61 00         A  1792    				ld a,(key_mod_flags)
001542 BF                  A  1793    				cp a							001543 C9                  A  1794    				ret
                           A  1795    
                           A  1796    ;----------------------------------------------
                           A  1797    
001544                     A  1798    os_get_display_size
                           A  1799    			
001544 ED4B 5B 5D 00       A  1800    				ld bc,(display_parameters)
001549 BF                  A  1801    				cp a
00154A C9                  A  1802    				ret
                           A  1803    
                           A  1804    ;----------------------------------------------
                           A  1805    
00154B                     A  1806    os_bchl_memfill
                           A  1807    
                           A  1808    ; fill memory from xHL with A. Count in xBC.
                           A  1809    		
00154B 77                  A  1810    mf_loop			ld (hl),a
00154C EDA1                A  1811    				cpi								00154E EA 4B 15 00         A  1812    				jp pe,mf_loop
001552 C9                  A  1813    				ret
                           A  1814    	
                           A  1815    ;----------------------------------------------
                           A  1816    
001553 7B                  A  1817    ext_set_pen		ld a,e
                           A  1818    
001554 32 34 5D 00         A  1819    os_set_pen		ld (current_pen),a
001558 BF                  A  1820    				cp a							001559 C9                  A  1821    				ret
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  38


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A  1822    
                           A  1823    ;----------------------------------------------
                           A  1824    	
00155A 3A 34 5D 00         A  1825    os_get_pen		ld a,(current_pen)
00155E BF                  A  1826    				cp a							00155F C9                  A  1827    				ret	
                           A  1828    
                           A  1829    ;----------------------------------------------
                           A  1830    
001560                     A  1831    ext_background_colours
                           A  1832    				
001560 CC 72 15 00         A  1833    				call z,mbase_hl
001564 C3 BE 3B 00         A  1834    				jp hswc_set_ui_colours
                           A  1835    				
                           A  1836    				
                           A  1837    ;----------------------------------------------
                           A  1838    
001568                     A  1839    os_get_xde_msb	
                           A  1840    			
001568 ED53 C8 5F 00       A  1841    				ld (xrr_temp),de				00156D 3A CA 5F 00         A  1842    				ld a,(xrr_temp+2)
001571 C9                  A  1843    				ret
                           A  1844    
                           A  1845    ;----------------------------------------------
                           A  1846    
001572 F5                  A  1847    mbase_hl		push af
001573 22 C8 5F 00         A  1848    				ld (xrr_temp),hl				001577 ED6E                A  1849    				ld a,MB
001579 32 CA 5F 00         A  1850    				ld (xrr_temp+2),a
00157D 2A C8 5F 00         A  1851    				ld hl,(xrr_temp)
001581 F1                  A  1852    				pop af
001582 C9                  A  1853    				ret
                           A  1854    				
001583 F5                  A  1855    mbase_de		push af
001584 ED53 C8 5F 00       A  1856    				ld (xrr_temp),de				001589 ED6E                A  1857    				ld a,MB
00158B 32 CA 5F 00         A  1858    				ld (xrr_temp+2),a
00158F ED5B C8 5F 00       A  1859    				ld de,(xrr_temp)
001594 F1                  A  1860    				pop af
001595 C9                  A  1861    				ret
                           A  1862    
001596 F5                  A  1863    mbase_ix		push af
001597 DD22 C8 5F 00       A  1864    				ld (xrr_temp),ix				00159C ED6E                A  1865    				ld a,MB
00159E 32 CA 5F 00         A  1866    				ld (xrr_temp+2),a
0015A2 DD2A C8 5F 00       A  1867    				ld ix,(xrr_temp)
0015A7 F1                  A  1868    				pop af
0015A8 C9                  A  1869    				ret
                           A  1870    							
                           A  1871    ;----------------------------------------------
                           A  1872    ; Unpacks Z80P_RLE packed files - V1.02 
                           A  1873    ;----------------------------------------------
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  39


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A  1874    
0015A9                     A  1875    unpack_rle
                           A  1876    
                           A  1877    ;set xHL = source address of packed file
                           A  1878    ;set xDE = destination address for unpacked dat
                           A  1879    ;set xBC = length of packed file
                           A  1880    
0015A9 E5                  A  1881    			push hl	
0015AA DDE1                A  1882    			pop ix
0015AC 0B                  A  1883    			dec bc								0015AD 23                  A  1884    			inc hl
0015AE DD7E00              A  1885    unp_gtok	ld a,(ix)							0015B1 BE                  A  1886    unp_next	cp (hl)								0015B2 28 07               A  1887    			jr z,unp_brun						0015B4 EDA0                A  1888    			ldi									0015B6 EA B1 15 00         A  1889    			jp pe,unp_next						0015BA C9                  A  1890    			ret
                           A  1891    	
0015BB C5                  A  1892    unp_brun	push bc								0015BC 23                  A  1893    			inc hl		
0015BD 7E                  A  1894    			ld a,(hl)							0015BE 23                  A  1895    			inc hl		
0015BF 46                  A  1896    			ld b,(hl)							0015C0 23                  A  1897    			inc hl
                           A  1898    	
0015C1 12                  A  1899    unp_rllp	ld (de),a							0015C2 13                  A  1900    			inc de			
0015C3 10 FC               A  1901    			djnz unp_rllp
                           A  1902    	
0015C5 C1                  A  1903    			pop bc	
0015C6 0B                  A  1904    			dec bc								0015C7 0B                  A  1905    			dec bc
0015C8 0B                  A  1906    			dec bc
0015C9 E5                  A  1907    			push hl								0015CA 21000000            A  1908    			ld hl,0
0015CE B7                  A  1909    			or a
0015CF ED4A                A  1910    			adc hl,bc
0015D1 E1                  A  1911    			pop hl
0015D2 20 DA               A  1912    			jr nz,unp_gtok
0015D4 C9                  A  1913    			ret	
                           A  1914    	
                           A  1915    ;----------------------------------------------
                           A  1916    ; Commonly called error messages - gets message
                           A  1917    ;----------------------------------------------
                           A  1918    
                           A  1919    
0015D5 3E0D                A  1920    os_no_fn_error		ld a,0dh
0015D7 B7                  A  1921    					or a
0015D8 C9                  A  1922    					ret
                           A  1923    			
0015D9 3E15                A  1924    os_fn_too_long		ld a,15h
0015DB B7                  A  1925    					or a
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  40


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
0015DC C9                  A  1926    					ret
                           A  1927    				
0015DD 3E16                A  1928    os_no_start_addr	ld a,16h
0015DF B7                  A  1929    					or a
0015E0 C9                  A  1930    					ret
                           A  1931    			
0015E1 3E17                A  1932    os_no_filesize		ld a,17h
0015E3 B7                  A  1933    					or a
0015E4 C9                  A  1934    					ret
                           A  1935    			
0015E5 3E18                A  1936    os_abort_save		ld a,18h
0015E7 B7                  A  1937    					or a
0015E8 C9                  A  1938    					ret
                           A  1939    			
0015E9 3E1C                A  1940    os_no_e_addr_error	ld a,1ch
0015EB B7                  A  1941    					or a
0015EC C9                  A  1942    					ret
                           A  1943    			
0015ED 3E1D                A  1944    os_no_d_addr_error	ld a,1dh
0015EF B7                  A  1945    					or a
0015F0 C9                  A  1946    					ret
                           A  1947    				
0015F1 3E1E                A  1948    os_range_error		ld a,1eh
0015F3 B7                  A  1949    					or a
0015F4 C9                  A  1950    					ret
                           A  1951    			
0015F5 3E1F                A  1952    os_no_args_error	ld a,1fh
0015F7 B7                  A  1953    					or a
0015F8 C9                  A  1954    					ret	
                           A  1955    
                           A  1956    ;----------------------------------------------
                           A  1957    
                           A  1958    ; Set xHL to address of zero terminated filenam
                           A  1959    ; RETURNS:	C:xDE  = File length
                           A  1960    ;    		HL     = Start cluster of file
                           A  1961    
0015F9 CC 72 15 00         A  1962    ext_find_file	call z,mbase_hl
                           A  1963    
0015FD CD 0D 51 00         A  1964    os_find_file	call fs_hl_to_filename
001601 CD AE 48 00         A  1965    				call fs_open_file_command		001605 38 02               A  1966    				jr c,os_fferr					001607 B7                  A  1967    				or a							001608 C9                  A  1968    				ret 		
                           A  1969    								
001609 47                  A  1970    os_fferr		ld b,a							00160A AF                  A  1971    				xor a			
00160B 4F                  A  1972    				ld c,a
00160C 0C                  A  1973    				inc c							00160D C9                  A  1974    				ret	
                           A  1975    
                           A  1976    ;----------------------------------------------
                           A  1977    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  41


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
00160E                     A  1978    os_set_load_length
                           A  1979    
00160E ED53 64 53 00       A  1980    				ld (fs_file_transfer_length),de
001613 BF                  A  1981    				cp a							001614 C9                  A  1982    				ret
                           A  1983    				
                           A  1984    ;----------------------------------------------
                           A  1985    
001615                     A  1986    ext_set_file_pointer
                           A  1987    
001615 79                  A  1988    				ld a,c
                           A  1989    				
001616                     A  1990    os_set_file_pointer
                           A  1991    
                           A  1992    ; Moves the 'start of file' pointer allowing ra
                           A  1993    ; Note: File pointer is reset by opening a file
                           A  1994    ; by normal read function.
                           A  1995    
001616 ED53 58 53 00       A  1996    				ld (fs_file_pointer),de			00161B 32 5B 53 00         A  1997    				ld (fs_file_pointer+3),a
00161F F5                  A  1998    				push af
001620 AF                  A  1999    				xor a
001621 32 8A 53 00         A  2000    				ld (fs_filepointer_valid),a		001625 F1                  A  2001    				pop af
001626 BF                  A  2002    				cp a							001627 C9                  A  2003    				ret
                           A  2004    				
                           A  2005    ;----------------------------------------------
                           A  2006    
                           A  2007    ; set xHL = load address 
                           A  2008    ; (Before calling this routine, call os_find_fi
                           A  2009    
001628                     A  2010    ext_read_bytes_from_file
                           A  2011    
001628 CC 72 15 00         A  2012    				call z,mbase_hl					                           A  2013    				
00162C                     A  2014    os_read_bytes_from_file
                           A  2015    
00162C 22 6D 53 00         A  2016    				ld (fs_ez80_address),hl			001630 CD F9 48 00         A  2017    				call fs_read_data_command
001634 38 D3               A  2018    				jr c,os_fferr
001636 B7                  A  2019    				or a
001637 C9                  A  2020    				ret
                           A  2021    
                           A  2022    ;----------------------------------------------
                           A  2023    
                           A  2024    ; Before calling, set xHL = address of zero ter
                           A  2025    
001638 CC 72 15 00         A  2026    ext_create_file	call z,mbase_hl
                           A  2027    
00163C CD 0D 51 00         A  2028    os_create_file	call fs_hl_to_filename
001640 CD AF 4B 00         A  2029    				call fs_create_file_command		Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  42


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
001644 DA 09 16 00         A  2030    				jp c,os_fferr					001648 B7                  A  2031    				or a
001649 C9                  A  2032    				ret
                           A  2033    
                           A  2034    ;----------------------------------------------
                           A  2035    
00164A                     A  2036    ext_write_bytes_to_file
                           A  2037    
00164A CC 72 15 00         A  2038    				call z,mbase_hl
00164E CC 83 15 00         A  2039    				call z,mbase_de
                           A  2040    
001652                     A  2041    os_write_bytes_to_file
                           A  2042    
                           A  2043    ; Before calling, set..
                           A  2044    
                           A  2045    ; xDE   = address to save data from
                           A  2046    ; xBC   = number of bytes to save
                           A  2047    ; xHL   = address of null-terminated ascii name
                           A  2048    
                           A  2049    ; On return:
                           A  2050    
                           A  2051    ; If zero flag NOT set, there was an error.
                           A  2052    ; If   A = $00, b = hardware error code
                           A  2053    ; Else A = File system error code
                           A  2054    
                           A  2055    ; NOTE:
                           A  2056    ; Will return 'file not found' if the file has 
                           A  2057    				
001652 ED43 64 53 00       A  2058    				ld (fs_file_transfer_length),bc
001657 ED53 6D 53 00       A  2059    				ld (fs_ez80_address),de	 	
00165C CD 0D 51 00         A  2060    				call fs_hl_to_filename
001660 CD E1 4B 00         A  2061    				call fs_write_bytes_to_file_com
001664 DA 09 16 00         A  2062    				jp c,os_fferr
001668 B7                  A  2063    				or a
001669 C9                  A  2064    				ret
                           A  2065    		
                           A  2066    		
                           A  2067    ;----------------------------------------------
                           A  2068    	
                           A  2069    
00166A                     A  2070    os_check_volume_format
                           A  2071    
00166A CD 0C 47 00         A  2072    				call fs_check_disk_format
00166E DA 09 16 00         A  2073    os_rffsc		jp c,os_fferr
001672 B7                  A  2074    				or a
001673 C9                  A  2075    				ret
                           A  2076    
                           A  2077    ;----------------------------------------------
                           A  2078    
                           A  2079    
001674 7B                  A  2080    ext_format		ld a,e
001675 CC 72 15 00         A  2081    				call z,mbase_hl					Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  43


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A  2082    
001679 E5                  A  2083    os_format		push hl							00167A CD 80 1A 00         A  2084    				call dev_to_driver_lookup
00167E E1                  A  2085    				pop hl
00167F 38 04               A  2086    				jr c,sdevok
001681 3ED0                A  2087    				ld a,0d0h						001683 B7                  A  2088    				or a
001684 C9                  A  2089    				ret
                           A  2090    
001685 F5                  A  2091    sdevok			push af				
001686 11 34 53 00         A  2092    				ld de,fs_sought_filename
00168A CD 1C 52 00         A  2093    				call fs_clear_filename
00168E 060B                A  2094    				ld b,11
001690 CD FE 11 00         A  2095    				call os_copy_ascii_run
001694 F1                  A  2096    				pop af
                           A  2097    				
001695 21 D6 5D 00         A  2098    				ld hl,current_driver
001699 46                  A  2099    				ld b,(hl)
00169A 77                  A  2100    				ld (hl),a
00169B C5                  A  2101    				push bc
00169C E5                  A  2102    				push hl
00169D CD 81 45 00         A  2103    				call fs_format_device_command
0016A1 E1                  A  2104    				pop hl
0016A2 C1                  A  2105    				pop bc
0016A3 70                  A  2106    				ld (hl),b
0016A4 18 C8               A  2107    				jr os_rffsc
                           A  2108    
                           A  2109    
                           A  2110    ;----------------------------------------------
                           A  2111    
                           A  2112    
0016A6 CC 72 15 00         A  2113    ext_make_dir	call z,mbase_hl					                           A  2114    
0016AA CD 0D 51 00         A  2115    os_make_dir		call fs_hl_to_filename
0016AE CD 27 4A 00         A  2116    				call fs_make_dir_command
0016B2 18 BA               A  2117    				jr os_rffsc
                           A  2118    
                           A  2119    
                           A  2120    ;----------------------------------------------
                           A  2121    
                           A  2122    
0016B4 CC 72 15 00         A  2123    ext_change_dir	call z,mbase_hl					                           A  2124    
0016B8 CD 0D 51 00         A  2125    os_change_dir	call fs_hl_to_filename
0016BC CD 5A 48 00         A  2126    				call fs_change_dir_command
0016C0 18 AC               A  2127    				jr os_rffsc
                           A  2128    				
                           A  2129    	
                           A  2130    ;----------------------------------------------
                           A  2131    	
                           A  2132    	
0016C2 CD 8B 48 00         A  2133    os_parent_dir	call fs_parent_dir_command
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  44


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
0016C6 18 A6               A  2134    				jr os_rffsc
                           A  2135    				
                           A  2136    
                           A  2137    ;----------------------------------------------
                           A  2138    
                           A  2139    	
0016C8 CD 7F 48 00         A  2140    os_root_dir		call fs_goto_root_dir_command
0016CC 18 A0               A  2141    				jr os_rffsc
                           A  2142    
                           A  2143    
                           A  2144    ;----------------------------------------------
                           A  2145    
                           A  2146    
0016CE CC 72 15 00         A  2147    ext_erase_file	call z,mbase_hl					                           A  2148    
0016D2 CD 0D 51 00         A  2149    os_erase_file	call fs_hl_to_filename
0016D6 CD 70 4D 00         A  2150    				call fs_erase_file_command
0016DA 18 92               A  2151    				jr os_rffsc
                           A  2152    	
                           A  2153    
                           A  2154    ;----------------------------------------------
                           A  2155    
                           A  2156    
0016DC                     A  2157    os_goto_first_dir_entry	
                           A  2158    
0016DC CD CB 4D 00         A  2159    				call fs_goto_first_dir_entry
0016E0 18 8C               A  2160    				jr os_rffsc
                           A  2161    
                           A  2162    
                           A  2163    ;----------------------------------------------
                           A  2164    
                           A  2165    
0016E2                     A  2166    os_get_dir_entry		
                           A  2167    
0016E2 CD E2 4D 00         A  2168    				call fs_get_dir_entry	
0016E6 18 86               A  2169    				jr os_rffsc
                           A  2170    
                           A  2171    
                           A  2172    ;----------------------------------------------
                           A  2173    
                           A  2174    
0016E8                     A  2175    os_goto_next_dir_entry	
                           A  2176    	
0016E8 CD 6F 4E 00         A  2177    				call fs_goto_next_dir_entry	
0016EC 18 80               A  2178    				jr os_rffsc
                           A  2179    
                           A  2180    
                           A  2181    ;----------------------------------------------
                           A  2182    
                           A  2183    
0016EE                     A  2184    os_get_current_dir_name
                           A  2185    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  45


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
0016EE CD D3 51 00         A  2186    				call fs_get_current_dir_name
0016F2 C3 6E 16 00         A  2187    				jr os_rffsc
                           A  2188    				
                           A  2189    
                           A  2190    ;----------------------------------------------
                           A  2191    
                           A  2192    
0016F6 CC 72 15 00         A  2193    ext_rename_file	call z,mbase_hl
0016FA CC 83 15 00         A  2194    				call z,mbase_de
                           A  2195    
0016FE D5                  A  2196    os_rename_file	push de
0016FF CD 07 51 00         A  2197    				call fs_hl_to_alt_filename		001703 E1                  A  2198    				pop hl				
001704 CD 0D 51 00         A  2199    				call fs_hl_to_filename	
001708 CD 87 4D 00         A  2200    				call fs_rename_command
00170C C3 6E 16 00         A  2201    				jr os_rffsc
                           A  2202    				
                           A  2203    
                           A  2204    ;----------------------------------------------
                           A  2205    
                           A  2206    
001710 CC 72 15 00         A  2207    ext_delete_dir	call z,mbase_hl					                           A  2208    
001714 CD 0D 51 00         A  2209    os_delete_dir	call fs_hl_to_filename
001718 CD 00 4B 00         A  2210    				call fs_delete_dir_command
00171C C3 6E 16 00         A  2211    				jp os_rffsc
                           A  2212    	
                           A  2213    	
                           A  2214    ;----- LOW LEVEL SECTOR ACCESS ETC FOR EXTERNAL
                           A  2215    
                           A  2216    
001720                     A  2217    ext_read_sector
001720 CD 6B 17 00         A  2218    				call ext_sector_access_preamble
001724 C0                  A  2219    				ret nz
001725 32 D6 5D 00         A  2220    				ld (current_driver),a
001729 CD AA 52 00         A  2221    				call fs_read_sector
00172D 20 11               A  2222    				jr nz,sect_done
00172F 38 0F               A  2223    				jr c,sect_done
001731 21 1D 65 00         A  2224    				ld hl,sector_buffer
001735 ED5B E6 5D 00       A  2225    				ld de,(sector_rd_wr_addr)
00173A 01000200            A  2226    				ld bc,512
00173E EDB0                A  2227    				ldir			
001740 F5                  A  2228    sect_done		push af
001741 3A 0C 5F 00         A  2229    				ld a,(sys_driver_backup)		001745 32 D6 5D 00         A  2230    				ld (current_driver),a
001749 F1                  A  2231    				pop af
00174A C3 6E 16 00         A  2232    				jp os_rffsc
                           A  2233    				
                           A  2234    
00174E                     A  2235    ext_write_sector
                           A  2236    			
00174E CD 6B 17 00         A  2237    				call ext_sector_access_preamble
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  46


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
001752 C0                  A  2238    				ret nz
001753 32 D6 5D 00         A  2239    				ld (current_driver),a
001757 2A E6 5D 00         A  2240    				ld hl,(sector_rd_wr_addr)
00175B 11 1D 65 00         A  2241    				ld de,sector_buffer
00175F 01000200            A  2242    				ld bc,512
001763 EDB0                A  2243    				ldir			
001765 CD C2 52 00         A  2244    				call fs_write_sector
001769 18 D5               A  2245    				jr sect_done
                           A  2246    
                           A  2247    
00176B                     A  2248    ext_sector_access_preamble
                           A  2249    
00176B CC 72 15 00         A  2250    				call z,mbase_hl
00176F 22 E6 5D 00         A  2251    				ld (sector_rd_wr_addr),hl
                           A  2252    				
001773 78                  A  2253    				ld a,b
001774 F5                  A  2254    				push af							001775 DD21 AC 5F 00       A  2255    				ld ix,sector_lba0
00177A DD1F00              A  2256    				ld (ix),de						00177D DD7103              A  2257    				ld (ix+3),c
001780 CD 80 1A 00         A  2258    				call dev_to_driver_lookup		001784 E5                  A  2259    				push hl
001785 DDE1                A  2260    				pop ix
001787 2A AC 5F 00         A  2261    				ld hl,(sector_lba0)				00178B 3A AF 5F 00         A  2262    				ld a,(sector_lba3)				00178F DD0701              A  2263    				ld bc,(ix+1)					001792 B7                  A  2264    				or a							001793 ED42                A  2265    				sbc hl,bc
001795 DD9E04              A  2266    				sbc a,(ix+4)
001798 38 05               A  2267    				jr c,range_ok
00179A F1                  A  2268    				pop af
00179B 3ED5                A  2269    				ld a,0d5h						00179D B7                  A  2270    				or a							00179E C9                  A  2271    				ret
                           A  2272    	
00179F 3A D6 5D 00         A  2273    range_ok		ld a,(current_driver)
0017A3 32 0C 5F 00         A  2274    				ld (sys_driver_backup),a
0017A7 F1                  A  2275    				pop af							0017A8 CD 80 1A 00         A  2276    				call dev_to_driver_lookup
0017AC 30 02               A  2277    				jr nc,bad_dev
0017AE BF                  A  2278    os_null			cp a							0017AF C9                  A  2279    				ret
                           A  2280    					
0017B0 3ED0                A  2281    bad_dev			ld a,0d0h						0017B2 B7                  A  2282    				or a							0017B3 C9                  A  2283    				ret	
                           A  2284    			
                           A  2285    
                           A  2286    ;----------------------------------------------
                           A  2287    
                           A  2288    
0017B4                     A  2289    os_get_device_info
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  47


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A  2290    
0017B4 21 87 5E 00         A  2291    				ld hl,host_device_hardware_info
0017B8 11 E9 5D 00         A  2292    				ld de,driver_table
0017BC 3A D7 5D 00         A  2293    				ld a,(device_count)
0017C0 47                  A  2294    				ld b,a
0017C1 3A D6 5D 00         A  2295    				ld a,(current_driver)
0017C5 BF                  A  2296    				cp a
0017C6 C9                  A  2297    				ret
                           A  2298    
                           A  2299    
                           A  2300    
                           A  2301    
0017C7                     A  2302    os_get_volume_info
                           A  2303    
0017C7 21 07 5E 00         A  2304    				ld hl,volume_mount_list	
0017CB 3A D8 5D 00         A  2305    				ld a,(volume_count)
0017CF 47                  A  2306    				ld b,a
0017D0 3A D5 5D 00         A  2307    				ld a,(current_volume)
0017D4 C9                  A  2308    				ret
                           A  2309    				
                           A  2310    		
                           A  2311    ;----------------------------------------------
                           A  2312    
                           A  2313    
0017D5                     A  2314    ext_serial_get_header
                           A  2315    
0017D5 CC 72 15 00         A  2316    				call z,mbase_hl
0017D9 7B                  A  2317    				ld a,e
0017DA CD 14 43 00         A  2318    				call serial_get_header
0017DE C9                  A  2319    				ret
                           A  2320    				
                           A  2321    				
0017DF                     A  2322    ext_serial_receive_file
                           A  2323    				
0017DF CC 72 15 00         A  2324    				call z,mbase_hl
0017E3 CD AF 43 00         A  2325    				call serial_receive_file
0017E7 C9                  A  2326    				ret
                           A  2327    				
                           A  2328    	
0017E8                     A  2329    ext_serial_send_file
                           A  2330    
0017E8 CC 72 15 00         A  2331    				call z,mbase_hl
0017EC CC 96 15 00         A  2332    				call z,mbase_ix				
0017F0 CD 78 44 00         A  2333    				call serial_send_file
0017F4 C9                  A  2334    				ret
                           A  2335    
                           A  2336    
0017F5                     A  2337    ext_serial_tx
0017F5 7B                  A  2338    				ld a,e
0017F6 CD 87 3A 00         A  2339    				call send_serial_byte
0017FA AF                  A  2340    				xor a							0017FB C9                  A  2341    				ret
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  48


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A  2342    
                           A  2343    
0017FC                     A  2344    ext_serial_rx
0017FC 7B                  A  2345    				ld a,e
0017FD 32 A5 5D 00         A  2346    				ld (serial_timeout),a
001801 CD 4C 3A 00         A  2347    				call receive_serial_byte
001805 C9                  A  2348    				ret
                           A  2349    				
                           A  2350    
                           A  2351    ;----------------------------------------------
                           A  2352    
001806                     A  2353    ext_mount_volumes
                           A  2354    
001806 7B                  A  2355    				ld a,e
                           A  2356    
001807                     A  2357    os_mount_volumes
                           A  2358    				
001807 32 0D 5F 00         A  2359    				ld (os_quiet_mode),a			                           A  2360    				
00180B 21 A3 54 00         A  2361    				ld hl,storage_txt
00180F CD 20 0F 00         A  2362    				call os_print_string_cond
001813 CD 3B 18 00         A  2363    				call mount_go
001817 AF                  A  2364    				xor a
001818 32 D5 5D 00         A  2365    tvloop			ld (current_volume),a
00181C CD 96 1A 00         A  2366    				call os_change_volume			001820 C8                  A  2367    				ret z							001821 3A D5 5D 00         A  2368    				ld a,(current_volume)			001825 3C                  A  2369    				inc a
001826 FE08                A  2370    				cp max_volumes
001828 20 EE               A  2371    				jr nz,tvloop
00182A 3A D7 5D 00         A  2372    				ld a,(device_count)
00182E B7                  A  2373    				or a
00182F 20 08               A  2374    				jr nz,mfsdevs
001831 21 BF 5B 00         A  2375    				ld hl,none_found_msg
001835 CD EA 13 00         A  2376    				call os_show_packed_text_cond
001839 AF                  A  2377    mfsdevs			xor a
00183A C9                  A  2378    				ret
                           A  2379    
                           A  2380    
                           A  2381    
00183B 21 07 5E 00         A  2382    mount_go		ld hl,volume_mount_list			00183F 01800000            A  2383    				ld bc,max_volumes*16
001843 AF                  A  2384    clrdl_lp		xor a
001844 CD 4B 15 00         A  2385    				call os_bchl_memfill
                           A  2386    								
001848 21 EF 5D 00         A  2387    				ld hl,volume_dir_clusters		00184C 01180000            A  2388    				ld bc,max_volumes*3		
001850 AF                  A  2389    				xor a	
001851 CD 4B 15 00         A  2390    				call os_bchl_memfill	
                           A  2391    			
001855 11 87 5E 00         A  2392    				ld de,host_device_hardware_info
001859 ED53 07 5F 00       A  2393    				ld (dhwn_temp_pointer),de
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  49


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A  2394    				
00185E FD21 07 5E 00       A  2395    				ld iy,volume_mount_list
001863 AF                  A  2396    				xor a
001864 32 D8 5D 00         A  2397    				ld (volume_count),a
001868 32 D7 5D 00         A  2398    				ld (device_count),a
00186C 32 D6 5D 00         A  2399    mnt_loop		ld (current_driver),a			001870 CD 0C 1A 00         A  2400    				call locate_driver_base			001874 21000000            A  2401    				ld hl,0
001878 AF                  A  2402    				xor a
001879 ED5A                A  2403    				adc hl,de
00187B C8                  A  2404    				ret z							00187C EB                  A  2405    				ex de,hl						00187D FDE5                A  2406    				push iy
00187F CD 90 18 00         A  2407    				call find_dev					001883 FDE1                A  2408    				pop iy							001885 DC 91 18 00         A  2409    				call c,got_dev		
001889 3A D6 5D 00         A  2410    nxt_drv			ld a,(current_driver)			00188D 3C                  A  2411    				inc a
00188E 18 DC               A  2412    				jr mnt_loop
                           A  2413    
                           A  2414    				
001890 E9                  A  2415    find_dev		jp (hl)
                           A  2416    			
                           A  2417    			
001891 E5                  A  2418    got_dev			push hl							001892 D5                  A  2419    				push de							001893 C5                  A  2420    				push bc
001894 CD B3 13 00         A  2421    				call os_new_line_cond			001898 015B0100            A  2422    				ld bc,015bh
00189C CD 1D 1A 00         A  2423    				call os_print_multiple_chars_co
0018A0 3A D6 5D 00         A  2424    				ld a,(current_driver)
0018A4 CD 0C 1A 00         A  2425    				call locate_driver_base
0018A8 210C0000            A  2426    				ld hl,0ch
0018AC 19                  A  2427    				add hl,de
0018AD CD 20 0F 00         A  2428    				call os_print_string_cond		0018B1 015D0100            A  2429    				ld bc,015dh
0018B5 CD 1D 1A 00         A  2430    				call os_print_multiple_chars_co
0018B9 C1                  A  2431    				pop bc
0018BA D1                  A  2432    				pop de
0018BB AF                  A  2433    				xor a
0018BC 32 0B 5F 00         A  2434    				ld (vols_on_device_temp),a
                           A  2435    				
0018C0 21 D7 5D 00         A  2436    				ld hl,device_count
0018C4 34                  A  2437    				inc (hl)						0018C5 3A D6 5D 00         A  2438    				ld a,(current_driver)
0018C9 2A 07 5F 00         A  2439    				ld hl,(dhwn_temp_pointer)	
0018CD 77                  A  2440    				ld (hl),a
0018CE 23                  A  2441    				inc hl
0018CF 73                  A  2442    				ld (hl),e						0018D0 FD7304              A  2443    				ld (iy+4),e						0018D3 23                  A  2444    				inc hl							0018D4 72                  A  2445    				ld (hl),d
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  50


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
0018D5 FD7205              A  2446    				ld (iy+5),d
0018D8 23                  A  2447    				inc hl
0018D9 71                  A  2448    				ld (hl),c			
0018DA FD7106              A  2449    				ld (iy+6),c
0018DD 23                  A  2450    				inc hl
0018DE 70                  A  2451    				ld (hl),b						0018DF 23                  A  2452    				inc hl
0018E0 D1                  A  2453    				pop de
0018E1 EB                  A  2454    				ex de,hl
0018E2 01160000            A  2455    				ld bc,22
0018E6 EDB0                A  2456    				ldir							0018E8 AF                  A  2457    				xor a
0018E9 0605                A  2458    				ld b,5		
0018EB 12                  A  2459    clrrode			ld (de),a						0018EC 13                  A  2460    				inc de
0018ED 10 FC               A  2461    				djnz clrrode
0018EF ED53 07 5F 00       A  2462    				ld (dhwn_temp_pointer),de		                           A  2463    					
0018F4 AF                  A  2464    				xor a							0018F5 FDE5                A  2465    fnxtpart		push iy
0018F7 CD AA 46 00         A  2466    				call fs_get_partition_info
0018FB FDE1                A  2467    				pop iy
0018FD 38 31               A  2468    				jr c,nxt_dev					0018FF FECE                A  2469    				cp 0ceh							001901 28 2D               A  2470    				jr z,nxt_dev
001903 F5                  A  2471    				push af
001904 FD360001            A  2472    				ld (iy),1						001908 3A D6 5D 00         A  2473    				ld a,(current_driver)
00190C FD7701              A  2474    				ld (iy+1),a						00190F 3A 0A 5F 00         A  2475    				ld a,(partition_temp)	
001913 FD7707              A  2476    				ld (iy+7),a						001916 F1                  A  2477    				pop af
001917 B7                  A  2478    				or a
001918 28 35               A  2479    				jr z,dev_mbr
00191A AF                  A  2480    				xor a
00191B FD7708              A  2481    				ld (iy+8),a						00191E FD7709              A  2482    				ld (iy+9),a						001921 FD770A              A  2483    				ld (iy+10),a					001924 FD770B              A  2484    				ld (iy+11),a
001927 CD 9B 19 00         A  2485    				call show_vol_info
00192B CD 8C 19 00         A  2486    				call test_max_vol
00192F C8                  A  2487    				ret z							                           A  2488    			
001930 3A 0B 5F 00         A  2489    nxt_dev			ld a,(vols_on_device_temp)		001934 B7                  A  2490    				or a
001935 C0                  A  2491    				ret nz		
001936 CD ED 19 00         A  2492    				call test_quiet_mode
00193A 20 06               A  2493    				jr nz,skp_cu
00193C 3E0A                A  2494    				ld a,10
00193E 32 B1 5F 00         A  2495    				ld (cursor_x),a
001942 21 BC 5B 00         A  2496    skp_cu			ld hl,no_vols_msg				001946 CD EA 13 00         A  2497    				call os_show_packed_text_cond
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  51


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
00194A CD B3 13 00         A  2498    				call os_new_line_cond
00194E C9                  A  2499    				ret
                           A  2500    				
                           A  2501    			
00194F 11040000            A  2502    dev_mbr			ld de,4
001953 19                  A  2503    				add hl,de
001954 7E                  A  2504    				ld a,(hl)						001955 B7                  A  2505    				or a
001956 C8                  A  2506    				ret z							001957 19                  A  2507    				add hl,de
                           A  2508    				
001958 FDE5                A  2509    				push iy
00195A 0604                A  2510    				ld b,4
00195C 7E                  A  2511    sfmbrlp			ld a,(hl)						00195D FD7708              A  2512    				ld (iy+8),a
001960 23                  A  2513    				inc hl
001961 FD23                A  2514    				inc iy
001963 10 F7               A  2515    				djnz sfmbrlp
001965 FDE1                A  2516    				pop iy
001967 FDE5                A  2517    				push iy
001969 0603                A  2518    				ld b,3	
00196B 7E                  A  2519    nsivlp			ld a,(hl)
00196C FD7704              A  2520    				ld (iy+4),a						00196F 23                  A  2521    				inc hl
001970 FD23                A  2522    				inc iy
001972 10 F7               A  2523    				djnz nsivlp
001974 FDE1                A  2524    				pop iy
                           A  2525    				
001976 CD 9B 19 00         A  2526    				call show_vol_info
00197A CD 8C 19 00         A  2527    				call test_max_vol	
00197E C8                  A  2528    				ret z							00197F 3A 0A 5F 00         A  2529    				ld a,(partition_temp)
001983 3C                  A  2530    				inc a
001984 FE04                A  2531    				cp 4							001986 C2 F5 18 00         A  2532    				jp nz,fnxtpart
00198A 18 A4               A  2533    				jr nxt_dev
                           A  2534    				
                           A  2535    
00198C                     A  2536    test_max_vol
                           A  2537    			
00198C 11100000            A  2538    				ld de,16
001990 FD19                A  2539    				add iy,de			
001992 21 D8 5D 00         A  2540    				ld hl,volume_count
001996 34                  A  2541    				inc (hl)
001997 7E                  A  2542    				ld a,(hl)
001998 FE08                A  2543    				cp max_volumes
00199A C9                  A  2544    				ret
                           A  2545    			
                           A  2546    			
00199B                     A  2547    show_vol_info
                           A  2548    				
00199B CD ED 19 00         A  2549    				call test_quiet_mode
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  52


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
00199F 20 06               A  2550    				jr nz,skp_cm2
0019A1 3E09                A  2551    				ld a,9			
0019A3 32 B1 5F 00         A  2552    				ld (cursor_x),a
0019A7 3A D8 5D 00         A  2553    skp_cm2			ld a,(volume_count)
0019AB F5                  A  2554    				push af
0019AC C630                A  2555    				add a,30h		
0019AE 32 DD 5D 00         A  2556    				ld (vol_txt+4),a	
0019B2 21 D9 5D 00         A  2557    				ld hl,vol_txt
0019B6 CD 20 0F 00         A  2558    				call os_print_string_cond		0019BA 21 0B 5F 00         A  2559    				ld hl,vols_on_device_temp
0019BE CBC6                A  2560    				set 0,(hl)						                           A  2561    			
0019C0 F1                  A  2562    				pop af
0019C1 FDE5                A  2563    				push iy
0019C3 CD 96 1A 00         A  2564    				call os_change_volume			0019C7 28 0A               A  2565    				jr z,vform_ok					0019C9 21 6C 5B 00         A  2566    svi_fe			ld hl,format_err_msg		
0019CD CD EA 13 00         A  2567    svi_pem			call os_show_packed_text_cond	0019D1 18 0D               A  2568    				jr skpsvl
                           A  2569    			
0019D3 CD C6 4E 00         A  2570    vform_ok		call fs_get_volume_label
0019D7 38 0E               A  2571    				jr c,svi_hwe
0019D9 B7                  A  2572    				or a
0019DA 20 ED               A  2573    				jr nz,svi_fe
0019DC CD 20 0F 00         A  2574    				call os_print_string_cond		                           A  2575    			
0019E0 CD B3 13 00         A  2576    skpsvl			call os_new_line_cond
0019E4 FDE1                A  2577    				pop iy
0019E6 C9                  A  2578    				ret
                           A  2579    				
0019E7 21 B6 59 00         A  2580    svi_hwe			ld hl,disk_err_msg
0019EB 18 E0               A  2581    				jr svi_pem
                           A  2582    			
                           A  2583    			
0019ED                     A  2584    test_quiet_mode
                           A  2585    			
0019ED 3A 0D 5F 00         A  2586    				ld a,(os_quiet_mode)
0019F1 B7                  A  2587    				or a
0019F2 C9                  A  2588    				ret
                           A  2589    
                           A  2590    ;----------------------------------------------
                           A  2591    
                           A  2592    
0019F3                     A  2593    show_dev_driver_name
                           A  2594    	
                           A  2595    	
0019F3 CD 0C 1A 00         A  2596    				call locate_driver_base			0019F7 EB                  A  2597    				ex de,hl
0019F8 110C0000            A  2598    				ld de,0ch
0019FC 19                  A  2599    				add hl,de
0019FD CD 25 0F 00         A  2600    				call os_print_string			001A01 C5                  A  2601    				push bc
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  53


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
001A02 01200100            A  2602    				ld bc,0120h
001A06 CD 22 1A 00         A  2603    				call os_print_multiple_chars	001A0A C1                  A  2604    				pop bc
001A0B C9                  A  2605    				ret
                           A  2606    
                           A  2607    
001A0C                     A  2608    locate_driver_base
                           A  2609    
001A0C E5                  A  2610    				push hl							001A0D 11030000            A  2611    				ld de,3							001A11 57                  A  2612    				ld d,a
001A12 ED5C                A  2613    				mlt de
001A14 21 E9 5D 00         A  2614    				ld hl,driver_table
001A18 19                  A  2615    				add hl,de
001A19 ED17                A  2616    				ld de,(hl)
001A1B E1                  A  2617    				pop hl
001A1C C9                  A  2618    				ret
                           A  2619    				
                           A  2620    		
                           A  2621    ;----------------------------------------------
                           A  2622    
001A1D                     A  2623    os_print_multiple_chars_cond
                           A  2624    
001A1D CD ED 19 00         A  2625    				call test_quiet_mode
001A21 C0                  A  2626    				ret nz
                           A  2627    			
001A22                     A  2628    os_print_multiple_chars
                           A  2629    
                           A  2630    ;c = char
                           A  2631    ;b = count
001A22 C5                  A  2632    				push bc
001A23 E5                  A  2633    				push hl
001A24 79                  A  2634    				ld a,c
001A25 21 1E 55 00         A  2635    				ld hl,rep_char_txt
001A29 77                  A  2636    				ld (hl),a
001A2A E5                  A  2637    pmch_lp			push hl
001A2B CD 25 0F 00         A  2638    				call os_print_string
001A2F E1                  A  2639    				pop hl
001A30 10 F8               A  2640    				djnz pmch_lp
001A32 E1                  A  2641    				pop hl
001A33 C1                  A  2642    				pop bc
001A34 C9                  A  2643    				ret
                           A  2644    
                           A  2645    ;----------------------------------------------
                           A  2646    
                           A  2647    
001A35 7B                  A  2648    ext_plot_char	ld a,e
001A36 C3 B7 3C 00         A  2649    				jp hwsc_plot_char
                           A  2650    				
                           A  2651    
                           A  2652    ;----------------------------------------------
                           A  2653    ; Some file system related routines 
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  54


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
                           A  2654    ;----------------------------------------------
                           A  2655    
                           A  2656    
001A3A                     A  2657    fs_get_dir_cluster
                           A  2658    
                           A  2659    
001A3A F5                  A  2660    				push af							001A3B E5                  A  2661    				push hl			
001A3C CD 52 1A 00         A  2662    				call fs_get_dir_cluster_address
001A40 ED17                A  2663    				ld de,(hl)
001A42 E1                  A  2664    dclopdone		pop hl
001A43 F1                  A  2665    				pop af
001A44 BF                  A  2666    				cp a							001A45 C9                  A  2667    				ret
                           A  2668    				
                           A  2669    
                           A  2670    
                           A  2671    
                           A  2672    
001A46                     A  2673    fs_update_dir_cluster
                           A  2674    
001A46 F5                  A  2675    				push af							001A47 E5                  A  2676    				push hl			
001A48 D5                  A  2677    				push de			
001A49 CD 52 1A 00         A  2678    				call fs_get_dir_cluster_address
001A4D D1                  A  2679    				pop de
001A4E ED1F                A  2680    				ld (hl),de
001A50 18 F0               A  2681    				jr dclopdone
                           A  2682    			
                           A  2683    
                           A  2684    
                           A  2685    
                           A  2686    
001A52                     A  2687    fs_get_dir_cluster_address
                           A  2688    
001A52 21 EF 5D 00         A  2689    				ld hl,volume_dir_clusters		001A56 3A D5 5D 00         A  2690    				ld a,(current_volume)	
001A5A 11030000            A  2691    				ld de,3
001A5E 57                  A  2692    				ld d,a
001A5F ED5C                A  2693    				mlt de
001A61 19                  A  2694    				add hl,de
001A62 C9                  A  2695    				ret
                           A  2696    				
                           A  2697    	
                           A  2698    
                           A  2699    	
                           A  2700    	
001A63                     A  2701    fs_get_total_sectors
                           A  2702    
                           A  2703    
001A63 F5                  A  2704    				push af
001A64 E5                  A  2705    				push hl							Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  55


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
001A65 CD 74 1A 00         A  2706    				call fs_calc_volume_offset	
001A69 21 0B 5E 00         A  2707    				ld hl,volume_mount_list+4
001A6D 19                  A  2708    				add hl,de
001A6E ED17                A  2709    				ld de,(hl)
001A70 E1                  A  2710    				pop hl
001A71 F1                  A  2711    				pop af
001A72 BF                  A  2712    				cp a							001A73 C9                  A  2713    				ret
                           A  2714    
                           A  2715    
                           A  2716    
                           A  2717    
                           A  2718    
001A74                     A  2719    fs_calc_volume_offset
                           A  2720    
001A74 3A D5 5D 00         A  2721    				ld a,(current_volume)			001A78 11100000            A  2722    calc_vol		ld de,16
001A7C 57                  A  2723    				ld d,a
001A7D ED5C                A  2724    				mlt de
001A7F C9                  A  2725    				ret
                           A  2726    
                           A  2727    
                           A  2728    
                           A  2729    
                           A  2730    
001A80                     A  2731    dev_to_driver_lookup
                           A  2732    
001A80 21 D7 5D 00         A  2733    				ld hl,device_count				001A84 BE                  A  2734    				cp (hl)							001A85 D0                  A  2735    				ret nc
001A86 11200000            A  2736    				ld de,32						001A8A 57                  A  2737    				ld d,a
001A8B ED5C                A  2738    				mlt de
001A8D 21 87 5E 00         A  2739    				ld hl,host_device_hardware_info
001A91 19                  A  2740    				add hl,de
001A92 7E                  A  2741    				ld a,(hl)
001A93 37                  A  2742    				scf
001A94 C9                  A  2743    				ret
                           A  2744    				
                           A  2745    
                           A  2746    
001A95                     A  2747    ext_change_volume
                           A  2748    
001A95 7B                  A  2749    				ld a,e
                           A  2750    
001A96                     A  2751    os_change_volume
                           A  2752    
001A96 47                  A  2753    				ld b,a							001A97 FE08                A  2754    				cp max_volumes		
001A99 30 23               A  2755    				jr nc,fs_ccv2					                           A  2756    			
001A9B 3A D5 5D 00         A  2757    				ld a,(current_volume)			Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  56


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
001A9F F5                  A  2758    				push af
001AA0 78                  A  2759    				ld a,b
001AA1 32 D5 5D 00         A  2760    				ld (current_volume),a			001AA5 CD C2 1A 00         A  2761    				call fs_set_driver_for_volume	                           A  2762    				
001AA9 CD 0C 47 00         A  2763    				call fs_check_disk_format		001AAD 38 06               A  2764    				jr c,fs_cant_chg_vols	
001AAF B7                  A  2765    				or a
001AB0 20 03               A  2766    				jr nz,fs_cant_chg_vols
001AB2 F1                  A  2767    				pop af							001AB3 AF                  A  2768    				xor a							001AB4 C9                  A  2769    				ret
                           A  2770    
                           A  2771    
001AB5                     A  2772    fs_cant_chg_vols
                           A  2773    			
001AB5 F1                  A  2774    				pop af
001AB6 32 D5 5D 00         A  2775    				ld (current_volume),a			001ABA CD C2 1A 00         A  2776    				call fs_set_driver_for_volume	                           A  2777    				
001ABE 3ECF                A  2778    fs_ccv2			ld a,0cfh						001AC0 B7                  A  2779    				or a
001AC1 C9                  A  2780    				ret
                           A  2781    					
                           A  2782    	
001AC2                     A  2783    fs_set_driver_for_volume
                           A  2784    
001AC2 CD 74 1A 00         A  2785    				call fs_calc_volume_offset		001AC6 21 08 5E 00         A  2786    				ld hl,volume_mount_list+1
001ACA 19                  A  2787    				add hl,de
001ACB 7E                  A  2788    				ld a,(hl)
001ACC 32 D6 5D 00         A  2789    				ld (current_driver),a
001AD0 C9                  A  2790    				ret
                           A  2791    
                           A  2792    
                           A  2793    ;----------------------------------------------
                           A  2794    
001AD1                     A  2795    ext_file_sector_list
                           A  2796    
                           A  2797    ;Input HL = cluster, E = sector offset
                           A  2798    
                           A  2799    ;Output HL = new cluster, E = new sector number
                           A  2800    ;       IX = address of LBA0 LSB of sector (int
                           A  2801    
                           A  2802    				
001AD1 3A 1D 53 00         A  2803    				ld a,(fs_cluster_size)
001AD5 BB                  A  2804    				cp e
001AD6 20 0A               A  2805    				jr nz,fsl_sc
001AD8 CD 52 51 00         A  2806    				call get_fat_entry_for_cluster
001ADC DA 09 16 00         A  2807    				jp c,os_fferr
001AE0 1E00                A  2808    				ld e,0
001AE2 CD 29 52 00         A  2809    fsl_sc			call cluster_and_offset_to_lba
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  57


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
001AE6 1C                  A  2810    				inc e
001AE7 DD21 AC 5F 00       A  2811    fsl_done		ld ix,sector_lba0
001AEC BF                  A  2812    				cp a							001AED C9                  A  2813    				ret
                           A  2814    				
                           A  2815    ;----------------------------------------------
                           A  2816    
                           A  2817    
001AEE E5                  A  2818    os_count_chars	push hl							001AEF 01000000            A  2819    				ld bc,0
001AF3 7E                  A  2820    cch_lp			ld a,(hl)
001AF4 B7                  A  2821    				or a
001AF5 28 04               A  2822    				jr z,cch_end
001AF7 23                  A  2823    				inc hl
001AF8 03                  A  2824    				inc bc
001AF9 18 F8               A  2825    				jr cch_lp
001AFB E1                  A  2826    cch_end			pop hl
001AFC C9                  A  2827    				ret
                           A  2828    				
                           A  2829    			
                           A  2830    ;----------------------------------------------
                           A  2831    ; Environment variable code V0.01
                           A  2832    ;----------------------------------------------
                           A  2833    
       00000100            A  2834    envar_buffer_size equ 256
                           A  2835    
                           A  2836    ;----------------------------------------------
                           A  2837    
001AFD                     A  2838    ext_get_envar
001AFD CC 72 15 00         A  2839    				call z,mbase_hl
                           A  2840    
001B01                     A  2841    os_get_envar
                           A  2842    
                           A  2843    ;Set: 		HL = name of required variable
                           A  2844    ;Returns:	ZF Set: DE = address of variable's 
                           A  2845    ;        	ZF Not Set: Couldn't find variable
                           A  2846    				
001B01 DD21 30 61 00       A  2847    				ld ix,envar_list-1
001B06 CD EE 1A 00         A  2848    env_fname		call os_count_chars				001B0A 78                  A  2849    				ld a,b
001B0B B1                  A  2850    				or c
001B0C 28 27               A  2851    				jr z,env_bad
                           A  2852    								
001B0E ED1201              A  2853    env_cname		lea de,ix+1
001B11 1A                  A  2854    				ld a,(de)
001B12 FEFF                A  2855    				cp 0ffh
001B14 28 1F               A  2856    				jr z,env_bad
001B16 C5                  A  2857    				push bc
001B17 41                  A  2858    				ld b,c
001B18 CD DF 11 00         A  2859    				call os_compare_strings
001B1C C1                  A  2860    				pop bc
001B1D 20 06               A  2861    				jr nz,env_nomatch
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  58


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
001B1F 03                  A  2862    				inc bc							001B20 EB                  A  2863    				ex de,hl
001B21 09                  A  2864    				add hl,bc
001B22 EB                  A  2865    				ex de,hl						001B23 AF                  A  2866    				xor a
001B24 C9                  A  2867    				ret			
                           A  2868    				
001B25 DD23                A  2869    env_nomatch		inc ix							001B27 CD CD 1B 00         A  2870    				call check_envar_bounds
001B2B 20 08               A  2871    				jr nz,env_bad
001B2D DD7E00              A  2872    				ld a,(ix)
001B30 B7                  A  2873    				or a
001B31 28 DB               A  2874    				jr z,env_cname
001B33 18 F0               A  2875    				jr env_nomatch
                           A  2876    
001B35 3E82                A  2877    env_bad			ld a,82h						001B37 B7                  A  2878    				or a
001B38 C9                  A  2879    				ret	
                           A  2880    				
                           A  2881    ;----------------------------------------------
                           A  2882    
001B39                     A  2883    ext_set_envar
                           A  2884    
                           A  2885    ;HL = addr of variable name (zero terminated)
                           A  2886    ;DE = addr of data for variable (zero terminate
                           A  2887    
                           A  2888    ;Returns:
                           A  2889    ;ZF = Set: OK
                           A  2890    ;ZF = Not Set: No enough space for new variable
                           A  2891    		
001B39 CC 72 15 00         A  2892    				call z,mbase_hl
001B3D CC 83 15 00         A  2893    				call z,mbase_de
                           A  2894    
001B41 7E                  A  2895    os_set_envar	ld a,(hl)						001B42 B7                  A  2896    				or a
001B43 28 F0               A  2897    				jr z,env_bad
001B45 1A                  A  2898    				ld a,(de)
001B46 B7                  A  2899    				or a
001B47 28 EC               A  2900    				jr z,env_bad
                           A  2901    
001B49 E5                  A  2902    				push hl
001B4A D5                  A  2903    				push de
001B4B CD 97 1B 00         A  2904    				call os_delete_envar			001B4F D1                  A  2905    				pop de
001B50 E1                  A  2906    				pop hl
                           A  2907    				
001B51 DD2A 3B 62 00       A  2908    				ld ix,(envar_top_loc)			001B56 CD CD 1B 00         A  2909    env_enlp		call check_envar_bounds
001B5A 20 D9               A  2910    				jr nz,env_bad
001B5C 7E                  A  2911    				ld a,(hl)						001B5D DD7700              A  2912    				ld (ix),a
001B60 B7                  A  2913    				or a
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  59


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
001B61 28 05               A  2914    				jr z,env_ndone
001B63 23                  A  2915    				inc hl
001B64 DD23                A  2916    				inc ix
001B66 18 EE               A  2917    				jr env_enlp
                           A  2918    				
001B68 CD CD 1B 00         A  2919    env_ndone		call check_envar_bounds			001B6C 20 C7               A  2920    				jr nz,env_bad
001B6E DD36003D            A  2921    				ld (ix),'='
001B72 DD23                A  2922    				inc ix
                           A  2923    
001B74 CD CD 1B 00         A  2924    env_evlp		call check_envar_bounds			001B78 20 BB               A  2925    				jr nz,env_bad
001B7A 1A                  A  2926    				ld a,(de)
001B7B DD7700              A  2927    				ld (ix),a
001B7E B7                  A  2928    				or a
001B7F 28 05               A  2929    				jr z,env_vdone
001B81 13                  A  2930    				inc de
001B82 DD23                A  2931    				inc ix
001B84 18 EE               A  2932    				jr env_evlp
                           A  2933    
001B86 DD23                A  2934    env_vdone		inc ix
001B88 DD3600FF            A  2935    				ld (ix),0ffh
001B8C DD22 3B 62 00       A  2936    				ld (envar_top_loc),ix			001B91 AF                  A  2937    				xor a
001B92 C9                  A  2938    				ret
                           A  2939    
                           A  2940    	
                           A  2941    ;----------------------------------------------
                           A  2942    
001B93                     A  2943    ext_delete_envar
                           A  2944    
001B93 CC 72 15 00         A  2945    				call z,mbase_hl
                           A  2946    
001B97                     A  2947    os_delete_envar
                           A  2948    
                           A  2949    ;HL = name of required variable (null terminate
                           A  2950    ;ZF = Set: OK
                           A  2951    ;ZF = Not Set: Didnt find named variable
                           A  2952    
                           A  2953    
001B97 CD 01 1B 00         A  2954    				call os_get_envar				001B9B C0                  A  2955    				ret nz
                           A  2956    				
001B9C D5                  A  2957    				push de
001B9D E1                  A  2958    				pop hl
001B9E AF                  A  2959    				xor a
001B9F ED42                A  2960    				sbc hl,bc						                           A  2961    				
001BA1 13                  A  2962    env_fnxt		inc de							001BA2 D5                  A  2963    				push de
001BA3 DDE1                A  2964    				pop ix
001BA5 CD CD 1B 00         A  2965    				call check_envar_bounds
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  60


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
001BA9 20 8A               A  2966    				jr nz,env_bad
001BAB 1A                  A  2967    				ld a,(de)
001BAC B7                  A  2968    				or a
001BAD 20 F2               A  2969    				jr nz,env_fnxt
                           A  2970    
001BAF 13                  A  2971    env_gnxt		inc de							001BB0 EB                  A  2972    				ex de,hl
001BB1 7E                  A  2973    env_collp		ld a,(hl)
001BB2 12                  A  2974    				ld (de),a						001BB3 FEFF                A  2975    				cp 0ffh
001BB5 28 0F               A  2976    				jr z,env_clspd					001BB7 E5                  A  2977    				push hl
001BB8 DDE1                A  2978    				pop ix
001BBA CD CD 1B 00         A  2979    				call check_envar_bounds
001BBE C2 35 1B 00         A  2980    				jr nz,env_bad
001BC2 23                  A  2981    				inc hl
001BC3 13                  A  2982    				inc de
001BC4 18 EB               A  2983    				jr env_collp
                           A  2984    
001BC6 ED53 3B 62 00       A  2985    env_clspd		ld (envar_top_loc),de			001BCB AF                  A  2986    				xor a
001BCC C9                  A  2987    				ret
                           A  2988    				
                           A  2989    ;----------------------------------------------
                           A  2990    
001BCD                     A  2991    check_envar_bounds
                           A  2992    
001BCD C5                  A  2993    				push bc
001BCE E5                  A  2994    				push hl
001BCF DDE5                A  2995    				push ix
001BD1 E1                  A  2996    				pop hl
001BD2 01 32 62 00         A  2997    				ld bc,1+(envar_list+envar_buffe
001BD6 AF                  A  2998    				xor a
001BD7 ED42                A  2999    				sbc hl,bc
001BD9 38 05               A  3000    				jr c,env_bok
001BDB AF                  A  3001    				xor a
001BDC 3C                  A  3002    				inc a
001BDD E1                  A  3003    				pop hl
001BDE C1                  A  3004    				pop bc
001BDF C9                  A  3005    				ret
                           A  3006    
001BE0 AF                  A  3007    env_bok			xor a
001BE1 E1                  A  3008    				pop hl
001BE2 C1                  A  3009    				pop bc
001BE3 C9                  A  3010    				ret
                           A  3011    						
                           A  3012    ;----------------------------------------------
                           A  3013    
001BE4                     A  3014    os_get_keymap_location
                           A  3015    
001BE4 21 08 5C 00         A  3016    				ld hl,unshifted_keymap
001BE8 BF                  A  3017    				cp a							Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  61


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
001BE9 C9                  A  3018    				ret
                           A  3019    
                           A  3020    ;----------------------------------------------
                           A  3021    
001BEA                     A  3022    os_get_font_info
                           A  3023    
001BEA DD21 67 5D 00       A  3024    				ld ix,font_parameters
001BEF BF                  A  3025    				cp a
001BF0 C9                  A  3026    				ret
                           A  3027    
                           A  3028    ;==============================================
                           A  3029    ; Internal OS command routines
                           A  3030    ;==============================================
                           A  3031    
                           B     0    	include 'commands\c.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"c" - Copy memory command. V0.02 - ADL mode
                           B     3    ;----------------------------------------------
                           B     4    
001BF1                     B     5    os_cmd_c
                           B     6    
001BF1 CD 27 1C 00         B     7    				call get_start_and_end			                           B     8    				
001BF5 CD 50 1C 00         B     9    				call hexword_or_bust			001BF9 CA ED 15 00         B    10    				jp z,os_no_d_addr_error
001BFD ED53 BF 5F 00       B    11    				ld (copy_dest_address),de
                           B    12    						
001C02 CD 15 1C 00         B    13    				call test_mem_range				001C06 DA F1 15 00         B    14    				jp c,os_range_error				001C0A ED5B BF 5F 00       B    15    				ld de,(copy_dest_address)
001C0F EDB0                B    16    				ldir
                           B    17    
001C11 3E20                B    18    copy_done		ld a,020h						001C13 B7                  B    19    				or a
001C14 C9                  B    20    				ret
                           B    21    			
                           B    22    			
                           B    23    ;----------------------------------------------
                           B    24    			
001C15                     B    25    test_mem_range
                           B    26    			
                           B    27    ; on return:
                           B    28    ;
                           B    29    ; carry flag: Set = bad range
                           B    30    ; xBC = run length on return
                           B    31    ; xHL = start address
                           B    32    			
001C15 2A BC 5F 00         B    33    				ld hl,(cmdop_end_address)	
001C19 ED4B B9 5F 00       B    34    				ld bc,(cmdop_start_address)
001C1E C5                  B    35    				push bc
001C1F AF                  B    36    				xor a
001C20 ED42                B    37    				sbc hl,bc
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  62


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\c.asm
001C22 E5                  B    38    				push hl
001C23 C1                  B    39    				pop bc
001C24 03                  B    40    				inc bc
001C25 E1                  B    41    				pop hl
001C26 C9                  B    42    				ret
                           B    43    				
                           B    44    ;----------------------------------------------
                           B    45    			
001C27                     B    46    get_start_and_end
                           B    47    			
001C27 CD 9C 10 00         B    48    				call ascii_to_hexword			001C2B ED53 B9 5F 00       B    49    				ld (cmdop_start_address),de
001C30 23                  B    50    				inc hl
001C31 28 09               B    51    				jr z,st_addrok
001C33 E1                  B    52    				pop hl							001C34 FE82                B    53    				cp 82h							001C36 28 02               B    54    				jr z,c_badhex
001C38 3E16                B    55    				ld a,016h						001C3A B7                  B    56    c_badhex		or a
001C3B C9                  B    57    				ret
                           B    58    				
001C3C CD 9C 10 00         B    59    st_addrok		call ascii_to_hexword			001C40 ED53 BC 5F 00       B    60    				ld (cmdop_end_address),de
001C45 23                  B    61    				inc hl
001C46 B7                  B    62    				or a
001C47 C8                  B    63    				ret z
001C48 E1                  B    64    				pop hl							001C49 FE82                B    65    				cp 82h							001C4B 28 ED               B    66    				jr z,c_badhex
001C4D 3E1C                B    67    				ld a,01ch						001C4F C9                  B    68    				ret
                           B    69    				
                           B    70    ;----------------------------------------------
                           B    71    
001C50                     B    72    hexword_or_bust
                           B    73    
                           B    74    ; Set HL to string address:
                           B    75    ; Returns to parent routine ONLY if the string 
                           B    76    ; DE = hex word. If no hex found, the zero flag
                           B    77    ; If chars are invalid hex, returns to grandpar
                           B    78    
001C50 CD 9C 10 00         B    79    				call ascii_to_hexword		
001C54 FE82                B    80    				cp 82h
001C56 20 03               B    81    				jr nz,hex_good
001C58 E1                  B    82    				pop hl						; r
001C59 B7                  B    83    				or a	
001C5A C9                  B    84    				ret			 
001C5B FE81                B    85    hex_good		cp 081h						; n
001C5D C9                  B    86    				ret
                           B    87    	
                           B    88    ;----------------------------------------------
                           B    89    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  63


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\cd.asm
                           B     0    	include 'commands\cd.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;'cd' - Change Dir command. V0.02 - ADL mode
                           B     3    ;----------------------------------------------
                           B     4    
001C5E                     B     5    os_cmd_cd	
                           B     6    
001C5E CD 6A 16 00         B     7    				call os_check_volume_format	
001C62 C0                  B     8    				ret nz
                           B     9    			
                           B    10    			
001C63 7E                  B    11    				ld a,(hl)						001C64 B7                  B    12    				or a				
001C65 CA 0C 1D 00         B    13    				jp z,cd_show_path		
                           B    14    			
                           B    15    			
001C69 7E                  B    16    				ld a,(hl)						001C6A 23                  B    17    				inc hl
001C6B 46                  B    18    				ld b,(hl)
001C6C 2B                  B    19    				dec hl
001C6D FE2E                B    20    				cp '.'			
001C6F 20 08               B    21    				jr nz,cd_nual
001C71 B8                  B    22    				cp b
001C72 20 05               B    23    				jr nz,cd_nual
001C74 CD C2 16 00         B    24    				call os_parent_dir	
001C78 C9                  B    25    				ret
                           B    26    			
                           B    27    			
001C79 FE2F                B    28    cd_nual			cp 02fh			
001C7B 20 05               B    29    				jr nz,cd_nogor					001C7D CD C8 16 00         B    30    				call os_root_dir	
001C81 C9                  B    31    				ret
                           B    32    				
                           B    33    				
001C82 FE25                B    34    cd_nogor		cp '%'							001C84 20 1F               B    35    				jr nz,cd_no_assign
001C86 CD 01 1B 00         B    36    				call os_get_envar
001C8A 28 04               B    37    				jr z,cd_evok
001C8C 3ED1                B    38    				ld a,0d1h						001C8E B7                  B    39    				or a
001C8F C9                  B    40    				ret
001C90 11000000            B    41    cd_evok			ld de,0
001C94 5E                  B    42    				ld e,(hl)
001C95 23                  B    43    				inc hl
001C96 56                  B    44    				ld d,(hl)
001C97 23                  B    45    				inc hl
001C98 7E                  B    46    				ld a,(hl)
001C99 D5                  B    47    				push de
001C9A CD 96 1A 00         B    48    				call os_change_volume
001C9E D1                  B    49    				pop de
001C9F C0                  B    50    				ret nz
001CA0 CD 46 1A 00         B    51    				call fs_update_dir_cluster
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  64


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\cd.asm
001CA4 C9                  B    52    				ret
                           B    53    				
                           B    54    				
001CA5                     B    55    cd_no_assign
                           B    56    			
001CA5 3A D5 5D 00         B    57    				ld a,(current_volume)
001CA9 32 20 67 00         B    58    				ld (original_vol_cd_cmd),a
                           B    59    			
001CAD E5                  B    60    				push hl
001CAE DDE1                B    61    				pop ix
001CB0 DD7E04              B    62    				ld a,(ix+4)
001CB3 FE3A                B    63    				cp ':'							001CB5 20 25               B    64    				jr nz,cd_nchvol
001CB7 11 DA 5D 00         B    65    				ld de,vol_txt+1
001CBB 0603                B    66    				ld b,3
001CBD CD DF 11 00         B    67    				call os_compare_strings
001CC1 20 19               B    68    				jr nz,cd_nchvol
001CC3 11050000            B    69    				ld de,5
001CC7 19                  B    70    				add hl,de
001CC8 22 72 60 00         B    71    				ld (os_args_loc),hl				001CCC DD7E03              B    72    				ld a,(ix+3)						001CCF D630                B    73    				sub 030h
001CD1 CD 96 1A 00         B    74    				call os_change_volume
001CD5 C0                  B    75    				ret nz							001CD6 CD C8 16 00         B    76    				call os_root_dir				001CDA 18 11               B    77    				jr cd_mol						                           B    78    				
                           B    79    			
001CDC CD 3A 1A 00         B    80    cd_nchvol		call fs_get_dir_cluster
001CE0 ED53 1D 67 00       B    81    				ld (original_dir_cd_cmd),de
                           B    82    			
001CE5 E5                  B    83    cd_mollp		push hl
001CE6 CD B8 16 00         B    84    				call os_change_dir				001CEA E1                  B    85    				pop hl
001CEB 20 0A               B    86    				jr nz,cd_dcherr
001CED 7E                  B    87    cd_mol			ld a,(hl)						001CEE 23                  B    88    				inc hl
001CEF B7                  B    89    				or a
001CF0 C8                  B    90    				ret z
001CF1 FE2F                B    91    				cp 02fh
001CF3 28 F0               B    92    				jr z,cd_mollp
001CF5 18 F6               B    93    				jr cd_mol
                           B    94    					
001CF7                     B    95    cd_dcherr	
                           B    96    			
001CF7 F5                  B    97    				push af							001CF8 ED5B 1D 67 00       B    98    				ld de,(original_dir_cd_cmd)
001CFD CD 46 1A 00         B    99    				call fs_update_dir_cluster
001D01 3A 20 67 00         B   100    				ld a,(original_vol_cd_cmd)
001D05 CD 96 1A 00         B   101    				call os_change_volume	
001D09 F1                  B   102    				pop af
001D0A B7                  B   103    				or a
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  65


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\cd.asm
001D0B C9                  B   104    				ret
                           B   105    				
                           B   106    ;----------------------------------------------
                           B   107    			
001D0C                     B   108    cd_show_path
                           B   109    			
                           B   110    			
       00000010            B   111    max_dirs	equ 16
                           B   112    			
001D0C 0610                B   113    				ld b,max_dirs
001D0E 0E00                B   114    				ld c,0
001D10 C5                  B   115    lp1				push bc
001D11 CD 3A 1A 00         B   116    				call fs_get_dir_cluster
001D15 C1                  B   117    				pop bc
001D16 D5                  B   118    				push de
001D17 0C                  B   119    				inc c
001D18 C5                  B   120    				push bc
001D19 CD C2 16 00         B   121    				call os_parent_dir
001D1D C1                  B   122    				pop bc
001D1E 20 02               B   123    				jr nz,shdir_lp
001D20 10 EE               B   124    				djnz lp1
                           B   125    				
001D22 D1                  B   126    shdir_lp		pop de
001D23 C5                  B   127    				push bc
001D24 CD 46 1A 00         B   128    				call fs_update_dir_cluster
001D28 CD EE 16 00         B   129    				call os_get_current_dir_name
001D2C CD 25 0F 00         B   130    				call os_print_string
001D30 21 42 1D 00         B   131    				ld hl,cd_fwdslash_txt
001D34 CD 25 0F 00         B   132    				call os_print_string
001D38 C1                  B   133    				pop bc
001D39 0D                  B   134    				dec c
001D3A 20 E6               B   135    				jr nz,shdir_lp
                           B   136    			
001D3C CD B8 13 00         B   137    				call os_new_line	
001D40 AF                  B   138    				xor a
001D41 C9                  B   139    				ret
                           B   140    			
001D42 2F00                B   141    cd_fwdslash_txt	db '/',0	
                           B   142    			
                           B   143    ;----------------------------------------------
                           B   144    			
       0000671D            B   145    original_dir_cd_cmd		equ scratch_pad 
       00006720            B   146    original_vol_cd_cmd	 	equ scratch_pad+3
                           B   147    					
                           B   148    ;----------------------------------------------
                           B     0    	include 'commands\cls.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"cls" - Clear screen command. V0.02 - ADL mode
                           B     3    ;----------------------------------------------
                           B     4    
001D44                     B     5    os_cmd_cls
                           B     6    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  66


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\cls.asm
001D44 CD CA 3B 00         B     7    				call hwsc_clear_screen
001D48 AF                  B     8    				xor a
001D49 C9                  B     9    				ret
                           B    10    				
                           B    11    ;----------------------------------------------
                           B    12    	
                           B     0    	include 'commands\colon.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;":" for write hex bytes command. V0.02 - ADL m
                           B     3    ;----------------------------------------------
                           B     4    
001D4A                     B     5    os_cmd_colon
                           B     6    	
001D4A CD 50 1C 00         B     7    				call hexword_or_bust			001D4E CA DD 15 00         B     8    				jp z,os_no_start_addr			001D52 D5                  B     9    				push de
001D53 DDE1                B    10    				pop ix							                           B    11    			
001D55 CD 50 1C 00         B    12    wmblp			call hexword_or_bust			001D59 28 07               B    13    				jr z,os_ccmdn
001D5B DD7300              B    14    				ld (ix),e						001D5E DD23                B    15    				inc ix
001D60 18 F3               B    16    				jr wmblp
                           B    17    
001D62 AF                  B    18    os_ccmdn		xor a
001D63 C9                  B    19    				ret
                           B    20    		
                           B    21    
                           B    22    ;----------------------------------------------
                           B     0    	include 'commands\d.asm'
                           B     1    ;----------------------------------------------
                           B     2    ; OS "D" Command: EZ80 Disassembler V0.01
                           B     3    ; Totally and utterly unoptimized!
                           B     4    ;----------------------------------------------
                           B     5    
001D64 FD21 19 23 00       B     6    os_cmd_d		ld iy,prefix_bits_loc
001D69 FDCB 07 C6          B     7    				set adl_dis,(iy+var_adl)
                           B     8    
001D6D CD 50 1C 00         B     9    os_cmd_d_go		call hexword_or_bust			001D71 28 05               B    10    				jr z,d_no_hex					001D73 ED53 5F 28 00       B    11    				ld (dis_addr),de
                           B    12    				
001D78 3A 5B 5D 00         B    13    d_no_hex		ld a,(window_rows)				001D7C D602                B    14    				sub a,2
001D7E 47                  B    15    				ld b,a
001D7F C5                  B    16    dis_loop		push bc
                           B    17    				
001D80 DD2A 5F 28 00       B    18    				ld ix,(dis_addr)				001D85 CD FB 22 00         B    19    				call show_ix					001D89 3E20                B    20    				ld a,' '
001D8B CD EF 22 00         B    21    				call show_ascii_char
                           B    22    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  67


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
001D8F FD21 19 23 00       B    23    				ld iy,prefix_bits_loc
001D94 FD360000            B    24    				ld (iy),0						001D98 CD D4 1D 00         B    25    				call dis_instr					001D9C DD23                B    26    				inc ix							                           B    27    				
001D9E 3E18                B    28    				ld a,24							001DA0 32 B1 5F 00         B    29    				ld (cursor_pos+1),a				001DA4 ED4B 5F 28 00       B    30    				ld bc,(dis_addr)
001DA9 DD22 5F 28 00       B    31    				ld (dis_addr),ix				001DAE DDE5                B    32    				push ix
001DB0 E1                  B    33    				pop hl
001DB1 AF                  B    34    				xor a
001DB2 ED42                B    35    				sbc hl,bc						001DB4 7D                  B    36    				ld a,l
001DB5 E607                B    37    				and 7
001DB7 6F                  B    38    				ld l,a
001DB8 0A                  B    39    shexoplp		ld a,(bc)						001DB9 CD DE 22 00         B    40    				call show_hex_byte
001DBD 3E20                B    41    				ld a,' '
001DBF CD EF 22 00         B    42    				call show_ascii_char
001DC3 03                  B    43    				inc bc
001DC4 2D                  B    44    				dec l
001DC5 20 F1               B    45    				jr nz,shexoplp
                           B    46    				
001DC7 CD B8 13 00         B    47    				call os_new_line
001DCB C1                  B    48    				pop bc
001DCC 10 B1               B    49    				djnz dis_loop
                           B    50    
001DCE CD B8 13 00         B    51    				call os_new_line
001DD2 AF                  B    52    				xor a
001DD3 C9                  B    53    				ret
                           B    54    
                           B    55    
                           B    56    ;- Handle op code prefixes --------------------
                           B    57    			
       00000000            B    58    cb_prefix			equ 0					
       00000001            B    59    ed_prefix			equ 1
       00000002            B    60    sub_ix_prefix		equ 2
       00000003            B    61    sub_iy_prefix		equ 3
       00000004            B    62    ddcb_fdcb_prefix	equ 4					; p
       00000005            B    63    dot_l_prefix		equ 5
       00000006            B    64    il_prefix			equ 6
       00000007            B    65    show_adl_prefix		equ 7
                           B    66    
       00000000            B    67    adl_dis				equ 0					; b
                           B    68    
                           B    69    
001DD4 DD7E00              B    70    dis_instr	ld a,(ix)						; c
                           B    71    			
001DD7 FDCB 07 46          B    72    			bit adl_dis,(iy+var_adl)		; i
001DDB 28 04               B    73    			jr z,z80_list					; T
001DDD FDCB00F6            B    74    			set il_prefix,(iy)				; a
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  68


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
001DE1                     B    75    z80_list			
                           B    76    			
                           B    77    ;----------------------------------------------
                           B    78    
001DE1 FE40                B    79    			cp 40h
001DE3 20 0A               B    80    			jr nz,not_sis
001DE5 FDCB00B6            B    81    			res il_prefix,(iy)
001DE9 FDCB00AE            B    82    			res dot_l_prefix,(iy)
001DED 18 28               B    83    			jr set_adl_pf
                           B    84    			
001DEF FE49                B    85    not_sis		cp 49h
001DF1 20 0A               B    86    			jr nz,not_lis
001DF3 FDCB00B6            B    87    			res il_prefix,(iy)
001DF7 FDCB00EE            B    88    			set dot_l_prefix,(iy)
001DFB 18 1A               B    89    			jr set_adl_pf
                           B    90    			
001DFD FE52                B    91    not_lis		cp 52h
001DFF 20 0A               B    92    			jr nz,not_sil
001E01 FDCB00F6            B    93    			set il_prefix,(iy)
001E05 FDCB00AE            B    94    			res dot_l_prefix,(iy)
001E09 18 0C               B    95    			jr set_adl_pf
                           B    96    			
001E0B FE5B                B    97    not_sil		cp 5bh
001E0D 20 11               B    98    			jr nz,not_adl_prefix_byte
001E0F FDCB00F6            B    99    			set il_prefix,(iy)
001E13 FDCB00EE            B   100    			set dot_l_prefix,(iy)
                           B   101    			
001E17 FDCB00FE            B   102    set_adl_pf	set show_adl_prefix,(iy)
001E1B DD23                B   103    			inc ix
001E1D DD7E00              B   104    			ld a,(ix)	
                           B   105    			
                           B   106    ;----------------------------------------------
                           B   107    
001E20                     B   108    not_adl_prefix_byte			
                           B   109    			
001E20 FECB                B   110    			cp 0cbh								001E22 20 08               B   111    			jr nz,not_cb
001E24 FDCB00C6            B   112    do_cb		set cb_prefix,(iy)
001E28 DD23                B   113    			inc ix
001E2A 18 3A               B   114    			jr not_traditional_prefix_byte
                           B   115    
001E2C FEED                B   116    not_cb		cp 0edh
001E2E 20 08               B   117    			jr nz,not_ed
001E30 FDCB00CE            B   118    do_ed		set ed_prefix,(iy)
001E34 DD23                B   119    			inc ix
001E36 18 2E               B   120    			jr not_traditional_prefix_byte
                           B   121    
001E38 FEDD                B   122    not_ed		cp 0ddh
001E3A 20 18               B   123    			jr nz,not_dd
001E3C CD 5F 20 00         B   124    do_dd		call check_nxt_byte_prefix			001E40 28 92               B   125    			jr z,dis_instr						001E42 FDCB00D6            B   126    			set sub_ix_prefix,(iy)
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  69


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
001E46 FECB                B   127    xdcb_query	cp 0cbh								001E48 20 1C               B   128    			jr nz,not_traditional_prefix_byte	001E4A FDCB00E6            B   129    			set ddcb_fdcb_prefix,(iy)
001E4E DD23                B   130    			inc ix								001E50 DD23                B   131    			inc ix								001E52 18 12               B   132    			jr not_traditional_prefix_byte
                           B   133    
001E54 FEFD                B   134    not_dd		cp 0fdh
001E56 20 0E               B   135    			jr nz,not_traditional_prefix_byte
001E58 CD 5F 20 00         B   136    do_fd		call check_nxt_byte_prefix
001E5C CA D4 1D 00         B   137    			jr z,dis_instr	
001E60 FDCB00DE            B   138    			set sub_iy_prefix,(iy)
001E64 18 E0               B   139    			jr xdcb_query
                           B   140    
001E66                     B   141    not_traditional_prefix_byte
                           B   142    
                           B   143    ;----------------------------------------------
                           B   144    
001E66 DD7E00              B   145    			ld a,(ix)	
001E69 E6C0                B   146    			and 11000000b			; seperate 
001E6B 07                  B   147    			rlca
001E6C 07                  B   148    			rlca
001E6D FD77 01             B   149    			ld (iy+var_x),a			;var x= val
                           B   150    			
001E70 DD7E00              B   151    			ld a,(ix)
001E73 E638                B   152    			and 00111000b
001E75 CB3F                B   153    			srl a
001E77 CB3F                B   154    			srl a
001E79 CB3F                B   155    			srl a	
001E7B FD77 02             B   156    			ld (iy+var_y),a			;var x = vl
                           B   157    
001E7E DD7E00              B   158    			ld a,(ix)
001E81 E607                B   159    			and 00000111b
001E83 FD77 03             B   160    			ld (iy+var_z),a			;var z = va
                           B   161    			
001E86 DD7E00              B   162    			ld a,(ix)
001E89 E630                B   163    			and 00110000b
001E8B CB3F                B   164    			srl a
001E8D CB3F                B   165    			srl a
001E8F CB3F                B   166    			srl a
001E91 CB3F                B   167    			srl a
001E93 FD77 04             B   168    			ld (iy+var_p),a			; var p = v
                           B   169    			
001E96 DD7E00              B   170    			ld a,(ix)
001E99 E608                B   171    			and 00001000b
001E9B CB3F                B   172    			srl a
001E9D CB3F                B   173    			srl a
001E9F CB3F                B   174    			srl a
001EA1 FD77 05             B   175    			ld (iy+var_q),a				;var q 
                           B   176    
001EA4 CD 6D 20 00         B   177    			call find_instruction_ascii		; g
                           B   178    	
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  70


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
                           B   179    ;----------------------------------------------
                           B   180    
001EA8 78                  B   181    index_table	ld a,b							; a
001EA9 B7                  B   182    			or a
001EAA 28 07               B   183    			jr z,parse_instr				; m
001EAC CB7E                B   184    d_filp		bit 7,(hl)						; w
001EAE 23                  B   185    			inc hl							; o
001EAF 28 FB               B   186    			jr z,d_filp					
001EB1 10 F9               B   187    			djnz d_filp
                           B   188    										
                           B   189    			
001EB3 FD21 19 23 00       B   190    parse_instr	ld iy,opcode_vars
001EB8 01000000            B   191    			ld bc,0
001EBC 7E                  B   192    			ld a,(hl)						;ge
001EBD FE80                B   193    			cp 80h
001EBF C8                  B   194    			ret z
001EC0 E67F                B   195    			and 7fh
                           B   196    			
001EC2 FE26                B   197    			cp '&'							;sy
001EC4 20 28               B   198    			jr nz,not_adlsym
001EC6 FDCB007E            B   199    			bit show_adl_prefix,(iy)		;do
001ECA CA 48 20 00         B   200    			jr z,next_opcode_ascii_char
001ECE 0600                B   201    			ld b,0
001ED0 FDCB006E            B   202    			bit dot_l_prefix,(iy)
001ED4 28 02               B   203    			jr z,naplsb
001ED6 CBC0                B   204    			set 0,b
001ED8 FDCB0076            B   205    naplsb		bit il_prefix,(iy)
001EDC 28 02               B   206    			jr z,napmsb
001EDE CBC8                B   207    			set 1,b
001EE0 E5                  B   208    napmsb		push hl
001EE1 21 47 28 00         B   209    			ld hl,adl_prefix_list
001EE5 CD A8 1E 00         B   210    			call index_table				; r
001EE9 E1                  B   211    			pop hl
001EEA C3 48 20 00         B   212    			jp next_opcode_ascii_char
                           B   213    
001EEE FE5E                B   214    not_adlsym	cp '^'							;sy
001EF0 20 0D               B   215    			jr nz,d_not_imm8
001EF2 DD23                B   216    			inc ix							;th
001EF4 DD7E00              B   217    			ld a,(ix)
001EF7 CD DE 22 00         B   218    			call show_hex_byte
001EFB C3 48 20 00         B   219    			jp next_opcode_ascii_char
                           B   220    					
001EFF FE21                B   221    d_not_imm8	cp '!'							;sy
001F01 20 26               B   222    			jr nz,d_not_imm16					001F03 11020000            B   223    			ld de,2
001F07 FDCB0076            B   224    			bit il_prefix,(iy)				;ad
001F0B 28 08               B   225    			jr z,imm16
001F0D 13                  B   226    			inc de
001F0E DD7E03              B   227    			ld a,(ix+3)
001F11 CD DE 22 00         B   228    			call show_hex_byte
001F15 DD7E02              B   229    imm16		ld a,(ix+2)						;sh
001F18 CD DE 22 00         B   230    			call show_hex_byte			
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  71


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
001F1C DD7E01              B   231    			ld a,(ix+1)						;th
001F1F CD DE 22 00         B   232    			call show_hex_byte
001F23 DD19                B   233    			add ix,de						;ad
001F25 C3 48 20 00         B   234    			jp next_opcode_ascii_char
                           B   235    
001F29 FE2F                B   236    d_not_imm16	cp '/'							;sy
001F2B 20 36               B   237    			jr nz,d_not_sb
001F2D FDCB0066            B   238    			bit ddcb_fdcb_prefix,(iy)
001F31 28 05               B   239    			jr z,norm_dbyte
001F33 DD7EFF              B   240    			ld a,(ix-1)						;if
001F36 18 05               B   241    			jr xdcb_dbyte
001F38 DD23                B   242    norm_dbyte	inc ix
001F3A DD7E00              B   243    			ld a,(ix)						;th
001F3D CB7F                B   244    xdcb_dbyte	bit 7,a
001F3F 20 10               B   245    			jr nz,d_sbin					;sh
001F41 F5                  B   246    			push af
001F42 3E2B                B   247    			ld a,'+'
001F44 CD EF 22 00         B   248    			call show_ascii_char
001F48 F1                  B   249    			pop af
001F49 CD DE 22 00         B   250    			call show_hex_byte
001F4D C3 48 20 00         B   251    			jp next_opcode_ascii_char
001F51 F5                  B   252    d_sbin		push af
001F52 3E2D                B   253    			ld a,'-'
001F54 CD EF 22 00         B   254    			call show_ascii_char
001F58 F1                  B   255    			pop af
001F59 ED44                B   256    			neg
001F5B CD DE 22 00         B   257    			call show_hex_byte
001F5F C3 48 20 00         B   258    			jp next_opcode_ascii_char
                           B   259    			
001F63 FE64                B   260    d_not_sb	cp 'd'							;sy
001F65 20 1E               B   261    			jr nz,d_not_pcdip
001F67 DD23                B   262    			inc ix
001F69 01000000            B   263    			ld bc,0
001F6D DD7E00              B   264    			ld a,(ix)
001F70 CB7F                B   265    			bit 7,a
001F72 28 01               B   266    			jr z,d_spcd_pos
001F74 0B                  B   267    			dec bc
001F75 4F                  B   268    d_spcd_pos	ld c,a
001F76 03                  B   269    			inc bc
001F77 DDE5                B   270    			push ix
001F79 DD09                B   271    			add ix,bc
001F7B CD FB 22 00         B   272    			call show_ix
001F7F DDE1                B   273    			pop ix
001F81 C3 48 20 00         B   274    			jp next_opcode_ascii_char
                           B   275    
001F85 FE3E                B   276    d_not_pcdip	cp '>'							;sy
001F87 20 16               B   277    			jr nz,d_not_sdig
001F89 23                  B   278    			inc hl							;th
001F8A 01000000            B   279    			ld bc,0
001F8E 4E                  B   280    			ld c,(hl)
001F8F FD21 19 23 00       B   281    			ld iy,opcode_vars
001F94 FD09                B   282    			add iy,bc
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  72


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
001F96 FD7E00              B   283    			ld a,(iy)						;a 
001F99 C630                B   284    			add a,30h						;co
001F9B C3 44 20 00         B   285    			jp d_output_char
                           B   286    
001F9F FE5F                B   287    d_not_sdig	cp '_'
001FA1 20 12               B   288    			jr nz,d_nhlsubst				; s
001FA3 E5                  B   289    			push hl
001FA4 21 1F 28 00         B   290    			ld hl,hl_subs
001FA8 CD 50 20 00         B   291    hl_subst	call prefix_to_offset
001FAC CD A8 1E 00         B   292    			call index_table				; r
001FB0 E1                  B   293    			pop hl
001FB1 C3 48 20 00         B   294    			jp next_opcode_ascii_char
                           B   295    			
001FB5 FE7C                B   296    d_nhlsubst	cp '|'
001FB7 20 07               B   297    			jr nz,d_noinvhls
001FB9 E5                  B   298    			push hl
001FBA 21 25 28 00         B   299    			ld hl,inv_hl_subs
001FBE 18 E8               B   300    			jr hl_subst
                           B   301    			
001FC0 FE68                B   302    d_noinvhls	cp 'h'							;sy
001FC2 20 07               B   303    			jr nz,d_nhsubst
001FC4 E5                  B   304    			push hl
001FC5 21 2B 28 00         B   305    			ld hl,h_subs
001FC9 18 DD               B   306    			jr hl_subst
                           B   307    			
001FCB FE6C                B   308    d_nhsubst	cp 'l'							;sy
001FCD 20 07               B   309    			jr nz,d_nlsubst
001FCF E5                  B   310    			push hl
001FD0 21 32 28 00         B   311    			ld hl,l_subs
001FD4 18 D2               B   312    			jr hl_subst
                           B   313    			
001FD6 FE24                B   314    d_nlsubst	cp '$'
001FD8 20 07               B   315    			jr nz,d_nihlsubst				; s
001FDA E5                  B   316    			push hl
001FDB 21 39 28 00         B   317    			ld hl,ind_hl_subs
001FDF 18 C7               B   318    			jr hl_subst
                           B   319    
                           B   320    
001FE1                     B   321    d_nihlsubst	
                           B   322    
001FE1 FE7E                B   323    			cp '~'							; s
001FE3 20 1F               B   324    			jr nz,ntable_r
001FE5 11 87 27 00         B   325    			ld de,table_r
001FE9 23                  B   326    do_table 	inc hl
001FEA 01000000            B   327    			ld bc,0							; t
001FEE 4E                  B   328    			ld c,(hl)
001FEF FD21 19 23 00       B   329    			ld iy,opcode_vars
001FF4 FD09                B   330    			add iy,bc
001FF6 FD4600              B   331    			ld b,(iy)						;in
001FF9 E5                  B   332    			push hl
001FFA EB                  B   333    			ex de,hl
001FFB CD A8 1E 00         B   334    			call index_table				; r
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  73


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
001FFF E1                  B   335    			pop hl
002000 C3 48 20 00         B   336    			jp next_opcode_ascii_char
                           B   337    			
002004 11 92 27 00         B   338    ntable_r	ld de,table_rp					; s
002008 FE40                B   339    			cp '@'
00200A 28 DD               B   340    			jr z,do_table 
                           B   341    			
00200C 11 99 27 00         B   342    			ld de,table_rp2					; s
002010 FE2A                B   343    			cp '*'
002012 28 D5               B   344    			jr z,do_table
                           B   345    			
002014 11 FF 27 00         B   346    			ld de,table_rp3					; s
002018 FE3C                B   347    			cp '<'
00201A 28 CD               B   348    			jr z,do_table
                           B   349    			
00201C 11 07 28 00         B   350    			ld de,table_rp4					; s
002020 FE7D                B   351    			cp '}'
002022 28 C5               B   352    			jr z,do_table
                           B   353    			
002024 11 A1 27 00         B   354    			ld de,table_cc					; s
002028 FE23                B   355    			cp '#'
00202A 28 BD               B   356    			jr z,do_table 
                           B   357    			
00202C 11 AD 27 00         B   358    			ld de,table_alu					; s
002030 FE3A                B   359    			cp ':'
002032 28 B5               B   360    			jr z,do_table 
                           B   361    			
002034 11 D9 27 00         B   362    			ld de,table_rot					; s
002038 FE25                B   363    			cp '%'
00203A 28 AD               B   364    			jr z,do_table 
                           B   365    			
00203C 11 0F 28 00         B   366    			ld de,table_rst					; s
002040 FE3B                B   367    			cp ';'
002042 28 A5               B   368    			jr z,do_table 
                           B   369    
                           B   370    			
002044                     B   371    ntable_bli
                           B   372    
                           B   373    ;----------------------------------------------
                           B   374    
002044                     B   375    d_output_char
                           B   376    
002044 CD EF 22 00         B   377    			call show_ascii_char
                           B   378    
002048                     B   379    next_opcode_ascii_char
                           B   380    
002048 CB7E                B   381    			bit 7,(hl)						;if
00204A C0                  B   382    			ret nz
00204B 23                  B   383    			inc hl
00204C C3 B3 1E 00         B   384    			jp parse_instr
                           B   385    			
                           B   386    			
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  74


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
                           B   387    ;----------------------------------------------
                           B   388    
                           B   389    
002050                     B   390    prefix_to_offset
                           B   391    
002050 0602                B   392    			ld b,2							;se
002052 FDCB005E            B   393    			bit sub_iy_prefix,(iy)
002056 C0                  B   394    			ret nz
002057 05                  B   395    			dec b
002058 FDCB0056            B   396    			bit sub_ix_prefix,(iy)
00205C C0                  B   397    			ret nz
00205D 05                  B   398    			dec b
00205E C9                  B   399    			ret
                           B   400    			
                           B   401    			
00205F                     B   402    check_nxt_byte_prefix			
                           B   403    
00205F DD23                B   404    			inc ix
002061 DD7E00              B   405    			ld a,(ix)
002064 FEDD                B   406    			cp 0ddh
002066 C8                  B   407    			ret z
002067 FEED                B   408    			cp 0edh
002069 C8                  B   409    			ret z
00206A FEFD                B   410    			cp 0fdh
00206C C9                  B   411    			ret
                           B   412    			
                           B   413    			
                           B   414    ;==============================================
                           B   415    ;- Find instruction ascii ---------------------
                           B   416    ;==============================================
                           B   417    
                           B   418    ; Returns HL = ptr to ascii name
                           B   419    ;          B = group index (number of instructi
                           B   420    
00206D                     B   421    find_instruction_ascii
                           B   422    
00206D 0600                B   423    			ld b,0						; defau
                           B   424    
00206F FDCB0066            B   425    			bit ddcb_fdcb_prefix,(iy)	; Was t
002073 28 12               B   426    			jr z,not_ddcb_fdcb_inst
002075 21 61 27 00         B   427    			ld hl,ddcb_fdcb_z6		
002079 FD46 01             B   428    			ld b,(iy+var_x)				; x is 
00207C FD7E 03             B   429    			ld a,(iy+var_z)
00207F FE06                B   430    			cp 6
002081 C8                  B   431    			ret z
002082 21 29 27 00         B   432    			ld hl,ddcb_fdcb_zn6					002086 C9                  B   433    			ret
                           B   434    			
                           B   435    ;==============================================
                           B   436    
002087                     B   437    not_ddcb_fdcb_inst
                           B   438    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  75


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
002087 FDCB0046            B   439    			bit cb_prefix,(iy)			;is thi
00208B 28 08               B   440    			jr z,not_cb_inst
00208D 21 B4 24 00         B   441    			ld hl,cb_group		
002091 FD46 01             B   442    			ld b,(iy+var_x)				; x is 
002094 C9                  B   443    			ret
                           B   444    
                           B   445    ;==============================================
                           B   446    
002095                     B   447    not_cb_inst
                           B   448    
002095 FDCB004E            B   449    			bit ed_prefix,(iy)			;is thi
002099 CA BF 21 00         B   450    			jr z,not_ed_inst
                           B   451    
00209D FD7E 01             B   452    			ld a,(iy+var_x)				;x = 0
0020A0 B7                  B   453    			or a
0020A1 20 5B               B   454    			jr nz,notedx0
                           B   455    		
                           B   456    			
0020A3 FD7E 03             B   457    			ld a,(iy+var_z)				
0020A6 B7                  B   458    			or a
0020A7 20 0D               B   459    			jr nz,notedx0z0
0020A9 21 DB 24 00         B   460    			ld hl,ed_x0_z0_yn6			;x0 / z
0020AD FD7E 02             B   461    			ld a,(iy+var_y)
0020B0 FE06                B   462    			cp 6
0020B2 C0                  B   463    			ret nz
0020B3 0601                B   464    			ld b,1
0020B5 C9                  B   465    			ret
                           B   466    
0020B6 FE01                B   467    notedx0z0	cp 1
0020B8 20 0D               B   468    			jr nz,notedx0z1
0020BA 21 EC 24 00         B   469    			ld hl,ed_x0_z1				;x0 / z
0020BE FD7E 02             B   470    			ld a,(iy+var_y)
0020C1 FE06                B   471    			cp 6
0020C3 C0                  B   472    			ret nz
0020C4 0601                B   473    			ld b,1
0020C6 C9                  B   474    			ret
                           B   475    
0020C7 FE02                B   476    notedx0z1	cp 2
0020C9 20 05               B   477    			jr nz,notedx0z2
0020CB 21 01 25 00         B   478    			ld hl,ed_x0_z2				;x0 / z
0020CF C9                  B   479    			ret
                           B   480    
0020D0 FE03                B   481    notedx0z2	cp 3
0020D2 20 05               B   482    			jr nz,notedx0z3
0020D4 21 0D 25 00         B   483    			ld hl,ed_x0_z3				;x0 / z
0020D8 C9                  B   484    			ret
                           B   485    			
0020D9 FE04                B   486    notedx0z3	cp 4
0020DB 20 05               B   487    			jr nz,notedx0z4
0020DD 21 19 25 00         B   488    			ld hl,ed_x0_z4				;x0 / z
0020E1 C9                  B   489    			ret
                           B   490    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  76


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
0020E2 FE06                B   491    notedx0z4	cp 6
0020E4 20 05               B   492    			jr nz,notedx0z6				;x0 / z
0020E6 21 23 25 00         B   493    			ld hl,ed_x0_z6
0020EA C9                  B   494    			ret
                           B   495    
0020EB FE07                B   496    notedx0z6	cp 7
0020ED C2 84 27 00         B   497    			jr nz,bad_opcode			;x0 / z
0020F1 21 2E 25 00         B   498    			ld hl,ed_x0_z7
0020F5 FD7E 02             B   499    			ld a,(iy+var_y)
0020F8 FE06                B   500    			cp 6
0020FA C0                  B   501    			ret nz
0020FB 0601                B   502    			ld b,1
0020FD C9                  B   503    			ret
                           B   504    			
                           B   505    ;----------------------------------------------
                           B   506    			
0020FE FE01                B   507    notedx0		cp 1	
002100 20 68               B   508    			jr nz,ed_xn1
                           B   509    
002102 FD7E 03             B   510    			ld a,(iy+var_z)					;x 
002105 B7                  B   511    			or a
002106 20 0D               B   512    			jr nz,ed_x1_zn0
002108 21 43 25 00         B   513    			ld hl,ed_x1_z0_yn6				;z 
00210C FD7E 02             B   514    			ld a,(iy+var_y)
00210F FE06                B   515    			cp 6
002111 C0                  B   516    			ret nz
002112 0601                B   517    			ld b,1
002114 C9                  B   518    			ret
                           B   519    			
002115 FE01                B   520    ed_x1_zn0	cp 1
002117 20 0D               B   521    			jr nz,ed_x1_zn1
002119 21 53 25 00         B   522    			ld hl,ed_x1_z1_yn6				;z 
00211D FD7E 02             B   523    			ld a,(iy+var_y)
002120 FE06                B   524    			cp 6
002122 C0                  B   525    			ret nz
002123 0601                B   526    			ld b,1
002125 C9                  B   527    			ret
                           B   528    		
002126 FE02                B   529    ed_x1_zn1	cp 2
002128 20 08               B   530    			jr nz,ed_x1_zn2					;z 
00212A 21 67 25 00         B   531    			ld hl,ed_x1_z2	
00212E FD46 05             B   532    			ld b,(iy+var_q)
002131 C9                  B   533    			ret
                           B   534    
002132 FE03                B   535    ed_x1_zn2	cp 3
002134 20 08               B   536    			jr nz,ed_x1_zn3					;z 
002136 21 7D 25 00         B   537    			ld hl,ed_x1_z3	
00213A FD46 05             B   538    			ld b,(iy+var_q)
00213D C9                  B   539    			ret
                           B   540    			
00213E FE04                B   541    ed_x1_zn3	cp 4							;z 
002140 20 08               B   542    			jr nz,ed_x1_zn4
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  77


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
002142 21 91 25 00         B   543    			ld hl,ed_x1_z4
002146 FD46 02             B   544    			ld b,(iy+var_y)
002149 C9                  B   545    			ret
                           B   546    			
00214A FE05                B   547    ed_x1_zn4	cp 5
00214C 20 08               B   548    			jr nz,ed_x1_zn5
00214E 21 C9 25 00         B   549    			ld hl,ed_x1_z5					;z 
002152 FD46 02             B   550    			ld b,(iy+var_y)
002155 C9                  B   551    			ret
                           B   552    			
002156 FE06                B   553    ed_x1_zn5	cp 6
002158 20 08               B   554    			jr nz,ed_x1_zn6					;z=
00215A 21 F8 25 00         B   555    			ld hl,ed_x1_z6
00215E FD46 02             B   556    			ld b,(iy+var_y)
002161 C9                  B   557    			ret
                           B   558    			
002162 21 1D 26 00         B   559    ed_x1_zn6	ld hl,ed_x1_z7					;z=
002166 FD46 02             B   560    			ld b,(iy+var_y)
002169 C9                  B   561    			ret
                           B   562    
                           B   563    ;----------------------------------------------
                           B   564    				
00216A FE02                B   565    ed_xn1		cp 2
00216C 20 2E               B   566    			jr nz,ed_xn2
                           B   567    			
00216E FD46 02             B   568    			ld b,(iy+var_y)
002171 FD7E 03             B   569    			ld a,(iy+var_z)
002174 B7                  B   570    			or a
002175 20 05               B   571    			jr nz,edx2zn0
002177 21 41 26 00         B   572    			ld hl,ed_x2_z0					;x=
00217B C9                  B   573    			ret
                           B   574    
00217C FE01                B   575    edx2zn0		cp 1
00217E 20 05               B   576    			jr nz,edx2zn1
002180 21 5B 26 00         B   577    			ld hl,ed_x2_z1					;x=
002184 C9                  B   578    			ret
                           B   579    
002185 FE02                B   580    edx2zn1		cp 2
002187 20 05               B   581    			jr nz,edx2zn2
002189 21 75 26 00         B   582    			ld hl,ed_x2_z2					;x=
00218D C9                  B   583    			ret
                           B   584    
00218E FE03                B   585    edx2zn2		cp 3
002190 20 05               B   586    			jr nz,edx2zn3
002192 21 A5 26 00         B   587    			ld hl,ed_x2_z3					;x=
002196 C9                  B   588    			ret
                           B   589    
002197 21 D7 26 00         B   590    edx2zn3		ld hl,ed_x2_z4					;x=
00219B C9                  B   591    			ret
                           B   592    
                           B   593    ;----------------------------------------------
                           B   594    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  78


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
00219C FE03                B   595    ed_xn2		cp 3
00219E 20 18               B   596    			jr nz,ed_xn3
                           B   597    			
0021A0 FD46 02             B   598    			ld b,(iy+var_y)
0021A3 FD7E 03             B   599    			ld a,(iy+var_z)
0021A6 FE02                B   600    			cp 2
0021A8 20 05               B   601    			jr nz,edx3zn2
0021AA 21 0D 27 00         B   602    			ld hl,ed_x3_z2					;x=
0021AE C9                  B   603    			ret
0021AF FE03                B   604    edx3zn2		cp 3
0021B1 20 05               B   605    			jr nz,edx3zn3
0021B3 21 1B 27 00         B   606    			ld hl,ed_x3_z3					;x=
0021B7 C9                  B   607    			ret
                           B   608    
0021B8                     B   609    edx3zn3
                           B   610    
0021B8                     B   611    ed_xn3
                           B   612    
                           B   613    ;----------------------------------------------
                           B   614    
0021B8                     B   615    invalid_op
0021B8 21 84 27 00         B   616    			ld hl,bad_opcode				; x
0021BC 0600                B   617    			ld b,0
0021BE C9                  B   618    			ret
                           B   619    			
                           B   620    			
                           B   621    ;========= UNPREFIXED INSTRUCTION =============
                           B   622    
                           B   623    
0021BF FD7E 01             B   624    not_ed_inst	ld a,(iy+var_x)				; is X 
0021C2 B7                  B   625    			or a
0021C3 C2 5C 22 00         B   626    			jr nz,x_not_zero
                           B   627    
                           B   628    ;----------------------------------------------
                           B   629    
                           B   630    
0021C7 FD7E 03             B   631    			ld a,(iy+var_z)				;x = 0
0021CA B7                  B   632    			or a
0021CB 20 14               B   633    			jr nz,x0_z_not_zero
0021CD 21 21 23 00         B   634    			ld hl,x0_z0
0021D1 FD7E 02             B   635    			ld a,(iy+var_y)				;y is t
0021D4 47                  B   636    			ld b,a
0021D5 D604                B   637    			sub 4
0021D7 FD77 06             B   638    			ld (iy+var_calc),a			;var_ca
0021DA 78                  B   639    			ld a,b
0021DB FE04                B   640    			cp 4
0021DD D8                  B   641    			ret c
0021DE 0604                B   642    			ld b,4						;if y >
0021E0 C9                  B   643    			ret
                           B   644    			
0021E1                     B   645    x0_z_not_zero		
                           B   646    			
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  79


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
0021E1 FE01                B   647    			cp 1
0021E3 20 14               B   648    			jr nz,x0_z_not_one
0021E5 21 41 23 00         B   649    			ld hl,x0_z1_yn6
0021E9 FD46 05             B   650    			ld b,(iy+var_q)				;q is t
0021EC FD7E 02             B   651    			ld a,(iy+var_y)
0021EF FE06                B   652    			cp 6
0021F1 C0                  B   653    			ret nz
0021F2 21 54 23 00         B   654    			ld hl,x0_z1_y6
0021F6 0600                B   655    			ld b,0
0021F8 C9                  B   656    			ret 
                           B   657    			
0021F9                     B   658    x0_z_not_one
                           B   659    
0021F9 FE02                B   660    			cp 2
0021FB 20 08               B   661    			jr nz,x0_z_not_two
0021FD 21 5C 23 00         B   662    			ld hl,x0_z2
002201 FD46 02             B   663    			ld b,(iy+var_y)				;y is t
002204 C9                  B   664    			ret
                           B   665    			
002205                     B   666    x0_z_not_two
                           B   667    
002205 FE03                B   668    			cp 3
002207 20 08               B   669    			jr nz,x0_z_not_three
002209 21 A7 23 00         B   670    			ld hl,x0_z3
00220D FD46 05             B   671    			ld b,(iy+var_q)				;q is t
002210 C9                  B   672    			ret
                           B   673    			
002211                     B   674    x0_z_not_three
                           B   675    
002211 FE04                B   676    			cp 4
002213 20 05               B   677    			jr nz,x0_z_not_four
002215 21 B7 23 00         B   678    			ld hl,x0_z4					;no ini
002219 C9                  B   679    			ret			
                           B   680    			
00221A                     B   681    x0_z_not_four
                           B   682    
00221A FE05                B   683    			cp 5
00221C 20 05               B   684    			jr nz,x0_z_not_five
00221E 21 BF 23 00         B   685    			ld hl,x0_z5					;no ini
002222 C9                  B   686    			ret				
                           B   687    			
002223                     B   688    x0_z_not_five
                           B   689    
002223 FE06                B   690    			cp 6
002225 20 1A               B   691    			jr nz,x0_z_not_six
002227 21 C7 23 00         B   692    			ld hl,x0_z6					;normal
00222B FD7E 02             B   693    			ld a,(iy+var_y)
00222E FE07                B   694    			cp 7
002230 C0                  B   695    			ret nz
002231 FDCB0056            B   696    			bit sub_ix_prefix,(iy)
002235 20 05               B   697    			jr nz,altx0z6
002237 FDCB005E            B   698    			bit sub_iy_prefix,(iy)
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  80


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
00223B C8                  B   699    			ret z	
00223C 21 D0 23 00         B   700    altx0z6		ld hl,alt_x0_z6				;if dd/
002240 C9                  B   701    			ret
                           B   702    
                           B   703    
002241                     B   704    x0_z_not_six
                           B   705    			
002241 21 D8 23 00         B   706    			ld hl,x0_z7
002245 FD46 02             B   707    			ld b,(iy+var_y)				;y is n
002248 FDCB0056            B   708    			bit sub_ix_prefix,(iy)
00224C 20 05               B   709    			jr nz,altx0z7
00224E FDCB005E            B   710    			bit sub_iy_prefix,(iy)
002252 C8                  B   711    			ret z
002253 78                  B   712    altx0z7		ld a,b
002254 E601                B   713    			and 1
002256 47                  B   714    			ld b,a						;if dd/
002257 21 F2 23 00         B   715    			ld hl,alt_x0_z7				;this i
00225B C9                  B   716    			ret
                           B   717    
                           B   718    ;----------------------------------------------
                           B   719    
00225C FE01                B   720    x_not_zero	cp 1						; is x 
00225E 20 14               B   721    			jr nz,x_not_one
                           B   722    			
002260 21 02 24 00         B   723    			ld hl,x1_table				; x=1
002264 0600                B   724    			ld b,0
002266 FD7E 02             B   725    			ld a,(iy+var_y)				; no in
002269 FE06                B   726    			cp 6
00226B C0                  B   727    			ret nz
00226C FD7E 03             B   728    			ld a,(iy+var_z)
00226F FE06                B   729    			cp 6
002271 C0                  B   730    			ret nz
002272 04                  B   731    			inc b						; unles
002273 C9                  B   732    			ret
                           B   733    		
                           B   734    ;----------------------------------------------
                           B   735    			
002274 FE02                B   736    x_not_one	cp 2						; is x 
002276 20 05               B   737    			jr nz,x_not_two
002278 21 10 24 00         B   738    			ld hl,x2_table				; no in
00227C C9                  B   739    			ret
                           B   740    			
                           B   741    ;----------------------------------------------
                           B   742    
00227D FD7E 03             B   743    x_not_two	ld a,(iy+var_z)				; x mus
002280 B7                  B   744    			or a
002281 20 05               B   745    			jr nz,x3_z_not_zero
002283 21 15 24 00         B   746    			ld hl,x3_z0					; no in
002287 C9                  B   747    			ret
                           B   748    						
002288                     B   749    x3_z_not_zero
                           B   750    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  81


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
002288 FE01                B   751    			cp 1
00228A 20 11               B   752    			jr nz,x3_z_not_one
00228C 21 1C 24 00         B   753    			ld hl,x3_z1_q0
002290 FD7E 05             B   754    			ld a,(iy+var_q)
002293 B7                  B   755    			or a
002294 C8                  B   756    			ret z						; no in
002295 21 24 24 00         B   757    			ld hl,x3_z1_q1
002299 FD46 04             B   758    			ld b,(iy+var_p)				; index
00229C C9                  B   759    			ret
                           B   760    
00229D                     B   761    x3_z_not_one
                           B   762    
00229D FE02                B   763    			cp 2
00229F 20 05               B   764    			jr nz,x3_z_not_two
0022A1 21 39 24 00         B   765    			ld hl,x3_z2					;no ini
0022A5 C9                  B   766    			ret
                           B   767    
0022A6                     B   768    x3_z_not_two
                           B   769    
0022A6 FE03                B   770    			cp 3
0022A8 20 08               B   771    			jr nz,x3_z_not_three
0022AA 21 42 24 00         B   772    			ld hl,x3_z3
0022AE FD46 02             B   773    			ld b,(iy+var_y)				;index 
0022B1 C9                  B   774    			ret
                           B   775    
0022B2                     B   776    x3_z_not_three
                           B   777    
0022B2 FE04                B   778    			cp 4
0022B4 20 05               B   779    			jr nz,x3_z_not_four
0022B6 21 77 24 00         B   780    			ld hl,x3_z4				;no initial
0022BA C9                  B   781    			ret						
                           B   782    
                           B   783    
0022BB                     B   784    x3_z_not_four
                           B   785    
0022BB FE05                B   786    			cp 5
0022BD 20 11               B   787    			jr nz,x3_z_not_five
0022BF 21 82 24 00         B   788    			ld hl,x3_z5_q0
0022C3 FD7E 05             B   789    			ld a,(iy+var_q)
0022C6 B7                  B   790    			or a
0022C7 C8                  B   791    			ret z						;no ind
0022C8 21 8B 24 00         B   792    			ld hl,x3_z5_q1
0022CC FD46 04             B   793    			ld b,(iy+var_p)				;else i
0022CF C9                  B   794    			ret
                           B   795    
0022D0                     B   796    x3_z_not_five
                           B   797    
0022D0 FE06                B   798    			cp 6
0022D2 20 05               B   799    			jr nz,x3_z_not_six
0022D4 21 A9 24 00         B   800    			ld hl,x3_z6					;no ind
0022D8 C9                  B   801    			ret
                           B   802    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  82


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
0022D9                     B   803    x3_z_not_six
                           B   804    
0022D9 21 AD 24 00         B   805    			ld hl,x3_z7					;x=3, z
0022DD C9                  B   806    			ret
                           B   807    
                           B   808    
                           B   809    ;==============================================
                           B   810    
                           B   811    
0022DE                     B   812    show_hex_byte
                           B   813    
0022DE E5                  B   814    			push hl
0022DF 21 5A 28 00         B   815    			ld hl,output_byte_txt
0022E3 E5                  B   816    			push hl
0022E4 CD 68 10 00         B   817    			call hexbyte_to_ascii
0022E8 E1                  B   818    			pop hl
0022E9 CD 25 0F 00         B   819    			call os_print_string
0022ED E1                  B   820    			pop hl
0022EE C9                  B   821    			ret
                           B   822    			
                           B   823    
0022EF                     B   824    show_ascii_char
                           B   825    
0022EF E5                  B   826    			push hl
0022F0 21 5D 28 00         B   827    			ld hl,output_char_txt
0022F4 77                  B   828    			ld (hl),a
0022F5 CD 25 0F 00         B   829    			call os_print_string
0022F9 E1                  B   830    			pop hl
0022FA C9                  B   831    			ret
                           B   832    		
                           B   833    		
0022FB DD22 57 28 00       B   834    show_ix		ld (d_work_address),ix
002300 3A 59 28 00         B   835    			ld a,(d_work_address+2)
002304 CD DE 22 00         B   836    			call show_hex_byte
002308 3A 58 28 00         B   837    			ld a,(d_work_address+1)
00230C CD DE 22 00         B   838    			call show_hex_byte
002310 3A 57 28 00         B   839    			ld a,(d_work_address)
002314 CD DE 22 00         B   840    			call show_hex_byte
002318 C9                  B   841    			ret
                           B   842    			
                           B   843    ;----------------------------------------------
                           B   844    
                           B   845    ; SYMBOLS:
                           B   846    
                           B   847    ; # = CC_table
                           B   848    ; ~ = r table (registers)
                           B   849    ; @ = RP table (register pairs 1)
                           B   850    ; * = RP2 table (registers pairs 2)
                           B   851    ; : = ALU table
                           B   852    ; % = ROT table
                           B   853    ; _ = HL,IX/IY substitute selected by prefix
                           B   854    ;  = HL, IY/IX substitute based on prefix (IX/
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  83


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
                           B   855    ; $ = (HL),(IX+d),(IY+d) substitute selected by
                           B   856    ; h = H,IXH/IYH substitute selected by prefix
                           B   857    ; l = L,IXL,IYL substitute selected by prefix
                           B   858    ; & = ADL prefix 
                           B   859    
                           B   860    ; ^ = n (8 bit immediate)
                           B   861    ; ! = nn (16 or 24 bit immediate)
                           B   862    ; d = 8 bit signed jump displacement from PC
                           B   863    ; / = 8 bit signed byte used for IX+d, IY+d ins
                           B   864    ; > = single digit used by BIT,SET,RES instruct
                           B   865    ; < = RP3 table (register pairs 3)
                           B   866    ; } = RP4 table (register pairs 4)
                           B   867    ; ; = RST table
                           B   868    
002319                     B   869    opcode_vars
                           B   870    
002319 00                  B   871    prefix_bits_loc	db 0	
00231A 00                  B   872    var_x_loc		db 0	
00231B 00                  B   873    var_y_loc		db 0	
00231C 00                  B   874    var_z_loc		db 0	
00231D 00                  B   875    var_p_loc		db 0	
00231E 00                  B   876    var_q_loc		db 0
00231F 00                  B   877    var_calc_loc	db 0
002320 01                  B   878    var_adl_loc		db 1
                           B   879    
       00000000            B   880    prefix_bits		equ opcode_vars-prefix_bits_loc
       00000001            B   881    var_x			equ var_x_loc-opcode_vars
       00000002            B   882    var_y			equ var_y_loc-opcode_vars
       00000003            B   883    var_z			equ var_z_loc-opcode_vars
       00000004            B   884    var_p			equ var_p_loc-opcode_vars
       00000005            B   885    var_q			equ var_q_loc-opcode_vars
       00000006            B   886    var_calc		equ var_calc_loc-opcode_vars
       00000007            B   887    var_adl			equ var_adl_loc-opcode_vars
                           B   888    
                           B   889    ;---- Unprefixed opcodes ----------------------
                           B   890    
                           B   891    
002321 4E4FD0              B   892    x0_z0		db 'NO','P'+80h				; y0
002324 45582041 462C4146   B   893    			db 'EX AF,AF',27h+80h		; y1 
00232C A7 
00232D 444A4E5A 206480     B   894    			db 'DJNZ ','d',80h			; y2
002334 4A522064 80         B   895    			db 'JR ','d',80h			; y3
002339 4A522023 06 2C6480   B   896    			db 'JR #',var_calc,',d',80h	; y4-y7
                           B   897    			
002341 4C442620 40 04      B   898    x0_z1_yn6	db 'LD& @',var_p,',!',80h	; q=0
002347 2C2180 
00234A 41444426 205F2C40   B   899    			db 'ADD& _,@',var_p,80h		; q=1
002352 04 80 
002354 4C442620 7C2C2480   B   900    x0_z1_y6	db 'LD& |,$',80h			; y=6
                           B   901    			
00235C 4C442620 28424329   B   902    x0_z2		db 'LD& (BC)','A'+80h		;y=0
002364 C1 
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  84


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
002365 4C442620 412C2842   B   903    			db 'LD& A,(BC',')'+80h		;y=1
00236D 43A9 
00236F 4C442620 28444529   B   904    			db 'LD& (DE),','A'+80h		;y=2
002377 2CC1 
002379 4C442620 412C2844   B   905    			db 'LD& A,(DE',')'+80h		;y=3
002381 45A9 
002383 4C442620 2821292C   B   906    			db 'LD& (!),','_'+80h		;y=4
00238B DF 
00238C 4C442620 5F2C2821   B   907    			db 'LD& _,(!',')'+80h		;y=5
002394 A9 
002395 4C442620 2821292C   B   908    			db 'LD& (!),','A'+80h		;y=6
00239D C1 
00239E 4C442620 412C2821   B   909    			db 'LD& A,(!',')'+80h		;y=7
0023A6 A9 
                           B   910    
0023A7 494E4326 2040 04    B   911    x0_z3		db 'INC& @',var_p,80h		;q=0
0023AE 80 
0023AF 44454326 2040 04    B   912    			db 'DEC& @',var_p,80h		;q=1
0023B6 80 
                           B   913    			
0023B7 494E4326 207E 02    B   914    x0_z4		db 'INC& ~',var_y,80h		
0023BE 80 
                           B   915    
0023BF 44454326 207E 02    B   916    x0_z5		db 'DEC& ~',var_y,80h		
0023C6 80 
                           B   917    			
0023C7 4C442620 7E 02      B   918    x0_z6		db 'LD& ~',var_y,',^',80h	
0023CD 2C5E80 
0023D0 4C442620 242C7C80   B   919    alt_x0_z6	db 'LD& $,|',80h			; when 
                           B   920    		
0023D8 524C43C1            B   921    x0_z7		db 'RLC','A'+80h		;y=0
0023DC 525243C1            B   922    			db 'RRC','A'+80h		;y=1
0023E0 524CC1              B   923    			db 'RL','A'+80h			;y=2
0023E3 5252C1              B   924    			db 'RR','A'+80h			;y=3
0023E6 4441C1              B   925    			db 'DA','A'+80h			;y=4
0023E9 4350CC              B   926    			db 'CP','L'+80h			;y=5
0023EC 5343C6              B   927    			db 'SC','F'+80h			;y=6 (and n
0023EF 4343C6              B   928    			db 'CC','F'+80h			;y=7 (and n
                           B   929    			
0023F2 4C442620 5F2C2480   B   930    alt_x0_z7	db 'LD& _,$',80h		;y=6 (DD/FD
0023FA 4C442620 242C5F80   B   931    			db 'LD& $,_',80h		;y=7 ("" ""
                           B   932    
                           B   933    
002402 4C442620 7E 02      B   934    x1_table	db 'LD& ~',var_y,',~',var_z,80h		002408 2C7E 03 80 
00240C 48414CD4            B   935    x1_y6_z6	db 'HAL','T'+80h					                           B   936    
                           B   937    
                           B   938    
002410 3A 02 7E 03 80      B   939    x2_table	db ':',var_y,'~',var_z,80h			                           B   940    			
                           B   941    		
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  85


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
                           B   942    		
002415 52455420 23 02 80   B   943    x3_z0		db 'RET #',var_y,80h
                           B   944    
00241C 504F5026 202A 04    B   945    x3_z1_q0	db 'POP& *',var_p,80h			
002423 80 
002424 5245D4              B   946    x3_z1_q1	db 'RE','T'+80h			;p=0
002427 4558D8              B   947    			db 'EX','X'+80h			;p=1
00242A 4A502620 5F80       B   948    			db 'JP& _',80h			;p=2
002430 4C442620 53502C5F   B   949    			db 'LD& SP,_',80h		;p=3
002438 80 
                           B   950    
002439 4A502620 23 02      B   951    x3_z2		db 'JP& #',var_y,',!',80h		
00243F 2C2180 
                           B   952    
002442 4A502620 2180       B   953    x3_z3		db 'JP& !',80h			;y = 0
002448 43422070 667880     B   954    			db 'CB pfx',80h			;y = 1
00244F 4F555420 285E292C   B   955    			db 'OUT (^),','A'+80h	;y = 2
002457 C1 
002458 494E2041 2C285EA9   B   956    			db 'IN A,(^',')'+80h	;y = 3
002460 45582620 28535029   B   957    			db 'EX& (SP),','_',80h	;y = 4
002468 2C5F80 
00246B 45582044 452C48CC   B   958    			db 'EX DE,H','L'+80h	;y = 5
002473 44C9                B   959    			db 'D','I'+80h			;y = 6
002475 45C9                B   960    			db 'E','I'+80h			;y = 7
                           B   961    
002477 43414C4C 262023 02   B   962    x3_z4		db 'CALL& #',var_y,',!',80h
00247F 2C2180 
                           B   963    
002482 50555348 26202A 04   B   964    x3_z5_q0	db 'PUSH& *',var_p,80h			
00248A 80 
00248B 43414C4C 26202180   B   965    x3_z5_q1	db 'CALL& !',80h			;p=0
002493 44442070 667880     B   966    			db 'DD pfx',80h			;p=1
00249A 45442070 667880     B   967    			db 'ED pfx',80h			;p=2
0024A1 20464420 70667880   B   968    			db' FD pfx',80h			;p=3
                           B   969    
0024A9 3A 02 5E80          B   970    x3_z6		db ':',var_y,'^',80h	;ALU_table(
                           B   971    
0024AD 52535420 3B 02 80   B   972    x3_z7		db 'RST ;',var_y,80h		; rst_t
                           B   973    
                           B   974    
                           B   975    ;--- CB - Prefixed op-codes--------------------
                           B   976    
                           B   977    
0024B4 25 02 2C7E 03 80    B   978    cb_group		db '%',var_y,',~',var_z,80h		0024BA 42495426 203E 02    B   979    				db 'BIT& >',var_y,',~',var_z,80
0024C1 2C7E 03 80 
0024C5 52455326 203E 02    B   980    				db 'RES& >',var_y,',~',var_z,80
0024CC 2C7E 03 80 
0024D0 53455426 203E 02    B   981    				db 'SET& >',var_y,',~',var_z,80
0024D7 2C7E 03 80 
                           B   982    
                           B   983    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  86


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
                           B   984    ;---- ED - Prefixed op-codes-------------------
                           B   985    
0024DB 494E3020 7E 02      B   986    ed_x0_z0_yn6	db 'IN0 ~',var_y,',(^',')'+80h
0024E1 2C285EA9 
0024E5 494E3020 285EA9     B   987    ed_x0_z0_y6		db 'IN0 (^',')'+80h	
                           B   988    
0024EC 4F555430 207E 02    B   989    ed_x0_z1		db 'OUT0 ~',var_y,',(^',')'+80h
0024F3 2C285EA9 
0024F7 4C442620 49592C28   B   990    				db 'LD& IY,(_',')'+80h			0024FF 5FA9 
                           B   991    
002501 4C454126 203C 04    B   992    ed_x0_z2		db 'LEA& <',var_p,',IX/',80h	002508 2C49582F 80 
00250D 4C454126 207D 04    B   993    ed_x0_z3		db 'LEA& }',var_p,',IY/',80h
002514 2C49592F 80 
002519 54535426 20412C7E   B   994    ed_x0_z4		db 'TST& A,~',var_y,80h
002521 02 80 
                           B   995    
002523 4C442620 285F292C   B   996    ed_x0_z6		db 'LD& (_),}',var_p,80h
00252B 7D 04 80 
                           B   997    
00252E 4C442620 285F292C   B   998    ed_x0_z7		db 'LD& (_),<',var_p,80h		002536 3C 04 80 
002539 4C442620 49582C28   B   999    				db 'LD& IX,(_',')'+80h			002541 5FA9 
                           B  1000    
                           B  1001    
002543 494E207E 02         B  1002    ed_x1_z0_yn6	db 'IN ~',var_y,',(BC',')'+80h
002548 2C284243 A9 
00254D 494E2028 43A9       B  1003    ed_x1_z0_y6		db 'IN (C',')'+80h
                           B  1004    
002553 4F555420 2843292C   B  1005    ed_x1_z1_yn6	db 'OUT (C),~',var_y,80h
00255B 7E 02 80 
00255E 4F555420 2843292C   B  1006    ed_x1_z1_y6		db 'OUT (C),','0'+80h
002566 B0 
                           B  1007    
002567 53424326 20484C2C   B  1008    ed_x1_z2		db 'SBC& HL,@',var_p,80h		00256F 40 04 80 
002572 41444326 20484C2C   B  1009    				db 'ADC& HL,@',var_p,80h		00257A 40 04 80 
                           B  1010    
00257D 4C442620 2821292C   B  1011    ed_x1_z3		db 'LD& (!),@',var_p,80h		002585 40 04 80 
002588 4C442620 40 04      B  1012    				db 'LD& @',var_p,'(!',')'+80h	00258E 2821A9 
                           B  1013    
002591 4E45C7              B  1014    ed_x1_z4		db 'NE','G'+80h				;y=
002594 4D4C5420 42C3       B  1015    				db 'MLT B','C'+80h			;y=
00259A 4C454126 2049582C   B  1016    				db 'LEA& IX,IY/',80h			0025A2 49592F80 
0025A6 4D4C5420 44C5       B  1017    				db 'MLT D','E'+80h			;y=
0025AC 54535426 20412C5E   B  1018    				db 'TST& A,^',80h			;y=
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  87


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
0025B4 80 
0025B5 4D4C5420 48CC       B  1019    				db 'MLT H','L'+80h			;y=
0025BB 54535449 4F205E80   B  1020    				db 'TSTIO ^',80h			;y=
0025C3 4D4C5420 53D0       B  1021    				db 'MLT S','P'+80h 			;y=
                           B  1022    
0025C9 5245544E 2680       B  1023    ed_x1_z5		db 'RETN&',80h				;y=
0025CF 52455449 2680       B  1024    				db 'RETI&',80h				;y=
0025D5 4C454126 2049592C   B  1025    				db 'LEA& IY,IX/',80h		;y=
0025DD 49582F80 
0025E1 BF                  B  1026    				db '?'+80h					;y=
0025E2 50454126 2049582F   B  1027    				db 'PEA& IX/',80h			;y=
0025EA 80 
0025EB 4C44204D 422CC1     B  1028    				db 'LD MB,','A'+80h			;y=
0025F2 BF                  B  1029    				db '?'+80h					;y=
0025F3 53544D49 D8         B  1030    				db 'STMI','X'+80h			;y=
                           B  1031    				
                           B  1032    	
0025F8 494D20B0            B  1033    ed_x1_z6		db 'IM ','0'+80h			;y=
0025FC BF                  B  1034    				db '?'+80h					;y=
0025FD 494D20B1            B  1035    				db 'IM ','1'+80h			;y=
002601 494D20B2            B  1036    				db 'IM ','2'+80h			;y=
002605 50454126 2049592F   B  1037    				db 'PEA& IY/',80h			;y=
00260D 80 
00260E 4C442041 2C4DC2     B  1038    				db 'LD A,','M','B'+80h		;y=
002615 534CD0              B  1039    				db 'SL','P'+80h				;y=
002618 52534D49 D8         B  1040    				db 'RSMI','X'+80h			;y=
                           B  1041    
00261D 4C442049 2CC1       B  1042    ed_x1_z7		db 'LD I,','A'+80h			;y=
002623 4C442052 2CC1       B  1043    				db 'LD R,','A'+80h			;y=
002629 4C442041 2CC9       B  1044    				db 'LD A,','I'+80h			;y=
00262F 4C442041 2CD2       B  1045    				db 'LD A,','R'+80h			;y=
002635 5252C4              B  1046    				db 'RR','D'+80h				;y=
002638 524CC4              B  1047    				db 'RL','D'+80h				;y=
00263B 4E4FD0              B  1048    				db 'NO','P'+80h				;y=
00263E 4E4FD0              B  1049    				db 'NO','P'+80h				;y=
                           B  1050    
                           B  1051    
002641 BFBFBFBF            B  1052    ed_x2_z0		db '?'+80h,'?'+80h,'?'+80h,'?'+
002645 4C444926 80         B  1053    				db 'LDI&',80h					00264A 4C444426 80         B  1054    				db 'LDD&',80h					00264F 4C444952 2680       B  1055    				db 'LDIR&',80h					002655 4C444452 2680       B  1056    				db 'LDDR&',80h					                           B  1057    
00265B BFBFBFBF            B  1058    ed_x2_z1		db '?'+80h,'?'+80h,'?'+80h,'?'+
00265F 43504926 80         B  1059    				db 'CPI&',80h					002664 43504426 80         B  1060    				db 'CPD&',80h					002669 43504952 2680       B  1061    				db 'CPIR&',80h					00266F 43504452 2680       B  1062    				db 'CPDR&',80h					                           B  1063    
002675 494E494D 2680       B  1064    ed_x2_z2		db 'INIM&',80h		; y0	
00267B 494E444D 2680       B  1065    				db 'INDM&',80h		; y1
002681 494E494D 522680     B  1066    				db 'INIMR&',80h		; y2
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  88


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
002688 494E444D 522680     B  1067    				db 'INDMR&',80h		; y3
00268F 494E4926 80         B  1068    				db 'INI&',80h		; y4
002694 494E4426 80         B  1069    				db 'IND&',80h		; y5
002699 494E4952 2680       B  1070    				db 'INIR&',80h		; y6
00269F 494E4452 2680       B  1071    				db 'INDR&',80h		; y7
                           B  1072    
                           B  1073    
0026A5 4F54494D 2680       B  1074    ed_x2_z3		db 'OTIM&',80h		; y0
0026AB 4F54444D 2680       B  1075    				db 'OTDM&',80h		; y1
0026B1 4F54494D 522680     B  1076    				db 'OTIMR&',80h		; y2
0026B8 4F54444D 522680     B  1077    				db 'OTDMR&',80h		; y3
0026BF 4F555449 2680       B  1078    				db 'OUTI&',80h		; y4
0026C5 4F555444 2680       B  1079    				db 'OUTD&',80h		; y5
0026CB 4F544952 2680       B  1080    				db 'OTIR&',80h		; y6
0026D1 4F544452 2680       B  1081    				db 'OTDR&',80h		; y7
                           B  1082    
0026D7 494E4932 2680       B  1083    ed_x2_z4		db 'INI2&',80h		; y0
0026DD 494E4432 2680       B  1084    				db 'IND2&',80h		; y1
0026E3 494E4932 522680     B  1085    				db 'INI2R&',80h		; y2
0026EA 494E4432 522680     B  1086    				db 'IND2R&',80h		; y3
0026F1 4F555449 322680     B  1087    				db 'OUTI2&',80h		; y4
0026F8 4F555444 322680     B  1088    				db 'OUTD2&',80h		; y5
0026FF 4F544932 522680     B  1089    				db 'OTI2R&',80h		; y6
002706 4F544432 522680     B  1090    				db 'OTD2R&',80h		; y7
                           B  1091    
                           B  1092    
00270D 494E4952 582680     B  1093    ed_x3_z2		db 'INIRX&',80h 	; y0
002714 494E4452 582680     B  1094    				db 'INDRX&',80h		; y1
                           B  1095    
00271B 4F544952 582680     B  1096    ed_x3_z3		db 'OTIRX&',80h		; y0
002722 4F544452 582680     B  1097    				db 'OTDRX&',80h		; y1
                           B  1098    			
                           B  1099    
                           B  1100    ;--- DDCB or FDCB - Prefixed op-codes----------
                           B  1101    
                           B  1102    
002729 4C442620 7E 03      B  1103    ddcb_fdcb_zn6	db 'LD& ~',var_z, ',%',var_y,' 
00272F 2C25 02 202480 
002735 42495426 203E 02    B  1104    				db 'BIT& >',var_y,',$',80h		00273C 2C2480 
00273F 4C442620 7E 03      B  1105    				db 'LD& ~',var_z,',RES& >',var_
002745 2C524553 26203E 02 
00274D 2C2480 
002750 4C442620 7E 03      B  1106    				db 'LD& ~',var_z,',SET& >',var_
002756 2C534554 26203E 02 
00275E 2C2480 
                           B  1107    
002761 25 02 202480        B  1108    ddcb_fdcb_z6	db '%',var_y,' $',80h			002766 42495426 203E 02    B  1109    				db 'BIT& >',var_y,',$',80h		00276D 2C2480 
002770 52455326 203E 02    B  1110    				db 'RES& >',var_y,',$',80h		002777 2C2480 
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  89


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
00277A 53455426 203E 02    B  1111    				db 'SET& >',var_y,',$',80h		002781 2C2480 
                           B  1112    
                           B  1113    ;----------------------------------------------
                           B  1114    
002784 3F3FBF              B  1115    bad_opcode	db '??','?'+80h
                           B  1116    
                           B  1117    ;----------------------------------------------
                           B  1118    
                           B  1119    
002787 C2C3C4C5 68806C80   B  1120    table_r		db 'B'+80h, 'C'+80h, 'D'+80h, 'E'+8
00278F 2480C1 
                           B  1121    
002792 42C344C5 DF53D0     B  1122    table_rp	db 'B','C'+80h, 'D','E'+80h, '_'+80
                           B  1123    
002799 42C344C5 5F8041C6   B  1124    table_rp2	db 'B','C'+80h, 'D','E'+80h, '_',+8
                           B  1125    	
0027A1 4EDADA4E C3C350CF   B  1126    table_cc	db 'N','Z'+80h, 'Z'+80h, 'N','C'+80
0027A9 50C5D0CD 
                           B  1127    	
0027AD 41444426 2041AC41   B  1128    table_alu	db 'ADD& A',','+80h, 'ADC& A',','+8
0027B5 44432620 41AC5355 
0027BD 4226A053 42432041 
0027C5 26AC 
0027C7 414E4426 A0584F52   B  1129    			db 'AND&',' '+80h, 'XOR&',' '+80h, 
0027CF 26A04F52 26A04350 
0027D7 26A0 
                           B  1130    			
0027D9 524C4326 80525243   B  1131    table_rot	db 'RLC&',80h, 'RRC&',80h, 'RL&',80
0027E1 2680524C 26805252 
0027E9 2680 
0027EB 534C4126 80535241   B  1132    			db 'SLA&',80h, 'SRA&',80h, 'SLL&',8
0027F3 2680534C 4C268053 
0027FB 524C2680 
                           B  1133    	
0027FF 42C344C5 48CC49D8   B  1134    table_rp3	db 'B','C'+80h, 'D','E'+80h, 'H','L
                           B  1135    
002807 42C344C5 48CC49D9   B  1136    table_rp4	db 'B','C'+80h, 'D','E'+80h, 'H','L
                           B  1137    			
00280F 30B0                B  1138    table_rst	db '0','0'+80h
002811 30B8                B  1139    			db '0','8'+80h
002813 31B0                B  1140    			db '1','0'+80h
002815 31B8                B  1141    			db '1','8'+80h
002817 32B0                B  1142    			db '2','0'+80h
002819 32B8                B  1143    			db '2','8'+80h	
00281B 33B0                B  1144    			db '3','0'+80h
00281D 33B8                B  1145    			db '3','8'+80h			
                           B  1146    
                           B  1147    ;----------------------------------------------
                           B  1148    
                           B  1149    ; "_" = HL, IX, IY depending on prefix 
                           B  1150    ; "|" = as above with IX/IY switched
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  90


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\d.asm
                           B  1151    
                           B  1152    ; "h" = H, IXH, IYL depending on prefix
                           B  1153    ; "l" = L, IXL, IYL depending on prefix
                           B  1154    ; "$" = (HL), (IX+d), (IY+d) depending on prefi
                           B  1155    
00281F 48CC49D8 49D9       B  1156    hl_subs		db 'H','L'+80h, 'I','X'+80h, 'I','Y
002825 48CC49D9 49D8       B  1157    inv_hl_subs	db 'H','L'+80h, 'I','Y'+80h, 'I','X
00282B C84958C8 4959C8     B  1158    h_subs		db 'H'+80h, 'IX','H'+80h, 'IY','H'+
002832 CC4958CC 4959CC     B  1159    l_subs		db 'L'+80h, 'IX','L'+80h, 'IY','L'+
002839 28484CA9 2849582F   B  1160    ind_hl_subs	db '(HL',')'+80h, '(IX/',')'+80h, '
002841 A9284959 2FA9 
                           B  1161    
                           B  1162    ;----------------------------------------------
                           B  1163    
002847                     B  1164    adl_prefix_list
                           B  1165    
002847 2E5349D3 2E4C49D3   B  1166    			db '.SI','S'+80h, '.LI','S'+80h, '.
00284F 2E5349CC 2E4C49CC 
                           B  1167    
                           B  1168    ;----------------------------------------------
                           B  1169    
002857 000000              B  1170    d_work_address	dw24 0
                           B  1171    
00285A 2D2D00              B  1172    output_byte_txt	db "--",0
00285D 2D00                B  1173    output_char_txt	db "-",0
                           B  1174    
00285F 000001              B  1175    dis_addr		dw24 10000h
                           B  1176    
                           B  1177    ;----------------------------------------------
                           B  1178    
                           B     0    	include 'commands\del.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"del" delete file command. V0.02 - ADL mode
                           B     3    ;----------------------------------------------
                           B     4    
                           B     5    
002862                     B     6    os_cmd_del
                           B     7    	
002862 CD 6A 16 00         B     8    				call os_check_volume_format	
002866 C0                  B     9    				ret nz
                           B    10    			
002867 CD 6F 28 00         B    11    				call filename_or_bust
                           B    12    				
00286B C3 D2 16 00         B    13    				jp os_erase_file			;no
                           B    14    				
                           B    15    				
                           B    16    ;----------------------------------------------
                           B    17    			
00286F                     B    18    filename_or_bust
                           B    19    			
00286F 7E                  B    20    				ld a,(hl)					;is
002870 B7                  B    21    				or a
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  91


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\del.asm
002871 C0                  B    22    				ret nz
002872 E1                  B    23    				pop hl						;ot
002873 C3 D5 15 00         B    24    				jp os_no_fn_error			;so
                           B    25    
                           B    26    ;----------------------------------------------
                           B     0    	include 'commands\dir.asm'
                           B     1    ;----------------------------------------------
                           B     2    ; FAT16 'dir' - show directory command. v0.03 -
                           B     3    ;----------------------------------------------
                           B     4    
002877                     B     5    os_cmd_dir
                           B     6    
002877 CD 6A 16 00         B     7    				call os_check_volume_format	
00287B C0                  B     8    				ret nz
                           B     9    				
00287C CD 56 29 00         B    10    				call div_line
002880 CD D3 51 00         B    11    				call fs_get_current_dir_name	002884 D8                  B    12    				ret c
002885 C0                  B    13    				ret nz
002886 CD 25 0F 00         B    14    				call os_print_string
00288A CD 3A 1A 00         B    15    				call fs_get_dir_cluster			00288E 7A                  B    16    				ld a,d
00288F B3                  B    17    				or e
002890 20 08               B    18    				jr nz,dcmdnr
002892 CD C6 4E 00         B    19    				call fs_get_volume_label
002896 CD 25 0F 00         B    20    				call os_print_string
00289A CD B8 13 00         B    21    dcmdnr			call os_new_line
                           B    22    				
00289E CD 56 29 00         B    23    nrootdir		call div_line
0028A2 CD CB 4D 00         B    24    				call fs_goto_first_dir_entry
0028A6 D8                  B    25    				ret c
0028A7 20 6F               B    26    				jr nz,os_dlr
0028A9 AF                  B    27    				xor a
0028AA 32 B5 5F 00         B    28    				ld (os_linecount),a
                           B    29    				
0028AE CD E2 4D 00         B    30    os_dfllp		call fs_get_dir_entry			0028B2 D8                  B    31    				ret c
0028B3 20 63               B    32    				jr nz,os_dlr					0028B5 C5                  B    33    				push bc
0028B6 CD 25 0F 00         B    34    				call os_print_string			0028BA CD E3 13 00         B    35    				call os_get_cursor_position		0028BE 060E                B    36    				ld b,14
0028C0 CD C3 13 00         B    37    				call os_set_cursor_position	
0028C4 C1                  B    38    				pop bc
0028C5 CB40                B    39    				bit 0,b							0028C7 28 06               B    40    				jr z,os_deif		
0028C9 21 63 29 00         B    41    				ld hl,dir_txt					0028CD 18 32               B    42    				jr os_dpl
                           B    43    				
0028CF 21 C1 54 00         B    44    os_deif			ld hl,os_hex_prefix_txt			0028D3 CD 25 0F 00         B    45    				call os_print_string
0028D7 ED53 1D 67 00       B    46    				ld (scratch_pad),de
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  92


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\dir.asm
0028DC 79                  B    47    				ld a,c
0028DD 32 20 67 00         B    48    				ld (scratch_pad+3),a
0028E1 21 20 60 00         B    49    				ld hl,output_line
0028E5 E5                  B    50    				push hl
0028E6 ED5B 1F 67 00       B    51    				ld de,(scratch_pad+2)
0028EB CD 8D 10 00         B    52    				call hexword_to_ascii
0028EF ED5B 1D 67 00       B    53    				ld de,(scratch_pad)
0028F4 CD 8D 10 00         B    54    				call hexword_to_ascii
0028F8 3600                B    55    				ld (hl),0
0028FA E1                  B    56    				pop hl
0028FB 0607                B    57    				ld b,7							0028FD CD 45 10 00         B    58    				call os_skip_leading_ascii_zero
002901 CD 25 0F 00         B    59    os_dpl			call os_print_string
002905 CD B8 13 00         B    60    				call os_new_line
                           B    61    				
002909 CD 6F 4E 00         B    62    				call fs_goto_next_dir_entry
00290D 20 09               B    63    				jr nz,os_dlr					00290F CD B6 11 00         B    64    				call os_count_lines
002913 3E79                B    65    				ld a,'y'
002915 B8                  B    66    				cp b
002916 28 96               B    67    				jr z,os_dfllp
                           B    68    				
002918 CD 56 29 00         B    69    os_dlr			call div_line					00291C CD FE 47 00         B    70    				call fs_calc_free_space
002920 D8                  B    71    				ret c	
002921 CD 2F 29 00         B    72    				call show_hlde_decimal
002925 21 69 29 00         B    73    				ld hl,kb_spare_txt
002929 CD 25 0F 00         B    74    				call os_print_string
00292D AF                  B    75    				xor a
00292E C9                  B    76    				ret
                           B    77    
                           B    78    ;----------------------------------------------
                           B    79    
00292F                     B    80    show_hlde_decimal
                           B    81    
00292F CD 4B 12 00         B    82    				call os_hex_to_decimal			002933 11070000            B    83    				ld de,7
002937 19                  B    84    				add hl,de						002938 43                  B    85    				ld b,e
002939 11 20 60 00         B    86    				ld de,output_line
00293D D5                  B    87    				push de
00293E 7E                  B    88    dec2strlp		ld a,(hl)						00293F B7                  B    89    				or a
002940 20 03               B    90    				jr nz,foundlnz
002942 2B                  B    91    				dec hl
002943 10 F9               B    92    				djnz dec2strlp
002945 04                  B    93    foundlnz		inc b
002946 7E                  B    94    ndecchar		ld a,(hl)						002947 C630                B    95    				add a,030h
002949 12                  B    96    				ld (de),a
00294A 13                  B    97    				inc de
00294B 2B                  B    98    				dec hl
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  93


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\dir.asm
00294C 10 F8               B    99    				djnz ndecchar
00294E AF                  B   100    				xor a
00294F 12                  B   101    				ld (de),a
002950 E1                  B   102    				pop hl							002951 CD 25 0F 00         B   103    				call os_print_string
002955 C9                  B   104    				ret
                           B   105    
                           B   106    ;----------------------------------------------
                           B   107    			
002956 0E2D                B   108    div_line		ld c,'-'
002958 0613                B   109    				ld b,19
00295A CD 22 1A 00         B   110    				call os_print_multiple_chars
00295E CD B8 13 00         B   111    				call os_new_line
002962 C9                  B   112    				ret
                           B   113    
                           B   114    ;----------------------------------------------
                           B   115    
002963 5B444952 5D00       B   116    dir_txt			db '[DIR]',0
                           B   117    
002969 204B4220 46726565   B   118    kb_spare_txt	db ' KB Free',11,0
002971 0B00 
                           B   119    
                           B   120    ;----------------------------------------------
                           B   121    	
                           B     0    	include 'commands\f.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"f" fill memory command. V0.02 - ADL mode
                           B     3    ;----------------------------------------------
                           B     4    
002973                     B     5    os_cmd_f			
                           B     6    
002973 CD 27 1C 00         B     7    				call get_start_and_end			                           B     8    			
002977 CD 50 1C 00         B     9    				call hexword_or_bust			00297B CA F5 15 00         B    10    				jp z,os_no_args_error			00297F 7B                  B    11    				ld a,e
002980 32 CC 5F 00         B    12    				ld (fillbyte),a
                           B    13    					
002984 CD 15 1C 00         B    14    				call test_mem_range
002988 DA F1 15 00         B    15    				jp c,os_range_error				                           B    16    					
00298C 3A CC 5F 00         B    17    				ld a,(fillbyte)
002990 77                  B    18    f_floop			ld (hl),a
002991 EDA1                B    19    				cpi								002993 EA 90 29 00         B    20    				jp pe,f_floop
                           B    21    					
002997 3E20                B    22    				ld a,020h						002999 B7                  B    23    				or a
00299A C9                  B    24    				ret
                           B    25    
                           B    26    ;----------------------------------------------
                           B     0    	include 'commands\format.asm'
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  94


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\format.asm
                           B     1    ;----------------------------------------------
                           B     2    ;"format" - format disk command. V0.04 - ADL mo
                           B     3    ;
                           B     4    ; The internal format routine is limited to for
                           B     5    ; No partition data is allowed.
                           B     6    ;----------------------------------------------
                           B     7    
                           B     8    
00299B                     B     9    os_cmd_format
                           B    10    
00299B 7E                  B    11    				ld a,(hl)						00299C B7                  B    12    				or a
00299D 20 04               B    13    				jr nz,fgotargs					00299F 3E1F                B    14    				ld a,01fh						0029A1 B7                  B    15    				or a
0029A2 C9                  B    16    				ret
                           B    17    			
0029A3                     B    18    fgotargs	
0029A3 11 34 53 00         B    19    				ld de,fs_sought_filename
0029A7 CD 1C 52 00         B    20    				call fs_clear_filename			0029AB E5                  B    21    				push hl							0029AC CD A6 0F 00         B    22    				call os_next_arg
0029B0 20 04               B    23    				jr nz,fgotlab
0029B2 21 E3 2A 00         B    24    				ld hl,default_label
0029B6 060B                B    25    fgotlab			ld b,11
0029B8 CD FE 11 00         B    26    				call os_copy_ascii_run
0029BC E1                  B    27    				pop hl
                           B    28    				
0029BD 3A D7 5D 00         B    29    				ld a,(device_count)				0029C1 B7                  B    30    				or a
0029C2 28 25               B    31    				jr z,fno_dev
0029C4 47                  B    32    				ld b,a
0029C5 0E00                B    33    				ld c,0							0029C7 DD21 87 5E 00       B    34    				ld ix,host_device_hardware_info
0029CC DD7E00              B    35    fdev_lp			ld a,(ix)						0029CF CD 0C 1A 00         B    36    				call locate_driver_base			0029D3 D5                  B    37    				push de
0029D4 FDE1                B    38    				pop iy
0029D6 ED130C              B    39    				lea de,iy+0ch					0029D9 C5                  B    40    				push bc
0029DA 0607                B    41    				ld b,7
0029DC CD DF 11 00         B    42    				call os_compare_strings
0029E0 C1                  B    43    				pop bc
0029E1 28 0A               B    44    				jr z,format_dev
0029E3 ED3220              B    45    				lea ix,ix+20h					0029E6 0C                  B    46    				inc c
0029E7 10 E3               B    47    				djnz fdev_lp
                           B    48    			
0029E9 3ED0                B    49    fno_dev			ld a,0d0h						0029EB B7                  B    50    				or a
0029EC C9                  B    51    				ret
                           B    52    				
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  95


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\format.asm
                           B    53    			
                           B    54    				
                           B    55    ;----- FORMAT A DEVICE (USE ENTIRE CAPACITY (TR
                           B    56    			
                           B    57    			
0029ED C5                  B    58    format_dev		push bc
0029EE CD B8 13 00         B    59    				call os_new_line
0029F2 21 B4 2A 00         B    60    				ld hl,form_dev_warn1
0029F6 CD EF 13 00         B    61    				call os_show_packed_text
0029FA C1                  B    62    				pop bc
                           B    63    				
0029FB 79                  B    64    				ld a,c							0029FC C630                B    65    				add a,030h
0029FE 32 E3 5D 00         B    66    				ld (dev_txt+3),a
002A02 21 E0 5D 00         B    67    				ld hl,dev_txt	
002A06 CD 25 0F 00         B    68    				call os_print_string			                           B    69    				
002A0A 79                  B    70    				ld a,c
002A0B CD 80 1A 00         B    71    				call dev_to_driver_lookup		002A0F E5                  B    72    				push hl
002A10 32 D6 5D 00         B    73    				ld (current_driver),a
002A14 CD F3 19 00         B    74    				call show_dev_driver_name		002A18 DDE1                B    75    				pop ix
002A1A DD1701              B    76    				ld de,(ix+1)
002A1D FD21 C8 5F 00       B    77    				ld iy,xrr_temp
002A22 FD1F00              B    78    				ld (iy),de						002A25 FDCB023E            B    79    				srl (iy+2)
002A29 FDCB011E            B    80    				rr (iy+1)
002A2D FDCB001E            B    81    				rr (iy+0)						002A31 FD1700              B    82    				ld de,(iy)						002A34 CD 2F 29 00         B    83    				call show_hlde_decimal			002A38 21 EE 2A 00         B    84    				ld hl,kb_txt
002A3C CD 25 0F 00         B    85    				call os_print_string
002A40 ED2205              B    86    				lea hl,ix+5		
002A43 CD 25 0F 00         B    87    				call os_print_string			002A47 3E29                B    88    				ld a,')'
002A49 CD 67 0F 00         B    89    				call os_print_char
                           B    90    				
002A4D CD B8 13 00         B    91    				call os_new_line
002A51 CD B8 13 00         B    92    				call os_new_line
002A55 21 BB 2A 00         B    93    				ld hl,form_dev_warn2
002A59 CD AB 2A 00         B    94    				call show_packed_text_and_cr
002A5D CD 93 2A 00         B    95    				call confirm_yes
002A61 20 28               B    96    				jr nz,ab_form
                           B    97    				
002A63 21 C5 2A 00         B    98    				ld hl,formatting_txt			002A67 CD 25 0F 00         B    99    				call os_print_string
                           B   100    				
002A6B CD 81 45 00         B   101    				call fs_format_device_command
002A6F 38 10               B   102    				jr c,form_err
002A71 B7                  B   103    				or a
002A72 20 0D               B   104    				jr nz,form_err
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  96


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\format.asm
                           B   105    			
002A74 21 D5 2A 00         B   106    				ld hl,ok_txt					002A78 CD 25 0F 00         B   107    				call os_print_string
                           B   108    				
002A7C CD 88 31 00         B   109    f_end			call os_cmd_remount				002A80 C9                  B   110    				ret
                           B   111    			
002A81                     B   112    form_err
002A81 21 DA 2A 00         B   113    				ld hl,ferr_txt
002A85 CD 25 0F 00         B   114    				call os_print_string
002A89 18 F1               B   115    				jr f_end
                           B   116    				
                           B   117    				
                           B   118    ;----------------------------------------------
                           B   119    				
                           B   120    				
002A8B CD B8 13 00         B   121    ab_form			call os_new_line
002A8F 3E24                B   122    				ld a,024h						002A91 B7                  B   123    				or a
002A92 C9                  B   124    				ret
                           B   125    				
002A93                     B   126    confirm_yes
                           B   127    			
002A93 21 1D 67 00         B   128    				ld hl,scratch_pad
002A97 1E03                B   129    				ld e,3
002A99 E5                  B   130    				push hl
002A9A CD F1 10 00         B   131    				call os_user_input
002A9E E1                  B   132    				pop hl
002A9F C0                  B   133    				ret nz
002AA0 0603                B   134    				ld b,3
002AA2 11 88 58 00         B   135    				ld de,yes_txt+1
002AA6 CD DF 11 00         B   136    				call os_compare_strings
002AAA C9                  B   137    				ret
                           B   138    			
                           B   139    			
002AAB                     B   140    show_packed_text_and_cr
                           B   141    			
002AAB CD EF 13 00         B   142    				call os_show_packed_text
002AAF CD B8 13 00         B   143    				call os_new_line
002AB3 C9                  B   144    				ret
                           B   145    			
                           B   146    ;----------------------------------------------
                           B   147    
002AB4                     B   148    form_dev_warn1
                           B   149    
002AB4 27283640 979700     B   150    				db 027h,028h,036h,040h,097h,097
                           B   151    
002ABB                     B   152    form_dev_warn2
                           B   153    
002ABB 52467E98 9EA2A3A5   B   154    				db 052h,046h,07eh,098h,09eh,0a2
002AC3 9700 
                           B   155    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  97


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\format.asm
002AC5                     B   156    formatting_txt
                           B   157    
002AC5 0B0B466F 726D6174   B   158    				db 11,11,'Formatting.. ',0
002ACD 74696E67 2E2E2000 
                           B   159    
002AD5 4F4B0B0B 00         B   160    ok_txt			db 'OK',11,11,0
                           B   161    
002ADA 4552524F 52210B0B   B   162    ferr_txt		db 'ERROR!',11,11,0
002AE2 00 
                           B   163    
002AE3                     B   164    default_label	
                           B   165    
002AE3 50524F53 455F4449   B   166    				db 'PROSE_DISK',0
002AEB 534B00 
                           B   167    
002AEE 4B422028 00         B   168    kb_txt			db 'KB (',0
                           B   169    
                           B   170    ;----------------------------------------------
                           B   171    
       00006721            B   172    fs_drive_sel_cache		equ scratch_pad+4		                           B   173    
                           B   174    ;----------------------------------------------
                           B   175    
                           B     0    	include 'commands\h.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"H" - Hunt in memory command V0.02 - ADL mode
                           B     3    ;----------------------------------------------
                           B     4    
002AF3 CD 27 1C 00         B     5    os_cmd_h		call get_start_and_end			002AF7 22 C5 5F 00         B     6    				ld (find_hexstringascii),hl		                           B     7    
002AFB CD 15 1C 00         B     8    				call test_mem_range
002AFF DA F1 15 00         B     9    				jp c,os_range_error				                           B    10    			
002B03 AF                  B    11    				xor a
002B04 32 A0 2B 00         B    12    				ld (h_ascii_mode),a
                           B    13    				
002B08 2A C5 5F 00         B    14    				ld hl,(find_hexstringascii)
002B0C 0600                B    15    				ld b,0
002B0E 7E                  B    16    h_lfascii		ld a,(hl)						002B0F B7                  B    17    				or a
002B10 28 28               B    18    				jr z,h_no_text					002B12 FE22                B    19    				cp 022h
002B14 28 03               B    20    				jr z,h_found_quote
002B16 23                  B    21    				inc hl
002B17 18 F5               B    22    				jr h_lfascii
002B19 23                  B    23    h_found_quote	inc hl
002B1A 22 C5 5F 00         B    24    				ld (find_hexstringascii),hl
002B1E 7E                  B    25    h_fasc_len		ld a,(hl)
002B1F B7                  B    26    				or a
002B20 CA F5 15 00         B    27    				jp z,os_no_args_error			002B24 FE22                B    28    				cp 022h
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  98


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\h.asm
002B26 28 04               B    29    				jr z,h_startas
002B28 23                  B    30    				inc hl
002B29 04                  B    31    				inc b
002B2A 18 F2               B    32    				jr h_fasc_len
                           B    33    
002B2C 78                  B    34    h_startas		ld a,b
002B2D B7                  B    35    				or a
002B2E CA F5 15 00         B    36    				jp z,os_no_args_error			002B32 3E01                B    37    				ld a,1
002B34 32 A0 2B 00         B    38    				ld (h_ascii_mode),a
002B38 18 16               B    39    				jr h_start_search
                           B    40    						
                           B    41    
002B3A 2A C5 5F 00         B    42    h_no_text		ld hl,(find_hexstringascii)
002B3E 0600                B    43    				ld b,0							002B40 CD 50 1C 00         B    44    cntfbyts		call hexword_or_bust			002B44 28 04               B    45    				jr z,gthexstr
002B46 04                  B    46    				inc b
002B47 23                  B    47    				inc hl
002B48 18 F6               B    48    				jr cntfbyts
002B4A 78                  B    49    gthexstr		ld a,b
002B4B B7                  B    50    				or a
002B4C CA F5 15 00         B    51    				jp z,os_no_args_error	
                           B    52    
                           B    53    
002B50                     B    54    h_start_search
                           B    55    	
002B50 DD2A B9 5F 00       B    56    				ld ix,(cmdop_start_address)		002B55 DDE5                B    57    fndloop1		push ix
002B57 FDE1                B    58    				pop iy
002B59 48                  B    59    				ld c,b							002B5A 2A C5 5F 00         B    60    				ld hl,(find_hexstringascii)
002B5E 3A A0 2B 00         B    61    fcmloop			ld a,(h_ascii_mode)
002B62 B7                  B    62    				or a
002B63 28 08               B    63    				jr z,h_hex
002B65 FD7E00              B    64    				ld a,(iy)
002B68 BE                  B    65    				cp (hl)
002B69 20 23               B    66    				jr nz,nofmatch
002B6B 18 0A               B    67    				jr h_matched
002B6D CD 9C 10 00         B    68    h_hex			call ascii_to_hexword			002B71 FD7E00              B    69    				ld a,(iy)
002B74 BB                  B    70    				cp e
002B75 20 17               B    71    				jr nz,nofmatch
002B77 FD23                B    72    h_matched		inc iy
002B79 23                  B    73    				inc hl
002B7A 0D                  B    74    				dec c
002B7B 20 E1               B    75    				jr nz,fcmloop
                           B    76    			
002B7D DDE5                B    77    				push ix							002B7F D1                  B    78    				pop de							002B80 DDE5                B    79    				push ix
002B82 C5                  B    80    				push bc
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page:  99


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\h.asm
002B83 CD F0 12 00         B    81    				call os_show_hex_address
002B87 CD B8 13 00         B    82    				call os_new_line
002B8B C1                  B    83    				pop bc
002B8C DDE1                B    84    				pop ix
                           B    85    				
002B8E DDE5                B    86    nofmatch		push ix
002B90 DD23                B    87    				inc ix
002B92 D1                  B    88    				pop de
002B93 2A BC 5F 00         B    89    				ld hl,(cmdop_end_address)
002B97 AF                  B    90    				xor a
002B98 ED52                B    91    				sbc hl,de
002B9A 20 B9               B    92    				jr nz,fndloop1
                           B    93    							
002B9C 3E20                B    94    				ld a,020h						002B9E B7                  B    95    				or a
002B9F C9                  B    96    				ret
                           B    97    			
                           B    98    ;----------------------------------------------
                           B    99    
002BA0 00                  B   100    h_ascii_mode	db 0
                           B   101    
                           B   102    ;----------------------------------------------
                           B     0    	include 'commands\help.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"?" - List commands. V0.03 - ADL mode
                           B     3    ;----------------------------------------------
                           B     4    
002BA1                     B     5    os_cmd_help		
002BA1 AF                  B     6    				xor a
002BA2 32 B5 5F 00         B     7    				ld (os_linecount),a
                           B     8    				
002BA6 21 C3 59 00         B     9    				ld hl,packed_help1
002BAA CD EF 13 00         B    10    show_page		call os_show_packed_text
002BAE E5                  B    11    				push hl
002BAF CD B8 13 00         B    12    				call os_new_line
002BB3 E1                  B    13    				pop hl
002BB4 23                  B    14    				inc hl						;sk
002BB5 7E                  B    15    				ld a,(hl)
002BB6 FEFF                B    16    				cp 0ffh						;la
002BB8 28 09               B    17    				jr z,last_help_page
                           B    18    				
002BBA CD B6 11 00         B    19    				call os_count_lines
002BBE 78                  B    20    				ld a,b
002BBF FE79                B    21    				cp 'y'
002BC1 28 E7               B    22    				jr z,show_page
                           B    23    
002BC3                     B    24    last_help_page
002BC3 AF                  B    25    				xor a
002BC4 C9                  B    26    				ret	
                           B    27    	
                           B    28    ;----------------------------------------------
                           B    29    	
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 100


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\gtr.asm
                           B     0    	include 'commands\gtr.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;">" for write ascii bytes to memory command. V
                           B     3    ;----------------------------------------------
                           B     4    
002BC5                     B     5    os_cmd_gtr
                           B     6    
002BC5 CD 50 1C 00         B     7    				call hexword_or_bust			002BC9 CA DD 15 00         B     8    				jp z,os_no_start_addr
002BCD 23                  B     9    fndquot1		inc hl
002BCE 7E                  B    10    				ld a,(hl)
002BCF B7                  B    11    				or a
002BD0 CA F5 15 00         B    12    				jp z,os_no_args_error
002BD4 FE22                B    13    				cp 022h							002BD6 20 F5               B    14    				jr nz,fndquot1
002BD8 23                  B    15    				inc hl
002BD9 E5                  B    16    				push hl
002BDA 7E                  B    17    fndquot2		ld a,(hl)
002BDB 23                  B    18    				inc hl
002BDC B7                  B    19    				or a
002BDD 28 15               B    20    				jr z,noquot2
002BDF FE22                B    21    				cp 022h							002BE1 20 F7               B    22    				jr nz,fndquot2
002BE3 E1                  B    23    				pop hl
                           B    24    					
002BE4 7E                  B    25    wmbalp			ld a,(hl)						002BE5 FE22                B    26    				cp 022h
002BE7 28 09               B    27    				jr z,os_gtrdn					002BE9 FE7D                B    28    				cp 07dh
002BEB 28 01               B    29    				jr z,skpnasc
002BED 12                  B    30    				ld (de),a
002BEE 13                  B    31    skpnasc			inc de
002BEF 23                  B    32    				inc hl
002BF0 18 F2               B    33    				jr wmbalp
002BF2 AF                  B    34    os_gtrdn		xor a
002BF3 C9                  B    35    				ret	
                           B    36    				
002BF4 E1                  B    37    noquot2			pop hl							002BF5 3E12                B    38    				ld a,012h
002BF7 B7                  B    39    				or a
002BF8 C9                  B    40    				ret
                           B    41    
                           B    42    ;----------------------------------------------
                           B     0    	include 'commands\lb.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"lb" - Load binary file command. V0.03 - ADL m
                           B     3    ;----------------------------------------------
                           B     4    
002BF9                     B     5    os_cmd_lb
                           B     6    	
002BF9 CD 6A 16 00         B     7    				call os_check_volume_format	
002BFD C0                  B     8    				ret nz
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 101


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\lb.asm
                           B     9    				
002BFE CD 6F 28 00         B    10    				call filename_or_bust			002C02 CD FD 15 00         B    11    				call os_find_file				002C06 C0                  B    12    				ret nz
002C07 ED53 20 67 00       B    13    				ld (filesize_cache),de			002C0C 2A 0E 5F 00         B    14    				ld hl,(default_load_addr)
002C10 22 1D 67 00         B    15    				ld (data_load_addr),hl			                           B    16    				
002C14 2A 72 60 00         B    17    				ld hl,(os_args_loc)
002C18 CD A6 0F 00         B    18    				call os_next_arg
                           B    19    
002C1C CD 50 1C 00         B    20    				call hexword_or_bust			002C20 28 05               B    21    				jr z,os_lbnao					002C22 ED53 1D 67 00       B    22    				ld (data_load_addr),de
                           B    23    
002C27 ED5B 1D 67 00       B    24    os_lbnao		ld de,(data_load_addr)			002C2C 2A 1B 5F 00         B    25    				ld hl,(sys_ram_high)			002C30 2B                  B    26    				dec hl
002C31 AF                  B    27    				xor a
002C32 ED52                B    28    				sbc hl,de
002C34 38 04               B    29    				jr c,os_lbprok
002C36 3E26                B    30    				ld a,026h						002C38 B7                  B    31    				or a
002C39 C9                  B    32    				ret
                           B    33    				
002C3A 2A 1D 67 00         B    34    os_lbprok		ld hl,(data_load_addr)			002C3E CD 2C 16 00         B    35    				call os_read_bytes_from_file
002C42 C0                  B    36    				ret nz
                           B    37    			
002C43                     B    38    report_bytes_loaded
                           B    39    
002C43 21 C1 54 00         B    40    				ld hl,os_hex_prefix_txt			002C47 CD 25 0F 00         B    41    				call os_print_string			                           B    42    				
002C4B 11 22 67 00         B    43    				ld de,filesize_cache+2			002C4F 21 20 60 00         B    44    				ld hl,output_line
002C53 0603                B    45    				ld b,3
002C55 CD 5A 10 00         B    46    				call n_hexbytes_to_ascii
002C59 3600                B    47    				ld (hl),0	
002C5B 0605                B    48    				ld b,5							002C5D CD 26 13 00         B    49    				call os_print_output_line_skip_
                           B    50    				
002C61 21 63 5B 00         B    51    				ld hl,bytes_loaded_msg			002C65 CD EF 13 00         B    52    				call os_show_packed_text
                           B    53    				
002C69 21 20 55 00         B    54    				ld hl,to_txt					002C6D CD 25 0F 00         B    55    				call os_print_string
                           B    56    
002C71 21 C1 54 00         B    57    				ld hl,os_hex_prefix_txt			002C75 CD 25 0F 00         B    58    				call os_print_string	
                           B    59    
002C79 ED5B 1D 67 00       B    60    				ld de,(data_load_addr)			Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 102


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\lb.asm
002C7E CD F0 12 00         B    61    				call os_show_hex_address
                           B    62    
002C82 CD B8 13 00         B    63    				call os_new_line
002C86 AF                  B    64    				xor a
002C87 C9                  B    65    				ret
                           B    66    				
                           B    67    ;----------------------------------------------
                           B    68    
       0000671D            B    69    data_load_addr	equ scratch_pad
       00006720            B    70    filesize_cache	equ scratch_pad+3
                           B    71    
                           B    72    ;----------------------------------------------
                           B     0    	include 'commands\m.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;'m' - Show memory as hex bytes command. V0.02 
                           B     3    ;----------------------------------------------
                           B     4    
       00000010            B     5    bytes_per_line	equ 16
                           B     6    
002C88 CD 50 1C 00         B     7    os_cmd_m		call hexword_or_bust			002C8C 28 05               B     8    				jr z,m_no_hex					002C8E ED53 B6 5F 00       B     9    				ld (mem_mon_addr),de
                           B    10    				
002C93 0610                B    11    m_no_hex		ld b,16							002C95 C5                  B    12    smbllp			push bc							                           B    13    				
002C96 21 CF 2C 00         B    14    				ld hl,colon_cmd_prefix			002C9A CD 25 0F 00         B    15    				call os_print_string
002C9E ED5B B6 5F 00       B    16    				ld de,(mem_mon_addr)
002CA3 CD F0 12 00         B    17    				call os_show_hex_address
                           B    18    
002CA7 21 20 60 00         B    19    				ld hl,output_line
002CAB 0610                B    20    				ld b,bytes_per_line				002CAD 3620                B    21    mmbllp			ld (hl),' '
002CAF 23                  B    22    				inc hl
002CB0 1A                  B    23    				ld a,(de)	
002CB1 CD 68 10 00         B    24    				call hexbyte_to_ascii
002CB5 13                  B    25    				inc de
002CB6 10 F5               B    26    				djnz mmbllp
                           B    27    
002CB8 ED53 B6 5F 00       B    28    				ld (mem_mon_addr),de
002CBD 360B                B    29    				ld (hl),11
002CBF 23                  B    30    				inc hl
002CC0 3600                B    31    				ld (hl),0
002CC2 21 20 60 00         B    32    				ld hl,output_line
002CC6 CD 25 0F 00         B    33    				call os_print_string
002CCA C1                  B    34    				pop bc
002CCB 10 C8               B    35    				djnz smbllp
                           B    36    				
002CCD AF                  B    37    				xor a
002CCE C9                  B    38    				ret
                           B    39    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 103


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\m.asm
                           B    40    ;----------------------------------------------
                           B    41    
002CCF 3A2000              B    42    colon_cmd_prefix	db ': ',0
                           B    43    
                           B    44    ;----------------------------------------------
                           B     0    	include 'commands\md.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"md" - Make dir command. V0.02 - ADL mode
                           B     3    ;----------------------------------------------
                           B     4    
002CD2                     B     5    os_cmd_md
                           B     6    	
002CD2 CD 6A 16 00         B     7    				call os_check_volume_format	
002CD6 C0                  B     8    				ret nz
                           B     9    			
002CD7 CD 6F 28 00         B    10    				call filename_or_bust
                           B    11    				
002CDB C3 AA 16 00         B    12    				jp os_make_dir			;no poi
                           B    13    				
                           B    14    
                           B    15    ;----------------------------------------------
                           B     0    	include 'commands\r.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;'R' - show CPU register values saved on return
                           B     3    ;----------------------------------------------
                           B     4    
002CDF                     B     5    os_cmd_r	
002CDF DD21 24 5F 00       B     6    				ld ix,store_a1					002CE4 21 89 2D 00         B     7    				ld hl,register_txt
002CE8 CD 25 0F 00         B     8    rcmdloop2		call os_print_string
002CEC 7E                  B     9    rcmdloop		ld a,(hl)
002CED FE01                B    10    				cp 1
002CEF 28 0B               B    11    				jr z,showbyte
002CF1 FE02                B    12    				cp 2
002CF3 28 15               B    13    				jr z,showword16
002CF5 FE03                B    14    				cp 3
002CF7 28 2E               B    15    				jr z,showaddr
002CF9 23                  B    16    				inc hl
002CFA 18 F0               B    17    				jr rcmdloop
                           B    18    				
002CFC DD7E00              B    19    showbyte		ld a,(ix)
002CFF DD23                B    20    				inc ix
002D01 DDE5                B    21    				push ix
002D03 E5                  B    22    				push hl
002D04 CD 04 13 00         B    23    				call os_show_hex_byte
002D08 18 2A               B    24    				jr showreg
                           B    25    
002D0A DD7E01              B    26    showword16		ld a,(ix+1)
002D0D DDE5                B    27    				push ix
002D0F E5                  B    28    				push hl
002D10 CD 04 13 00         B    29    				call os_show_hex_byte
002D14 E1                  B    30    				pop hl
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 104


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\r.asm
002D15 DDE1                B    31    				pop ix
002D17 DD7E00              B    32    				ld a,(ix)
002D1A DD23                B    33    				inc ix
002D1C DD23                B    34    				inc ix
002D1E DDE5                B    35    				push ix
002D20 E5                  B    36    				push hl
002D21 CD 04 13 00         B    37    				call os_show_hex_byte
002D25 18 0D               B    38    				jr showreg
                           B    39    
002D27 DD1700              B    40    showaddr		ld de,(ix)
002D2A ED3203              B    41    				lea ix,ix+3
002D2D DDE5                B    42    				push ix
002D2F E5                  B    43    				push hl
002D30 CD F0 12 00         B    44    				call os_show_hex_address
002D34 E1                  B    45    showreg			pop hl
002D35 DDE1                B    46    				pop ix
002D37 23                  B    47    				inc hl
002D38 7E                  B    48    				ld a,(hl)
002D39 B7                  B    49    				or a
002D3A 20 AC               B    50    				jr nz,rcmdloop2
                           B    51    			
002D3C CD B8 13 00         B    52    				call os_new_line				002D40 21 ED 2D 00         B    53    				ld hl,flag_txt
002D44 CD D8 12 00         B    54    				call os_copy_to_output_line
002D48 21 24 60 00         B    55    				ld hl,output_line+4
002D4C 01050000            B    56    				ld bc,5
002D50 3A 47 5F 00         B    57    				ld a,(store_f)
002D54 CB77                B    58    				bit 6,a							002D56 28 02               B    59    				jr z,zfzero
002D58 3631                B    60    				ld (hl),'1'
002D5A 09                  B    61    zfzero			add hl,bc
002D5B CB47                B    62    				bit 0,a							002D5D 28 02               B    63    				jr z,cfzero
002D5F 3631                B    64    				ld (hl),'1'
002D61 09                  B    65    cfzero			add hl,bc
002D62 CB7F                B    66    				bit 7,a							002D64 28 02               B    67    				jr z,sfzero
002D66 364D                B    68    				ld (hl),'M'
002D68 09                  B    69    sfzero			add hl,bc
002D69 CB57                B    70    				bit 2,a							002D6B 28 02               B    71    				jr z,pfzero
002D6D 364F                B    72    				ld (hl),'O'
002D6F 09                  B    73    pfzero			add hl,bc
002D70 23                  B    74    				inc hl
002D71 CB67                B    75    				bit 4,a							002D73 28 02               B    76    				jr z,iffzero
002D75 3631                B    77    				ld (hl),'1'
002D77                     B    78    iffzero			
002D77 01060000            B    79    				ld bc,6
002D7B 09                  B    80    				add hl,bc
002D7C 3A 48 5F 00         B    81    				ld a,(store_adl)
002D80 C630                B    82    				add a,30h
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 105


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\r.asm
002D82 77                  B    83    				ld (hl),a
002D83 CD 1B 13 00         B    84    				call os_print_output_line
002D87 AF                  B    85    				xor a
002D88 C9                  B    86    				ret
                           B    87    
                           B    88    ;----------------------------------------------
                           B    89    	
                           B    90    
002D89 20413D00 01         B    91    register_txt		db ' A=',0,1
002D8E 20204243 3D0003     B    92    					db '  BC=',0,3
002D95 20204445 3D0003     B    93    					db '  DE=',0,3
002D9C 2020484C 3D0003     B    94    					db '  HL=',0,3
                           B    95    					
002DA3 0B                  B    96    					db 11
                           B    97    
002DA4 27413D00 01         B    98    					db 027h,'A=',0,1
002DA9 20274243 3D0003     B    99    					db ' ',027h,'BC=',0,3
002DB0 20274445 3D0003     B   100    					db ' ',027h,'DE=',0,3
002DB7 2027484C 3D0003     B   101    					db ' ',027h,'HL=',0,3
                           B   102    					
002DBE 0B                  B   103    					db 11
                           B   104    
002DBF 2049583D 0003       B   105    					db ' IX=',0,3
002DC5 2049593D 0003       B   106    					db ' IY=',0,3
                           B   107    					
002DCB 0B                  B   108    					db 11
                           B   109    					
002DCC 2050433D 0003       B   110    					db ' PC=',0,3
002DD2 204C5350 3D0003     B   111    					db ' LSP=',0,3
002DD9 20535350 3D0002     B   112    					db ' SSP=',0,2
                           B   113    					
002DE0 0B                  B   114    					db 11
                           B   115    					
002DE1 204D4241 53453D00   B   116    					db ' MBASE=',0,1,0,0
002DE9 010000 
                           B   117    					
002DEC 0B                  B   118    					db 11
                           B   119    
002DED 205A463D 30204346   B   120    flag_txt			db ' ZF=0 CF=0 SF=P PV=E IF
002DF5 3D302053 463D5020 
002DFD 50563D45 20494646 
002E05 3D302041 444C3D30 
002E0D 0B0B00 
                           B   121    		
                           B   122    ;----------------------------------------------
                           B     0    	include 'commands\rd.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"RD" - Remove directory command. V0.02 - ADL m
                           B     3    ;----------------------------------------------
                           B     4    
002E10                     B     5    os_cmd_rd
                           B     6    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 106


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\rd.asm
002E10 CD 6A 16 00         B     7    				call os_check_volume_format	
002E14 C0                  B     8    				ret nz
                           B     9    				
002E15 CD 6F 28 00         B    10    				call filename_or_bust
                           B    11    			
002E19 C3 14 17 00         B    12    				jp os_delete_dir		;no poi
                           B    13    
                           B    14    
                           B    15    ;----------------------------------------------
                           B     0    	include 'commands\rn.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"rn" - Rename command. V0.02 - ADL mode
                           B     3    ;----------------------------------------------
                           B     4    
002E1D                     B     5    os_cmd_rn
                           B     6    	
002E1D CD 6A 16 00         B     7    				call os_check_volume_format	
002E21 C0                  B     8    				ret nz
                           B     9    			
002E22 CD 6F 28 00         B    10    				call filename_or_bust
002E26 E5                  B    11    				push hl
002E27 D1                  B    12    				pop de
002E28 CD A6 0F 00         B    13    				call os_next_arg
002E2C 7E                  B    14    				ld a,(hl)						002E2D B7                  B    15    				or a
002E2E 20 04               B    16    				jr nz,rn_grfn
002E30 3E1F                B    17    				ld a,01fh						002E32 B7                  B    18    				or a
002E33 C9                  B    19    				ret
                           B    20    
002E34 EB                  B    21    rn_grfn			ex de,hl
002E35 C3 FE 16 00         B    22    				jp os_rename_file				                           B    23    		
                           B    24    ;----------------------------------------------
                           B     0    	include 'commands\sb.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;'SB' - Save binary file command. V0.02 - ADL m
                           B     3    ;----------------------------------------------
                           B     4    
002E39                     B     5    os_cmd_sb
                           B     6    	
002E39 CD 6A 16 00         B     7    				call os_check_volume_format		002E3D C0                  B     8    				ret nz
                           B     9    					
002E3E CD 6F 28 00         B    10    				call filename_or_bust			002E42 22 23 67 00         B    11    				ld (sb_save_name_addr),hl
                           B    12    				
002E46 2A 72 60 00         B    13    				ld hl,(os_args_loc)
002E4A CD A6 0F 00         B    14    				call os_next_arg
002E4E CD 50 1C 00         B    15    				call hexword_or_bust			002E52 CA DD 15 00         B    16    				jp z,os_no_start_addr			002E56 ED53 1D 67 00       B    17    				ld (sb_save_addr),de
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 107


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\sb.asm
                           B    18    				
002E5B CD 50 1C 00         B    19    				call hexword_or_bust			002E5F CA E1 15 00         B    20    				jp z,os_no_filesize
002E63 ED53 20 67 00       B    21    				ld (sb_save_length),de
                           B    22    				
002E68 2A 23 67 00         B    23    				ld hl,(sb_save_name_addr)		002E6C CD 3C 16 00         B    24    				call os_create_file
002E70 28 18               B    25    				jr z,os_sfapp
002E72 FEC9                B    26    				cp 0c9h							002E74 C0                  B    27    				ret nz			
002E75 21 8A 59 00         B    28    				ld hl,save_append_msg			002E79 CD EF 13 00         B    29    				call os_show_packed_text
002E7D CD B2 42 00         B    30    				call os_wait_key_press
002E81 3E79                B    31    				ld a,'y'
002E83 B8                  B    32    				cp b
002E84 28 04               B    33    				jr z,os_sfapp
002E86 3E2C                B    34    				ld a,2ch						002E88 B7                  B    35    				or a
002E89 C9                  B    36    				ret
                           B    37    			
002E8A 2A 23 67 00         B    38    os_sfapp		ld hl,(sb_save_name_addr)		002E8E ED5B 1D 67 00       B    39    				ld de,(sb_save_addr)			002E93 ED4B 20 67 00       B    40    				ld bc,(sb_save_length)			002E98 CD 52 16 00         B    41    				call os_write_bytes_to_file
002E9C C0                  B    42    				ret nz	
                           B    43    				
002E9D 3E20                B    44    				ld a,020h						002E9F B7                  B    45    				or a
002EA0 C9                  B    46    				ret
                           B    47    			
                           B    48    				
                           B    49    ;----------------------------------------------
                           B    50    
       0000671D            B    51    sb_save_addr		equ scratch_pad
       00006720            B    52    sb_save_length		equ scratch_pad+3
       00006723            B    53    sb_save_name_addr	equ scratch_pad+6
                           B    54    
                           B    55    ;----------------------------------------------
                           B     0    	include 'commands\rx.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"RX" - Receive binary file via serial port com
                           B     3    ;----------------------------------------------
                           B     4    
       00000080            B     5    buffer_blocks			 equ 128				       0000681D            B     6    buffer_addr				 equ os_max_addr		       0000671D            B     7    rx_buffer_ptr			 equ scratch_pad
       00006720            B     8    serial_file_length_cache equ scratch_pad+3
                           B     9    
                           B    10    
002EA1 7E                  B    11    os_cmd_rx		ld a,(hl)						002EA2 B7                  B    12    				or a
002EA3 CA D5 15 00         B    13    				jp z,os_no_fn_error
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 108


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\rx.asm
                           B    14    				
002EA7 3E3E                B    15    				ld a,'>'						002EA9 BE                  B    16    				cp (hl)
002EAA C2 6D 2F 00         B    17    				jp nz,rx_nrs
002EAE 23                  B    18    				inc hl
002EAF 3E20                B    19    				ld a,' '
002EB1 BE                  B    20    				cp (hl)
002EB2 2B                  B    21    				dec hl
002EB3 C2 6D 2F 00         B    22    				jp nz,rx_nrs
                           B    23    				
002EB7 CD 6A 16 00         B    24    				call os_check_volume_format		002EBB C0                  B    25    				ret nz		
                           B    26    				
002EBC 112A0000            B    27    				ld de,02ah						002EC0 ED53 92 5D 00       B    28    				ld (serial_filename),de			002EC5 CD 71 30 00         B    29    				call rx_get_header
002EC9 C0                  B    30    				ret nz
002ECA CD 71 44 00         B    31    				call s_holdack					                           B    32    				
002ECE 21 A6 5D 00         B    33    				ld hl,serial_fileheader			002ED2 CD 3C 16 00         B    34    				call os_create_file
002ED6 C2 4C 2F 00         B    35    				jp nz,rxwtd_fail				                           B    36    				
002EDA 21 AA 59 00         B    37    				ld hl,ser_recsave_msg
002EDE CD EF 13 00         B    38    				call os_show_packed_text
                           B    39    				
002EE2 2A B6 5D 00         B    40    rx_rnblk		ld hl,(serial_fileheader+16)	002EE6 22 20 67 00         B    41    				ld (serial_file_length_cache),h
002EEA 21 1D 68 00         B    42    				ld hl,buffer_addr
002EEE 22 1D 67 00         B    43    				ld (rx_buffer_ptr),hl
002EF2 0680                B    44    				ld b,buffer_blocks				                           B    45    				
002EF4 CD 59 44 00         B    46    rx_lnb			call s_goodack
002EF8 CD 03 44 00         B    47    				call s_getblock
002EFC 28 0F               B    48    				jr z,rxtd_blok
                           B    49    
002EFE F5                  B    50    				push af							002EFF CD 6A 44 00         B    51    				call s_badack					002F03 21 A6 5D 00         B    52    				ld hl,serial_fileheader			002F07 CD D2 16 00         B    53    				call os_erase_file
002F0B F1                  B    54    				pop af
002F0C C9                  B    55    				ret
                           B    56    
002F0D CD 71 44 00         B    57    rxtd_blok		call s_holdack
                           B    58    				
002F11 21 1D 65 00         B    59    				ld hl,sector_buffer
002F15 ED5B 1D 67 00       B    60    				ld de,(rx_buffer_ptr)
002F1A 01000100            B    61    				ld bc,256
002F1E EDB0                B    62    				ldir
002F20 ED53 1D 67 00       B    63    				ld (rx_buffer_ptr),de
                           B    64    				
002F25 2A B6 5D 00         B    65    				ld hl,(serial_fileheader+16)
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 109


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\rx.asm
002F29 11000100            B    66    				ld de,256
002F2D AF                  B    67    				xor a
002F2E ED52                B    68    				sbc hl,de
002F30 22 B6 5D 00         B    69    				ld (serial_fileheader+16),hl
002F34 28 1D               B    70    				jr z,rx_lbr
002F36 38 1B               B    71    				jr c,rx_lbr
002F38 10 BA               B    72    				djnz rx_lnb
                           B    73    
002F3A 01008000            B    74    				ld bc,buffer_blocks*256
002F3E 11 1D 68 00         B    75    				ld de,buffer_addr
002F42 21 A6 5D 00         B    76    				ld hl,serial_fileheader
002F46 CD 52 16 00         B    77    				call os_write_bytes_to_file
002F4A 28 96               B    78    				jr z,rx_rnblk
002F4C F5                  B    79    rxwtd_fail		push af
002F4D CD 6A 44 00         B    80    				call s_badack
002F51 F1                  B    81    				pop af
002F52 C9                  B    82    				ret
                           B    83    				
002F53 CD 59 44 00         B    84    rx_lbr			call s_goodack
002F57 ED4B 20 67 00       B    85    				ld bc,(serial_file_length_cache
002F5C 11 1D 68 00         B    86    				ld de,buffer_addr
002F60 21 A6 5D 00         B    87    				ld hl,serial_fileheader
002F64 CD 52 16 00         B    88    				call os_write_bytes_to_file
002F68 C0                  B    89    				ret nz	
                           B    90    				
002F69 3E20                B    91    rxtd_done		ld a,020h						002F6B B7                  B    92    				or a
002F6C C9                  B    93    				ret
                           B    94    
                           B    95    				
                           B    96    
                           B    97    				
002F6D 3E21                B    98    rx_nrs			ld a,'!'						002F6F BE                  B    99    				cp (hl)							002F70 C2 1B 30 00         B   100    				jr nz,notrxe
002F74 23                  B   101    				inc hl
002F75 3E20                B   102    				ld a,' '
002F77 BE                  B   103    				cp (hl)
002F78 2B                  B   104    				dec hl
002F79 C2 1B 30 00         B   105    				jr nz,notrxe
002F7D 112A0000            B   106    				ld de,02ah						002F81 ED53 92 5D 00       B   107    				ld (serial_filename),de			002F86 CD 71 30 00         B   108    				call rx_get_header
002F8A C0                  B   109    				ret nz
002F8B 21 A0 59 00         B   110    				ld hl,ser_rec2_msg
002F8F CD EF 13 00         B   111    				call os_show_packed_text
002F93 CD 59 44 00         B   112    				call s_goodack
002F97 3E01                B   113    				ld a,1							002F99 32 A5 5D 00         B   114    				ld (serial_timeout),a
002F9D CD 03 44 00         B   115    				call s_getblock					002FA1 28 07               B   116    				jr z,rxe_fblok
002FA3 F5                  B   117    rxe_badblock	push af							Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 110


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\rx.asm
002FA4 CD 6A 44 00         B   118    				call s_badack					002FA8 F1                  B   119    				pop af
002FA9 C9                  B   120    				ret
                           B   121    	
002FAA 2A 1F 65 00         B   122    rxe_fblok		ld hl,(sector_buffer+2)
002FAE 1150524F            B   123    				ld de,04f5250h					002FB2 AF                  B   124    				xor a
002FB3 28 04               B   125    				jr z,rxe_ok
002FB5 3E1A                B   126    				ld a,1ah						002FB7 B7                  B   127    				or a
002FB8 C9                  B   128    				ret
002FB9 2A 22 65 00         B   129    rxe_ok			ld hl,(sector_buffer+5)			002FBD 22 89 5D 00         B   130    				ld (serial_ez80_address),hl
002FC1 01000100            B   131    				ld bc,256						002FC5 DD21 A6 5D 00       B   132    				ld ix,serial_fileheader
002FCA AF                  B   133    				xor a
002FCB DDB612              B   134    				or (ix+18)						002FCE 20 0A               B   135    				jr nz,mtones
002FD0 DDB611              B   136    				or a,(ix+17)					002FD3 20 05               B   137    				jr nz,mtones
002FD5 0600                B   138    				ld b,0
002FD7 DD4E10              B   139    				ld c,(ix+16)					002FDA 21 1D 65 00         B   140    mtones			ld hl,sector_buffer				002FDE ED5B 89 5D 00       B   141    				ld de,(serial_ez80_address)		002FE3 EDB0                B   142    				ldir
                           B   143    				
002FE5 D5                  B   144    				push de
002FE6 CD 59 44 00         B   145    				call s_goodack		
002FEA DDE1                B   146    				pop ix							002FEC 2A B6 5D 00         B   147    				ld hl,(serial_fileheader+16)	002FF0 11000100            B   148    				ld de,256
002FF4 AF                  B   149    				xor a
002FF5 ED52                B   150    				sbc hl,de						002FF7 28 18               B   151    				jr z,rxe_done
002FF9 38 16               B   152    				jr c,rxe_done
002FFB EB                  B   153    				ex de,hl
002FFC ED53 B6 5D 00       B   154    				ld (serial_fileheader+16),de	003001 DD2A 89 5D 00       B   155    				ld ix,(serial_ez80_address)
003006 01000100            B   156    				ld bc,256
00300A DD09                B   157    				add ix,bc
00300C CD C1 43 00         B   158    				call s_gbloop					003010 C0                  B   159    				ret nz
003011 E1                  B   160    rxe_done		pop hl							003012 CD 3D 3A 00         B   161    				call enable_nmi					003016 2A 89 5D 00         B   162    				ld hl,(serial_ez80_address)
00301A E9                  B   163    				jp (hl)							                           B   164    				
                           B   165    				
                           B   166    
00301B CD B8 30 00         B   167    notrxe			call clear_serial_filename
                           B   168    				
00301F 0610                B   169    				ld b,16							Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 111


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\rx.asm
003021 11 92 5D 00         B   170    				ld de,serial_filename
003025 CD FE 11 00         B   171    				call os_copy_ascii_run			003029 79                  B   172    				ld a,c
00302A 32 A4 5D 00         B   173    				ld (serial_fn_length),a
00302E CD B2 0F 00         B   174    				call os_scan_for_space
                           B   175    				
003032 CD 50 1C 00         B   176    				call hexword_or_bust			003036 CA DD 15 00         B   177    				jp z,os_no_start_addr			00303A ED53 1D 67 00       B   178    				ld (data_load_addr),de			00303F 2A 1B 5F 00         B   179    				ld hl,(sys_ram_high)			003043 2B                  B   180    				dec hl
003044 AF                  B   181    				xor a
003045 ED52                B   182    				sbc hl,de
003047 38 04               B   183    				jr c,os_prok
003049 3E26                B   184    				ld a,026h						00304B B7                  B   185    				or a
00304C C9                  B   186    				ret
                           B   187    
00304D CD 71 30 00         B   188    os_prok			call rx_get_header
003051 C0                  B   189    				ret nz
                           B   190    
003052 21 A0 59 00         B   191    				ld hl,ser_rec2_msg
003056 CD EF 13 00         B   192    				call os_show_packed_text
                           B   193    	
00305A 2A 1D 67 00         B   194    				ld hl,(data_load_addr)			00305E CD AF 43 00         B   195    				call serial_receive_file
003062 C0                  B   196    				ret nz							                           B   197    
003063 ED5B B6 5D 00       B   198    				ld de,(serial_fileheader+16)	003068 ED53 20 67 00       B   199    				ld (filesize_cache),de
00306D C3 43 2C 00         B   200    				jp report_bytes_loaded			                           B   201    				
                           B   202    ;----------------------------------------------
                           B   203    
003071                     B   204    rx_get_header
003071 21 9C 59 00         B   205    				ld hl,ser_rec_msg
003075 CD EF 13 00         B   206    				call os_show_packed_text
                           B   207    				
003079 3E00                B   208    				ld a,0
00307B 32 C7 5D 00         B   209    				ld (anim_wait_count),a			00307F 3A C7 5D 00         B   210    get_hdr_loop	ld a,(anim_wait_count)
003083 3C                  B   211    				inc a
003084 47                  B   212    				ld b,a
003085 FE06                B   213    				cp 6
003087 20 07               B   214    				jr nz,notsix
003089 0E20                B   215    				ld c,' '
00308B 0605                B   216    				ld b,5
00308D AF                  B   217    				xor a
00308E 18 02               B   218    				jr mcharset
003090 0E2E                B   219    notsix			ld c,'.'
003092 32 C7 5D 00         B   220    mcharset		ld (anim_wait_count),a
003096 CD 22 1A 00         B   221    				call os_print_multiple_chars
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 112


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\rx.asm
00309A CD 6E 0F 00         B   222    				call home_cursor
                           B   223    				
00309E 21 92 5D 00         B   224    				ld hl,serial_filename			0030A2 3E01                B   225    				ld a,1							0030A4 CD 14 43 00         B   226    				call serial_get_header
0030A8 C8                  B   227    				ret z
0030A9 FE83                B   228    				cp 083h							0030AB C0                  B   229    				ret nz
0030AC CD F9 42 00         B   230    				call os_get_key_press
0030B0 FE76                B   231    				cp 076h
0030B2 20 CB               B   232    				jr nz,get_hdr_loop
0030B4 3E80                B   233    				ld a,080h						0030B6 B7                  B   234    notsto			or a
0030B7 C9                  B   235    				ret								                           B   236    							
                           B   237    
                           B   238    ;----------------------------------------------
                           B   239    
0030B8                     B   240    clear_serial_filename
                           B   241    
0030B8 E5                  B   242    				push hl							0030B9 21 92 5D 00         B   243    				ld hl,serial_filename
0030BD 01100000            B   244    				ld bc,16
0030C1 AF                  B   245    				xor a
0030C2 CD 4B 15 00         B   246    				call os_bchl_memfill
0030C6 E1                  B   247    				pop hl
0030C7 C9                  B   248    				ret
                           B   249    
                           B   250    ;----------------------------------------------
                           B     0    	include 'commands\tx.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;'TX' - Transmit binary file via serial port co
                           B     3    ;----------------------------------------------
                           B     4    
0030C8 7E                  B     5    os_cmd_tx		ld a,(hl)						0030C9 B7                  B     6    				or a
0030CA CA D5 15 00         B     7    				jp z,os_no_fn_error
                           B     8    			
0030CE E5                  B     9    				push hl							0030CF 21 92 5D 00         B    10    				ld hl,serial_filename
0030D3 01100000            B    11    				ld bc,16
0030D7 AF                  B    12    				xor a
0030D8 CD 4B 15 00         B    13    				call os_bchl_memfill
0030DC E1                  B    14    				pop hl
                           B    15    			
0030DD 0610                B    16    				ld b,16							0030DF 11 92 5D 00         B    17    				ld de,serial_filename
0030E3 CD FE 11 00         B    18    				call os_copy_ascii_run			0030E7 79                  B    19    				ld a,c
0030E8 32 A4 5D 00         B    20    				ld (serial_fn_length),a
0030EC CD B2 0F 00         B    21    				call os_scan_for_space
                           B    22    							
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 113


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\tx.asm
0030F0 CD 50 1C 00         B    23    				call hexword_or_bust			0030F4 CA DD 15 00         B    24    				jp z,os_no_start_addr			0030F8 ED53 89 5D 00       B    25    				ld (serial_ez80_address),de
                           B    26    			
0030FD CD 50 1C 00         B    27    				call hexword_or_bust			003101 CA E1 15 00         B    28    				jp z,os_no_filesize
003105 ED53 8C 5D 00       B    29    				ld (serial_file_length),de
00310A 21000000            B    30    				ld hl,0
00310E 3E07                B    31    				ld a,07h						003110 B7                  B    32    				or a
003111 ED5A                B    33    				adc hl,de
003113 28 1D               B    34    				jr z,s_error
                           B    35    				
003115 21 A5 59 00         B    36    				ld hl,ser_send_msg
003119 CD EF 13 00         B    37    				call os_show_packed_text
                           B    38    			
00311D ED5B 8C 5D 00       B    39    				ld de,(serial_file_length)
003122 21 92 5D 00         B    40    				ld hl,serial_filename			003126 DD2A 89 5D 00       B    41    				ld ix,(serial_ez80_address)
00312B CD 78 44 00         B    42    				call serial_send_file
00312F C0                  B    43    				ret nz			
                           B    44    			
003130 3E20                B    45    				ld a,020h						003132 B7                  B    46    s_error			or a
003133 C9                  B    47    				ret
                           B    48    				
                           B    49    			
                           B    50    ;----------------------------------------------
                           B     0    	include 'commands\t.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;'T' - Show memory as ascii text command. V0.02
                           B     3    ;----------------------------------------------
                           B     4    
003134 CD 50 1C 00         B     5    os_cmd_t		call hexword_or_bust			003138 28 05               B     6    				jr z,t_no_hex					00313A ED53 B6 5F 00       B     7    				ld (mem_mon_addr),de
                           B     8    							
00313F 0610                B     9    t_no_hex		ld b,16
003141 C5                  B    10    smaalp			push bc
                           B    11    				
003142 21 85 31 00         B    12    				ld hl,gtr_cmd_prefix			003146 CD 25 0F 00         B    13    				call os_print_string
00314A ED5B B6 5F 00       B    14    				ld de,(mem_mon_addr)
00314F CD F0 12 00         B    15    				call os_show_hex_address
                           B    16    
003153 21 20 60 00         B    17    				ld hl,output_line
003157 3620                B    18    				ld (hl),' '
003159 23                  B    19    				inc hl
00315A 3622                B    20    				ld (hl),022h
00315C 0610                B    21    				ld b,16
00315E 23                  B    22    mabllp			inc hl
00315F 1A                  B    23    				ld a,(de)	
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 114


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\t.asm
003160 FE20                B    24    				cp 020h
003162 38 04               B    25    				jr c,chchar
003164 FE7F                B    26    				cp 07fh
003166 38 02               B    27    				jr c,nchchar
003168 3E7C                B    28    chchar			ld a,07ch
00316A 77                  B    29    nchchar			ld (hl),a
00316B 13                  B    30    				inc de
00316C 10 F0               B    31    				djnz mabllp
                           B    32    
00316E ED53 B6 5F 00       B    33    				ld (mem_mon_addr),de
003173 23                  B    34    				inc hl
003174 3622                B    35    				ld (hl),022h
003176 23                  B    36    				inc hl
003177 360B                B    37    				ld (hl),11
003179 23                  B    38    				inc hl
00317A 3600                B    39    				ld (hl),0
00317C CD 1B 13 00         B    40    				call os_print_output_line
003180 C1                  B    41    				pop bc
003181 10 BE               B    42    				djnz smaalp
003183 AF                  B    43    				xor a
003184 C9                  B    44    				ret
                           B    45    	
                           B    46    ;----------------------------------------------
                           B    47    
003185 3E2000              B    48    gtr_cmd_prefix	db '> ',0
                           B    49    
                           B    50    ;----------------------------------------------
                           B     0    	include 'commands\mount.asm'
                           B     1    ;----------------------------------------------
                           B     2    ; "MOUNT" = Re-mount and show drives v0.02 - AD
                           B     3    ;----------------------------------------------
                           B     4    
003188                     B     5    os_cmd_remount
                           B     6    
003188 3E00                B     7    				ld a,0							00318A CD 07 18 00         B     8    				call os_mount_volumes
00318E CD B8 13 00         B     9    				call os_new_line
003192 AF                  B    10    				xor a
003193 C9                  B    11    				ret
                           B    12    
                           B    13    ;----------------------------------------------
                           B    14    	
                           B     0    	include 'commands\vers.asm'
                           B     1    ;----------------------------------------------
                           B     2    ; "Vers" = Show OS / Hardware version v0.02 - A
                           B     3    ;----------------------------------------------
                           B     4    
003194                     B     5    os_cmd_vers
                           B     6    
003194 21 C3 54 00         B     7    				ld hl,os_version_txt
003198 CD 25 0F 00         B     8    				call os_print_string
                           B     9    			
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 115


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\vers.asm
00319C CD EF 3F 00         B    10    				call hwsc_get_version
0031A0 D5                  B    11    				push de
0031A1 EB                  B    12    				ex de,hl
0031A2 CD 0F 13 00         B    13    				call os_show_hex_word
                           B    14    				
0031A6 21 E6 54 00         B    15    				ld hl,fwd_slash_txt
0031AA CD 25 0F 00         B    16    				call os_print_string
                           B    17    				
0031AE 21 D1 54 00         B    18    				ld hl,hw_version_txt
0031B2 CD 25 0F 00         B    19    				call os_print_string
0031B6 D1                  B    20    				pop de
0031B7 CD 0F 13 00         B    21    				call os_show_hex_word
                           B    22    				
0031BB CD B8 13 00         B    23    				call os_new_line
0031BF CD B8 13 00         B    24    				call os_new_line	
0031C3 AF                  B    25    				xor a
0031C4 C9                  B    26    				ret
                           B    27    	
                           B    28    ;----------------------------------------------
                           B    29    	
                           B     0    	include 'commands\exec.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"exec" - execute script V0.03 - ADL mode
                           B     3    ;
                           B     4    ; Notes: Changing drives within a script not su
                           B     5    ;        Scripts cannot launch scripts
                           B     6    ;		 Abort with CRTL + C
                           B     7    ;----------------------------------------------
                           B     8    
0031C5                     B     9    os_cmd_exec
                           B    10    
0031C5 21 7E 60 00         B    11    				ld hl,in_script_flag			0031C9 CB46                B    12    				bit 0,(hl)
0031CB 28 02               B    13    				jr z,oktlscr
0031CD AF                  B    14    				xor a
0031CE C9                  B    15    				ret
0031CF CBC6                B    16    oktlscr			set 0,(hl)
                           B    17    			
0031D1 2A 72 60 00         B    18    				ld hl,(os_args_loc)				0031D5 11 9F 5F 00         B    19    				ld de,script_fn					0031D9 060D                B    20    				ld b,13
0031DB CD FE 11 00         B    21    				call os_copy_ascii_run
0031DF CD 3A 1A 00         B    22    				call fs_get_dir_cluster			0031E3 ED53 7F 60 00       B    23    				ld (script_dir),de
                           B    24    				
0031E8 CD 6A 16 00         B    25    				call os_check_volume_format	
0031EC C0                  B    26    				ret nz
                           B    27    				
0031ED 21000000            B    28    				ld hl,0
0031F1 22 D4 60 00         B    29    				ld (script_file_offset),hl
                           B    30    				
                           B    31    			
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 116


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\exec.asm
0031F5 3A 03 61 00         B    32    scrp_loop		ld a,(key_mod_flags)			0031F9 E602                B    33    				and 2
0031FB 28 27               B    34    				jr z,noskip_script	
0031FD 1600                B    35    				ld d,0
0031FF CD F9 42 00         B    36    chk_c			call os_get_key_press
003203 FE21                B    37    				cp 021h
003205 20 1A               B    38    				jr nz,no_cpr
003207 1619                B    39    wkend			ld d,25							003209 CD 9C 3F 00         B    40    wkend2			call hwsc_wait_vrt				00320D CD F9 42 00         B    41    				call os_get_key_press		
003211 B7                  B    42    				or a
003212 20 F3               B    43    				jr nz,wkend
003214 15                  B    44    				dec d
003215 20 F2               B    45    				jr nz,wkend2
003217 21 B9 59 00         B    46    				ld hl,script_aborted_msg
00321B CD EF 13 00         B    47    				call os_show_packed_text
00321F AF                  B    48    				xor a							003220 C9                  B    49    				ret
003221 15                  B    50    no_cpr			dec d
003222 20 DB               B    51    				jr nz,chk_c
                           B    52    			
                           B    53    			
003224                     B    54    noskip_script
                           B    55    		
003224 21 82 60 00         B    56    				ld hl,script_buffer				003228 11 CE 5F 00         B    57    				ld de,commandstring
00322C 0651                B    58    				ld b,max_buffer_chars+1
00322E 3E20                B    59    				ld a,020h						003230 77                  B    60    scrp_flp		ld (hl),a
003231 12                  B    61    				ld (de),a
003232 23                  B    62    				inc hl
003233 13                  B    63    				inc de
003234 10 FA               B    64    				djnz scrp_flp
                           B    65    				
003236 CD 3A 1A 00         B    66    				call fs_get_dir_cluster			00323A D5                  B    67    				push de
00323B ED5B 7F 60 00       B    68    				ld de,(script_dir)				003240 CD 46 1A 00         B    69    				call fs_update_dir_cluster
003244 21 9F 5F 00         B    70    				ld hl,script_fn					003248 CD 0D 51 00         B    71    				call fs_hl_to_filename			00324C CD AE 48 00         B    72    				call fs_open_file_command		003250 38 71               B    73    				jr c,pop_ret
003252 B7                  B    74    				or a
003253 20 6E               B    75    				jr nz,pop_ret
003255 D1                  B    76    				pop de
003256 CD 46 1A 00         B    77    				call fs_update_dir_cluster		                           B    78    			
00325A 11500000            B    79    				ld de,max_buffer_chars			00325E CD 0E 16 00         B    80    				call os_set_load_length
003262 AF                  B    81    				xor a
003263 ED5B D4 60 00       B    82    				ld de,(script_file_offset)		003268 CD 16 16 00         B    83    				call os_set_file_pointer
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 117


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\exec.asm
                           B    84    					
00326C 21 82 60 00         B    85    				ld hl,script_buffer				003270 CD 2C 16 00         B    86    				call os_read_bytes_from_file
003274 B7                  B    87    				or a			
003275 28 03               B    88    				jr z,scrp_ok					003277 FECC                B    89    				cp 0cch			
003279 C0                  B    90    				ret nz							                           B    91    				
00327A FD2A D4 60 00       B    92    scrp_ok			ld iy,(script_file_offset)
00327F 21 82 60 00         B    93    				ld hl,script_buffer				003283 11 CE 5F 00         B    94    				ld de,commandstring
003287 3E50                B    95    				ld a,max_buffer_chars
003289 47                  B    96    				ld b,a
00328A 7E                  B    97    scrp_cmd		ld a,(hl)
00328B FE20                B    98    				cp 020h
00328D 38 07               B    99    				jr c,scrp_eol
00328F 12                  B   100    				ld (de),a
003290 23                  B   101    				inc hl
003291 13                  B   102    				inc de
003292 FD23                B   103    				inc iy
003294 10 F4               B   104    				djnz scrp_cmd
                           B   105    				
003296 AF                  B   106    scrp_eol		xor a
003297 12                  B   107    				ld (de),a						003298 FD22 D4 60 00       B   108    				ld (script_file_offset),iy
00329D 22 D7 60 00         B   109    				ld (script_buffer_offset),hl
                           B   110    			
0032A1 CD 4A 0C 00         B   111    				call os_parse_cmd_chk_ps		                           B   112    				
0032A5 FD2A D4 60 00       B   113    				ld iy,(script_file_offset)		0032AA 2A D7 60 00         B   114    				ld hl,(script_buffer_offset)
0032AE 7E                  B   115    scrp_fnc		ld a,(hl)		
0032AF B7                  B   116    				or a
0032B0 C8                  B   117    				ret z							0032B1 FE20                B   118    				cp 020h
0032B3 30 05               B   119    				jr nc,scrp_gnc					0032B5 23                  B   120    				inc hl		
0032B6 FD23                B   121    				inc iy							0032B8 18 F4               B   122    				jr scrp_fnc
                           B   123    			
0032BA FD22 D4 60 00       B   124    scrp_gnc		ld (script_file_offset),iy		0032BF C3 F5 31 00         B   125    				jp scrp_loop	
                           B   126    			
                           B   127    			
                           B   128    			
0032C3 D1                  B   129    pop_ret			pop de
0032C4 C9                  B   130    				ret
                           B   131    				
                           B   132    			
                           B   133    ;----------------------------------------------
                           B     0    	include 'commands\ltn.asm'
                           B     1    ;----------------------------------------------
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 118


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\ltn.asm
                           B     2    ; OS "<" Command: Update mem hex bytes and re-d
                           B     3    ;
                           B     4    ; Not currently enabled in PROSE
                           B     5    ;----------------------------------------------
                           B     6    
0032C5                     B     7    os_cmd_ltn
                           B     8    
0032C5 AF                  B     9    				xor a
0032C6 C9                  B    10    				ret
                           B    11    
                           B    12    
                           B    13    ;----------------------------------------------
                           B    14    	
                           B     0    	include 'commands\pen.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"Pen" - Change attribute v0.02 - ADL mode
                           B     3    ;----------------------------------------------
                           B     4    
0032C7                     B     5    os_cmd_pen
                           B     6    	
0032C7 0602                B     7    				ld b,2							0032C9 DD21 34 5D 00       B     8    				ld ix,current_pen
                           B     9    				
0032CE CD 50 1C 00         B    10    chpenlp			call hexword_or_bust			0032D2 28 0D               B    11    				jr z,pendone					0032D4 23                  B    12    				inc hl
0032D5 DD7300              B    13    				ld (ix),e
0032D8 DD7201              B    14    				ld (ix+1),d
0032DB DD23                B    15    				inc ix
0032DD DD23                B    16    				inc ix
0032DF 10 ED               B    17    				djnz chpenlp	
                           B    18    				
0032E1 CD 97 0F 00         B    19    pendone			call os_refresh_screen
0032E5 AF                  B    20    				xor a
0032E6 C9                  B    21    				ret
                           B    22    
                           B    23    ;----------------------------------------------
                           B     0    	include 'commands\palette.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"Palette" - Change attribute v0.01 - ADL mode
                           B     3    ;----------------------------------------------
                           B     4    
0032E7                     B     5    os_cmd_palette
                           B     6    
0032E7 0610                B     7    				ld b,16							0032E9 DD21 38 5D 00       B     8    				ld ix,pen_palette
                           B     9    				
0032EE 0E00                B    10    				ld c,0
0032F0 C5                  B    11    chcollp			push bc
0032F1 CD 50 1C 00         B    12    				call hexword_or_bust			0032F5 C1                  B    13    				pop bc
0032F6 28 0E               B    14    				jr z,colrdone					Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 119


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\palette.asm
0032F8 0C                  B    15    				inc c
0032F9 23                  B    16    				inc hl
0032FA DD7300              B    17    				ld (ix),e
0032FD DD7201              B    18    				ld (ix+1),d
003300 DD23                B    19    				inc ix
003302 DD23                B    20    				inc ix
003304 10 EA               B    21    				djnz chcollp
                           B    22    			
003306 79                  B    23    colrdone		ld a,c
003307 B7                  B    24    				or a
003308 20 04               B    25    				jr nz,pal_ok
00330A 3E81                B    26    				ld a,81h						00330C B7                  B    27    				or a
00330D C9                  B    28    				ret
00330E 21 38 5D 00         B    29    pal_ok			ld hl,pen_palette
003312 CD BE 3B 00         B    30    				call hswc_set_ui_colours	
003316 AF                  B    31    				xor a
003317 C9                  B    32    				ret
                           B    33    
                           B    34    ;----------------------------------------------
                           B     0    	include 'commands\mouse.asm'
                           B     1    ;----------------------------------------------
                           B     2    ; "Mouse" = Reset / Enable Mouse Driver v0.05 -
                           B     3    ;----------------------------------------------
                           B     4    
       00000280            B     5    window_width_pixels		equ 640
       000001E0            B     6    window_height_pixels	equ 480
                           B     7    
       00000064            B     8    default_sample_rate 	equ 100			; 100 s
       00000003            B     9    default_resolution		equ 03h			; 8 cou
       000000E6            B    10    default_scaling			equ 0e6h		; valid
                           B    11    
003318                     B    12    os_cmd_mouse
                           B    13    
                           B    14    		
003318 CD B8 38 00         B    15    				call disable_ms_irq
                           B    16    
00331C 21 1A 5F 00         B    17    				ld hl,devices_connected
003320 CB8E                B    18    				res 1,(hl)
                           B    19    		
003322 CD 34 41 00         B    20    				call init_mouse
003326 C0                  B    21    				ret nz
                           B    22    			
003327 AF                  B    23    				xor a
003328 32 0D 61 00         B    24    				ld (mouse_packet_index),a
00332C 32 0E 61 00         B    25    				ld (mouse_buttons),a
003330 21000000            B    26    				ld hl,0
003334 22 0F 61 00         B    27    				ld (mouse_disp_x),hl
003338 22 12 61 00         B    28    				ld (mouse_disp_y),hl
                           B    29    
00333C 21800200            B    30    				ld hl,window_width_pixels
003340 11E00100            B    31    				ld de,window_height_pixels
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 120


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\mouse.asm
003344 CD 39 14 00         B    32    				call os_set_mouse_window
                           B    33    
003348 CD B2 38 00         B    34    				call enable_ms_irq
                           B    35    
00334C 21 1A 5F 00         B    36    				ld hl,devices_connected
003350 CBCE                B    37    				set 1,(hl)
003352 AF                  B    38    				xor a
003353 C9                  B    39    				ret				
                           B    40    				
                           B    41    ;----------------------------------------------
                           B    42    	
                           B     0    	include 'commands\vmode.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"vmode" - Change video mode - ADL mode 0.1
                           B     3    ;----------------------------------------------
                           B     4    
003354                     B     5    os_cmd_vmode
                           B     6    	
003354 CD 50 1C 00         B     7    				call hexword_or_bust			003358 28 78               B     8    				jr z,vm_no_data					00335A 7B                  B     9    				ld a,e
                           B    10    
00335B FE04                B    11    set_vmode		cp 4
00335D 30 6F               B    12    				jr nc,vm_bad_range
                           B    13    				
00335F 2A 6D 5D 00         B    14    				ld hl,(font_addr)				003363 ED5B 73 5D 00       B    15    				ld de,(video_window_address)
003368 ED4B 70 5D 00       B    16    				ld bc,(font_length)
00336D EDB0                B    17    				ldir
                           B    18    								
00336F 32 33 5D 00         B    19    				ld (video_mode),a
003373 21070000            B    20    				ld hl,7
003377 67                  B    21    				ld h,a
003378 ED6C                B    22    				mlt hl
00337A E5                  B    23    				push hl
00337B DDE1                B    24    				pop ix
00337D 11 D6 33 00         B    25    				ld de,mode_param_list
003381 DD19                B    26    				add ix,de
003383 21000000            B    27    				ld hl,0
003387 11000000            B    28    				ld de,0
00338B DD6E00              B    29    				ld l,(ix)
00338E DD6601              B    30    				ld h,(ix+1)
003391 DD5E02              B    31    				ld e,(ix+2)
003394 DD5603              B    32    				ld d,(ix+3)
003397 DD4604              B    33    				ld b,(ix+4)
00339A DDE5                B    34    				push ix
00339C CD AB 3A 00         B    35    				call set_bitmap_parameters
0033A0 DDE1                B    36    				pop ix
0033A2 DD4605              B    37    				ld b,(ix+5)
0033A5 DD4E06              B    38    				ld c,(ix+6)
0033A8 CD 11 3B 00         B    39    				call set_charmap_parameters
                           B    40    				
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 121


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\vmode.asm
0033AC 2A 73 5D 00         B    41    				ld hl,(video_window_address)	0033B0 ED5B 6D 5D 00       B    42    				ld de,(font_addr)				0033B5 ED4B 70 5D 00       B    43    				ld bc,(font_length)				0033BA EDB0                B    44    				ldir
                           B    45    				
0033BC CD CA 3B 00         B    46    				call hwsc_clear_screen
                           B    47    				
0033C0 01080400            B    48    				ld bc,0408h
0033C4 CD DF 3A 00         B    49    				call set_font_parameters		                           B    50    				
0033C8 AF                  B    51    				xor a
0033C9 32 5A 5D 00         B    52    				ld (active_cursor_image),a		                           B    53    				
0033CD C9                  B    54    				ret
                           B    55    
0033CE 3E88                B    56    vm_bad_range	ld a,88h
0033D0 B7                  B    57    				or a
0033D1 C9                  B    58    				ret
                           B    59    
0033D2 3E81                B    60    vm_no_data		ld a,81h
0033D4 B7                  B    61    				or a
0033D5 C9                  B    62    				ret
                           B    63    
                           B    64    ;----------------------------------------------
                           B    65    
0033D6                     B    66    mode_param_list
                           B    67    
0033D6 4001E001            B    68    				dw 640/2,480
0033DA 00                  B    69    				db 00b
0033DB 503C                B    70    				db 80,60
                           B    71    				
0033DD 4001F000            B    72    				dw 640/2,240
0033E1 01                  B    73    				db 01b
0033E2 501E                B    74    				db 80,30
                           B    75    				
0033E4 A000E001            B    76    				dw 320/2,480
0033E8 02                  B    77    				db 10b
0033E9 283C                B    78    				db 40,60
                           B    79    				
0033EB A000F000            B    80    				dw 320/2,240
0033EF 03                  B    81    				db 11b
0033F0 281E                B    82    				db 40,30
                           B    83    				
                           B    84    ;----------------------------------------------
                           B     0    	include 'commands\font.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"font" - replace font. V0.01 - ADL mode
                           B     3    ;----------------------------------------------
                           B     4    
0033F2                     B     5    os_cmd_font
                           B     6    	
0033F2 CD 6A 16 00         B     7    				call os_check_volume_format	
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 122


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\font.asm
0033F6 C0                  B     8    				ret nz
                           B     9    				
0033F7 CD 6F 28 00         B    10    				call filename_or_bust			0033FB 22 1D 67 00         B    11    				ld (scratch_pad),hl
                           B    12    
0033FF CD 3A 1A 00         B    13    				call fs_get_dir_cluster			003403 ED53 20 67 00       B    14    				ld (scratch_pad+3),de
                           B    15    				
003408 CD C8 16 00         B    16    				call os_root_dir				00340C C0                  B    17    				ret nz
00340D 21 3D 34 00         B    18    				ld hl,fonts_fn
003411 CD B8 16 00         B    19    				call os_change_dir
003415 20 1A               B    20    				jr nz,no_font
                           B    21    				
003417 2A 1D 67 00         B    22    				ld hl,(scratch_pad)
00341B CD FD 15 00         B    23    				call os_find_file				00341F 20 10               B    24    				jr nz,no_font
                           B    25    				
003421 11000700            B    26    				ld de,700h
003425 CD 0E 16 00         B    27    				call os_set_load_length			                           B    28    
003429 2A 6D 5D 00         B    29    				ld hl,(font_addr)				00342D CD 2C 16 00         B    30    				call os_read_bytes_from_file
                           B    31    						
003431 F5                  B    32    no_font			push af
003432 ED5B 20 67 00       B    33    				ld de,(scratch_pad+3)			003437 CD 46 1A 00         B    34    				call fs_update_dir_cluster
00343B F1                  B    35    				pop af
00343C C9                  B    36    				ret
                           B    37    
                           B    38    ;----------------------------------------------
                           B    39    
00343D 666F6E74 7300       B    40    fonts_fn		db "fonts",0
                           B    41    
                           B    42    ;----------------------------------------------
                           B     0    	include 'commands\set.asm'
                           B     1    ;----------------------------------------------
                           B     2    ;"set" - set an environment variable v0.01
                           B     3    ;
                           B     4    ; Command should be in format: "SET BLAH=SOMETH
                           B     5    ;
                           B     6    ;----------------------------------------------
                           B     7    
003443 7E                  B     8    os_cmd_set		ld a,(hl)					; i
003444 B7                  B     9    				or a
003445 28 3B               B    10    				jr z,show_envars
                           B    11    
003447 11 20 67 00         B    12    				ld de,scratch_pad+3			; p
00344B 7E                  B    13    evsalp1			ld a,(hl)
00344C 12                  B    14    				ld (de),a
00344D B7                  B    15    				or a
00344E 28 2E               B    16    				jr z,set_bad_args
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 123


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\set.asm
003450 FE3D                B    17    				cp '='
003452 28 04               B    18    				jr z,evsadone1
003454 23                  B    19    				inc hl
003455 13                  B    20    				inc de
003456 18 F3               B    21    				jr evsalp1
003458 AF                  B    22    evsadone1		xor a
003459 12                  B    23    				ld (de),a
00345A 13                  B    24    				inc de
00345B 23                  B    25    				inc hl
00345C ED53 1D 67 00       B    26    				ld (scratch_pad),de
                           B    27    
003461 7E                  B    28    evsalp2			ld a,(hl)
003462 12                  B    29    				ld (de),a
003463 FE20                B    30    				cp ' '
003465 28 07               B    31    				jr z,evsadone2
003467 B7                  B    32    				or a
003468 28 14               B    33    				jr z,set_bad_args
00346A 23                  B    34    				inc hl
00346B 13                  B    35    				inc de
00346C 18 F3               B    36    				jr evsalp2
00346E AF                  B    37    evsadone2		xor a
00346F 12                  B    38    				ld (de),a
                           B    39    				
003470 21 20 67 00         B    40    				ld hl,scratch_pad+3
003474 ED5B 1D 67 00       B    41    				ld de,(scratch_pad)
003479 CD 41 1B 00         B    42    				call os_set_envar
00347D C9                  B    43    				ret
                           B    44    
00347E 3E82                B    45    set_bad_args	ld a,82h
003480 B7                  B    46    				or a
003481 C9                  B    47    				ret
                           B    48    				
                           B    49    
003482 21 31 61 00         B    50    show_envars		ld hl,envar_list
                           B    51    				
003486 7E                  B    52    show_envlp		ld a,(hl)
003487 FEFF                B    53    				cp 0ffh
003489 28 12               B    54    				jr z,set_done
00348B E5                  B    55    				push hl
00348C CD 25 0F 00         B    56    				call os_print_string
003490 CD B8 13 00         B    57    				call os_new_line
003494 E1                  B    58    				pop hl
                           B    59    				
003495 23                  B    60    set_fnl			inc hl
003496 7E                  B    61    				ld a,(hl)
003497 B7                  B    62    				or a
003498 20 FB               B    63    				jr nz,set_fnl
00349A 23                  B    64    				inc hl
00349B 18 E9               B    65    				jr show_envlp
                           B    66    				
00349D AF                  B    67    set_done		xor a
00349E C9                  B    68    				ret
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 124


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\commands\set.asm
                           B    69    								
                           B    70    ;----------------------------------------------
                           B     0    	include 'commands\dz.asm'
                           B     1    ;----------------------------------------------
                           B     2    ; OS "DZ" Command: Z80-mode Disassemble V0.01
                           B     3    ;----------------------------------------------
                           B     4    
00349F FD21 19 23 00       B     5    os_cmd_dz		ld iy,prefix_bits_loc
0034A4 FDCB 07 86          B     6    				res adl_dis,(iy+var_adl)
0034A8 C3 6D 1D 00         B     7    				jp os_cmd_d_go
                           B     8    				
                           B     9    ;----------------------------------------------
                           A  3065    
0034AC C9                  A  3066    os_cmd_unused	ret		; <- dummy command, sho
                           A  3067    
                           A  3068    ;----------------------------------------------
                           A  3069    
0034AD                     A  3070    os_get_mem_high
                           A  3071    
0034AD 2A 1B 5F 00         A  3072    		ld hl,(sys_ram_high)
0034B1 ED5B 1E 5F 00       A  3073    		ld de,(vram_a_high)
0034B6 ED4B 21 5F 00       A  3074    		ld bc,(vram_b_high)
0034BB AF                  A  3075    		xor a
0034BC C9                  A  3076    		ret
                           A  3077    								
                           A  3078    ;----------------------------------------------
                           A  3079    ; Drivers
                           A  3080    ;----------------------------------------------
                           A  3081    
                           B     0    	include		'prose_sdcard_driver.asm'		                           B     1    ;----------------------------------------------
                           B     2    ; Z80 MMC/SDC card access routines - Phil Rusto
                           B     3    ;----------------------------------------------
                           B     4    ;
                           B     5    ; Limitations:
                           B     6    ; ------------
                           B     7    ; Currently does not support V2.0 SD cards (IE:
                           B     8    ; Does not check for voltage compatibility or b
                           B     9    ; Somewhat arbitary timimg..
                           B    10    ;
                           B    11    ;----------------------------------------------
                           B    12    
                           B    13    ; Key Routines:      Input Registers           
                           B    14    ; -------------      ---------------           
                           B    15    ; sdc_get_id			no arguments required  
                           B    16    ; sdc_read_sector		sector_LBA0-3			                           B    17    ; sdc_write_sector		sector_LBA0-3    		                           B    18    ;
                           B    19    ; (Assume all other registers are trashed.)
                           B    20    ;
                           B    21    ; Routines respond with Carry flag set if opera
                           B    22    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 125


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_sdcard_driver.asm
       00000000            B    23    sdc_error_spi_mode_failed			equ 0
       00000001            B    24    sdc_error_bad_init_mmc				equ 1
       00000002            B    25    sdc_error_bad_init					equ 2
       00000003            B    26    sdc_error_bad_id					equ 3
       00000004            B    27    sdc_error_bad_command_response		equ 4
       00000005            B    28    sdc_error_data_token_timeout		equ 5
       00000006            B    29    sdc_error_write_timeout				equ 6
       00000007            B    30    sdc_error_write_failed				equ 7
                           B    31    
                           B    32    ; Variables required:
                           B    33    ; -------------------
                           B    34    ;
                           B    35    ; "sector_buffer" - 512 bytes
                           B    36    ;
                           B    37    ; "sector_lba0" - LBA of desired sector LSB
                           B    38    ; "sector_lba1" 
                           B    39    ; "sector_lba2"
                           B    40    ; "sector_lba3" - LBA of desired sector MSB
                           B    41    ;
                           B    42    ; "sdc_sdc" - 1 byte (0 = card is MMC, 1 = card
                           B    43    
                           B    44    
                           B    45    ;----------------------------------------------
                           B    46    ; PROSE STANDARD DRIVER HEADER
                           B    47    ;----------------------------------------------
                           B    48    
0034BD                     B    49    sd_card_driver				; label of driver c
                           B    50    
0034BD C3 D1 34 00         B    51    	jp sdc_get_id			; $00 : init / get 
0034C1 C3 9B 36 00         B    52    	jp sdc_read_sector		; $04 : jump to rea
0034C5 C3 EB 36 00         B    53    	jp sdc_write_sector		; $08 : jump to wri
0034C9 53445F43 41524400   B    54    	db "SD_CARD",0			; $0c : desired ASC
                           B    55    
                           B    56    ;----------------------------------------------
                           B    57    ; Hardware agnostic section..
                           B    58    ;----------------------------------------------
                           B    59    
0034D1                     B    60    sdc_get_id
                           B    61    
                           B    62    
                           B    63    ; Initializes card, reads CSD and CID into sect
                           B    64    ; containing ASCII device ID. Returns device ca
                           B    65    
                           B    66    ; Returns:
                           B    67    ; --------
                           B    68    ;   HL = Pointer to device ID string 
                           B    69    ; C:DE = Capacity (number of sectors)
                           B    70    
                           B    71    
0034D1 3E01                B    72    				ld a,1							0034D3 32 21 38 00         B    73    				ld (sdc_sdc),a			
                           B    74    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 126


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_sdcard_driver.asm
0034D7 CD 68 38 00         B    75    				call sdc_power_off				0034DB CD 73 38 00         B    76    				call sdc_slow_clock				0034DF CD 41 38 00         B    77    				call sdc_select_card			                           B    78    
0034E3 11004000            B    79    				ld de,16384						0034E7 CD 0A 40 00         B    80    				call hwsc_time_delay
                           B    81    				
0034EB CD 5D 38 00         B    82    				call sdc_power_on				                           B    83    
0034EF 11830000            B    84    				ld de,131						0034F3 CD 0A 40 00         B    85    				call hwsc_time_delay
                           B    86    
0034F7 CD 4C 38 00         B    87    				call sdc_deselect_card			                           B    88    	
0034FB 060A                B    89    				ld b,10							0034FD CD D9 37 00         B    90    sdc_ecilp		call sdc_send_eight_clocks
003501 10 FA               B    91    				djnz sdc_ecilp
                           B    92    	
003503 CD 41 38 00         B    93    				call sdc_select_card			                           B    94    	
003507 3E40                B    95    				ld a,040h						003509 01009500            B    96    				ld bc,09500h					00350D 11000000            B    97    				ld de,00000h
003511 CD 87 37 00         B    98    				call sdc_send_command		 
003515 CD 32 38 00         B    99    				call sdc_get_byte				003519 CD AC 37 00         B   100    				call sdc_wait_ncr				00351D EE01                B   101    				xor 01h							00351F C2 E0 37 00         B   102    				jp nz,init_spi_mode_fail		                           B   103    
                           B   104    
003523 01401F00            B   105    				ld bc,8000						003527 C5                  B   106    sdc_iwl			push bc							003528 3E77                B   107    				ld a,077h						00352A CD 7F 37 00         B   108    				call sdc_send_command_null_args
00352E CD 32 38 00         B   109    				call sdc_get_byte				003532 CD 32 38 00         B   110    				call sdc_get_byte				003536 3E69                B   111    				ld a,069h						003538 CD 7F 37 00         B   112    				call sdc_send_command_null_args
00353C CD 32 38 00         B   113    				call sdc_get_byte
003540 C1                  B   114    				pop bc
003541 CD AC 37 00         B   115    				call sdc_wait_ncr				003545 CB57                B   116    				bit 2,a							003547 20 0C               B   117    				jr nz,mmc_init			
003549 B7                  B   118    				or a
00354A 28 2A               B   119    				jr z,sdc_init_done				00354C 0B                  B   120    				dec bc
00354D 78                  B   121    				ld a,b
00354E B1                  B   122    				or c
00354F 20 D6               B   123    				jr nz,sdc_iwl
003551 C3 EE 37 00         B   124    				jp sdc_init_fail
                           B   125    
                           B   126    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 127


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_sdcard_driver.asm
003555 AF                  B   127    mmc_init		xor a							003556 32 21 38 00         B   128    				ld (sdc_sdc),a
00355A 01401F00            B   129    				ld bc,8000						00355E C5                  B   130    mmc_iwl			push bc
00355F 3E41                B   131    				ld a,041h						003561 CD 7F 37 00         B   132    				call sdc_send_command_null_args
003565 C1                  B   133    				pop bc
003566 CD AC 37 00         B   134    				call sdc_wait_ncr				00356A B7                  B   135    				or a							00356B 28 09               B   136    				jr z,sdc_init_done
00356D 0B                  B   137    				dec bc
00356E 78                  B   138    				ld a,b
00356F B1                  B   139    				or c
003570 20 EC               B   140    				jr nz,mmc_iwl
003572 C3 EA 37 00         B   141    				jp mmc_init_fail
                           B   142    
003576                     B   143    sdc_init_done
                           B   144    
003576 3E49                B   145    				ld a,049h						003578 CD 7F 37 00         B   146    				call sdc_send_command_null_args
00357C CD AC 37 00         B   147    				call sdc_wait_ncr				003580 B7                  B   148    				or a							003581 C2 F2 37 00         B   149    				jp nz,sdc_id_fail
003585 CD C0 37 00         B   150    				call sdc_wait_data_token		003589 B7                  B   151    				or a
00358A C2 F2 37 00         B   152    				jp nz,sdc_id_fail
00358E 21 1D 65 00         B   153    				ld hl,sector_buffer				003592 CD 88 36 00         B   154    				call sdc_read_id_bytes	
                           B   155    
003596 3E4A                B   156    				ld a,04ah						003598 CD 7F 37 00         B   157    				call sdc_send_command_null_args
00359C CD AC 37 00         B   158    				call sdc_wait_ncr				0035A0 B7                  B   159    				or a							0035A1 C2 F2 37 00         B   160    				jp nz,sdc_id_fail
0035A5 CD C0 37 00         B   161    				call sdc_wait_data_token		0035A9 B7                  B   162    				or a
0035AA C2 F2 37 00         B   163    				jp nz,sdc_id_fail
0035AE 21 2D 65 00         B   164    				ld hl,sector_buffer+16			0035B2 CD 88 36 00         B   165    				call sdc_read_id_bytes
0035B6 CD 4C 38 00         B   166    				call sdc_deselect_card
                           B   167    
                           B   168    
0035BA                     B   169    sdc_quit	
                           B   170    
0035BA 21 30 65 00         B   171    				ld hl,sector_buffer+013h		0035BE 11 3D 65 00         B   172    				ld de,sector_buffer+020h
0035C2 01050000            B   173    				ld bc,5
0035C6 3A 21 38 00         B   174    				ld a,(sdc_sdc)
0035CA B7                  B   175    				or a
0035CB 20 01               B   176    				jr nz,sdc_cn5
0035CD 03                  B   177    				inc bc
0035CE EDB0                B   178    sdc_cn5			ldir
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 128


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_sdcard_driver.asm
0035D0 E5                  B   179    				push hl
0035D1 D5                  B   180    				push de
0035D2 21 06 38 00         B   181    				ld hl,sdc_vnchars
0035D6 011A0000            B   182    				ld bc,26
0035DA EDB0                B   183    				ldir
0035DC D1                  B   184    				pop de
0035DD E1                  B   185    				pop hl
0035DE 13                  B   186    				inc de
0035DF 13                  B   187    				inc de
0035E0 7E                  B   188    				ld a,(hl)
0035E1 CB3F                B   189    				srl a
0035E3 CB3F                B   190    				srl a
0035E5 CB3F                B   191    				srl a
0035E7 CB3F                B   192    				srl a
0035E9 C630                B   193    				add a,030h						0035EB 12                  B   194    				ld (de),a
0035EC 13                  B   195    				inc de
0035ED 13                  B   196    				inc de
0035EE 7E                  B   197    				ld a,(hl)
0035EF E60F                B   198    				and 0fh
0035F1 C630                B   199    				add a,030h
0035F3 12                  B   200    				ld (de),a						0035F4 13                  B   201    				inc de
0035F5 13                  B   202    				inc de
0035F6 13                  B   203    				inc de
0035F7 13                  B   204    				inc de
0035F8 13                  B   205    				inc de
0035F9 23                  B   206    				inc hl
0035FA 0604                B   207    				ld b,4
0035FC 7E                  B   208    sdc_snulp		ld a,(hl)						0035FD CB3F                B   209    				srl a
0035FF CB3F                B   210    				srl a
003601 CB3F                B   211    				srl a
003603 CB3F                B   212    				srl a
003605 C630                B   213    				add a,030h
003607 FE3A                B   214    				cp 03ah
003609 38 02               B   215    				jr c,sdc_hvl1
00360B C607                B   216    				add a,07h
00360D 12                  B   217    sdc_hvl1		ld (de),a
00360E 13                  B   218    				inc de
00360F 7E                  B   219    				ld a,(hl)
003610 E60F                B   220    				and 0fh
003612 C630                B   221    				add a,030h
003614 FE3A                B   222    				cp 03ah
003616 38 02               B   223    				jr c,sdc_hvl2
003618 C607                B   224    				add a,07h
00361A 12                  B   225    sdc_hvl2		ld (de),a
00361B 13                  B   226    				inc de
00361C 23                  B   227    				inc hl
00361D 10 DD               B   228    				djnz sdc_snulp
                           B   229    	
                           B   230    	
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 129


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_sdcard_driver.asm
                           B   231    
00361F DD21 1D 65 00       B   232    				ld ix,sector_buffer				003624 DD7E06              B   233    				ld a,(ix+6)
003627 E603                B   234    				and 00000011b
003629 57                  B   235    				ld d,a
00362A DD5E07              B   236    				ld e,(ix+7)
00362D DD7E08              B   237    				ld a,(ix+8)
003630 E6C0                B   238    				and 11000000b
003632 CB27                B   239    				sla a
003634 CB13                B   240    				rl e
003636 CB12                B   241    				rl d
003638 CB27                B   242    				sla a
00363A CB13                B   243    				rl e
00363C CB12                B   244    				rl d							                           B   245    	
00363E DD7E09              B   246    				ld a,(ix+9)
003641 E603                B   247    				and 00000011b
003643 47                  B   248    				ld b,a
003644 DD7E0A              B   249    				ld a,(ix+10)
003647 E680                B   250    				and 10000000b
003649 CB27                B   251    				sla a
00364B CB10                B   252    				rl b							                           B   253    	
00364D 04                  B   254    				inc b
00364E 04                  B   255    				inc b
00364F 21000000            B   256    				ld hl,0
003653 CB23                B   257    sdc_cmsh		sla e
003655 CB12                B   258    				rl d
003657 CB15                B   259    				rl l
003659 CB14                B   260    				rl h
00365B 10 F6               B   261    				djnz sdc_cmsh					                           B   262    	
00365D DD7E05              B   263    				ld a,(ix+5)
003660 E60F                B   264    				and 00001111b					003662 28 17               B   265    				jr z,sdc_nbls
003664 47                  B   266    				ld b,a
003665 CB23                B   267    sdc_blsh		sla e
003667 CB12                B   268    				rl d
003669 CB15                B   269    				rl l
00366B CB14                B   270    				rl h
00366D 10 F6               B   271    				djnz sdc_blsh					                           B   272    	
00366F 0609                B   273    				ld b,9							003671 CB3C                B   274    sdc_cbsec		srl h
003673 CB1D                B   275    				rr l
003675 CB1A                B   276    				rr d
003677 CB1B                B   277    				rr e
003679 10 F6               B   278    				djnz sdc_cbsec
                           B   279    
00367B E5                  B   280    sdc_nbls		push hl
00367C C1                  B   281    				pop bc							00367D 21 3D 65 00         B   282    				ld hl,sector_buffer+020h		Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 130


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_sdcard_driver.asm
                           B   283    
003681 CD 7E 38 00         B   284    				call sdc_fast_clock				003685 AF                  B   285    				xor a
003686 37                  B   286    				scf
003687 C9                  B   287    				ret
                           B   288    
                           B   289    
                           B   290    ;----------------------------------------------
                           B   291    
003688                     B   292    sdc_read_id_bytes
                           B   293    
003688 0610                B   294    				ld b,16
00368A CD 32 38 00         B   295    sdc_csdlp		call sdc_get_byte
00368E 77                  B   296    				ld (hl),a
00368F 23                  B   297    				inc hl
003690 10 F8               B   298    				djnz sdc_csdlp
003692 CD 32 38 00         B   299    				call sdc_get_byte				003696 CD 32 38 00         B   300    				call sdc_get_byte				00369A C9                  B   301    				ret
                           B   302    	
                           B   303    ;----------------------------------------------
                           B   304    	
                           B   305    	
00369B                     B   306    sdc_read_sector
                           B   307    
                           B   308    ;set c:de to sector number to read, 512 bytes r
                           B   309    
00369B CD 41 38 00         B   310    				call sdc_select_card
                           B   311    
00369F 21 AC 5F 00         B   312    				ld hl,sector_lba0
0036A3 5E                  B   313    				ld e,(hl)						0036A4 23                  B   314    				inc hl
0036A5 56                  B   315    				ld d,(hl)
0036A6 23                  B   316    				inc hl
0036A7 4E                  B   317    				ld c,(hl)
0036A8 CB23                B   318    				sla e							0036AA CB12                B   319    				rl d
0036AC CB11                B   320    				rl c
0036AE 3E51                B   321    				ld a,051h						0036B0 0601                B   322    				ld b,001h						0036B2 CD 87 37 00         B   323    				call sdc_send_command		
0036B6 CD AC 37 00         B   324    				call sdc_wait_ncr				0036BA B7                  B   325    				or a							0036BB C2 F6 37 00         B   326    				jp nz,sdc_bcr_error			
0036BF CD C0 37 00         B   327    				call sdc_wait_data_token		0036C3 B7                  B   328    				or a
0036C4 C2 FA 37 00         B   329    				jp nz,sdc_dt_timeout
                           B   330    	
0036C8 21 1D 65 00         B   331    				ld hl,sector_buffer				0036CC 0600                B   332    				ld b,0
0036CE CD 32 38 00         B   333    sdc_rslp		call sdc_get_byte
0036D2 77                  B   334    				ld (hl),a
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 131


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_sdcard_driver.asm
0036D3 23                  B   335    				inc hl
0036D4 CD 32 38 00         B   336    				call sdc_get_byte
0036D8 77                  B   337    				ld (hl),a
0036D9 23                  B   338    				inc hl
0036DA 10 F2               B   339    				djnz sdc_rslp
0036DC CD 32 38 00         B   340    				call sdc_get_byte				0036E0 CD 32 38 00         B   341    				call sdc_get_byte				                           B   342    
0036E4 CD 4C 38 00         B   343    				call sdc_deselect_card
0036E8 AF                  B   344    				xor a
0036E9 37                  B   345    				scf
0036EA C9                  B   346    				ret
                           B   347    	
                           B   348    ;----------------------------------------------
                           B   349    
0036EB                     B   350    sdc_write_sector
                           B   351    
                           B   352    ;set c:de to sector number to write, 512 bytes 
                           B   353    
0036EB CD 41 38 00         B   354    				call sdc_select_card
                           B   355    
0036EF 21 AC 5F 00         B   356    				ld hl,sector_lba0
0036F3 5E                  B   357    				ld e,(hl)						0036F4 23                  B   358    				inc hl
0036F5 56                  B   359    				ld d,(hl)
0036F6 23                  B   360    				inc hl
0036F7 4E                  B   361    				ld c,(hl)
0036F8 CB23                B   362    				sla e							0036FA CB12                B   363    				rl d
0036FC CB11                B   364    				rl c
0036FE 3E58                B   365    				ld a,058h						003700 0601                B   366    				ld b,001h						003702 CD 87 37 00         B   367    				call sdc_send_command		
003706 CD AC 37 00         B   368    				call sdc_wait_ncr				00370A B7                  B   369    				or a							00370B C2 F6 37 00         B   370    				jp nz,sdc_bcr_error			
                           B   371    	
00370F CD D9 37 00         B   372    				call sdc_send_eight_clocks		                           B   373    
003713 3EFE                B   374    				ld a,0feh
003715 CD 22 38 00         B   375    				call sdc_send_byte				                           B   376    
003719 21 1D 65 00         B   377    				ld hl,sector_buffer				00371D 0600                B   378    				ld b,0
00371F 7E                  B   379    sdc_wslp		ld a,(hl)
003720 CD 22 38 00         B   380    				call sdc_send_byte
003724 23                  B   381    				inc hl
003725 7E                  B   382    				ld a,(hl)
003726 CD 22 38 00         B   383    				call sdc_send_byte
00372A 23                  B   384    				inc hl
00372B 10 F2               B   385    				djnz sdc_wslp
                           B   386    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 132


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_sdcard_driver.asm
00372D CD D9 37 00         B   387    				call sdc_send_eight_clocks		003731 CD D9 37 00         B   388    				call sdc_send_eight_clocks		                           B   389    		
003735 CD 32 38 00         B   390    				call sdc_get_byte				003739 E61F                B   391    				and 01fh
00373B CB3F                B   392    				srl a
00373D FE02                B   393    				cp 002h
00373F C2 FE 37 00         B   394    				jp nz,sdc_write_fail
                           B   395    
003743 0150C300            B   396    				ld bc,50000						003747 CD 32 38 00         B   397    sdc_wcbsy		call sdc_get_byte				00374B FEFF                B   398    				cp 0ffh
00374D 28 09               B   399    				jr z,sdc_nbusy
00374F 0B                  B   400    				dec bc
003750 78                  B   401    				ld a,b
003751 B1                  B   402    				or c
003752 20 F3               B   403    				jr nz,sdc_wcbsy
003754 C3 02 38 00         B   404    				jp sdc_card_busy_timeout	
                           B   405    
003758 3E4D                B   406    sdc_nbusy		ld a,04dh						00375A 01000100            B   407    				ld bc,0100h			
00375E 11000000            B   408    				ld de,0000h
003762 CD 87 37 00         B   409    				call sdc_send_command
003766 CD AC 37 00         B   410    				call sdc_wait_ncr				00376A B7                  B   411    				or a							00376B C2 FE 37 00         B   412    				jp nz,sdc_write_fail
00376F CD 32 38 00         B   413    				call sdc_get_byte				003773 B7                  B   414    				or a							003774 C2 FE 37 00         B   415    				jp nz,sdc_write_fail		
003778 CD 4C 38 00         B   416    				call sdc_deselect_card			00377C AF                  B   417    				xor a
00377D 37                  B   418    				scf
00377E C9                  B   419    				ret
                           B   420    	
                           B   421    ;----------------------------------------------
                           B   422    
00377F                     B   423    sdc_send_command_null_args
                           B   424    
00377F 01000100            B   425    				ld bc,0100h				
003783 11000000            B   426    				ld de,0000h
                           B   427    
                           B   428    
003787                     B   429    sdc_send_command
                           B   430    
                           B   431    ; set A = command, C:DE for sector number, B fo
                           B   432    
003787 F5                  B   433    				push af				
003788 CD D9 37 00         B   434    				call sdc_send_eight_clocks		00378C F1                  B   435    				pop af
                           B   436    
00378D CD 22 38 00         B   437    				call sdc_send_byte				003791 79                  B   438    				ld a,c							Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 133


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_sdcard_driver.asm
003792 CD 22 38 00         B   439    				call sdc_send_byte
003796 7A                  B   440    				ld a,d
003797 CD 22 38 00         B   441    				call sdc_send_byte
00379B 7B                  B   442    				ld a,e
00379C CD 22 38 00         B   443    				call sdc_send_byte
0037A0 3E00                B   444    				ld a,0
0037A2 CD 22 38 00         B   445    				call sdc_send_byte
0037A6 78                  B   446    				ld a,b							0037A7 CD 22 38 00         B   447    				call sdc_send_byte
0037AB C9                  B   448    				ret
                           B   449    
                           B   450    ;----------------------------------------------
                           B   451    
0037AC                     B   452    sdc_wait_ncr
                           B   453    	
0037AC C5                  B   454    				push bc
0037AD 01000000            B   455    				ld bc,0
0037B1 CD 32 38 00         B   456    sdc_wncrl		call sdc_get_byte				0037B5 CB7F                B   457    				bit 7,a							0037B7 28 05               B   458    				jr z,sdc_gcr
0037B9 0B                  B   459    				dec bc
0037BA 78                  B   460    			 	ld a,b
0037BB B1                  B   461    				or c
0037BC 20 F3               B   462    				jr nz,sdc_wncrl
0037BE C1                  B   463    sdc_gcr			pop bc
0037BF C9                  B   464    				ret
                           B   465    	
                           B   466    ;----------------------------------------------
                           B   467    
0037C0                     B   468    sdc_wait_data_token
                           B   469    
0037C0 C5                  B   470    				push bc
0037C1 01000000            B   471    				ld bc,0
0037C5 CD 32 38 00         B   472    sdc_wdt			call sdc_get_byte				0037C9 FEFE                B   473    				cp 0feh
0037CB 28 09               B   474    				jr z,sdc_gdt
0037CD 0B                  B   475    				dec bc
0037CE 78                  B   476    			 	ld a,b
0037CF B1                  B   477    				or c
0037D0 20 F3               B   478    				jr nz,sdc_wdt
0037D2 C1                  B   479    				pop bc
0037D3 3E01                B   480    				ld a,1							0037D5 C9                  B   481    				ret
                           B   482    
0037D6 C1                  B   483    sdc_gdt			pop bc
0037D7 AF                  B   484    				xor a							0037D8 C9                  B   485    				ret
                           B   486    
                           B   487    ;----------------------------------------------
                           B   488    
0037D9                     B   489    sdc_send_eight_clocks
                           B   490    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 134


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_sdcard_driver.asm
0037D9 3EFF                B   491    				ld a,0ffh
0037DB CD 22 38 00         B   492    				call sdc_send_byte
0037DF C9                  B   493    				ret
                           B   494    
                           B   495    ;----------------------------------------------
                           B   496    	
0037E0                     B   497    init_spi_mode_fail	
                           B   498    
0037E0 3E00                B   499    				ld a,sdc_error_spi_mode_failed
0037E2 F5                  B   500    fail_ret		push af
0037E3 CD 4C 38 00         B   501    				call sdc_deselect_card
0037E7 F1                  B   502    				pop af
0037E8 B7                  B   503    				or a
0037E9 C9                  B   504    				ret
                           B   505    				
                           B   506    ;----------------------------------------------
                           B   507    
0037EA                     B   508    mmc_init_fail
                           B   509    
0037EA 3E01                B   510    				ld a,sdc_error_bad_init_mmc
0037EC 18 F4               B   511    				jr fail_ret
                           B   512    
                           B   513    ;----------------------------------------------
                           B   514    
0037EE                     B   515    sdc_init_fail
                           B   516    
0037EE 3E02                B   517    				ld a,sdc_error_bad_init
0037F0 18 F0               B   518    				jr fail_ret
                           B   519    	
                           B   520    	
                           B   521    ;----------------------------------------------
                           B   522    
0037F2                     B   523    sdc_id_fail
                           B   524    
0037F2 3E03                B   525    				ld a,sdc_error_bad_id
0037F4 18 EC               B   526    				jr fail_ret
                           B   527    
                           B   528    ;----------------------------------------------
                           B   529    
0037F6                     B   530    sdc_bcr_error
                           B   531    
0037F6 3E04                B   532    				ld a,sdc_error_bad_command_resp
0037F8 18 E8               B   533    				jr fail_ret
                           B   534    	
                           B   535    ;----------------------------------------------
                           B   536    
0037FA                     B   537    sdc_dt_timeout
                           B   538    
0037FA 3E05                B   539    				ld a,sdc_error_data_token_timeo
0037FC 18 E4               B   540    				jr fail_ret
                           B   541    
                           B   542    ;----------------------------------------------
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 135


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_sdcard_driver.asm
                           B   543    
0037FE                     B   544    sdc_write_fail
                           B   545    	
0037FE 3E07                B   546    				ld a,sdc_error_write_failed
003800 18 E0               B   547    				jr fail_ret
                           B   548    
                           B   549    ;----------------------------------------------
                           B   550    
003802                     B   551    sdc_card_busy_timeout
                           B   552    
003802 3E06                B   553    				ld a,sdc_error_write_timeout
003804 18 DC               B   554    				jr fail_ret
                           B   555    
                           B   556    ;----------------------------------------------
                           B   557    
003806 2076782E 7820534E   B   558    sdc_vnchars	db " vx.x SN:00000000      ",0,0,0,
00380E 3A303030 30303030 
003816 30202020 20202000 
00381E 000000 
                           B   559    
003821 00                  B   560    sdc_sdc		db 0	; 0 = Card is MMC type, 1 =
                           B   561    
                           B   562    ;==============================================
                           B   563    
                           B   564    
                           B   565    ;----------------------------------------------
                           B   566    
                           C     0    include "ez80p_sdcard_code.asm"				;ha
                           C     1    ;----------------------------------------------
                           C     2    ; eZ80P Specific SD card low-level routines v0.
                           C     3    ;----------------------------------------------
                           C     4    
003822                     C     5    sdc_send_byte
                           C     6    
                           C     7    ;Put byte to send to card in A
                           C     8    
003822 C5                  C     9    					push bc
003823 01030000            C    10    					ld bc,port_sdc_data
003827 ED79                C    11    					out (bc),a					                           C    12    	
003829 0E01                C    13    					ld c,port_hw_flags			00382B ED7410              C    14    sdc_wb_loop			tstio 1<<sdc_serializer_bus
00382E 20 FB               C    15    					jr nz,sdc_wb_loop
                           C    16    
003830 C1                  C    17    					pop bc
003831 C9                  C    18    					ret
                           C    19    
                           C    20    ;----------------------------------------------
                           C    21    
003832                     C    22    sdc_get_byte
                           C    23    
                           C    24    ; Returns byte read from card in A
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 136


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_sdcard_code.asm
                           C    25    
003832 3EFF                C    26    					ld a,0ffh
003834 CD 22 38 00         C    27    					call sdc_send_byte
003838 C5                  C    28    					push bc
003839 01030000            C    29    					ld bc,port_sdc_data
00383D ED78                C    30    					in a,(bc)					00383F C1                  C    31    					pop bc
003840 C9                  C    32    					ret
                           C    33    	
                           C    34    ;----------------------------------------------
                           C    35    
003841                     C    36    sdc_select_card
                           C    37    	
003841 C5                  C    38    					push bc
003842 01020000            C    39    					ld bc,port_sdc_ctrl
003846 3E02                C    40    					ld a,1<<sdc_cs				003848 ED79                C    41    					out (bc),a
00384A C1                  C    42    					pop bc
00384B C9                  C    43    					ret
                           C    44    
                           C    45    
00384C                     C    46    sdc_deselect_card
                           C    47    
00384C C5                  C    48    					push bc
00384D 01020000            C    49    					ld bc,port_sdc_ctrl
003851 3E82                C    50    					ld a,080h+(1<<sdc_cs)		003853 ED79                C    51    					out (bc),a
003855 C1                  C    52    					pop bc
                           C    53    				
003856 3EFF                C    54    					ld a,0ffh					003858 CD 22 38 00         C    55    					call sdc_send_byte
00385C C9                  C    56    					ret
                           C    57    	
                           C    58    ;----------------------------------------------
                           C    59    
00385D                     C    60    sdc_power_on
                           C    61    
00385D C5                  C    62    					push bc
00385E 01020000            C    63    					ld bc,port_sdc_ctrl
003862 3E81                C    64    					ld a,80h+(1<<sdc_power)		003864 ED79                C    65    					out (bc),a
003866 C1                  C    66    					pop bc
003867 C9                  C    67    					ret
                           C    68    	
                           C    69    
003868                     C    70    sdc_power_off
                           C    71    	
003868 C5                  C    72    					push bc						003869 01020000            C    73    					ld bc,port_sdc_ctrl
00386D 3E01                C    74    					ld a,1<<sdc_power			00386F ED79                C    75    					out (bc),a					003871 C1                  C    76    					pop bc						Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 137


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_sdcard_code.asm
003872 C9                  C    77    					ret							                           C    78    	
                           C    79    
                           C    80    ;----------------------------------------------
                           C    81    
003873                     C    82    sdc_slow_clock
                           C    83    
003873 C5                  C    84    					push bc
003874 01020000            C    85    					ld bc,port_sdc_ctrl
003878 3E04                C    86    					ld a,1<<sdc_speed			00387A ED79                C    87    					out (bc),a
00387C C1                  C    88    					pop bc
00387D C9                  C    89    					ret
                           C    90    
                           C    91    
00387E                     C    92    sdc_fast_clock
                           C    93    	
00387E C5                  C    94    					push bc
00387F 01020000            C    95    					ld bc,port_sdc_ctrl
003883 3E84                C    96    					ld a,080h+(1<<sdc_speed)	003885 ED79                C    97    					out (bc),a
003887 C1                  C    98    					pop bc
003888 C9                  C    99    					ret
                           C   100    
                           C   101    ;----------------------------------------------
                           B   568    
                           B   569    ;----------------------------------------------
                           A  3083    
                           A  3084    
                           A  3085    ;----------------------------------------------
                           A  3086    ; IO routines
                           A  3087    ;----------------------------------------------
                           A  3088    
                           B     0    	include		'ez80p_interrupt_code.asm'		                           B     1    ;----------------------------------------------
                           B     2    ; ez80p interrupt code v0.05 (MADL mode)
                           B     3    ;----------------------------------------------
                           B     4    
003889                     B     5    set_irq_vector
                           B     6    
003889 AF                  B     7    				xor a
00388A ED47                B     8    				ld i,a
00388C 3EC3                B     9    				ld a,c3h						00388E 32320000            B    10    				ld (032h),a	
003892 21 C4 38 00         B    11    				ld hl,int_routine				003896 22330000            B    12    				ld (033h),hl
00389A C9                  B    13    				ret
                           B    14    
                           B    15    
                           B    16    
00389B 21 1A 5F 00         B    17    enable_os_irqs	ld hl,devices_connected			00389F CB46                B    18    				bit 0,(hl)
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 138


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_interrupt_code.asm
0038A1 C4 AC 38 00         B    19    				call nz,enable_kb_irq
0038A5 CB4E                B    20    				bit 1,(hl)
0038A7 C4 B2 38 00         B    21    				call nz,enable_ms_irq
0038AB C9                  B    22    				ret
                           B    23    
                           B    24    
0038AC 3E81                B    25    enable_kb_irq	ld a,10000001b
0038AE ED3905              B    26    				out0 (port_irq_ctrl),a			0038B1 C9                  B    27    				ret
                           B    28    
0038B2 3E82                B    29    enable_ms_irq	ld a,10000010b
0038B4 ED3905              B    30    				out0 (port_irq_ctrl),a			0038B7 C9                  B    31    				ret
                           B    32    
0038B8 3E02                B    33    disable_ms_irq	ld a,00000010b
0038BA ED3905              B    34    				out0 (port_irq_ctrl),a			0038BD C9                  B    35    				ret
                           B    36    
0038BE 3E3F                B    37    disable_irqs	ld a,00111111b
0038C0 ED3905              B    38    				out0 (port_irq_ctrl),a			0038C3 C9                  B    39    				ret
                           B    40    			
                           B    41    ;----------------------------------------------
                           B    42    
                           B    43    
0038C4                     B    44    int_routine
0038C4 F5                  B    45    				push af							0038C5 ED3807              B    46    				in0 a,(port_ps2_ctrl)			0038C8 CB67                B    47    				bit 4,a
0038CA C4 DC 38 00         B    48    				call nz,kb_interrupt_handler
0038CE ED3807              B    49    				in0 a,(port_ps2_ctrl)			0038D1 CB6F                B    50    				bit 5,a
0038D3 C4 7E 39 00         B    51    				call nz,ms_interrupt_handler
0038D7 F1                  B    52    				pop af
                           B    53    
0038D8 FB                  B    54    				ei								0038D9 5BED4D              B    55    				reti.l							                           B    56    
                           B    57    ;----------------------------------------------
                           B    58    ; Keyboard IRQ routine v0.03
                           B    59    ;----------------------------------------------
                           B    60    
0038DC                     B    61    kb_interrupt_handler
                           B    62    
                           B    63    ;--- irq test ---------------------------------
                           B    64    
                           B    65    ;				push bc
                           B    66    ;				ld a,0ffh
                           B    67    ;				ld (hw_palette),a
                           B    68    ;				ld b,0
                           B    69    ;testlp1		djnz testlp1
                           B    70    ;				ld a,0
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 139


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_interrupt_code.asm
                           B    71    ;				ld (hw_palette),a
                           B    72    ;				pop bc
                           B    73    				
                           B    74    ;--- end of test ------------------------------
                           B    75    
                           B    76    
0038DC E5                  B    77    				push hl							0038DD C5                  B    78    				push bc
                           B    79    				
0038DE ED3802              B    80    key_loop		in0 a,(port_keyboard_data)		0038E1 47                  B    81    				ld b,a
                           B    82    
0038E2 3A 01 61 00         B    83    				ld a,(key_release_mode)
0038E6 B7                  B    84    				or a
0038E7 28 20               B    85    				jr z,key_pressed
                           B    86    			
0038E9 78                  B    87    				ld a,b							0038EA FEE0                B    88    				cp 0e0h							0038EC 28 61               B    89    				jr z,kirq_done	
0038EE FEE1                B    90    				cp 0e1h
0038F0 28 5D               B    91    				jr z,kirq_done	
                           B    92    				
0038F2 CD 59 39 00         B    93    				call qualifiers					0038F6 7D                  B    94    				ld a,l
0038F7 2F                  B    95    				cpl
0038F8 6F                  B    96    				ld l,a
0038F9 3A 03 61 00         B    97    				ld a,(key_mod_flags)
0038FD A5                  B    98    				and l							0038FE 32 03 61 00         B    99    				ld (key_mod_flags),a
003902 AF                  B   100    				xor a
003903 32 01 61 00         B   101    				ld (key_release_mode),a
003907 18 46               B   102    				jr kirq_done
                           B   103    	
                           B   104    
003909 78                  B   105    key_pressed		ld a,b							00390A FEE0                B   106    				cp 0e0h							00390C 28 41               B   107    				jr z,kirq_done	
00390E FEE1                B   108    				cp 0e1h
003910 28 3D               B   109    				jr z,kirq_done	
                           B   110    			
003912 FEF0                B   111    				cp 0f0h							003914 20 08               B   112    				jr nz,not_krel
003916 3E01                B   113    				ld a,1							003918 32 01 61 00         B   114    				ld (key_release_mode),a			00391C 18 31               B   115    				jr kirq_done
                           B   116    	
                           B   117    	
00391E CD 59 39 00         B   118    not_krel		call qualifiers					003922 3A 03 61 00         B   119    				ld a,(key_mod_flags)			003926 B5                  B   120    				or l
003927 32 03 61 00         B   121    				ld (key_mod_flags),a			00392B 68                  B   122    				ld l,b
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 140


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_interrupt_code.asm
00392C 01000000            B   123    				ld bc,0
003930 3A FF 60 00         B   124    				ld a,(key_buf_wr_idx)
003934 4F                  B   125    				ld c,a
003935 7D                  B   126    				ld a,l
003936 21 DF 60 00         B   127    				ld hl,scancode_buffer
00393A 09                  B   128    				add hl,bc
00393B 77                  B   129    				ld (hl),a						00393C 0E10                B   130    				ld c,16
00393E 09                  B   131    				add hl,bc
00393F 3A 03 61 00         B   132    				ld a,(key_mod_flags)			003943 77                  B   133    				ld (hl),a	
003944 3A FF 60 00         B   134    				ld a,(key_buf_wr_idx)
003948 3C                  B   135    				inc a
003949 E60F                B   136    				and 15
00394B 32 FF 60 00         B   137    				ld (key_buf_wr_idx),a			                           B   138    				
00394F ED3807              B   139    kirq_done		in0 a,(port_ps2_ctrl)			003952 CB67                B   140    				bit 4,a	
003954 20 88               B   141    				jr nz,key_loop
                           B   142    
003956 C1                  B   143    				pop bc
003957 E1                  B   144    				pop hl
003958 C9                  B   145    				ret
                           B   146    
                           B   147    
003959 2E40                B   148    qualifiers		ld l,040h
00395B FE2F                B   149    				cp 02fh
00395D C8                  B   150    				ret z
                           B   151    			
00395E 2E20                B   152    				ld l,020h
003960 FE27                B   153    				cp 027h
003962 C8                  B   154    				ret z
                           B   155    			
003963 2E10                B   156    				ld l,010h
003965 FE59                B   157    				cp 059h
003967 C8                  B   158    				ret z
                           B   159    			
003968 2E08                B   160    				ld l,08h
00396A FE11                B   161    				cp 011h
00396C C8                  B   162    				ret z
                           B   163    			
00396D 2E04                B   164    				ld l,04h
00396F FE1F                B   165    				cp 01fh
                           B   166    			
003971 2E02                B   167    				ld l,02h
003973 FE14                B   168    				cp 14h
003975 C8                  B   169    				ret z
                           B   170    			
003976 2E01                B   171    				ld l,01h
003978 FE12                B   172    				cp 12h
00397A C8                  B   173    				ret z
                           B   174    				
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 141


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_interrupt_code.asm
00397B 2E00                B   175    				ld l,0
00397D C9                  B   176    				ret
                           B   177    
                           B   178    ;----------------------------------------------
                           B   179    ; Mouse IRQ routine v0.03
                           B   180    ;----------------------------------------------
                           B   181    
00397E                     B   182    ms_interrupt_handler
                           B   183    
                           B   184    ;--- irq test ---------------------------------
                           B   185    
                           B   186    ;				push bc
                           B   187    ;				ld a,0ffh
                           B   188    ;				ld (hw_palette),a
                           B   189    ;				ld b,0
                           B   190    ;testlp1		djnz testlp1
                           B   191    ;				ld a,0
                           B   192    ;				ld (hw_palette),a
                           B   193    ;				pop bc
                           B   194    				
                           B   195    ;--- end of test ------------------------------
                           B   196    
                           B   197    
00397E C5                  B   198    				push bc							00397F D5                  B   199    				push de							003980 E5                  B   200    				push hl							                           B   201    							
003981 11000000            B   202    ms_loop			ld de,0		
003985 3A 0D 61 00         B   203    				ld a,(mouse_packet_index)		003989 5F                  B   204    				ld e,a
00398A 21 09 61 00         B   205    				ld hl,mouse_packet	
00398E 19                  B   206    				add hl,de
00398F ED3806              B   207    				in0 a,(port_mouse_data)
003992 77                  B   208    				ld (hl),a
                           B   209    								
003993 21 08 61 00         B   210    				ld hl,mouse_packet_size
003997 1C                  B   211    				inc e							003998 7B                  B   212    				ld a,e
003999 BE                  B   213    				cp (hl)
00399A 20 4F               B   214    				jr nz,msubpkt
                           B   215    
00399C 3A 09 61 00         B   216    				ld a,(mouse_packet)				0039A0 4F                  B   217    				ld c,a	
0039A1 E607                B   218    				and 0111b
0039A3 32 0E 61 00         B   219    				ld (mouse_buttons),a
                           B   220    				
0039A7 11000000            B   221    				ld de,0							0039AB CB61                B   222    				bit 4,c
0039AD 28 01               B   223    				jr z,mxsignpos
0039AF 1B                  B   224    				dec de
0039B0 3A 0A 61 00         B   225    mxsignpos		ld a,(mouse_packet+1)
0039B4 5F                  B   226    				ld e,a
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 142


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_interrupt_code.asm
0039B5 2A 0F 61 00         B   227    				ld hl,(mouse_disp_x)
0039B9 19                  B   228    				add hl,de
0039BA 22 0F 61 00         B   229    				ld (mouse_disp_x),hl
                           B   230    				
0039BE 11000000            B   231    				ld de,0							0039C2 CB69                B   232    				bit 5,c
0039C4 28 01               B   233    				jr z,mysignpos
0039C6 1B                  B   234    				dec de
0039C7 3A 0B 61 00         B   235    mysignpos		ld a,(mouse_packet+2)
0039CB 5F                  B   236    				ld e,a
0039CC 2A 12 61 00         B   237    				ld hl,(mouse_disp_y)			0039D0 AF                  B   238    				xor a							0039D1 ED52                B   239    				sbc hl,de
0039D3 22 12 61 00         B   240    				ld (mouse_disp_y),hl
                           B   241    				
0039D7 21 0C 61 00         B   242    				ld hl,mouse_packet+3			0039DB 3A 15 61 00         B   243    				ld a,(mouse_wheel)
0039DF 86                  B   244    				add a,(hl)
0039E0 32 15 61 00         B   245    				ld (mouse_wheel),a
                           B   246    				
0039E4 3E01                B   247    				ld a,1
0039E6 32 16 61 00         B   248    				ld (mouse_updated),a			                           B   249    				
0039EA AF                  B   250    				xor a
0039EB 32 0D 61 00         B   251    msubpkt			ld (mouse_packet_index),a
                           B   252    				
0039EF ED3807              B   253    				in0 a,(port_ps2_ctrl)			0039F2 CB6F                B   254    				bit 5,a
0039F4 20 8B               B   255    				jr nz,ms_loop				
                           B   256    				
0039F6 E1                  B   257    				pop hl
0039F7 D1                  B   258    				pop de
0039F8 C1                  B   259    				pop bc
0039F9 C9                  B   260    				ret
                           B   261    				
                           B   262    ;----------------------------------------------
                           B   263    ; ez80p NMI code v0.02
                           B   264    ;----------------------------------------------
                           B   265    
0039FA                     B   266    nmi_routine
0039FA CD 31 13 00         B   267    				call os_store_CPU_regs
                           B   268    				
0039FE 21000000            B   269    				ld hl,0
003A02 39                  B   270    				add hl,sp
003A03 7E                  B   271    				ld a,(hl)						003A04 E601                B   272    				and 1
003A06 32 48 5F 00         B   273    				ld (store_adl),a
003A0A 20 0A               B   274    				jr nz,adl_freeze
003A0C 23                  B   275    				inc hl
003A0D 5E                  B   276    				ld e,(hl)						003A0E 23                  B   277    				inc hl
003A0F 56                  B   278    				ld d,(hl)
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 143


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_interrupt_code.asm
003A10 CD 83 15 00         B   279    				call mbase_de
003A14 18 02               B   280    				jr got_pc
                           B   281    				
003A16 33                  B   282    adl_freeze		inc sp
003A17 D1                  B   283    				pop de							003A18 ED53 3E 5F 00       B   284    got_pc			ld (store_pc),de				                           B   285    				
003A1D CD 46 3A 00         B   286    				call disable_nmi
003A21 ED3906              B   287    				out0 (port_nmi_ack),a			003A24 3E01                B   288    				ld a,1
003A26 32 18 5F 00         B   289    				ld (frozen),a
003A2A C3 48 0A 00         B   290    				jp os_cold_start				                           B   291    
                           B   292    ;----------------------------------------------
                           B   293    
                           B   294    ;nmi_routine
                           B   295    ;
                           B   296    ;				push af							                           B   297    ;				push bc
                           B   298    ;				ld a,0ffh
                           B   299    ;				ld (hw_palette),a
                           B   300    ;				ld b,0
                           B   301    ;nmi_testlp2		djnz nmi_testlp2
                           B   302    ;				ld a,0
                           B   303    ;				ld (hw_palette),a
                           B   304    ;				pop bc
                           B   305    ;				pop af
                           B   306    ;				out0 (port_nmi_ack),a			                           B   307    ;				retn.l							                           B   308    
                           B   309    ;----------------------------------------------
                           B   310    
003A2E                     B   311    set_nmi_vector
                           B   312    
003A2E 3EC3                B   313    				ld a,0c3h						003A30 32660000            B   314    				ld (066h),a
003A34 21 FA 39 00         B   315    				ld hl,nmi_routine				003A38 22670000            B   316    				ld (067h),hl
003A3C C9                  B   317    				ret
                           B   318    
                           B   319    ;----------------------------------------------
                           B   320    
003A3D ED3906              B   321    enable_nmi		out0 (port_nmi_ack),a			003A40 3EC0                B   322    				ld a,11000000b					003A42 ED3905              B   323    				out0 (port_irq_ctrl),a
003A45 C9                  B   324    				ret
                           B   325    
003A46 3E40                B   326    disable_nmi		ld a,01000000b					003A48 ED3905              B   327    				out0 (port_irq_ctrl),a
003A4B C9                  B   328    				ret
                           B   329    
                           B   330    ;----------------------------------------------
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 144


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_interrupt_code.asm
                           B   331    
                           B     0    	include		'ez80p_rs232_code.asm'
                           B     1    ;----------------------------------------------
                           B     2    ; ez80p low level RS232 code v0.03 (ADL mode)
                           B     3    ;----------------------------------------------
                           B     4    		
003A4C                     B     5    receive_serial_byte
                           B     6    
                           B     7    ; If zero flag set on return OK, A = received b
                           B     8    ; Else timed out (and also A = error $83: time 
                           B     9    
003A4C C5                  B    10    				push bc
003A4D 3A A5 5D 00         B    11    				ld a,(serial_timeout)
003A51 47                  B    12    				ld b,a
003A52 3ECC                B    13    rx_set_timer	ld a,cch
003A54 ED3981              B    14    				out0 (TMR0_RR_L),a				003A57 3E0C                B    15    				ld a,0ch
003A59 ED3982              B    16    				out0 (TMR0_RR_H),a				003A5C 3E03                B    17    				ld a,00000011b					003A5E ED3980              B    18    				out0 (TMR0_CTL),a				003A61 ED3880              B    19    				in0 a,(TMR0_CTL)				                           B    20    				
003A64 0EC5                B    21    rx_byte_lp		ld c,UART0_LSR					003A66 ED7401              B    22    				tstio 1							003A69 20 0E               B    23    				jr nz,rx_in_buffer
003A6B AF                  B    24    				xor a
003A6C B0                  B    25    				or b
003A6D 28 13               B    26    				jr z,rx_time_out
003A6F 0E80                B    27    				ld c,TMR0_CTL	
003A71 ED7480              B    28    				tstio 128						003A74 28 EE               B    29    				jr z,rx_byte_lp		
003A76 05                  B    30    				dec b
003A77 18 D9               B    31    				jr rx_set_timer
                           B    32    
003A79 01C00000            B    33    rx_in_buffer	ld bc,UART0_RBR
003A7D ED78                B    34    				in a,(bc)						003A7F C1                  B    35    				pop bc
003A80 BF                  B    36    				cp a							003A81 C9                  B    37    				ret
                           B    38    
003A82 C1                  B    39    rx_time_out		pop bc
003A83 3E83                B    40    				ld a,083h						003A85 B7                  B    41    				or a							003A86 C9                  B    42    				ret
                           B    43    
                           B    44    
                           B    45    
                           B    46    ;----------------------------------------------
                           B    47    
003A87                     B    48    send_serial_byte
                           B    49    
                           B    50    ; set A to the byte to send
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 145


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_rs232_code.asm
                           B    51    
003A87 C5                  B    52    				push bc
003A88 0EC5                B    53    				ld c,UART0_LSR					003A8A ED7420              B    54    rs232_swait		tstio 020h						003A8D 28 FB               B    55    				jr z,rs232_swait
003A8F 01C00000            B    56    				ld bc,UART0_THR
003A93 ED79                B    57    				out (c),a						003A95 C1                  B    58    				pop bc
003A96 C9                  B    59    				ret
                           B    60    
                           B    61    ;----------------------------------------------
                           B    62    
003A97                     B    63    send_serial_bytes
                           B    64    
                           B    65    ; set D to the first byte to send
                           B    66    ; and E to the second byte to send
                           B    67    
003A97 7A                  B    68    				ld a,d
003A98 CD 87 3A 00         B    69    				call send_serial_byte
003A9C 7B                  B    70    				ld a,e
003A9D CD 87 3A 00         B    71    				call send_serial_byte
003AA1 C9                  B    72    				ret
                           B    73    
                           B    74    ;----------------------------------------------
                           B    75    
003AA2                     B    76    hwsc_flush_serial_buffer
                           B    77    
003AA2 C5                  B    78    				push bc
003AA3 01C00000            B    79    				ld bc,UART0_RBR
003AA7 ED78                B    80    				in a,(bc)						003AA9 C1                  B    81    				pop bc
003AAA C9                  B    82    				ret
                           B    83    
                           B    84    ;----------------------------------------------
                           B    85    		
                           B     0    	include		'ez80p_video_code.asm'
                           B     1    ;-------------------------------------------
                           B     2    ; ez80p-specific video code v0.05 (ADL mode)
                           B     3    ; 16 colour mode routines
                           B     4    ;-------------------------------------------
                           B     5    
003AAB                     B     6    set_bitmap_parameters
                           B     7    				
003AAB 78                  B     8    				ld a,b
003AAC 32 88 5D 00         B     9    				ld (window_pixel_doubling),a
003AB0 22 61 5D 00         B    10    				ld (window_width_bytes),hl		003AB4 ED53 64 5D 00       B    11    				ld (window_height_lines),de
                           B    12    			
003AB9 21000080            B    13    				ld hl,vram_a_addr				003ABD 22 73 5D 00         B    14    				ld (video_window_address),hl
003AC1 21000000            B    15    				ld hl,0
003AC5 ED5B 61 5D 00       B    16    				ld de,(window_width_bytes)
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 146


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_video_code.asm
003ACA ED4B 64 5D 00       B    17    				ld bc,(window_height_lines)
003ACF 19                  B    18    cwsblp			add hl,de
003AD0 0B                  B    19    				dec bc
003AD1 78                  B    20    				ld a,b
003AD2 B1                  B    21    				or c
003AD3 20 FA               B    22    				jr nz,cwsblp
003AD5 22 7F 5D 00         B    23    				ld (total_window_bytes),hl
                           B    24    				
003AD9 CD 6A 3B 00         B    25    				call os_set_video_hw_regs
                           B    26    				
003ADD AF                  B    27    				xor a
003ADE C9                  B    28    				ret
                           B    29    
                           B    30    
                           B    31    
003ADF                     B    32    set_font_parameters
                           B    33    
003ADF 78                  B    34    				ld a,b							003AE0 32 67 5D 00         B    35    				ld (font_width_bytes),a
003AE4 79                  B    36    				ld a,c
003AE5 32 6A 5D 00         B    37    				ld (font_height_lines),a		003AE9 11000000            B    38    				ld de,0
003AED 59                  B    39    				ld e,c
003AEE 50                  B    40    				ld d,b
003AEF ED5C                B    41    				mlt de
003AF1 21000000            B    42    				ld hl,0
003AF5 0638                B    43    				ld b,224/4						003AF7 19                  B    44    cfslp			add hl,de
003AF8 10 FD               B    45    				djnz cfslp
003AFA 22 70 5D 00         B    46    				ld (font_length),hl
                           B    47    							
003AFE 41                  B    48    				ld b,c
003AFF 21000000            B    49    				ld hl,0
003B03 ED5B 61 5D 00       B    50    				ld de,(window_width_bytes)
003B08 19                  B    51    csualp			add hl,de
003B09 10 FD               B    52    				djnz csualp
003B0B 22 85 5D 00         B    53    				ld (total_row_bytes),hl			                           B    54    				
003B0F AF                  B    55    				xor a
003B10 C9                  B    56    				ret
                           B    57    				
                           B    58    				
                           B    59    
003B11                     B    60    set_charmap_parameters
                           B    61    
003B11 79                  B    62    				ld a,c
003B12 32 5B 5D 00         B    63    				ld (window_rows),a
003B16 78                  B    64    				ld a,b
003B17 32 5E 5D 00         B    65    				ld (window_columns),a
                           B    66    				
003B1B 2A 73 5D 00         B    67    				ld hl,(video_window_address)
003B1F ED5B 7F 5D 00       B    68    				ld de,(total_window_bytes)
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 147


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_video_code.asm
003B24 19                  B    69    				add hl,de
003B25 22 76 5D 00         B    70    				ld (charmap_address),hl
                           B    71    
003B29 11000000            B    72    				ld de,0
003B2D 3A 5B 5D 00         B    73    				ld a,(window_rows)
003B31 5F                  B    74    				ld e,a
003B32 3A 5E 5D 00         B    75    				ld a,(window_columns)
003B36 57                  B    76    				ld d,a
003B37 ED5C                B    77    				mlt de
003B39 ED53 82 5D 00       B    78    				ld (total_charmap_bytes),de
003B3E 19                  B    79    				add hl,de
003B3F 22 79 5D 00         B    80    				ld (attributes_address),hl
003B43 19                  B    81    				add hl,de
003B44 22 7C 5D 00         B    82    				ld (cursor_image_address),hl
003B48 11000000            B    83    				ld de,0
003B4C 3A 6A 5D 00         B    84    				ld a,(font_height_lines)
003B50 5F                  B    85    				ld e,a
003B51 3A 67 5D 00         B    86    				ld a,(font_width_bytes)
003B55 57                  B    87    				ld d,a
003B56 D5                  B    88    				push de
003B57 ED5C                B    89    				mlt de
003B59 19                  B    90    				add hl,de
003B5A 22 6D 5D 00         B    91    				ld (font_addr),hl
003B5E D1                  B    92    				pop de
003B5F 16E0                B    93    				ld d,224
003B61 ED5C                B    94    				mlt de
003B63 19                  B    95    				add hl,de				
003B64 22 1E 5F 00         B    96    				ld (vram_a_high),hl
003B68 AF                  B    97    				xor a
003B69 C9                  B    98    				ret
                           B    99    				
                           B   100    
003B6A                     B   101    os_set_video_hw_regs
                           B   102    
003B6A DD210018 FF         B   103    				ld ix,video_control				003B6F 3A 88 5D 00         B   104    				ld a,(window_pixel_doubling)
003B73 CB27                B   105    				sla a
003B75 F601                B   106    				or 1
003B77 DD7700              B   107    				ld (ix),a						003B7A DD360100            B   108    				ld (ix+1),0						003B7E DD360200            B   109    				ld (ix+2),0						003B82 DD360463            B   110    				ld (ix+4),99					                           B   111    
003B86 DD212010 FF         B   112    				ld ix,bitmap_parameters			003B8B ED5B 73 5D 00       B   113    				ld de,(video_window_address)	003B90 DD1F00              B   114    				ld (ix),de						003B93 DD360401            B   115    				ld (ix+04h),1					003B97 DD360800            B   116    				ld (ix+08h),0					003B9B DD360C00            B   117    				ld (ix+0ch),0					003B9F ED4B 61 5D 00       B   118    				ld bc,(window_width_bytes)		003BA4 CB38                B   119    				srl b							003BA6 CB19                B   120    				rr c
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 148


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_video_code.asm
003BA8 CB38                B   121    				srl b
003BAA CB19                B   122    				rr c
003BAC CB38                B   123    				srl b
003BAE CB19                B   124    				rr c
003BB0 0D                  B   125    				dec c
003BB1 DD7110              B   126    				ld (ix+10h),c
                           B   127    				
003BB4 21 38 5D 00         B   128    				ld hl,pen_palette
003BB8 CD BE 3B 00         B   129    				call hswc_set_ui_colours
                           B   130    				
003BBC AF                  B   131    				xor a							003BBD C9                  B   132    				ret
                           B   133    
                           B   134    ;----------------------------------------------
                           B   135    				
                           B   136    				
003BBE                     B   137    hswc_set_ui_colours
                           B   138    
003BBE 110000FF            B   139    				ld de,hw_palette
003BC2 01200000            B   140    				ld bc,16*2
003BC6 EDB0                B   141    				ldir
003BC8 AF                  B   142    				xor a							003BC9 C9                  B   143    				ret
                           B   144    
                           B   145    
                           B   146    ;----------------------------------------------
                           B   147    
003BCA                     B   148    hwsc_clear_screen
                           B   149    
003BCA 2A 73 5D 00         B   150    				ld hl,(video_window_address)	003BCE 3A 36 5D 00         B   151    				ld a,(background_colour)
003BD2 E60F                B   152    				and 0fh
003BD4 47                  B   153    				ld b,a
003BD5 07                  B   154    				rlca
003BD6 07                  B   155    				rlca
003BD7 07                  B   156    				rlca
003BD8 07                  B   157    				rlca
003BD9 B0                  B   158    				or b
003BDA 77                  B   159    				ld (hl),a
003BDB E5                  B   160    				push hl
003BDC D1                  B   161    				pop de
003BDD 13                  B   162    				inc de
003BDE ED4B 7F 5D 00       B   163    				ld bc,(total_window_bytes)
003BE3 0B                  B   164    				dec bc
003BE4 EDB0                B   165    				ldir
                           B   166    				
003BE6 2A 79 5D 00         B   167    				ld hl,(attributes_address)		003BEA ED4B 82 5D 00       B   168    				ld bc,(total_charmap_bytes)
003BEF 0B                  B   169    				dec bc
003BF0 3600                B   170    				ld (hl),0
003BF2 E5                  B   171    				push hl
003BF3 D1                  B   172    				pop de
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 149


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_video_code.asm
003BF4 13                  B   173    				inc de
003BF5 EDB0                B   174    				ldir				
                           B   175    
003BF7 2A 76 5D 00         B   176    				ld hl,(charmap_address)			003BFB ED4B 82 5D 00       B   177    				ld bc,(total_charmap_bytes)
003C00 0B                  B   178    				dec bc
003C01 3620                B   179    				ld (hl),' '
003C03 E5                  B   180    				push hl
003C04 D1                  B   181    				pop de
003C05 13                  B   182    				inc de
003C06 EDB0                B   183    				ldir				
                           B   184    
003C08 01000000            B   185    				ld bc,0
003C0C ED43 B0 5F 00       B   186    				ld (cursor_y),bc
003C11 AF                  B   187    				xor a							003C12 C9                  B   188    				ret
                           B   189    				
                           B   190    				
                           B   191    ;----------------------------------------------
                           B   192    
003C13                     B   193    hwsc_scroll_up	
                           B   194    				
003C13 C5                  B   195    				push bc
003C14 D5                  B   196    				push de
003C15 E5                  B   197    				push hl
                           B   198    
003C16 2A 7F 5D 00         B   199    				ld hl,(total_window_bytes)
003C1A ED5B 85 5D 00       B   200    				ld de,(total_row_bytes)
003C1F AF                  B   201    				xor a
003C20 ED52                B   202    				sbc hl,de
003C22 E5                  B   203    				push hl
003C23 C1                  B   204    				pop bc							003C24 2A 73 5D 00         B   205    				ld hl,(video_window_address)
003C28 ED5B 85 5D 00       B   206    				ld de,(total_row_bytes)
003C2D 19                  B   207    				add hl,de						003C2E ED5B 73 5D 00       B   208    				ld de,(video_window_address)	003C33 EDB0                B   209    				ldir
                           B   210    				
003C35 EB                  B   211    				ex de,hl						003C36 3A 36 5D 00         B   212    				ld a,(background_colour)
003C3A E60F                B   213    				and 0fh
003C3C 4F                  B   214    				ld c,a
003C3D 07                  B   215    				rlca
003C3E 07                  B   216    				rlca
003C3F 07                  B   217    				rlca
003C40 07                  B   218    				rlca
003C41 B1                  B   219    				or c
003C42 77                  B   220    				ld (hl),a
003C43 ED4B 85 5D 00       B   221    				ld bc,(total_row_bytes)
003C48 0B                  B   222    				dec bc
003C49 E5                  B   223    				push hl
003C4A D1                  B   224    				pop de
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 150


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_video_code.asm
003C4B 13                  B   225    				inc de
003C4C EDB0                B   226    				ldir
                           B   227    
003C4E 2A 76 5D 00         B   228    				ld hl,(charmap_address)			003C52 ED5B 5E 5D 00       B   229    				ld de,(window_columns)
003C57 19                  B   230    				add hl,de
003C58 ED5B 76 5D 00       B   231    				ld de,(charmap_address)
003C5D ED4B 5B 5D 00       B   232    				ld bc,(window_rows)
003C62 0D                  B   233    				dec c
003C63 3A 5E 5D 00         B   234    				ld a,(window_columns)
003C67 47                  B   235    				ld b,a
003C68 ED4C                B   236    				mlt bc
003C6A C5                  B   237    				push bc
003C6B EDB0                B   238    				ldir
003C6D C1                  B   239    				pop bc							                           B   240    
003C6E 2A 76 5D 00         B   241    				ld hl,(charmap_address)			003C72 09                  B   242    				add hl,bc
003C73 3620                B   243    				ld (hl),' '
003C75 ED4B 5E 5D 00       B   244    				ld bc,(window_columns)
003C7A 0B                  B   245    				dec bc
003C7B E5                  B   246    				push hl
003C7C D1                  B   247    				pop de
003C7D 13                  B   248    				inc de
003C7E EDB0                B   249    				ldir
                           B   250    					
003C80 2A 79 5D 00         B   251    				ld hl,(attributes_address)		003C84 ED5B 5E 5D 00       B   252    				ld de,(window_columns)
003C89 19                  B   253    				add hl,de
003C8A ED5B 79 5D 00       B   254    				ld de,(attributes_address)
003C8F ED4B 5B 5D 00       B   255    				ld bc,(window_rows)
003C94 0D                  B   256    				dec c
003C95 3A 5E 5D 00         B   257    				ld a,(window_columns)
003C99 47                  B   258    				ld b,a
003C9A ED4C                B   259    				mlt bc
003C9C C5                  B   260    				push bc
003C9D EDB0                B   261    				ldir
003C9F C1                  B   262    				pop bc			
                           B   263    
003CA0 2A 79 5D 00         B   264    				ld hl,(attributes_address)		003CA4 09                  B   265    				add hl,bc
003CA5 3600                B   266    				ld (hl),0
003CA7 ED4B 5E 5D 00       B   267    				ld bc,(window_columns)
003CAC 0B                  B   268    				dec bc
003CAD E5                  B   269    				push hl
003CAE D1                  B   270    				pop de
003CAF 13                  B   271    				inc de
003CB0 EDB0                B   272    				ldir
                           B   273    
003CB2 E1                  B   274    				pop hl
003CB3 D1                  B   275    				pop de
003CB4 C1                  B   276    				pop bc
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 151


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_video_code.asm
003CB5 AF                  B   277    				xor a							003CB6 C9                  B   278    				ret
                           B   279    
                           B   280    
                           B   281    ;----------------------------------------------
                           B   282    
                           B   283    ; Set:
                           B   284    ; ----
                           B   285    ; A = ascii char
                           B   286    ; B = x character coordinate 
                           B   287    ; C = y character coordinate
                           B   288    
                           B   289    ; Can only use 8_bits * n_line fonts at present
                           B   290    
003CB7                     B   291    hwsc_plot_char
003CB7 E5                  B   292    				push hl							003CB8 F5                  B   293    				push af
003CB9 3A 34 5D 00         B   294    				ld a,(current_pen)
003CBD 32 58 5D 00         B   295    				ld (plotchar_colour),a
003CC1 18 02               B   296    				jr plotc_go
                           B   297    				
003CC3                     B   298    hwsc_plotchar_specific_attr	
                           B   299    
003CC3 E5                  B   300    				push hl
003CC4 F5                  B   301    				push af							003CC5 3A 5B 5D 00         B   302    plotc_go		ld a,(window_rows)				003CC9 3D                  B   303    				dec a
003CCA B9                  B   304    				cp c							003CCB 38 08               B   305    				jr c,win_err
003CCD 3A 5E 5D 00         B   306    				ld a,(window_columns)
003CD1 3D                  B   307    				dec a
003CD2 B8                  B   308    				cp b
003CD3 30 06               B   309    				jr nc,win_ok
003CD5 F1                  B   310    win_err			pop af
003CD6 E1                  B   311    				pop hl
003CD7 3E82                B   312    				ld a,82h						003CD9 B7                  B   313    				or a
003CDA C9                  B   314    				ret
                           B   315    				
003CDB F1                  B   316    win_ok			pop af
003CDC D5                  B   317    				push de
003CDD C5                  B   318    				push bc
003CDE DDE5                B   319    				push ix
003CE0 FDE5                B   320    				push iy
003CE2 2A 6A 5D 00         B   321    				ld hl,(font_height_lines)		003CE6 D620                B   322    				sub a,32
003CE8 67                  B   323    				ld h,a
003CE9 C620                B   324    				add a,32
003CEB ED6C                B   325    				mlt hl							003CED ED5B 6D 5D 00       B   326    				ld de,(font_addr)
003CF2 19                  B   327    				add hl,de
003CF3 E5                  B   328    				push hl
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 152


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_video_code.asm
003CF4 DDE1                B   329    				pop ix							                           B   330    				
003CF6 11000000            B   331    				ld de,0
003CFA 2A 85 5D 00         B   332    				ld hl,(total_row_bytes)			003CFE 5D                  B   333    				ld e,l
003CFF 51                  B   334    				ld d,c
003D00 ED5C                B   335    				mlt de							003D02 69                  B   336    				ld l,c							003D03 ED6C                B   337    				mlt hl							003D05 29                  B   338    				add hl,hl						003D06 29                  B   339    				add hl,hl
003D07 29                  B   340    				add hl,hl
003D08 29                  B   341    				add hl,hl
003D09 29                  B   342    				add hl,hl
003D0A 29                  B   343    				add hl,hl
003D0B 29                  B   344    				add hl,hl
003D0C 29                  B   345    				add hl,hl
003D0D 19                  B   346    				add hl,de						003D0E ED5B 67 5D 00       B   347    				ld de,(font_width_bytes)
003D13 50                  B   348    				ld d,b	
003D14 ED5C                B   349    				mlt de							003D16 19                  B   350    				add hl,de						003D17 ED5B 73 5D 00       B   351    				ld de,(video_window_address)
003D1C 19                  B   352    				add hl,de
003D1D E5                  B   353    				push hl
003D1E FDE1                B   354    				pop iy							                           B   355    				
003D20 2A 5E 5D 00         B   356    				ld hl,(window_columns)			003D24 61                  B   357    				ld h,c							003D25 ED6C                B   358    				mlt hl
003D27 11000000            B   359    				ld de,0
003D2B 58                  B   360    				ld e,b
003D2C 19                  B   361    				add hl,de
003D2D EB                  B   362    				ex de,hl
003D2E 2A 76 5D 00         B   363    				ld hl,(charmap_address)
003D32 19                  B   364    				add hl,de
003D33 77                  B   365    				ld (hl),a
                           B   366    
003D34 3A 58 5D 00         B   367    				ld a,(plotchar_colour)			003D38 2A 79 5D 00         B   368    				ld hl,(attributes_address)
003D3C 19                  B   369    				add hl,de
003D3D 77                  B   370    				ld (hl),a
                           B   371    
003D3E 57                  B   372    				ld d,a				
003D3F E6F0                B   373    				and 0f0h
003D41 20 0E               B   374    				jr nz,notransbg
003D43 3A 36 5D 00         B   375    				ld a,(background_colour)
003D47 E60F                B   376    				and 0fh
003D49 47                  B   377    				ld b,a
003D4A 07                  B   378    				rlca
003D4B 07                  B   379    				rlca
003D4C 07                  B   380    				rlca
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 153


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_video_code.asm
003D4D 07                  B   381    				rlca
003D4E 4F                  B   382    				ld c,a
003D4F 18 06               B   383    				jr gotbg
003D51 4F                  B   384    notransbg		ld c,a							003D52 0F                  B   385    				rrca
003D53 0F                  B   386    				rrca
003D54 0F                  B   387    				rrca
003D55 0F                  B   388    				rrca
003D56 47                  B   389    				ld b,a							003D57 7A                  B   390    gotbg			ld a,d
003D58 E60F                B   391    				and 0fh
003D5A 20 0E               B   392    				jr nz,notransfg
003D5C 3A 36 5D 00         B   393    				ld a,(background_colour)
003D60 E60F                B   394    				and 0fh
003D62 57                  B   395    				ld d,a
003D63 07                  B   396    				rlca
003D64 07                  B   397    				rlca
003D65 07                  B   398    				rlca
003D66 07                  B   399    				rlca
003D67 5F                  B   400    				ld e,a
003D68 18 06               B   401    				jr gotfg
003D6A 57                  B   402    notransfg		ld d,a							003D6B 07                  B   403    				rlca
003D6C 07                  B   404    				rlca
003D6D 07                  B   405    				rlca
003D6E 07                  B   406    				rlca
003D6F 5F                  B   407    				ld e,a							                           B   408    				
003D70 D9                  B   409    gotfg			exx
003D71 3A 6A 5D 00         B   410    				ld a,(font_height_lines)
003D75 47                  B   411    				ld b,a
003D76 2A 61 5D 00         B   412    				ld hl,(window_width_bytes)
003D7A ED5B 67 5D 00       B   413    				ld de,(font_width_bytes)
003D7F AF                  B   414    				xor a
003D80 ED52                B   415    				sbc hl,de
003D82 EB                  B   416    				ex de,hl
                           B   417    						
003D83 D9                  B   418    charloop		exx
003D84 DD6E00              B   419    				ld l,(ix)						003D87 CB25                B   420    				sla l
003D89 79                  B   421    				ld a,c
003D8A 30 01               B   422    				jr nc,nbgmsb7
003D8C 7B                  B   423    				ld a,e
003D8D CB25                B   424    nbgmsb7			sla l
003D8F 30 03               B   425    				jr nc,nfgmsb6
003D91 B2                  B   426    				or d
003D92 18 01               B   427    				jr gotpixcol76
003D94 B0                  B   428    nfgmsb6			or b
003D95 FD7700              B   429    gotpixcol76		ld (iy),a
003D98 FD23                B   430    				inc iy
                           B   431    
003D9A CB25                B   432    				sla l
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 154


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_video_code.asm
003D9C 79                  B   433    				ld a,c
003D9D 30 01               B   434    				jr nc,nbgmsb5
003D9F 7B                  B   435    				ld a,e
003DA0 CB25                B   436    nbgmsb5			sla l
003DA2 30 03               B   437    				jr nc,nfgmsb4
003DA4 B2                  B   438    				or d
003DA5 18 01               B   439    				jr gotpixcol54
003DA7 B0                  B   440    nfgmsb4			or b
003DA8 FD7700              B   441    gotpixcol54		ld (iy),a
003DAB FD23                B   442    				inc iy
                           B   443    				
003DAD CB25                B   444    				sla l
003DAF 79                  B   445    				ld a,c
003DB0 30 01               B   446    				jr nc,nbgmsb3
003DB2 7B                  B   447    				ld a,e
003DB3 CB25                B   448    nbgmsb3			sla l
003DB5 30 03               B   449    				jr nc,nfgmsb2
003DB7 B2                  B   450    				or d
003DB8 18 01               B   451    				jr gotpixcol32
003DBA B0                  B   452    nfgmsb2			or b
003DBB FD7700              B   453    gotpixcol32		ld (iy),a
003DBE FD23                B   454    				inc iy
                           B   455    				
003DC0 CB25                B   456    				sla l
003DC2 79                  B   457    				ld a,c
003DC3 30 01               B   458    				jr nc,nbgmsb1
003DC5 7B                  B   459    				ld a,e
003DC6 CB25                B   460    nbgmsb1			sla l
003DC8 30 03               B   461    				jr nc,nfgmsb0
003DCA B2                  B   462    				or d
003DCB 18 01               B   463    				jr gotpixcol10
003DCD B0                  B   464    nfgmsb0			or b
003DCE FD7700              B   465    gotpixcol10		ld (iy),a
003DD1 FD23                B   466    				inc iy
                           B   467    				
003DD3 DD23                B   468    				inc ix
003DD5 D9                  B   469    				exx
003DD6 FD19                B   470    				add iy,de
003DD8 10 A9               B   471    				djnz charloop
003DDA D9                  B   472    				exx 
                           B   473    				
003DDB FDE1                B   474    				pop iy
003DDD DDE1                B   475    				pop ix
003DDF C1                  B   476    				pop bc
003DE0 D1                  B   477    				pop de
003DE1 E1                  B   478    				pop hl
003DE2 AF                  B   479    				xor a
003DE3 C9                  B   480    				ret
                           B   481    
                           B   482    ;----------------------------------------------
                           B   483    
003DE4                     B   484    hwsc_remove_cursor
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 155


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_video_code.asm
                           B   485    
003DE4 ED4B B0 5F 00       B   486    				ld bc,(cursor_y)
003DE9 CD 8C 3E 00         B   487    				call hwsc_get_charmap_addr_xy
003DED 1A                  B   488    				ld a,(de)
003DEE 32 58 5D 00         B   489    				ld (plotchar_colour),a
003DF2 7E                  B   490    				ld a,(hl)				
003DF3 C3 C3 3C 00         B   491    				jp hwsc_plotchar_specific_attr
                           B   492    				
                           B   493    
003DF7                     B   494    hwsc_draw_cursor
                           B   495    
003DF7 21 5A 5D 00         B   496    				ld hl,active_cursor_image
003DFB 3A 59 5D 00         B   497    				ld a,(req_cursor_image)
003DFF BE                  B   498    				cp (hl)
003E00 C4 54 3E 00         B   499    				call nz,hwsc_set_cursor_image
                           B   500    
003E04 ED4B B0 5F 00       B   501    				ld bc,(cursor_y)
003E09 2A 85 5D 00         B   502    				ld hl,(total_row_bytes)			003E0D 5D                  B   503    				ld e,l
003E0E 51                  B   504    				ld d,c
003E0F ED5C                B   505    				mlt de
003E11 69                  B   506    				ld l,c
003E12 ED6C                B   507    				mlt hl
003E14 29                  B   508    				add hl,hl
003E15 29                  B   509    				add hl,hl
003E16 29                  B   510    				add hl,hl
003E17 29                  B   511    				add hl,hl
003E18 29                  B   512    				add hl,hl
003E19 29                  B   513    				add hl,hl
003E1A 29                  B   514    				add hl,hl
003E1B 29                  B   515    				add hl,hl
003E1C 19                  B   516    				add hl,de
003E1D ED5B 67 5D 00       B   517    				ld de,(font_width_bytes)
003E22 50                  B   518    				ld d,b
003E23 ED5C                B   519    				mlt de		
003E25 19                  B   520    				add hl,de						003E26 ED5B 73 5D 00       B   521    				ld de,(video_window_address)
003E2B 19                  B   522    				add hl,de						003E2C E5                  B   523    				push hl
003E2D FDE1                B   524    				pop iy
                           B   525    				
003E2F ED4B 6A 5D 00       B   526    				ld bc,(font_height_lines)
003E34 DD2A 7C 5D 00       B   527    				ld ix,(cursor_image_address)	003E39 ED5B 61 5D 00       B   528    				ld de,(window_width_bytes)
                           B   529    
003E3E ED2300              B   530    curlp2			lea hl,iy+0
003E41 0604                B   531    				ld b,4							003E43 7E                  B   532    curlp1			ld a,(hl)
003E44 DDAE00              B   533    				xor (ix)
003E47 77                  B   534    				ld (hl),a
003E48 DD23                B   535    				inc ix
003E4A 23                  B   536    				inc hl
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 156


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_video_code.asm
003E4B 10 F6               B   537    				djnz curlp1
                           B   538    											
003E4D FD19                B   539    				add iy,de
003E4F 0D                  B   540    				dec c
003E50 20 EC               B   541    				jr nz,curlp2
                           B   542    
003E52 AF                  B   543    				xor a							003E53 C9                  B   544    				ret
                           B   545    				
                           B   546    	
                           B   547    ;----------------------------------------------
                           B   548    
003E54                     B   549    hwsc_set_cursor_image
                           B   550    
003E54 32 5A 5D 00         B   551    				ld (active_cursor_image),a
003E58 D620                B   552    				sub a,32						003E5A 2A 6A 5D 00         B   553    				ld hl,(font_height_lines)
003E5E 67                  B   554    				ld h,a
003E5F ED6C                B   555    				mlt hl
003E61 ED5B 6D 5D 00       B   556    				ld de,(font_addr)
003E66 19                  B   557    				add hl,de
003E67 ED5B 7C 5D 00       B   558    				ld de,(cursor_image_address)	003E6C 3A 6A 5D 00         B   559    				ld a,(font_height_lines)
003E70 47                  B   560    				ld b,a
003E71 C5                  B   561    fclp2			push bc
                           B   562    
003E72 4E                  B   563    				ld c,(hl)
003E73 0604                B   564    				ld b,4							003E75 3E00                B   565    fclp1			ld a,0
003E77 CB21                B   566    				sla c
003E79 30 02               B   567    				jr nc,nopixl
003E7B F6F0                B   568    				or a,0f0h						003E7D CB21                B   569    nopixl			sla c
003E7F 30 02               B   570    				jr nc,nopixr
003E81 F60F                B   571    				or a,0fh
003E83 12                  B   572    nopixr			ld (de),a
003E84 13                  B   573    				inc de
003E85 10 EE               B   574    				djnz fclp1
                           B   575    			
003E87 23                  B   576    				inc hl
003E88 C1                  B   577    				pop bc
003E89 10 E6               B   578    				djnz fclp2
003E8B C9                  B   579    				ret	
                           B   580    
                           B   581    
                           B   582    ;----------------------------------------------
                           B   583    
003E8C                     B   584    hwsc_get_charmap_addr_xy
                           B   585    
                           B   586    ; returns address of charmap in xHL for charact
                           B   587    ; and attrmap in xDE
                           B   588    				
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 157


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_video_code.asm
003E8C 11000000            B   589    				ld de,0
003E90 3A 5E 5D 00         B   590    				ld a,(window_columns)			003E94 5F                  B   591    				ld e,a							003E95 51                  B   592    				ld d,c							003E96 ED5C                B   593    				mlt de
003E98 7B                  B   594    				ld a,e
003E99 80                  B   595    				add a,b
003E9A 5F                  B   596    				ld e,a
003E9B 30 01               B   597    				jr nc,choffh_ok
003E9D 14                  B   598    				inc d
003E9E 2A 76 5D 00         B   599    choffh_ok		ld hl,(charmap_address)
003EA2 19                  B   600    				add hl,de
003EA3 E5                  B   601    				push hl
003EA4 2A 79 5D 00         B   602    				ld hl,(attributes_address)
003EA8 19                  B   603    				add hl,de
003EA9 EB                  B   604    				ex de,hl
003EAA E1                  B   605    				pop hl
003EAB AF                  B   606    				xor a							003EAC C9                  B   607    				ret
                           B   608    								
                           B   609    ;----------------------------------------------
                           B   610    
003EAD                     B   611    hwsc_chars_left
                           B   612    
                           B   613    ; moves characters (in character map) on the cu
                           B   614    
003EAD C5                  B   615    				push bc
003EAE D5                  B   616    				push de
003EAF E5                  B   617    				push hl
                           B   618    
003EB0 3A B0 5F 00         B   619    				ld a,(cursor_y)
003EB4 2A 5E 5D 00         B   620    				ld hl,(window_columns)
003EB8 67                  B   621    				ld h,a
003EB9 ED6C                B   622    				mlt hl
003EBB 11000000            B   623    				ld de,0
003EBF 58                  B   624    				ld e,b
003EC0 19                  B   625    				add hl,de
003EC1 EB                  B   626    				ex de,hl
003EC2 D5                  B   627    				push de
003EC3 2A 76 5D 00         B   628    				ld hl,(charmap_address)
003EC7 19                  B   629    				add hl,de						                           B   630    
003EC8 E5                  B   631    				push hl
003EC9 D1                  B   632    				pop de
003ECA 1B                  B   633    				dec de							003ECB 3A 5E 5D 00         B   634    				ld a,(window_columns)
003ECF 90                  B   635    				sub b
003ED0 01000000            B   636    				ld bc,0
003ED4 4F                  B   637    				ld c,a							003ED5 C5                  B   638    				push bc
003ED6 EDB0                B   639    				ldir
003ED8 C1                  B   640    				pop bc
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 158


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_video_code.asm
003ED9 3E20                B   641    				ld a,32
003EDB 12                  B   642    				ld (de),a						                           B   643    				
003EDC 2A 79 5D 00         B   644    				ld hl,(attributes_address)		003EE0 D1                  B   645    				pop de
003EE1 19                  B   646    				add hl,de
003EE2 E5                  B   647    				push hl
003EE3 D1                  B   648    				pop de
003EE4 1B                  B   649    				dec de							003EE5 EDB0                B   650    				ldir							003EE7 3A 36 5D 00         B   651    				ld a,(background_colour)
003EEB 12                  B   652    				ld (de),a						                           B   653    
003EEC CD 52 3F 00         B   654    				call hwsc_redraw_line			                           B   655    
003EF0 E1                  B   656    				pop hl
003EF1 D1                  B   657    				pop de
003EF2 C1                  B   658    				pop bc
003EF3 C9                  B   659    				ret
                           B   660    
                           B   661    
                           B   662    
003EF4                     B   663    hwsc_chars_right
                           B   664    
                           B   665    ; moves characters on current line right from c
                           B   666    
003EF4 C5                  B   667    				push bc
003EF5 D5                  B   668    				push de
003EF6 E5                  B   669    				push hl
                           B   670    	
003EF7 21 B1 5F 00         B   671    				ld hl,cursor_x				
003EFB 3A 5E 5D 00         B   672    				ld a,(window_columns)
003EFF 3D                  B   673    				dec a
003F00 BE                  B   674    				cp (hl)			
003F01 28 4B               B   675    				jr z,chright_end
                           B   676    
003F03 46                  B   677    				ld b,(hl)
003F04 11000000            B   678    				ld de,0
003F08 57                  B   679    				ld d,a
003F09 14                  B   680    				inc d
003F0A 3A B0 5F 00         B   681    				ld a,(cursor_y)
003F0E 5F                  B   682    				ld e,a
003F0F ED5C                B   683    				mlt de
003F11 D5                  B   684    				push de 
                           B   685    				
003F12 C5                  B   686    				push bc
003F13 2A 76 5D 00         B   687    				ld hl,(charmap_address)
003F17 ED4B 5E 5D 00       B   688    				ld bc,(window_columns)
003F1C 0B                  B   689    				dec bc
003F1D 0B                  B   690    				dec bc
003F1E 09                  B   691    				add hl,bc
003F1F C1                  B   692    				pop bc
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 159


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_video_code.asm
                           B   693    				
003F20 19                  B   694    				add hl,de						003F21 E5                  B   695    				push hl
003F22 D1                  B   696    				pop de
003F23 13                  B   697    				inc de							003F24 3A 5E 5D 00         B   698    				ld a,(window_columns)
003F28 3D                  B   699    				dec a
003F29 90                  B   700    				sub b
003F2A 47                  B   701    				ld b,a
003F2B C5                  B   702    				push bc							003F2C 7E                  B   703    mchrlp			ld a,(hl)
003F2D 12                  B   704    				ld (de),a
003F2E 2B                  B   705    				dec hl
003F2F 1B                  B   706    				dec de
003F30 10 FA               B   707    				djnz mchrlp
                           B   708    
003F32 2A 79 5D 00         B   709    				ld hl,(attributes_address)		003F36 ED4B 5E 5D 00       B   710    				ld bc,(window_columns)
003F3B 0B                  B   711    				dec bc
003F3C 0B                  B   712    				dec bc
003F3D 09                  B   713    				add hl,bc
                           B   714    
003F3E C1                  B   715    				pop bc
003F3F D1                  B   716    				pop de
003F40 19                  B   717    				add hl,de						003F41 E5                  B   718    				push hl
003F42 D1                  B   719    				pop de
003F43 13                  B   720    				inc de							003F44 7E                  B   721    mattrlp			ld a,(hl)
003F45 12                  B   722    				ld (de),a
003F46 2B                  B   723    				dec hl
003F47 1B                  B   724    				dec de
003F48 10 FA               B   725    				djnz mattrlp
                           B   726    
003F4A CD 52 3F 00         B   727    				call hwsc_redraw_line			                           B   728    
003F4E E1                  B   729    chright_end		pop hl	
003F4F D1                  B   730    				pop de
003F50 C1                  B   731    				pop bc
003F51 C9                  B   732    				ret
                           B   733    
                           B   734    ;----------------------------------------------
                           B   735    
003F52                     B   736    hwsc_redraw_line
                           B   737    				
003F52 3A B0 5F 00         B   738    				ld a,(cursor_y)
003F56 4F                  B   739    				ld c,a
                           B   740    		
003F57                     B   741    hwsc_redraw_ui_line
                           B   742    
003F57 ED5B 5E 5D 00       B   743    				ld de,(window_columns)			003F5C 51                  B   744    				ld d,c
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 160


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_video_code.asm
003F5D ED5C                B   745    				mlt de
003F5F 0600                B   746    				ld b,0							003F61 2A 79 5D 00         B   747    rs_xloop		ld hl,(attributes_address)		003F65 19                  B   748    				add hl,de
003F66 7E                  B   749    				ld a,(hl)						003F67 32 58 5D 00         B   750    				ld (plotchar_colour),a
003F6B 2A 76 5D 00         B   751    				ld hl,(charmap_address)
003F6F 19                  B   752    				add hl,de
003F70 7E                  B   753    				ld a,(hl)				
003F71 CD C3 3C 00         B   754    				call hwsc_plotchar_specific_att
003F75 13                  B   755    				inc de
003F76 04                  B   756    				inc b
003F77 3A 5E 5D 00         B   757    				ld a,(window_columns)
003F7B B8                  B   758    				cp b
003F7C 20 E3               B   759    				jr nz,rs_xloop
003F7E C9                  B   760    				ret	
                           B   761    
                           B   762    ;----------------------------------------------
                           B   763    
003F7F                     B   764    hwsc_charline_to_command_string	
                           B   765    								
003F7F ED5B 5E 5D 00       B   766    				ld de,(window_columns)
003F84 3A B0 5F 00         B   767    				ld a,(cursor_y)					003F88 57                  B   768    				ld d,a
003F89 ED5C                B   769    				mlt de
003F8B 2A 76 5D 00         B   770    				ld hl,(charmap_address)
003F8F 19                  B   771    				add hl,de
003F90 11 CE 5F 00         B   772    				ld de,commandstring				003F94 ED4B 5E 5D 00       B   773    				ld bc,(window_columns)
003F99 EDB0                B   774    				ldir
003F9B C9                  B   775    				ret
                           B   776    
                           B   777    ;----------------------------------------------
                           B   778    
003F9C C5                  B   779    hwsc_wait_vrt	push bc
                           B   780    
003F9D 0E01                B   781    				ld c,1
003F9F ED0909              B   782    				out0 (port_clear_flags),c
                           B   783    
003FA2 0E01                B   784    				ld c,port_hw_flags
003FA4 ED7420              B   785    ewaitvrtlp1		tstio 1<<vrt
003FA7 28 FB               B   786    				jr z,ewaitvrtlp1
                           B   787    				
003FA9 C1                  B   788    				pop bc
003FAA BF                  B   789    				cp a							003FAB C9                  B   790    				ret
                           B   791    
                           B   792    
                           B   793    ;----------------------------------------------
                           B   794    
                           B     0    	include		'ez80p_misc_code.asm'
                           B     1    ;----------------------------------------------
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 161


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_misc_code.asm
                           B     2    ;Misc eZ80p specific routines v0.05 (ADL versio
                           B     3    ;----------------------------------------------
                           B     4    
003FAC                     B     5    hwsc_default_hw_settings
                           B     6    
                           B     7    ; Set up eZ80 Wait states
                           B     8    
003FAC 3E48                B     9    					ld a,01001000b				003FAE ED39AA              B    10    					out0 (CS0_CTL),a
003FB1 3E00                B    11    					ld a,000h					003FB3 ED39A8              B    12    					out0 (CS0_LBR),a
003FB6 3EFF                B    13    					ld a,0ffh	
003FB8 ED39A9              B    14    					out0 (CS0_UBR),a			                           B    15    
003FBB 3E58                B    16    					ld a,01011000b
003FBD ED39AD              B    17    					out0 (CS1_CTL),a			003FC0 3E00                B    18    					ld a,0
003FC2 ED39AB              B    19    					out0 (CS1_LBR),a			                           B    20    
                           B    21    ;set up eZ80 GPIO ports
                           B    22    
003FC5 3EFF                B    23    					ld a,0ffh
003FC7 ED399F              B    24    					out0 (PC_DDR),a				003FCA AF                  B    25    					xor a
003FCB ED39A0              B    26    					out0 (PC_ALT1),a
003FCE ED39A1              B    27    					out0 (PC_ALT2),a
                           B    28    					
003FD1 3EFF                B    29    					ld a,0ffh					003FD3 ED39A3              B    30    					out0 (PD_DDR),a				003FD6 AF                  B    31    					xor a	
003FD7 ED39A4              B    32    					out0 (PD_ALT1),a			003FDA 3E0F                B    33    					ld a,00fh				
003FDC ED39A5              B    34    					out0 (PD_ALT2),a			                           B    35    
                           B    36    ;set up eZ80 timer
                           B    37    
003FDF ED3892              B    38    					in0 a,(TMR_ISS)
003FE2 E6FC                B    39    					and 11111100b
003FE4 F601                B    40    					or  00000001b
003FE6 ED3992              B    41    					out0 (TMR_ISS),a			                           B    42    					
                           B    43    					
                           B    44    ;AMOEBA default settings
                           B    45    
003FE9 AF                  B    46    					xor a
003FEA 320314FF            B    47    					ld (hw_audio_registers+3),a
                           B    48    
003FEE C9                  B    49    					ret
                           B    50    
                           B    51    ;----------------------------------------------
                           B    52    
003FEF 11000000            B    53    hwsc_get_version	ld de,0
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 162


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_misc_code.asm
003FF3 0610                B    54    					ld b,16
003FF5 78                  B    55    gethwvlp			ld a,b
003FF6 3D                  B    56    					dec a
003FF7 ED3908              B    57    					out0 (port_selector),a		003FFA DB01                B    58    					in a,(port_hw_flags)		003FFC CB27                B    59    					sla a
003FFE CB13                B    60    					rl e
004000 CB12                B    61    					rl d
004002 10 F1               B    62    					djnz gethwvlp				                           B    63    									
004004 212C0000            B    64    					ld hl,prose_version
004008 BF                  B    65    					cp a						004009 C9                  B    66    					ret
                           B    67    
                           B    68    
                           B    69    
                           B    70    ;----------------------------------------------
                           B    71    ; Timer related 
                           B    72    ;----------------------------------------------
                           B    73    
00400A                     B    74    hwsc_time_delay
                           B    75    
                           B    76    ; set DE to 32768Hz ticks to wait
                           B    77    
00400A CD 16 40 00         B    78    					call set_timeout
00400E CD 27 40 00         B    79    twaitlp				call test_timeout
004012 28 FA               B    80    					jr z,twaitlp
004014 AF                  B    81    					xor a						004015 C9                  B    82    					ret			
                           B    83    
                           B    84    ;----------------------------------------------
                           B    85    
004016 7B                  B    86    set_timeout			ld a,e						004017 ED3981              B    87    					out0 (TMR0_RR_L),a			00401A 7A                  B    88    					ld a,d
00401B ED3982              B    89    					out0 (TMR0_RR_H),a			00401E 3E03                B    90    					ld a,00000011b				004020 ED3980              B    91    					out0 (TMR0_CTL),a			004023 ED3880              B    92    					in0 a,(TMR0_CTL)			004026 C9                  B    93    					ret
                           B    94    			
004027 ED3880              B    95    test_timeout		in0 a,(TMR0_CTL)			00402A CB7F                B    96    					bit 7,a
00402C C9                  B    97    					ret
                           B    98    			
                           B    99    ;----------------------------------------------
                           B   100    
00402D                     B   101    hwsc_read_rtc
00402D D5                  B   102    					push de
00402E C5                  B   103    					push bc
00402F 0EE0                B   104    hwsc_rtc_rlp		ld c,RTC_SEC
004031 0608                B   105    					ld b,8
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 163


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_misc_code.asm
004033 21 11 5F 00         B   106    					ld hl,time_data
004037 ED92                B   107    					inimr						004039 0EE0                B   108    					ld c,RTC_SEC
00403B 0600                B   109    					ld b,0
00403D 1E08                B   110    					ld e,8
00403F 21 11 5F 00         B   111    					ld hl,time_data
004043 ED78                B   112    timevloop			in a,(bc)					004045 BE                  B   113    					cp (hl)						004046 20 E7               B   114    					jr nz,hwsc_rtc_rlp			004048 23                  B   115    					inc hl
004049 0C                  B   116    					inc c
00404A 1D                  B   117    					dec e
00404B 20 F6               B   118    					jr nz,timevloop
00404D 21 11 5F 00         B   119    					ld hl,time_data
004051 C1                  B   120    					pop bc
004052 D1                  B   121    					pop de
004053 BF                  B   122    					cp a						004054 C9                  B   123    					ret
                           B   124    
                           B   125    
004055                     B   126    hwsc_write_rtc	
                           B   127    
                           B   128    ; set HL to location of BCD data for RTC: sec/m
                           B   129    
004055 E5                  B   130    					push hl
004056 C5                  B   131    					push bc
004057 3E21                B   132    					ld a,00100001b				004059 ED39ED              B   133    					out0 (RTC_CTRL),a
00405C 0EE0                B   134    					ld c,RTC_SEC
00405E 0608                B   135    					ld b,8
004060 ED93                B   136    					otimr
004062 3E20                B   137    					ld a,00100000b				004064 ED39ED              B   138    					out0 (RTC_CTRL),a
004067 C1                  B   139    					pop bc
004068 E1                  B   140    					pop hl
004069 BF                  B   141    					cp a						00406A C9                  B   142    					ret	
                           B   143    
                           B   144    
                           B   145    ;----------------------------------------------
                           B   146    ; INIT KEYBOARD ROUTINE 
                           B   147    ;----------------------------------------------
                           B   148    
                           B   149    ; ZF set and A = 0 if all OK, else error code i
                           B   150    
00406B                     B   151    init_keyboard
                           B   152    
00406B 11004000            B   153    			ld de,16384							00406F CD 0A 40 00         B   154    			call hwsc_time_delay
004073 F3                  B   155    			di
004074 CD 29 41 00         B   156    			call purge_keyboard
004078 CD 82 40 00         B   157    			call rs_keyboard
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 164


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_misc_code.asm
00407C FB                  B   158    			ei
00407D D0                  B   159    			ret nc
00407E 3E8B                B   160    			ld a,08bh							004080 B7                  B   161    			or a
004081 C9                  B   162    			ret
                           B   163    			
                           B   164    			
004082                     B   165    rs_keyboard
                           B   166    
004082 3EFF                B   167    			ld a,0ffh
004084 CD A1 40 00         B   168    			call write_to_keyboard
004088 30 04               B   169    			jr nc,kb_connected
00408A 3E8A                B   170    			ld a,08ah							00408C B7                  B   171    			or a
00408D C9                  B   172    			ret
                           B   173    
00408E                     B   174    kb_connected
                           B   175    			
00408E 0605                B   176    			ld b,5
004090 C5                  B   177    kb_initlp	push bc
004091 CD 0D 41 00         B   178    			call wait_kb_byte					004095 C1                  B   179    			pop bc
004096 D8                  B   180    			ret c
004097 FEAA                B   181    			cp 0aah
004099 28 04               B   182    			jr z,kb_postok
00409B 10 F3               B   183    			djnz kb_initlp						00409D 37                  B   184    			scf									00409E C9                  B   185    			ret
                           B   186    			
                           B   187    			
00409F AF                  B   188    kb_postok	xor a
0040A0 C9                  B   189    			ret
                           B   190    	
                           B   191    	
                           B   192    ;----------------------------------------------
                           B   193    				
0040A1                     B   194    write_to_keyboard
                           B   195    
                           B   196    ; Put byte to send to keyboard in A
                           B   197    
0040A1 4F                  B   198    			ld c,a								0040A2 3E01                B   199    			ld a,01b							0040A4 ED3907              B   200    			out0 (port_ps2_ctrl),a
                           B   201    
0040A7 110A0000            B   202    			ld de,10
0040AB CD 0A 40 00         B   203    			call hwsc_time_delay				                           B   204    
0040AF 3E03                B   205    			ld a,11b
0040B1 ED3907              B   206    			out0 (port_ps2_ctrl),a				                           B   207    			
0040B4 3E02                B   208    			ld a,10b
0040B6 ED3907              B   209    			out0 (port_ps2_ctrl),a				Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 165


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_misc_code.asm
                           B   210    			
0040B9 CD 89 42 00         B   211    			call wait_kb_clk_high
                           B   212    			
0040BD 1601                B   213    			ld d,1								0040BF 0608                B   214    			ld b,8								0040C1 CD 5C 42 00         B   215    kdoloop		call wait_kb_clk_low	
0040C5 D8                  B   216    			ret c
0040C6 AF                  B   217    			xor a
0040C7 CBCF                B   218    			set 1,a
0040C9 CB41                B   219    			bit 0,c
0040CB 28 03               B   220    			jr z,kdbzero
0040CD CB8F                B   221    			res 1,a
0040CF 14                  B   222    			inc d
0040D0 ED3907              B   223    kdbzero		out0 (port_ps2_ctrl),a				0040D3 CD 89 42 00         B   224    			call wait_kb_clk_high
0040D7 D8                  B   225    			ret c
0040D8 CB19                B   226    			rr c
0040DA 10 E5               B   227    			djnz kdoloop
                           B   228    
0040DC CD 5C 42 00         B   229    			call wait_kb_clk_low
0040E0 D8                  B   230    			ret c
0040E1 AF                  B   231    			xor a
0040E2 CB42                B   232    			bit 0,d
0040E4 20 02               B   233    			jr nz,kparone
0040E6 CBCF                B   234    			set 1,a
0040E8 ED3907              B   235    kparone		out0 (port_ps2_ctrl),a				0040EB CD 89 42 00         B   236    			call wait_kb_clk_high
0040EF D8                  B   237    			ret c
                           B   238    			
0040F0 CD 5C 42 00         B   239    			call wait_kb_clk_low
0040F4 D8                  B   240    			ret c
0040F5 AF                  B   241    			xor a
0040F6 ED3907              B   242    			out0 (port_ps2_ctrl),a				                           B   243    
0040F9 CD 58 42 00         B   244    			call wait_kb_data_low				0040FD D8                  B   245    			ret c
0040FE CD 5C 42 00         B   246    			call wait_kb_clk_low				004102 D8                  B   247    			ret c
                           B   248    				
004103 CD 85 42 00         B   249    			call wait_kb_data_high				004107 D8                  B   250    			ret c
004108 CD 89 42 00         B   251    			call wait_kb_clk_high				00410C C9                  B   252    			ret 
                           B   253    
                           B   254    
                           B   255    ;----------------------------------------------
                           B   256    
                           B   257    
00410D                     B   258    wait_kb_byte
                           B   259    
00410D 11008000            B   260    			ld de,8000h
004111 CD 16 40 00         B   261    			call set_timeout					Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 166


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_misc_code.asm
                           B   262    
004115 ED3807              B   263    wait_kloop	in0 a,(port_ps2_ctrl)
004118 CB67                B   264    			bit 4,a
00411A 20 08               B   265    			jr nz,rec_kbyte
                           B   266    			
00411C CD 27 40 00         B   267    			call test_timeout
004120 28 F3               B   268    			jr z,wait_kloop
004122 37                  B   269    			scf									004123 C9                  B   270    			ret
                           B   271    			
004124 ED3802              B   272    rec_kbyte	in0 a,(port_keyboard_data)			004127 B7                  B   273    			or a
004128 C9                  B   274    			ret
                           B   275    
                           B   276    
                           B   277    ;----------------------------------------------
                           B   278    
004129                     B   279    purge_keyboard
                           B   280    			
004129 ED3807              B   281    			in0 a,(port_ps2_ctrl)
00412C CB67                B   282    			bit 4,a
00412E C8                  B   283    			ret z
00412F ED3802              B   284    			in0 a,(port_keyboard_data)			004132 18 F5               B   285    			jr purge_keyboard
                           B   286    
                           B   287    
                           B   288    
                           B   289    ;----------------------------------------------
                           B   290    ; INIT MOUSE ROUTINE 
                           B   291    ;----------------------------------------------
                           B   292    
                           B   293    ; ZF set and A = 0 if all OK, else error code i
                           B   294    
004134                     B   295    init_mouse		
004134 F3                  B   296    			di
004135 CD 4D 42 00         B   297    			call purge_mouse
004139 CD 43 41 00         B   298    			call rs_mouse
00413D FB                  B   299    			ei
00413E D0                  B   300    			ret nc
00413F 3E8B                B   301    			ld a,08bh							004141 B7                  B   302    			or a
004142 C9                  B   303    			ret
                           B   304    
                           B   305    
004143                     B   306    rs_mouse
004143 3EFF                B   307    			ld a,0ffh							004145 CD C5 41 00         B   308    			call write_to_mouse		
004149 30 04               B   309    			jr nc,mouse_connected
00414B 3E8A                B   310    			ld a,08ah							00414D B7                  B   311    			or a
00414E C9                  B   312    			ret
                           B   313    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 167


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_misc_code.asm
                           B   314    
00414F                     B   315    mouse_connected
                           B   316    
00414F 0605                B   317    			ld b,5
004151 C5                  B   318    ms_initlp	push bc
004152 CD 31 42 00         B   319    			call wait_mouse_byte				004156 C1                  B   320    			pop bc
004157 D8                  B   321    			ret c
004158 FEAA                B   322    			cp 0aah
00415A 28 04               B   323    			jr z,ms_postok
00415C 10 F3               B   324    			djnz ms_initlp
00415E 18 43               B   325    			jr bad_mouse
                           B   326    			
004160 CD 31 42 00         B   327    ms_postok	call wait_mouse_byte				004164 D8                  B   328    			ret c
004165 B7                  B   329    			or a
004166 20 3B               B   330    			jr nz,bad_mouse						                           B   331    			
004168 3E03                B   332    			ld a,3
00416A 32 08 61 00         B   333    			ld (mouse_packet_size),a
                           B   334    
00416E 21 C8 5D 00         B   335    			ld hl,intellimouse_seq
004172 0606                B   336    			ld b,6
004174 CD A7 41 00         B   337    			call mouse_sequence
004178 D8                  B   338    			ret c
                           B   339    			
004179 3EF2                B   340    			ld a,0f2h
00417B CD B6 41 00         B   341    			call write_mouse_wait_ack			00417F D8                  B   342    			ret c
004180 CD 31 42 00         B   343    			call wait_mouse_byte				004184 D8                  B   344    			ret c
004185 32 07 61 00         B   345    			ld (mouse_id),a
004189 B7                  B   346    			or a								00418A 28 0A               B   347    			jr z,standard_mouse
00418C FE03                B   348    			cp 3
00418E 20 13               B   349    			jr nz,bad_mouse						004190 3E04                B   350    			ld a,4
004192 32 08 61 00         B   351    			ld (mouse_packet_size),a
                           B   352    
004196                     B   353    standard_mouse
                           B   354    		
004196 21 CE 5D 00         B   355    			ld hl,mouse_settings_seq
00419A 0606                B   356    			ld b,6
00419C CD A7 41 00         B   357    			call mouse_sequence
0041A0 D8                  B   358    			ret c
0041A1 AF                  B   359    			xor a								0041A2 C9                  B   360    			ret
                           B   361    
                           B   362    
0041A3 3E89                B   363    bad_mouse	ld a,089h							0041A5 B7                  B   364    			or a
0041A6 C9                  B   365    			ret
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 168


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_misc_code.asm
                           B   366    
                           B   367    
0041A7                     B   368    mouse_sequence
                           B   369    
0041A7 7E                  B   370    mseqlp		ld a,(hl)
0041A8 E5                  B   371    			push hl
0041A9 C5                  B   372    			push bc
0041AA CD B6 41 00         B   373    			call write_mouse_wait_ack
0041AE C1                  B   374    			pop bc
0041AF E1                  B   375    			pop hl
0041B0 D8                  B   376    			ret c
0041B1 23                  B   377    			inc hl
0041B2 10 F3               B   378    			djnz mseqlp
0041B4 AF                  B   379    			xor a
0041B5 C9                  B   380    			ret
                           B   381    
                           B   382    
0041B6                     B   383    write_mouse_wait_ack
                           B   384    			
0041B6 CD C5 41 00         B   385    			call write_to_mouse
0041BA D8                  B   386    			ret c
0041BB CD 31 42 00         B   387    			call wait_mouse_byte				0041BF D8                  B   388    			ret c
0041C0 FEFA                B   389    			cp 0fah								0041C2 C8                  B   390    			ret z
0041C3 37                  B   391    			scf
0041C4 C9                  B   392    			ret
                           B   393    			
                           B   394    ;----------------------------------------------
                           B   395    				
0041C5                     B   396    write_to_mouse
                           B   397    
                           B   398    ; Put byte to send to mouse in A
                           B   399    
0041C5 4F                  B   400    			ld c,a								0041C6 3E04                B   401    			ld a,0100b							0041C8 ED3907              B   402    			out0 (port_ps2_ctrl),a
                           B   403    
0041CB 110A0000            B   404    			ld de,10
0041CF CD 0A 40 00         B   405    			call hwsc_time_delay				                           B   406    
0041D3 3E0C                B   407    			ld a,1100b
0041D5 ED3907              B   408    			out0 (port_ps2_ctrl),a				                           B   409    			
0041D8 3E08                B   410    			ld a,1000b
0041DA ED3907              B   411    			out0 (port_ps2_ctrl),a				                           B   412    			
0041DD CD 91 42 00         B   413    			call wait_mouse_clk_high
                           B   414    			
0041E1 1601                B   415    			ld d,1								0041E3 0608                B   416    			ld b,8								0041E5 CD 64 42 00         B   417    mdoloop		call wait_mouse_clk_low	
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 169


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_misc_code.asm
0041E9 D8                  B   418    			ret c
0041EA AF                  B   419    			xor a
0041EB CBDF                B   420    			set 3,a
0041ED CB41                B   421    			bit 0,c
0041EF 28 03               B   422    			jr z,mdbzero
0041F1 CB9F                B   423    			res 3,a
0041F3 14                  B   424    			inc d
0041F4 ED3907              B   425    mdbzero		out0 (port_ps2_ctrl),a				0041F7 CD 91 42 00         B   426    			call wait_mouse_clk_high
0041FB D8                  B   427    			ret c
0041FC CB19                B   428    			rr c
0041FE 10 E5               B   429    			djnz mdoloop
                           B   430    
004200 CD 64 42 00         B   431    			call wait_mouse_clk_low
004204 D8                  B   432    			ret c
004205 AF                  B   433    			xor a
004206 CB42                B   434    			bit 0,d
004208 20 02               B   435    			jr nz,parone
00420A CBDF                B   436    			set 3,a
00420C ED3907              B   437    parone		out0 (port_ps2_ctrl),a				00420F CD 91 42 00         B   438    			call wait_mouse_clk_high
004213 D8                  B   439    			ret c
                           B   440    			
004214 CD 64 42 00         B   441    			call wait_mouse_clk_low
004218 D8                  B   442    			ret c
004219 AF                  B   443    			xor a
00421A ED3907              B   444    			out0 (port_ps2_ctrl),a				                           B   445    
00421D CD 60 42 00         B   446    			call wait_mouse_data_low			004221 D8                  B   447    			ret c
004222 CD 64 42 00         B   448    			call wait_mouse_clk_low				004226 D8                  B   449    			ret c
                           B   450    				
004227 CD 8D 42 00         B   451    			call wait_mouse_data_high			00422B D8                  B   452    			ret c
00422C CD 91 42 00         B   453    			call wait_mouse_clk_high			004230 C9                  B   454    			ret 
                           B   455    
                           B   456    ;----------------------------------------------
                           B   457    
                           B   458    
004231                     B   459    wait_mouse_byte
                           B   460    
004231 11008000            B   461    			ld de,8000h
004235 CD 16 40 00         B   462    			call set_timeout					                           B   463    
004239 ED3807              B   464    wait_mloop	in0 a,(port_ps2_ctrl)
00423C CB6F                B   465    			bit 5,a
00423E 20 08               B   466    			jr nz,rec_mbyte
                           B   467    			
004240 CD 27 40 00         B   468    			call test_timeout
004244 28 F3               B   469    			jr z,wait_mloop
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 170


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_misc_code.asm
004246 37                  B   470    			scf									004247 C9                  B   471    			ret
                           B   472    			
004248 ED3806              B   473    rec_mbyte	in0 a,(port_mouse_data)				00424B B7                  B   474    			or a
00424C C9                  B   475    			ret
                           B   476    
                           B   477    ;----------------------------------------------
                           B   478    
00424D                     B   479    purge_mouse
                           B   480    			
00424D ED3807              B   481    			in0 a,(port_ps2_ctrl)
004250 CB6F                B   482    			bit 5,a
004252 C8                  B   483    			ret z
004253 ED3806              B   484    			in0 a,(port_mouse_data)			; r
004256 18 F5               B   485    			jr purge_mouse
                           B   486    
                           B   487    
                           B   488    ;----------------------------------------------
                           B   489    
                           B   490    
004258                     B   491    wait_kb_data_low
                           B   492    
004258 3E02                B   493    			ld a,2
00425A 18 0A               B   494    			jr test_lo_ps2
                           B   495    			
00425C                     B   496    wait_kb_clk_low
                           B   497    
00425C 3E01                B   498    			ld a,1
00425E 18 06               B   499    			jr test_lo_ps2			
                           B   500    
004260                     B   501    wait_mouse_data_low
                           B   502    
004260 3E08                B   503    			ld a,8
004262 18 02               B   504    			jr test_lo_ps2
                           B   505    
004264                     B   506    wait_mouse_clk_low
                           B   507    
004264 3E04                B   508    			ld a,4
                           B   509    
004266 C5                  B   510    test_lo_ps2	push bc
004267 D5                  B   511    			push de
004268 4F                  B   512    			ld c,a
004269 11004000            B   513    			ld de,04000h					; a
00426D CD 16 40 00         B   514    			call set_timeout
                           B   515    
004271 CD 27 40 00         B   516    nkb_lw		call test_timeout				; t
004275 28 04               B   517    			jr z,nkb_lnto
004277 D1                  B   518    			pop de
004278 C1                  B   519    			pop bc
004279 37                  B   520    			scf								; c
00427A C9                  B   521    			ret
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 171


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_misc_code.asm
00427B ED3807              B   522    nkb_lnto	in0 a,(port_ps2_ctrl)
00427E A1                  B   523    			and c
00427F 20 F0               B   524    			jr nz,nkb_lw
                           B   525    					
004281 D1                  B   526    			pop de
004282 C1                  B   527    			pop bc
004283 AF                  B   528    			xor a
004284 C9                  B   529    			ret					
                           B   530    
                           B   531    
                           B   532    
                           B   533    
004285                     B   534    wait_kb_data_high
                           B   535    
004285 3E02                B   536    			ld a,2
004287 18 0A               B   537    			jr test_hi_ps2
                           B   538    			
004289                     B   539    wait_kb_clk_high
                           B   540    
004289 3E01                B   541    			ld a,1
00428B 18 06               B   542    			jr test_hi_ps2
                           B   543    
                           B   544    
00428D                     B   545    wait_mouse_data_high
                           B   546    			
00428D 3E08                B   547    			ld a,8
00428F 18 02               B   548    			jr test_hi_ps2
                           B   549    			 
004291                     B   550    wait_mouse_clk_high
                           B   551    
004291 3E04                B   552    			ld a,4
                           B   553    
004293 C5                  B   554    test_hi_ps2	push bc
004294 D5                  B   555    			push de
004295 4F                  B   556    			ld c,a
004296 11004000            B   557    			ld de,04000h					; a
00429A CD 16 40 00         B   558    			call set_timeout
                           B   559    
00429E CD 27 40 00         B   560    nkb_hw		call test_timeout				; t
0042A2 28 04               B   561    			jr z,nkb_hnto
0042A4 D1                  B   562    			pop de
0042A5 C1                  B   563    			pop bc
0042A6 37                  B   564    			scf								; c
0042A7 C9                  B   565    			ret
0042A8 ED3807              B   566    nkb_hnto	in0 a,(port_ps2_ctrl)
0042AB A1                  B   567    			and c
0042AC 28 F0               B   568    			jr z,nkb_hw
                           B   569    					
0042AE D1                  B   570    			pop de
0042AF C1                  B   571    			pop bc
0042B0 AF                  B   572    			xor a							; c
0042B1 C9                  B   573    			ret
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 172


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\ez80p_misc_code.asm
                           B   574    
                           B   575    
                           B   576    ;==============================================
                           A  3093    
                           B     0    	include		'prose_keyboard_routines.asm'	                           B     1    ;----------------------------------------------
                           B     2    ;PROSE KEYBOARD/MOUSE ROUTINES V0.04 (ADL mode)
                           B     3    ;----------------------------------------------
                           B     4    
0042B2                     B     5    os_wait_key_press
                           B     6    
                           B     7    ; Busy waits for a keypress.
                           B     8    ; Handles the following modifier keys (key_mod_
                           B     9    ; Returns scancode in A and ASCII code in B (B=
                           B    10    ; (ASCII code is modifed by shift / alt key sta
                           B    11    
                           B    12    
0042B2 D5                  B    13    				push de
0042B3 51                  B    14    				ld d,c
0042B4 E5                  B    15    				push hl
0042B5 CD 0B 43 00         B    16    wait_kbuf		call get_kb_buffer_indexes		0042B9 BE                  B    17    				cp (hl)							0042BA 28 F9               B    18    				jr z,wait_kbuf		
                           B    19    			
0042BC 01000000            B    20    new_key			ld bc,0							0042C0 4F                  B    21    				ld c,a
0042C1 21 DF 60 00         B    22    				ld hl,scancode_buffer	
0042C5 09                  B    23    				add hl,bc
                           B    24    												0042C6 4E                  B    25    				ld c,(hl)						0042C7 11100000            B    26    				ld de,16
0042CB 19                  B    27    				add hl,de						0042CC 7E                  B    28    				ld a,(hl)						                           B    29    				
0042CD 21 CC 5C 00         B    30    				ld hl,alted_keymap				0042D1 CB5F                B    31    				bit 3,a
0042D3 20 0C               B    32    				jr nz,got_kmap	
0042D5 21 08 5C 00         B    33    				ld hl,unshifted_keymap			0042D9 E611                B    34    				and 011h			
0042DB 28 04               B    35    				jr z,got_kmap
0042DD 21 6A 5C 00         B    36    				ld hl,shifted_keymap			                           B    37    			
0042E1 79                  B    38    got_kmap		ld a,c							0042E2 FE62                B    39    				cp 062h
0042E4 30 02               B    40    				jr nc,gotkdone
0042E6 09                  B    41    				add hl,bc						0042E7 46                  B    42    				ld b,(hl)						                           B    43    			
0042E8 3A 00 61 00         B    44    gotkdone		ld a,(key_buf_rd_idx)			0042EC 3C                  B    45    				inc a							0042ED E60F                B    46    				and 15
0042EF 32 00 61 00         B    47    				ld (key_buf_rd_idx),a			Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 173


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_keyboard_routines.asm
0042F3 79                  B    48    				ld a,c							0042F4 E1                  B    49    				pop hl
0042F5 4A                  B    50    				ld c,d
0042F6 D1                  B    51    				pop de
0042F7 BF                  B    52    				cp a							0042F8 C9                  B    53    				ret
                           B    54    			
                           B    55    		
                           B    56    ;----------------------------------------------
                           B    57    			
0042F9                     B    58    os_get_key_press
                           B    59    				
                           B    60    ; Gets a keycode on-the-fly - If one is availab
                           B    61    ; On return, ZF is set if there is a new scanco
                           B    62    ; (ASCII code is modifed by shift key status), 
                           B    63    			
                           B    64    			
0042F9 D5                  B    65    				push de
0042FA 51                  B    66    				ld d,c
0042FB E5                  B    67    				push hl
0042FC CD 0B 43 00         B    68    				call get_kb_buffer_indexes		004300 BE                  B    69    				cp (hl)							004301 20 B9               B    70    				jr nz,new_key					004303 3E81                B    71    				ld a,81h			
004305 47                  B    72    				ld b,a
004306 B7                  B    73    				or a
004307 E1                  B    74    				pop hl
004308 4A                  B    75    				ld c,d
004309 D1                  B    76    				pop de
00430A C9                  B    77    				ret
                           B    78    			
                           B    79    ;----------------------------------------------
                           B    80    			
00430B                     B    81    get_kb_buffer_indexes
                           B    82    			
                           B    83    			
00430B 21 FF 60 00         B    84    				ld hl,key_buf_wr_idx			00430F 3A 00 61 00         B    85    				ld a,(key_buf_rd_idx)			004313 C9                  B    86    				ret
                           B    87    			
                           B    88    		
                           B    89    ;----------------------------------------------
                           B     0    	include		'prose_serial_routines.asm'
                           B     1    ;**********************************************
                           B     2    ; PROSE Serial File Transfer Routines V0.05 (AD
                           B     3    ;**********************************************
                           B     4    
                           B     5    ;----------------------------------------------
                           B     6    ; .---------------------.
                           B     7    ; ! Receive file header !
                           B     8    ; '---------------------'
                           B     9    ;
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 174


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_serial_routines.asm
                           B    10    ; Before calling set:-
                           B    11    ;
                           B    12    ; HL = Filename ("*" if dont care)
                           B    13    ;  A = Time out in seconds
                           B    14    ;
                           B    15    ; If zero flag set, all OK. IX returns location
                           B    16    ;    Else A=$84 = memory address out of range, 
                           B    17    ;           $87 = Filename mismatch, $86 = chec
                           B    18    ;----------------------------------------------
                           B    19    	
                           B    20    
004314                     B    21    serial_get_header
                           B    22    
004314 32 A5 5D 00         B    23    				ld (serial_timeout),a			004318 22 8F 5D 00         B    24    				ld (serial_fn_addr),hl
00431C CD A2 3A 00         B    25    				call hwsc_flush_serial_buffer	                           B    26    
004320 CD 03 44 00         B    27    				call s_getblock					004324 28 0C               B    28    				jr z,s_gbfhok					004326 F5                  B    29    				push af							004327 3A C6 5D 00         B    30    				ld a,(serial_transfer_started)
00432B B7                  B    31    				or a							00432C C4 6A 44 00         B    32    				call nz,s_badack				004330 F1                  B    33    				pop af
004331 C9                  B    34    				ret
                           B    35    	
004332 21 BA 5D 00         B    36    s_gbfhok		ld hl,serial_header_id			004336 11 31 65 00         B    37    				ld de,sector_buffer+20			00433A 060C                B    38    				ld b,12
00433C CD DF 11 00         B    39    				call os_compare_strings
004340 20 0F               B    40    				jr nz,s_nfhdr
004342 06E0                B    41    				ld b,256-32						004344 21 3D 65 00         B    42    				ld hl,sector_buffer+32
004348 7E                  B    43    s_chdr			ld a,(hl)
004349 23                  B    44    				inc hl
00434A B7                  B    45    				or a
00434B 20 04               B    46    				jr nz,s_nfhdr
00434D 10 F9               B    47    				djnz s_chdr
00434F 18 08               B    48    				jr s_fhcsok
                           B    49    				
004351 CD 6A 44 00         B    50    s_nfhdr			call s_badack					004355 3E85                B    51    				ld a,085h						004357 B7                  B    52    				or a
004358 C9                  B    53    				ret
                           B    54    		
004359 21 2D 65 00         B    55    s_fhcsok		ld hl,sector_buffer+16			00435D 11 B6 5D 00         B    56    				ld de,serial_fileheader+16
004361 01040000            B    57    				ld bc,4
004365 EDB0                B    58    				ldir
                           B    59    				
004367 21 1D 65 00         B    60    				ld hl,sector_buffer
00436B 11 A6 5D 00         B    61    				ld de,serial_fileheader			Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 175


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_serial_routines.asm
00436F 0610                B    62    				ld b,16							004371 7E                  B    63    s_tuclp			ld a,(hl)						004372 B7                  B    64    				or a
004373 28 0B               B    65    				jr z,s_ffhswz	
004375 CD 19 12 00         B    66    				call os_uppercasify
004379 12                  B    67    				ld (de),a
00437A 23                  B    68    				inc hl
00437B 13                  B    69    				inc de
00437C 10 F3               B    70    				djnz s_tuclp
00437E 18 04               B    71    				jr s_tucdone
004380 12                  B    72    s_ffhswz		ld (de),a
004381 13                  B    73    				inc de
004382 10 FC               B    74    				djnz s_ffhswz		
                           B    75    	
004384 2A 8F 5D 00         B    76    s_tucdone		ld hl,(serial_fn_addr)			004388 7E                  B    77    				ld a,(hl)
004389 FE2A                B    78    				cp '*'
00438B 28 14               B    79    				jr z,s_rffns					00438D 11 A6 5D 00         B    80    				ld de,serial_fileheader
004391 0610                B    81    				ld b,16
004393 CD DF 11 00         B    82    				call os_compare_strings
004397 28 08               B    83    				jr z,s_rffns
004399 CD 6A 44 00         B    84    s_rfnbad		call s_badack
00439D 3E87                B    85    				ld a,087h						00439F B7                  B    86    				or a
0043A0 C9                  B    87    				ret
                           B    88    				
0043A1 DD21 A6 5D 00       B    89    s_rffns			ld ix,serial_fileheader			0043A6 AF                  B    90    				xor a
0043A7 C9                  B    91    				ret
                           B    92    
0043A8 F5                  B    93    s_fail			push af				
0043A9 CD 6A 44 00         B    94    				call s_badack		 
0043AD F1                  B    95    				pop af
0043AE C9                  B    96    				ret
                           B    97    	
                           B    98    ;----------------------------------------------
                           B    99    ; .-------------------.
                           B   100    ; ! Receive file data !
                           B   101    ; '-------------------'
                           B   102    ;
                           B   103    ; Serial_get_header must be called first!
                           B   104    ;
                           B   105    ; Set:
                           B   106    ;
                           B   107    ; xHL = Address to load to [23:0]
                           B   108    ;
                           B   109    ; On return, if Zero flag is set, all OK (IX = 
                           B   110    ; Else A =  $84 = memory address out of range
                           B   111    ;           $85 = comms error
                           B   112    ;----------------------------------------------
                           B   113    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 176


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_serial_routines.asm
0043AF                     B   114    serial_receive_file
                           B   115    
0043AF 3E0A                B   116    				ld a,10							0043B1 32 A5 5D 00         B   117    				ld (serial_timeout),a
0043B5 E5                  B   118    				push hl
0043B6 CD 59 44 00         B   119    				call s_goodack					0043BA DDE1                B   120    				pop ix							0043BC ED5B B6 5D 00       B   121    				ld de,(serial_fileheader+16)	                           B   122    
0043C1 CD 03 44 00         B   123    s_gbloop		call s_getblock
0043C5 20 E1               B   124    				jr nz,s_fail
0043C7 0E00                B   125    				ld c,0							0043C9 FD21 1D 65 00       B   126    				ld iy,sector_buffer
0043CE FD7E00              B   127    s_rfloop		ld a,(iy)
0043D1 DD7700              B   128    				ld (ix),a						0043D4 1B                  B   129    				dec de							0043D5 21000000            B   130    				ld hl,0
0043D9 AF                  B   131    				xor a
0043DA ED5A                B   132    				adc hl,de						0043DC 28 1A               B   133    				jr z,s_rfabr					0043DE C5                  B   134    				push bc
0043DF 01010000            B   135    				ld bc,1
0043E3 DD09                B   136    				add ix,bc						0043E5 C1                  B   137    				pop bc
0043E6 30 05               B   138    				jr nc,s_nbt
0043E8 3E84                B   139    				ld a,84h						0043EA B7                  B   140    				or a
0043EB 18 BB               B   141    				jr s_fail
0043ED FD23                B   142    s_nbt			inc iy
0043EF 0D                  B   143    				dec c
0043F0 20 DC               B   144    				jr nz,s_rfloop
0043F2 CD 59 44 00         B   145    				call s_goodack					0043F6 18 C9               B   146    				jr s_gbloop
                           B   147    			
0043F8 CD 59 44 00         B   148    s_rfabr			call s_goodack					0043FC DD21 A6 5D 00       B   149    				ld ix,serial_fileheader			004401 AF                  B   150    				xor a							004402 C9                  B   151    				ret
                           B   152    			
                           B   153    ;----------------------------------------------
                           B   154    
004403                     B   155    s_getblock
                           B   156    
                           B   157    ; carry set on return if timed out
                           B   158    
004403 AF                  B   159    				xor a
004404 32 C6 5D 00         B   160    				ld (serial_transfer_started),a	004408 E5                  B   161    				push hl							004409 D5                  B   162    				push de
00440A C5                  B   163    				push bc
00440B 21 1D 65 00         B   164    				ld hl,sector_buffer				00440F 0600                B   165    				ld b,0
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 177


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_serial_routines.asm
004411 D9                  B   166    				exx
004412 21FFFF00            B   167    				ld hl,0ffffh					004416 D9                  B   168    				exx
004417 CD 4C 3A 00         B   169    s_lgb			call receive_serial_byte
00441B 20 38               B   170    				jr nz,s_gberr					00441D F5                  B   171    				push af
00441E 3E01                B   172    				ld a,1
004420 32 C6 5D 00         B   173    				ld (serial_transfer_started),a
004424 F1                  B   174    				pop af
004425 77                  B   175    				ld (hl),a
004426 D9                  B   176    				exx
004427 AC                  B   177    				xor h							004428 67                  B   178    				ld h,a			
004429 0608                B   179    				ld b,8
00442B 4029                B   180    rxcrcbyte		add.sis hl,hl					00442D 30 08               B   181    				jr nc,rxcrcnext
00442F 7C                  B   182    				ld a,h
004430 EE10                B   183    				xor 10h
004432 67                  B   184    				ld h,a
004433 7D                  B   185    				ld a,l
004434 EE21                B   186    				xor 21h
004436 6F                  B   187    				ld l,a
004437 10 F2               B   188    rxcrcnext		djnz rxcrcbyte
004439 D9                  B   189    				exx
00443A 23                  B   190    				inc hl
00443B 10 DA               B   191    				djnz s_lgb
00443D D9                  B   192    				exx								                           B   193    			
00443E CD 4C 3A 00         B   194    				call receive_serial_byte		004442 20 11               B   195    				jr nz,s_gberr
004444 4F                  B   196    				ld c,a
004445 CD 4C 3A 00         B   197    				call receive_serial_byte
004449 20 0A               B   198    				jr nz,s_gberr		
00444B 47                  B   199    				ld b,a
                           B   200    				
00444C AF                  B   201    				xor a							00444D 52ED42              B   202    				sbc.s hl,bc						004450 28 03               B   203    				jr z,s_gberr
                           B   204    			
004452 3E86                B   205    				ld a,86h						004454 B7                  B   206    				or a							004455 C1                  B   207    s_gberr			pop bc
004456 D1                  B   208    				pop de
004457 E1                  B   209    				pop hl
004458 C9                  B   210    				ret
                           B   211    				
                           B   212    ;----------------------------------------------
                           B   213    
004459 C5                  B   214    s_goodack		push bc
00445A 014F4B00            B   215    				ld bc,04b4fh					00445E 79                  B   216    ackbytes		ld a,c
00445F CD 87 3A 00         B   217    				call send_serial_byte
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 178


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_serial_routines.asm
004463 78                  B   218    				ld a,b
004464 CD 87 3A 00         B   219    				call send_serial_byte
004468 C1                  B   220    				pop bc
004469 C9                  B   221    				ret
                           B   222    
00446A C5                  B   223    s_badack		push bc
00446B 01585800            B   224    				ld bc,05858h					00446F 18 ED               B   225    				jr ackbytes
                           B   226    
004471 C5                  B   227    s_holdack		push bc
004472 01575700            B   228    				ld bc,05757h					004476 18 E6               B   229    				jr ackbytes
                           B   230    				
                           B   231    ;==============================================
                           B   232    
                           B   233    ; .-----------.
                           B   234    ; ! Send file !
                           B   235    ; '-----------'
                           B   236    
                           B   237    ; Before calling set:-
                           B   238    
                           B   239    ;  xHL   = filename
                           B   240    ;  xDE   = length of file
                           B   241    ;  xIX   = Start address [23:0]
                           B   242    
                           B   243    ; On return, if zero flag is set, all OK. Else:
                           B   244    ; $81 = Save length is zero
                           B   245    ; $84 = memory address out of range
                           B   246    ; $85 = comms error
                           B   247    
                           B   248    
004478                     B   249    serial_send_file
                           B   250    			
004478 3E01                B   251    				ld a,1							00447A 32 A5 5D 00         B   252    				ld (serial_timeout),a
                           B   253    			
00447E DD22 89 5D 00       B   254    				ld (serial_ez80_address),ix
004483 ED53 B6 5D 00       B   255    				ld (serial_fileheader+10h),de	004488 E5                  B   256    				push hl
004489 21000000            B   257    				ld hl,0
00448D AF                  B   258    				xor a
00448E ED5A                B   259    				adc hl,de
004490 20 05               B   260    				jr nz,s_flok
004492 E1                  B   261    				pop hl
004493 3E81                B   262    				ld a,081h						004495 B7                  B   263    				or a							004496 C9                  B   264    				ret
                           B   265    			
004497 21 A6 5D 00         B   266    s_flok			ld hl,serial_fileheader			00449B 01100000            B   267    				ld bc,16
00449F AF                  B   268    				xor a
0044A0 CD 4B 15 00         B   269    				call os_bchl_memfill
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 179


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_serial_routines.asm
0044A4 E1                  B   270    				pop hl							0044A5 11 A6 5D 00         B   271    				ld de,serial_fileheader
0044A9 0610                B   272    				ld b,16
0044AB CD FE 11 00         B   273    				call os_copy_ascii_run
                           B   274    				
0044AF 21 BA 5D 00         B   275    				ld hl,serial_header_id			0044B3 11 BA 5D 00         B   276    				ld de,serial_fileheader+014h
0044B7 010C0000            B   277    				ld bc,12		
0044BB EDB0                B   278    				ldir
                           B   279    			
0044BD DD21 A6 5D 00       B   280    				ld ix,serial_fileheader			0044C2 11200000            B   281    				ld de,32
0044C6 CD FC 44 00         B   282    				call s_makeblock			
0044CA C0                  B   283    				ret nz
0044CB CD 34 45 00         B   284    				call s_sendblock
0044CF C0                  B   285    				ret nz
0044D0 CD 61 45 00         B   286    				call s_waitack					0044D4 C0                  B   287    				ret nz							                           B   288    				
0044D5 DD2A 89 5D 00       B   289    				ld ix,(serial_ez80_address)
0044DA ED5B B6 5D 00       B   290    				ld de,(serial_fileheader+16)	0044DF CD FC 44 00         B   291    s_sbloop		call s_makeblock				0044E3 38 16               B   292    				jr c,s_rerr
0044E5 CD 34 45 00         B   293    				call s_sendblock				0044E9 38 10               B   294    				jr c,s_rerr	
0044EB CD 61 45 00         B   295    				call s_waitack					0044EF 38 0A               B   296    				jr c,s_rerr
0044F1 21000000            B   297    				ld hl,0
0044F5 AF                  B   298    				xor a
0044F6 ED5A                B   299    				adc hl,de
0044F8 20 E5               B   300    				jr nz,s_sbloop					0044FA AF                  B   301    				xor a							0044FB C9                  B   302    s_rerr			ret
                           B   303    
                           B   304    ;----------------------------------------------
                           B   305    
0044FC                     B   306    s_makeblock
                           B   307    
                           B   308    ; set xIX = src addr
                           B   309    ; xDE = byte count
                           B   310    ; a=0 on return if all ok	
                           B   311    
0044FC 21 1D 65 00         B   312    				ld hl,sector_buffer				004500 01000100            B   313    				ld bc,256						004504 AF                  B   314    				xor a							004505 CD 4B 15 00         B   315    				call os_bchl_memfill			                           B   316    				
004509 0600                B   317    				ld b,0							00450B FD21 1D 65 00       B   318    				ld iy,sector_buffer	
004510 DD7E00              B   319    s_sloop			ld a,(ix)
004513 FD7700              B   320    				ld (iy),a
004516 1B                  B   321    				dec de							Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 180


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_serial_routines.asm
004517 21000000            B   322    				ld hl,0
00451B AF                  B   323    				xor a
00451C ED5A                B   324    				adc hl,de
00451E 28 12               B   325    				jr z,s_mbend	
004520 FD23                B   326    				inc iy							004522 C5                  B   327    				push bc
004523 01010000            B   328    				ld bc,1
004527 DD09                B   329    				add ix,bc						004529 C1                  B   330    				pop bc							00452A 20 04               B   331    				jr nz,s_sbok
00452C 3E84                B   332    				ld a,84h						00452E B7                  B   333    				or a
00452F C9                  B   334    				ret
004530 10 DE               B   335    s_sbok			djnz s_sloop
004532 AF                  B   336    s_mbend			xor a
004533 C9                  B   337    				ret
                           B   338    
                           B   339    
                           B   340    
004534                     B   341    s_sendblock
                           B   342    
004534 E5                  B   343    				push hl
004535 D5                  B   344    				push de							004536 C5                  B   345    				push bc				
004537 21 1D 65 00         B   346    				ld hl,sector_buffer			
00453B 1E00                B   347    				ld e,0
00453D 7E                  B   348    s_sblklp		ld a,(hl)
00453E CD 87 3A 00         B   349    				call send_serial_byte
004542 23                  B   350    				inc hl
004543 1D                  B   351    				dec e
004544 20 F7               B   352    				jr nz,s_sblklp
004546 11 1D 65 00         B   353    				ld de,sector_buffer
00454A 01000000            B   354    				ld bc,0
00454E CD 22 15 00         B   355    				call crc_checksum
004552 7D                  B   356    				ld a,l
004553 CD 87 3A 00         B   357    				call send_serial_byte
004557 7C                  B   358    				ld a,h
004558 CD 87 3A 00         B   359    				call send_serial_byte
00455C AF                  B   360    				xor a
00455D C1                  B   361    s_popall		pop bc
00455E D1                  B   362    				pop de
00455F E1                  B   363    				pop hl
004560 C9                  B   364    				ret
                           B   365    	
                           B   366    
004561                     B   367    s_waitack
004561 E5                  B   368    				push hl
004562 D5                  B   369    				push de
004563 C5                  B   370    				push bc
004564 CD 4C 3A 00         B   371    				call receive_serial_byte		004568 20 F3               B   372    				jr nz,s_popall
00456A 47                  B   373    				ld b,a
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 181


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_serial_routines.asm
00456B CD 4C 3A 00         B   374    				call receive_serial_byte
00456F 20 EC               B   375    				jr nz,s_popall
004571 4F                  B   376    				ld c,a
004572 264F                B   377    				ld h,'O'
004574 2E4B                B   378    				ld l,'K'
004576 AF                  B   379    				xor a
004577 52ED42              B   380    				sbc.s hl,bc						00457A 28 E1               B   381    				jr z,s_popall					                           B   382    			
00457C 3E85                B   383    				ld a,085h						00457E B7                  B   384    				or a
00457F 18 DC               B   385    				jr s_popall
                           B   386    
                           B   387    	
                           B   388    ;----------------------------------------------
                           B     0    	include		'prose_fat16_code.asm'
                           B     1    ;----------------------------------------------
                           B     2    ; eZ80 FAT16 File System code for PROSE by Phil
                           B     3    ;----------------------------------------------
                           B     4    ;
                           B     5    ; Changes:
                           B     6    ;
                           B     7    ; 0.05 - Fixed format command
                           B     8    ; 0.04 - File system error codes are now in the
                           B     9    ; 0.03 - ADL mode
                           B    10    ; 0.02 - removed references to banks, added 24 
                           B    11    ; 0.01 - first version based on FLOS routines v
                           B    12    ;
                           B    13    ; Known limitations:
                           B    14    ; ------------------
                           B    15    ; If a disk full error is returned during a fil
                           B    16    ; Allows a file to be created in root even if t
                           B    17    ;        
                           B    18    ;----------------------------------------------
                           B    19    ;
                           B    20    ; All routines return carry clear / zero flag s
                           B    21    ;
                           B    22    ; Carry set = hardware error, A = error byte fr
                           B    23    ;
                           B    24    ; Carry clear, A = 	00 $00 - Command completed 
                           B    25    ;
                           B    26    ;					$c1  - Disk full
                           B    27    ;					$c2  - file not found
                           B    28    ;             	    $c3  - (root) dir table is 
                           B    29    ;					$c4  - directory requested 
                           B    30    ;             	    $c5  - cant delete dir, it 
                           B    31    ;					$c6  - not a file
                           B    32    ;					$c7  - file length is zero
                           B    33    ;              	    $c8  - out of memory
                           B    34    ;					$c9  - filename already exi
                           B    35    ;					$ca  - already at root dire
                           B    36    ;                  	$cb  - directory not found
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 182


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
                           B    37    ;					$cc  - requested bytes beyo
                           B    38    ;					$cd  - invalid filename
                           B    39    ;					$ce  - unknown/incorrect di
                           B    40    ;					$cf  - invalid volume
                           B    41    ;                 	$d0  - device not present	                           B    42    ;					$d1  - directory not found	                           B    43    ;                 	$d2  - end of directory lis
                           B    44    ;                 	$d3  - device does not use 
                           B    45    ;                  	$d4  - cant find volume lab
                           B    46    ;                   $d5  - sector out of range
                           B    47    
                           B    48    ;----------------------------------------------
                           B    49    ; Main routines called by external programs
                           B    50    ;----------------------------------------------
                           B    51    
004581                     B    52    fs_format_device_command
                           B    53    
                           B    54    ; Creates a single partition (truncated to 2GB)
                           B    55    
                           B    56    
004581 3A D7 5D 00         B    57    				ld a,(device_count)				004585 47                  B    58    				ld b,a							004586 DD21 87 5E 00       B    59    				ld ix,host_device_hardware_info
00458B 3A D6 5D 00         B    60    fdevinfo		ld a,(current_driver)
00458F DDBE00              B    61    				cp (ix)
004592 28 09               B    62    				jr z,got_dev_info
004594 ED3220              B    63    				lea ix,ix+32
004597 10 F2               B    64    				djnz fdevinfo
004599 AF                  B    65    				xor a
00459A 3ED0                B    66    				ld a,0d0h						00459C C9                  B    67    				ret	
                           B    68    	
00459D CD 30 50 00         B    69    got_dev_info	call fs_clear_sector_buffer		0045A1 11000000            B    70    				ld de,0							0045A5 CD 95 46 00         B    71    form_ws			call set_lba_and_write_sector
0045A9 D8                  B    72    				ret c
0045AA 13                  B    73    				inc de
0045AB 7A                  B    74    				ld a,d
0045AC FE03                B    75    				cp 3
0045AE 20 F5               B    76    				jr nz,form_ws
                           B    77    	
0045B0 21 DE 52 00         B    78    				ld hl,bootsector_stub			0045B4 11 1D 65 00         B    79    				ld de,sector_buffer				0045B8 013F0000            B    80    				ld bc,03fh
0045BC EDB0                B    81    				ldir
                           B    82    	
0045BE DD7E04              B    83    				ld a,(ix+4)						0045C1 B7                  B    84    				or a
0045C2 20 0C               B    85    				jr nz,above_2gb
0045C4 2100FF3F            B    86    				ld hl,3fff00h					0045C8 DD1701              B    87    				ld de,(ix+1)					0045CB AF                  B    88    				xor a			
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 183


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
0045CC ED52                B    89    				sbc hl,de						0045CE 30 08               B    90    				jr nc,lessthan2gb				0045D0 3E40                B    91    above_2gb		ld a,40h						0045D2 1100FF3F            B    92    				ld de,3fff00h					0045D6 18 11               B    93    				jr spcvalok
                           B    94    
0045D8 DD4E03              B    95    lessthan2gb		ld c,(ix+3)						0045DB 0C                  B    96    				inc c							0045DC 3E01                B    97    spc_loop		ld a,1							0045DE B9                  B    98    spc_comp		cp c							0045DF 28 08               B    99    				jr z,spcvalok
0045E1 07                  B   100    				rlca
0045E2 FE80                B   101    				cp 080h							0045E4 20 F8               B   102    				jr nz,spc_comp
0045E6 0C                  B   103    				inc c			
0045E7 18 F3               B   104    				jr spc_loop						                           B   105    							
0045E9 DD21 1D 65 00       B   106    spcvalok		ld ix,sector_buffer
0045EE DD770D              B   107    				ld (ix+0dh),a					                           B   108    				
0045F1 CD 68 15 00         B   109    				call os_get_xde_msb				0045F5 4F                  B   110    				ld c,a							0045F6 B7                  B   111    				or a							0045F7 20 08               B   112    				jr nz,ts_dword					0045F9 DD7313              B   113    				ld (ix+13h),e					0045FC DD7214              B   114    				ld (ix+14h),d
0045FF 18 07               B   115    				jr ts_done
004601 DD1F20              B   116    ts_dword		ld (ix+20h),de					004604 DD362300            B   117    				ld (ix+23h),0
                           B   118    
004608 EB                  B   119    ts_done			ex de,hl						004609 11000000            B   120    				ld de,0						
00460D DD560D              B   121    				ld d,(ix+0dh)					004610 01000000            B   122    				ld bc,0							004614 AF                  B   123    div_tscls		xor a							004615 ED52                B   124    				sbc hl,de
004617 28 05               B   125    				jr z,gotfats
004619 38 03               B   126    				jr c,gotfats	
00461B 03                  B   127    				inc bc
00461C 18 F6               B   128    				jr div_tscls
00461E 03                  B   129    gotfats			inc bc
00461F DD7116              B   130    				ld (ix+16h),c					004622 DD7017              B   131    				ld (ix+17h),b
004625 ED43 2E 53 00       B   132    				ld (fs_sectors_per_fat),bc
                           B   133    				
00462A 010055AA            B   134    				ld bc,0aa5500h
00462E ED43 1A 67 00       B   135    				ld (sector_buffer+1fdh),bc		004633 11000000            B   136    				ld de,0
004637 CD 95 46 00         B   137    				call set_lba_and_write_sector	00463B D8                  B   138    				ret c
                           B   139    				
00463C 21000000            B   140    				ld hl,0
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 184


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
004640 DD6E0E              B   141    				ld l,(ix+0eh)					004643 DD660F              B   142    				ld h,(ix+0fh)
004646 19                  B   143    				add hl,de
004647 EB                  B   144    				ex de,hl						                           B   145    				
004648 CD 30 50 00         B   146    				call fs_clear_sector_buffer		00464C DD3600FF            B   147    				ld (ix+0),0ffh
004650 DD3601F8            B   148    				ld (ix+1),0f8h
004654 DD3602FF            B   149    				ld (ix+2),0ffh
004658 DD3603FF            B   150    				ld (ix+3),0ffh
00465C CD 95 46 00         B   151    				call set_lba_and_write_sector	004660 D8                  B   152    				ret c
                           B   153    
004661 2A 2E 53 00         B   154    				ld hl,(fs_sectors_per_fat)	
004665 19                  B   155    				add hl,de
004666 EB                  B   156    				ex de,hl
004667 CD 95 46 00         B   157    				call set_lba_and_write_sector 	00466B D8                  B   158    				ret c	
                           B   159    				
00466C D5                  B   160    				push de							00466D CD 30 50 00         B   161    				call fs_clear_sector_buffer
004671 21 34 53 00         B   162    				ld hl,fs_sought_filename
004675 11 1D 65 00         B   163    				ld de,sector_buffer
004679 010B0000            B   164    				ld bc,11
00467D EDB0                B   165    				ldir							00467F D1                  B   166    				pop de							004680 DD360B08            B   167    				ld (ix+0bh),8					004684 DD361821            B   168    				ld (ix+018h),021h				004688 2A 2E 53 00         B   169    				ld hl,(fs_sectors_per_fat)		00468C 19                  B   170    				add hl,de
00468D EB                  B   171    				ex de,hl
00468E CD 95 46 00         B   172    				call set_lba_and_write_sector	004692 D8                  B   173    				ret c	
                           B   174    			
004693 AF                  B   175    				xor a							004694 C9                  B   176    				ret
                           B   177    	
                           B   178    
                           B   179    
004695                     B   180    set_lba_and_write_sector
                           B   181    
004695 DDE5                B   182    				push ix
004697 DD21 AC 5F 00       B   183    				ld ix,sector_lba0				00469C DD1F00              B   184    				ld (ix),de						00469F DD360300            B   185    				ld (ix+3),0
0046A3 DDE1                B   186    				pop ix
0046A5 CD C2 52 00         B   187    				call fs_write_sector
0046A9 C9                  B   188    				ret
                           B   189    				
                           B   190    				
                           B   191    ;----------------------------------------------
                           B   192    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 185


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
0046AA                     B   193    fs_get_partition_info
                           B   194    
                           B   195    ; Set A to partition: $00 to $03
                           B   196    ; On return: If A = $00, xHL = Address of reque
                           B   197    ;            If A = $25, A partition table is n
                           B   198    ;            If A = $13, Disk format is bad 
                           B   199    ;            If carry flag set, there was a har
                           B   200    
                           B   201    
0046AA 32 0A 5F 00         B   202    				ld (partition_temp),a
                           B   203    				
0046AE 21000000            B   204    				ld hl,0							0046B2 22 AC 5F 00         B   205    				ld (sector_lba0),hl
0046B6 7D                  B   206    				ld a,l
0046B7 32 AF 5F 00         B   207    				ld (sector_lba3),a
0046BB CD AA 52 00         B   208    				call fs_read_sector
0046BF D8                  B   209    				ret c
                           B   210    			
0046C0 CD FB 46 00         B   211    				call fs_check_fat_sig			0046C4 20 42               B   212    				jr nz,formbad
                           B   213    			
0046C6 CD EC 46 00         B   214    				call check_fat16_id				0046CA 28 1C               B   215    				jr z,at_pbs						                           B   216    				
0046CC 3A DF 66 00         B   217    				ld a,(sector_buffer+01c2h)		0046D0 E604                B   218    				and 4							0046D2 28 34               B   219    				jr z,formbad	
0046D4 11000000            B   220    				ld de,0
0046D8 3A 0A 5F 00         B   221    				ld a,(partition_temp)
0046DC 5F                  B   222    				ld e,a
0046DD 1610                B   223    				ld d,16
0046DF ED5C                B   224    				mlt de
0046E1 21 DB 66 00         B   225    				ld hl,sector_buffer+01beh
0046E5 19                  B   226    				add hl,de						0046E6 AF                  B   227    				xor a
0046E7 C9                  B   228    				ret
                           B   229    					
0046E8 AF                  B   230    at_pbs			xor a
0046E9 3ED3                B   231    				ld a,0d3h						0046EB C9                  B   232    				ret
                           B   233    
                           B   234    
                           B   235    
0046EC                     B   236    check_fat16_id
                           B   237    		
0046EC 21 53 65 00         B   238    				ld hl,sector_buffer+036h		0046F0 11 C5 57 00         B   239    				ld de,fat16_txt			
0046F4 0605                B   240    				ld b,5
0046F6 CD DF 11 00         B   241    				call os_compare_strings
0046FA C9                  B   242    				ret
                           B   243    				
                           B   244    ;----------------------------------------------
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 186


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
                           B   245    
                           B   246    
0046FB                     B   247    fs_check_fat_sig
                           B   248    
0046FB 2A 1B 67 00         B   249    				ld hl,(sector_buffer+01feh)		0046FF 1155AA00            B   250    				ld de,0aa55h
004703 AF                  B   251    				xor a
004704 52ED52              B   252    				sbc.s hl,de						004707 C9                  B   253    				ret
                           B   254    			
                           B   255    			
                           B   256    			
004708 AF                  B   257    formbad			xor a
004709 3ECE                B   258    				ld a,0ceh						00470B C9                  B   259    				ret
                           B   260    
                           B   261    ;----------------------------------------------
                           B   262    
                           B   263    
00470C                     B   264    fs_check_disk_format
                           B   265    
                           B   266    ; ensures disk is FAT16, sets up constants..
                           B   267    	
00470C C5                  B   268    				push bc
00470D D5                  B   269    				push de
00470E E5                  B   270    				push hl
00470F CD 17 47 00         B   271    				call go_checkf
004713 E1                  B   272    				pop hl
004714 D1                  B   273    				pop de
004715 C1                  B   274    				pop bc
004716 C9                  B   275    				ret
                           B   276    				
004717 CD 74 1A 00         B   277    go_checkf		call fs_calc_volume_offset	
00471B 21 07 5E 00         B   278    				ld hl,volume_mount_list
00471F 19                  B   279    				add hl,de
004720 7E                  B   280    				ld a,(hl)
004721 B7                  B   281    				or a							004722 20 04               B   282    				jr nz,fs_volpre
004724 AF                  B   283    				xor a
004725 3ECF                B   284    				ld a,cfh						004727 C9                  B   285    				ret
                           B   286    			
004728 11080000            B   287    fs_volpre		ld de,8							00472C 19                  B   288    				add hl,de
00472D 11 AC 5F 00         B   289    				ld de,sector_lba0
004731 01040000            B   290    				ld bc,4
004735 EDB0                B   291    				ldir
004737 CD AA 52 00         B   292    				call fs_read_sector
00473B D8                  B   293    				ret c	
                           B   294    				
00473C CD FB 46 00         B   295    				call fs_check_fat_sig			004740 20 C6               B   296    				jr nz,formbad		
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 187


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
                           B   297    			
004742 CD EC 46 00         B   298    				call check_fat16_id				004746 20 C0               B   299    				jr nz,formbad
                           B   300    			
004748 DD21 1D 65 00       B   301    				ld ix,sector_buffer
00474D DD270B              B   302    				ld hl,(ix+0bh)					004750 11000200            B   303    				ld de,512						004754 AF                  B   304    				xor a
004755 52ED52              B   305    				sbc.s hl,de						004758 20 AE               B   306    				jr nz,formbad
                           B   307    			
00475A DD7E0D              B   308    				ld a,(ix+0dh)					00475D 32 1D 53 00         B   309    				ld (fs_cluster_size),a
004761 CB27                B   310    				sla a
004763 32 1F 53 00         B   311    				ld (fs_bytes_per_cluster+1),a
                           B   312    							
004767 21000000            B   313    				ld hl,0
00476B DD6E0E              B   314    				ld l,(ix+0eh)					00476E DD660F              B   315    				ld h,(ix+0fh)
004771 22 21 53 00         B   316    				ld (fs_fat1_position),hl		004775 11000000            B   317    				ld de,0
004779 DD5E16              B   318    				ld e,(ix+16h)					00477C DD5617              B   319    				ld d,(ix+17h)
00477F ED53 2E 53 00       B   320    				ld (fs_sectors_per_fat),de
004784 19                  B   321    				add hl,de
004785 22 24 53 00         B   322    				ld (fs_fat2_position),hl		004789 19                  B   323    				add hl,de
00478A 22 27 53 00         B   324    				ld (fs_root_dir_position),hl 	00478E EB                  B   325    				ex de,hl
00478F DD6E11              B   326    				ld l,(ix+11h)					004792 DD6612              B   327    				ld h,(ix+12h)					004795 7C                  B   328    				ld a,h
004796 B5                  B   329    				or l
004797 CA 08 47 00         B   330    				jr z,formbad					00479B 29                  B   331    				add hl,hl						00479C 29                  B   332    				add hl,hl						00479D 29                  B   333    				add hl,hl
00479E 29                  B   334    				add hl,hl
00479F EB                  B   335    				ex de,hl
0047A0 7A                  B   336    				ld a,d
0047A1 32 2D 53 00         B   337    				ld (fs_root_dir_sectors),a		0047A5 01000000            B   338    				ld bc,0
0047A9 4A                  B   339    				ld c,d
0047AA 09                  B   340    				add hl,bc				
0047AB 22 2A 53 00         B   341    				ld (fs_data_area),hl			                           B   342    												0047AF 21000000            B   343    				ld hl,0
0047B3 01000000            B   344    				ld bc,0
0047B7 DD4E22              B   345    				ld c,(ix+022h)					0047BA DD4623              B   346    				ld b,(ix+023h)
0047BD DD6E13              B   347    				ld l,(ix+013h)					0047C0 DD6614              B   348    				ld h,(ix+014h)
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 188


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
0047C3 7C                  B   349    				ld a,h							0047C4 B5                  B   350    				or l
0047C5 20 06               B   351    				jr nz,got_tsfbs
0047C7 DD6E20              B   352    				ld l,(ix+020h)					0047CA DD6621              B   353    				ld h,(ix+021h)
0047CD ED5B 2A 53 00       B   354    got_tsfbs 		ld de,(fs_data_area)
0047D2 AF                  B   355    				xor a							0047D3 52ED52              B   356    				sbc.s hl,de						0047D6 30 02               B   357    				jr nc,nomxcb
0047D8 520B                B   358    				dec.s bc
0047DA 3A 1D 53 00         B   359    nomxcb			ld a,(fs_cluster_size)
0047DE CB3F                B   360    fmaxcl			srl a
0047E0 28 08               B   361    				jr z,got_cmaxc					0047E2 CB39                B   362    				srl c				
0047E4 CB1C                B   363    				rr h
0047E6 CB1D                B   364    				rr l
0047E8 18 F4               B   365    				jr fmaxcl
0047EA E5                  B   366    got_cmaxc		push hl							0047EB 11F0FF00            B   367    				ld de,0fff0h
0047EF AF                  B   368    				xor a
0047F0 52ED52              B   369    				sbc.s hl,de						0047F3 38 02               B   370    				jr c,cmaxok
0047F5 E1                  B   371    				pop hl
0047F6 D5                  B   372    				push de
0047F7 E1                  B   373    cmaxok			pop hl
0047F8 22 31 53 00         B   374    				ld (fs_max_data_clusters),hl
0047FC AF                  B   375    				xor a
0047FD C9                  B   376    				ret				
                           B   377    
                           B   378    ;----------------------------------------------
                           B   379    
0047FE                     B   380    fs_calc_free_space
                           B   381    
                           B   382    ;returns free space in KB in HL:DE
                           B   383    
0047FE ED5B 31 53 00       B   384    				ld de,(fs_max_data_clusters)
004803 13                  B   385    				inc de
004804 13                  B   386    				inc de							004805 D5                  B   387    				push de
004806 DDE1                B   388    				pop ix
                           B   389    			
004808 AF                  B   390    				xor a
004809 32 76 53 00         B   391    cfs_lp2			ld (fs_working_sector),a
00480D 2A 21 53 00         B   392    				ld hl,(fs_fat1_position)
004811 CD 80 52 00         B   393    				call set_abs_lba_and_read_secto
004815 D8                  B   394    				ret c
                           B   395    				
004816 21 1D 65 00         B   396    				ld hl,sector_buffer
00481A 0600                B   397    				ld b,0
00481C AF                  B   398    cfs_lp1			xor a
00481D B6                  B   399    				or a,(hl)						00481E 23                  B   400    				inc hl							Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 189


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
00481F 20 03               B   401    				jr nz,cfs_ciu					004821 B6                  B   402    				or a,(hl)
004822 28 02               B   403    				jr z,cfs_ddcc
004824 DD2B                B   404    cfs_ciu			dec ix							004826 23                  B   405    cfs_ddcc		inc hl
004827 1B                  B   406    				dec de
004828 7A                  B   407    				ld a,d
004829 B3                  B   408    				or e
00482A 28 09               B   409    				jr z,cfs_ok						00482C 10 EE               B   410    				djnz cfs_lp1
00482E 3A 76 53 00         B   411    				ld a,(fs_working_sector)
004832 3C                  B   412    				inc a
004833 18 D4               B   413    				jr cfs_lp2
                           B   414    				
004835 3A 1D 53 00         B   415    cfs_ok			ld a,(fs_cluster_size)			004839 CB3F                B   416    cltoslp			srl a
00483B 28 04               B   417    				jr z,powdone
00483D DD29                B   418    				add ix,ix
00483F 18 F8               B   419    				jr cltoslp	
004841 FD21 C8 5F 00       B   420    powdone			ld iy,xrr_temp
004846 FD3E00              B   421    				ld (iy),ix						004849 FDCB023E            B   422    				srl (iy+2)
00484D FDCB011E            B   423    				rr (iy+1)
004851 FDCB001E            B   424    				rr (iy+0)						004855 FD1700              B   425    				ld de,(iy)						004858 AF                  B   426    				xor a
004859 C9                  B   427    				ret
                           B   428    
                           B   429    ;----------------------------------------------
                           B   430    
00485A                     B   431    fs_change_dir_command
                           B   432    
                           B   433    ; INPUT: HL = directory name ascii (zero/space 
                           B   434    			
                           B   435    			
00485A CD 42 50 00         B   436    				call fs_find_filename			00485E D8                  B   437    				ret c							00485F FEC2                B   438    				cp 0c2h							004861 20 04               B   439    				jr nz,founddir
004863 AF                  B   440    				xor a							004864 3ED1                B   441    				ld a,0d1h						004866 C9                  B   442    				ret
004867 AF                  B   443    founddir		xor a							004868 3E04                B   444    				ld a,04h						00486A DDCB0B66            B   445    				bit 4,(ix+0bh)
00486E C8                  B   446    				ret z
00486F 11000000            B   447    				ld de,0
004873 DD5E1A              B   448    				ld e,(ix+01ah)
004876 DD561B              B   449    				ld d,(ix+01bh)					004879 CD 46 1A 00         B   450    				call fs_update_dir_cluster
00487D AF                  B   451    				xor a
00487E C9                  B   452    				ret
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 190


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
                           B   453    
                           B   454    
                           B   455    ;----------------------------------------------
                           B   456    	
                           B   457    	
00487F                     B   458    fs_goto_root_dir_command
                           B   459    
00487F D5                  B   460    				push de
004880 11000000            B   461    				ld de,0
004884 CD 46 1A 00         B   462    				call fs_update_dir_cluster
004888 D1                  B   463    				pop de
004889 AF                  B   464    				xor a
00488A C9                  B   465    				ret
                           B   466    
                           B   467    ;----------------------------------------------
                           B   468    	
                           B   469    	
00488B                     B   470    fs_parent_dir_command
                           B   471    
00488B CD 3A 1A 00         B   472    				call fs_get_dir_cluster
00488F 7A                  B   473    				ld a,d
004890 B3                  B   474    				or e
004891 20 03               B   475    				jr nz,pdnaroot
004893 3ECA                B   476    				ld a,0cah						004895 C9                  B   477    				ret
004896 212E2E20            B   478    pdnaroot		ld hl,0202e2eh					00489A 22 34 53 00         B   479    				ld (fs_sought_filename),hl		00489E 21 37 53 00         B   480    				ld hl,fs_sought_filename+3		0048A2 3E20                B   481    				ld a,32
0048A4 01080000            B   482    				ld bc,8
0048A8 CD 4B 15 00         B   483    				call os_bchl_memfill
0048AC 18 AC               B   484    				jr fs_change_dir_command
                           B   485    				
                           B   486    		
                           B   487    ;----------------------------------------------
                           B   488    		
0048AE                     B   489    fs_open_file_command
                           B   490    
                           B   491    ; INPUT: xHL = directory name ascii (zero/space
                           B   492    ; OUTPUT: C:xDE  = File length
                           B   493    ;            HL  = Start cluster of file
                           B   494    ;            Internal vars (file pointer reset 
                           B   495    
                           B   496    			
0048AE CD 42 50 00         B   497    				call fs_find_filename			0048B2 D8                  B   498    				ret c							0048B3 C0                  B   499    				ret nz							                           B   500    								
0048B4 3EC6                B   501    				ld a,0c6h						0048B6 DDCB0B66            B   502    				bit 4,(ix+0bh)
0048BA C0                  B   503    				ret nz
                           B   504    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 191


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
0048BB AF                  B   505    				xor a
0048BC 32 8A 53 00         B   506    				ld (fs_filepointer_valid),a		0048C0 21000000            B   507    				ld hl,0
0048C4 22 58 53 00         B   508    				ld (fs_file_pointer),hl			0048C8 32 5B 53 00         B   509    				ld (fs_file_pointer+3),a		                           B   510    				
0048CC DD171C              B   511    				ld de,(ix+01ch)
0048CF D5                  B   512    				push de
0048D0 E1                  B   513    				pop hl
0048D1 DD4E1F              B   514    				ld c,(ix+01fh)					0048D4 ED53 5C 53 00       B   515    				ld (fs_file_length),de			0048D9 79                  B   516    				ld a,c
0048DA 32 5F 53 00         B   517    				ld (fs_file_length+3),a			0048DE B7                  B   518    				or a							0048DF 28 04               B   519    				jr z,fs_dflsm					0048E1 21FFFFFF            B   520    				ld hl,0ffffffh
0048E5 22 64 53 00         B   521    fs_dflsm		ld (fs_file_transfer_length),hl
                           B   522    				
0048E9 21000000            B   523    				ld hl,0
0048ED DD6E1A              B   524    				ld l,(ix+01ah)		
0048F0 DD661B              B   525    				ld h,(ix+01bh)
0048F3 22 67 53 00         B   526    				ld (fs_file_start_cluster),hl	0048F7 AF                  B   527    				xor a
0048F8 C9                  B   528    				ret
                           B   529    
                           B   530    	
                           B   531    ;----------------------------------------------
                           B   532    
0048F9                     B   533    fs_read_data_command		
                           B   534    
                           B   535    ;*******************************************
                           B   536    ;*** 'fs_open_file' must be called first ***
                           B   537    ;*******************************************
                           B   538    		
0048F9 2A 64 53 00         B   539    fs_load			ld hl,(fs_file_transfer_length)
0048FD 11000000            B   540    				ld de,0
004901 AF                  B   541    				xor a
004902 ED5A                B   542    				adc hl,de
004904 20 04               B   543    				jr nz,fs_btrok
004906 AF                  B   544    fs_fliz			xor a							004907 3EC7                B   545    				ld a,0c7h						004909 C9                  B   546    				ret
                           B   547    			 
00490A 2A 6D 53 00         B   548    fs_btrok		ld hl,(fs_ez80_address)			00490E 22 70 53 00         B   549    				ld (fs_ez80_working_address),hl
                           B   550    			
004912 2A 5C 53 00         B   551    				ld hl,(fs_file_length)			004916 ED4B 58 53 00       B   552    				ld bc,(fs_file_pointer)			00491B 3A 5B 53 00         B   553    				ld a,(fs_file_pointer+3)		00491F 5F                  B   554    				ld e,a
004920 3A 5F 53 00         B   555    				ld a,(fs_file_length+3)
004924 B7                  B   556    				or a							Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 192


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
004925 ED42                B   557    				sbc hl,bc
004927 9B                  B   558    				sbc a,e
004928 38 09               B   559    				jr c,fs_fpbad
00492A 01000000            B   560    				ld bc,0
00492E AF                  B   561    				xor a
00492F ED4A                B   562    				adc hl,bc
004931 20 04               B   563    				jr nz,fs_fpok
004933 AF                  B   564    fs_fpbad		xor a
004934 3ECC                B   565    				ld a,0cch						004936 C9                  B   566    				ret
                           B   567    			
                           B   568    	
004937 3A 8A 53 00         B   569    fs_fpok			ld a,(fs_filepointer_valid)		00493B B7                  B   570    				or a							00493C 28 1B               B   571    				jr z,seek_strt
                           B   572    			
00493E ED5B 70 53 00       B   573    				ld de,(fs_ez80_working_address)
004943 ED4B 8B 53 00       B   574    				ld bc,(fs_sector_pos_cnt)		004948 C5                  B   575    				push bc
004949 ED4B 73 53 00       B   576    				ld bc,(fs_in_sector_offset)
00494E 21 1D 67 00         B   577    				ld hl,sector_buffer+0200h		004952 AF                  B   578    				xor a
004953 ED42                B   579    				sbc hl,bc		
004955 C3 E5 49 00         B   580    				jr fs_dadok
                           B   581    				
                           B   582    			
004959 3E01                B   583    seek_strt		ld a,1
00495B 32 8A 53 00         B   584    				ld (fs_filepointer_valid),a
00495F 2A 67 53 00         B   585    				ld hl,(fs_file_start_cluster)	004963 22 6A 53 00         B   586    				ld (fs_file_working_cluster),hl
                           B   587    			
004967 3A 5B 53 00         B   588    				ld a,(fs_file_pointer+3)		00496B 2A 58 53 00         B   589    				ld hl,(fs_file_pointer)			00496F ED4B 1E 53 00       B   590    fs_fpblp		ld bc,(fs_bytes_per_cluster)
004974 AF                  B   591    				xor a
004975 ED42                B   592    				sbc hl,bc						004977 DE00                B   593    				sbc a,0
004979 38 14               B   594    				jr c,fs_fpgbo
00497B E5                  B   595    fs_fpgnb		push hl				
00497C 2A 6A 53 00         B   596    				ld hl,(fs_file_working_cluster)
004980 CD 52 51 00         B   597    				call get_fat_entry_for_cluster
004984 30 02               B   598    				jr nc,fs_ghok					004986 E1                  B   599    				pop hl
004987 C9                  B   600    				ret
004988 22 6A 53 00         B   601    fs_ghok			ld (fs_file_working_cluster),hl
00498C E1                  B   602    				pop hl
00498D 18 E0               B   603    				jr fs_fpblp
                           B   604    			
00498F 09                  B   605    fs_fpgbo		add hl,bc						004990 4C                  B   606    				ld c,h
004991 CB39                B   607    				srl c							004993 3A 1D 53 00         B   608    				ld a,(fs_cluster_size)
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 193


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
004997 91                  B   609    				sub c
004998 47                  B   610    				ld b,a							004999 7C                  B   611    				ld a,h
00499A E601                B   612    				and 01h
00499C 67                  B   613    				ld h,a
00499D 22 73 53 00         B   614    				ld (fs_in_sector_offset),hl		                           B   615    				
0049A1 79                  B   616    fs_flns			ld a,c				
0049A2 2A 6A 53 00         B   617    				ld hl,(fs_file_working_cluster)
0049A6 CD 29 52 00         B   618    				call cluster_and_offset_to_lba
0049AA CD AA 52 00         B   619    				call fs_read_sector				0049AE D8                  B   620    				ret c							                           B   621    			
0049AF C5                  B   622    				push bc							0049B0 11000000            B   623    				ld de,0
0049B4 2A 73 53 00         B   624    				ld hl,(fs_in_sector_offset)		0049B8 5D                  B   625    				ld e,l
0049B9 54                  B   626    				ld d,h
0049BA 21000200            B   627    				ld hl,512
0049BE AF                  B   628    				xor a
0049BF ED52                B   629    				sbc hl,de						0049C1 44                  B   630    				ld b,h
0049C2 4D                  B   631    				ld c,l							0049C3 21 1D 65 00         B   632    				ld hl,sector_buffer				0049C7 19                  B   633    				add hl,de						0049C8 ED5B 70 53 00       B   634    				ld de,(fs_ez80_working_address)
0049CD EDA0                B   635    fs_cblp			ldi 							                           B   636    
0049CF 7A                  B   637    				ld a,d							0049D0 B3                  B   638    				or e
0049D1 20 0C               B   639    				jr nz,fs_edaok
0049D3 ED53 70 53 00       B   640    				ld (fs_ez80_working_address),de
0049D8 3A 72 53 00         B   641    				ld a,(fs_ez80_working_address+2
0049DC B7                  B   642    				or a
0049DD 28 43               B   643    				jr z,fs_mem_error
                           B   644    
0049DF CD B2 51 00         B   645    fs_edaok		call transfer_length_countdown	0049E3 28 30               B   646    				jr z,fs_bdld
0049E5 78                  B   647    fs_dadok		ld a,b							0049E6 B1                  B   648    				or c
0049E7 20 E4               B   649    				jr nz,fs_cblp
                           B   650    			
0049E9 ED43 73 53 00       B   651    				ld (fs_in_sector_offset),bc		0049EE ED53 70 53 00       B   652    				ld (fs_ez80_working_address),de
0049F3 C1                  B   653    				pop bc							0049F4 0C                  B   654    				inc c							0049F5 10 AA               B   655    				djnz fs_flns					                           B   656    			
0049F7 2A 6A 53 00         B   657    				ld hl,(fs_file_working_cluster)
0049FB CD 52 51 00         B   658    				call get_fat_entry_for_cluster	0049FF D8                  B   659    				ret c							004A00 22 6A 53 00         B   660    				ld (fs_file_working_cluster),hl
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 194


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
004A04 CD FB 4E 00         B   661    				call fs_compare_hl_fff8			004A08 D2 33 49 00         B   662    				jp nc,fs_fpbad			
004A0C 0E00                B   663    fs_nfbok		ld c,0							004A0E 3A 1D 53 00         B   664    				ld a,(fs_cluster_size)	
004A12 47                  B   665    				ld b,a							004A13 18 8C               B   666    				jr fs_flns		
                           B   667    			
004A15 ED43 73 53 00       B   668    fs_bdld			ld (fs_in_sector_offset),bc		004A1A C1                  B   669    				pop bc							004A1B ED43 8B 53 00       B   670    				ld (fs_sector_pos_cnt),bc
004A20 AF                  B   671    				xor a							004A21 C9                  B   672    				ret
                           B   673    				
004A22 3EC8                B   674    fs_mem_error	ld a,0c8h						004A24 C1                  B   675    fs_flerr		pop bc
004A25 B7                  B   676    				or a							004A26 C9                  B   677    				ret			
                           B   678    			
                           B   679    ;----------------------------------------------
                           B   680    
004A27                     B   681    fs_make_dir_command		
                           B   682    				
004A27 CD 42 50 00         B   683    				call fs_find_filename			004A2B D8                  B   684    				ret c
004A2C FEC2                B   685    				cp 0c2h							004A2E 28 04               B   686    				jr z,mdirfnde
004A30 AF                  B   687    				xor a							004A31 3EC9                B   688    				ld a,0c9h						004A33 C9                  B   689    				ret
                           B   690    			
004A34 CD 08 4F 00         B   691    mdirfnde		call fs_find_free_cluster		004A38 D8                  B   692    				ret c							004A39 C0                  B   693    				ret nz							                           B   694    							
004A3A 2A 7A 53 00         B   695    				ld hl,(fs_free_cluster)
004A3E 22 7D 53 00         B   696    				ld (fs_new_file_cluster),hl
                           B   697    			
004A42 CD 59 4F 00         B   698    				call fs_find_free_dir_entry		004A46 D8                  B   699    				ret c							004A47 C0                  B   700    				ret nz							                           B   701    			
004A48 DDE5                B   702    				push ix							004A4A D1                  B   703    				pop de
004A4B 21 34 53 00         B   704    				ld hl,fs_sought_filename
004A4F 010B0000            B   705    				ld bc,11
004A53 EDB0                B   706    				ldir
004A55 AF                  B   707    				xor a							004A56 0615                B   708    				ld b,21
004A58 12                  B   709    clrdiren		ld (de),a
004A59 13                  B   710    				inc de
004A5A 10 FC               B   711    				djnz clrdiren
004A5C DD360B10            B   712    				ld (ix+0bh),010h				Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 195


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
004A60 DD361821            B   713    				ld (ix+018h),021h				004A64 ED5B 7D 53 00       B   714    				ld de,(fs_new_file_cluster)
004A69 DD731A              B   715    				ld (ix+01ah),e					004A6C DD721B              B   716    				ld (ix+01bh),d
004A6F CD C2 52 00         B   717    				call fs_write_sector			004A73 D8                  B   718    				ret c							                           B   719    				
004A74 CD 30 50 00         B   720    				call fs_clear_sector_buffer
004A78 DD21 1D 65 00       B   721    				ld ix,sector_buffer				004A7D DD36002E            B   722    				ld (ix+00h),02eh				004A81 DD360120            B   723    				ld (ix+01h),020h
004A85 DD36202E            B   724    				ld (ix+020h),02eh
004A89 DD36212E            B   725    				ld (ix+021h),02eh
004A8D DD360B10            B   726    				ld (ix+0bh),010h
004A91 DD362B10            B   727    				ld (ix+02bh),010h
004A95 ED5B 7D 53 00       B   728    				ld de,(fs_new_file_cluster)		004A9A DD731A              B   729    				ld (ix+01ah),e
004A9D DD721B              B   730    				ld (ix+01bh),d
004AA0 CD 3A 1A 00         B   731    				call fs_get_dir_cluster			004AA4 DD733A              B   732    				ld (ix+03ah),e
004AA7 DD723B              B   733    				ld (ix+03bh),d
004AAA DD361821            B   734    				ld (ix+018h),021h				004AAE DD363821            B   735    				ld (ix+038h),021h				004AB2 0609                B   736    				ld b,9
004AB4 DD360220            B   737    mndelp			ld (ix+002h),32
004AB8 DD362220            B   738    				ld (ix+022h),32
004ABC DD23                B   739    				inc ix
004ABE 10 F4               B   740    				djnz mndelp
004AC0 2A 7D 53 00         B   741    				ld hl,(fs_new_file_cluster)		004AC4 AF                  B   742    				xor a
004AC5 CD 29 52 00         B   743    				call cluster_and_offset_to_lba
004AC9 CD C2 52 00         B   744    				call fs_write_sector
004ACD D8                  B   745    				ret c							                           B   746    			
004ACE CD 30 50 00         B   747    				call fs_clear_sector_buffer		004AD2 AF                  B   748    				xor a
004AD3 3C                  B   749    wroslp			inc a
004AD4 32 76 53 00         B   750    				ld (fs_working_sector),a
004AD8 21 1D 53 00         B   751    				ld hl,fs_cluster_size
004ADC BE                  B   752    				cp (hl)
004ADD 28 13               B   753    				jr z,allsclr
004ADF 2A 7D 53 00         B   754    				ld hl,(fs_new_file_cluster)
004AE3 CD 29 52 00         B   755    				call cluster_and_offset_to_lba
004AE7 CD C2 52 00         B   756    				call fs_write_sector
004AEB D8                  B   757    				ret c
004AEC 3A 76 53 00         B   758    				ld a,(fs_working_sector)
004AF0 18 E1               B   759    				jr wroslp
                           B   760    			
004AF2 2A 7D 53 00         B   761    allsclr			ld hl,(fs_new_file_cluster)		004AF6 11FFFF00            B   762    				ld de,0ffffh
004AFA CD 7E 51 00         B   763    				call update_fat_entry_for_clust
004AFE AF                  B   764    				xor a
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 196


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
004AFF C9                  B   765    				ret
                           B   766    
                           B   767    
                           B   768    
                           B   769    ;----------------------------------------------
                           B   770    
004B00                     B   771    fs_delete_dir_command
                           B   772    
004B00 CD 42 50 00         B   773    				call fs_find_filename			004B04 D8                  B   774    				ret c
004B05 28 04               B   775    				jr z,ddc_gotd
004B07 3ED1                B   776    				ld a,0d1h						004B09 B7                  B   777    				or a
004B0A C9                  B   778    				ret
                           B   779    				
004B0B DDCB0B66            B   780    ddc_gotd		bit 4,(ix+0bh)					004B0F 20 04               B   781    				jr nz,okdeldir
004B11 AF                  B   782    				xor a
004B12 3EC4                B   783    				ld a,0c4h						004B14 C9                  B   784    				ret
                           B   785    				
004B15 DD22 80 53 00       B   786    okdeldir		ld (fs_fname_in_sector_addr),ix
004B1A CD 88 52 00         B   787    				call backup_sector_lba
004B1E DD6E1A              B   788    				ld l,(ix+01ah)					004B21 DD661B              B   789    				ld h,(ix+01bh)
                           B   790    				
004B24 3A 1D 53 00         B   791    fs_ddecl		ld a,(fs_cluster_size)
004B28 47                  B   792    				ld b,a							004B29 0E00                B   793    				ld c,0			
004B2B 79                  B   794    fs_cne2 		ld a,c
004B2C CD 29 52 00         B   795    				call cluster_and_offset_to_lba
004B30 CD AA 52 00         B   796    				call fs_read_sector
004B34 D8                  B   797    				ret c							                           B   798    				
004B35 C5                  B   799    				push bc
004B36 0610                B   800    				ld b,16							004B38 DD21 1D 65 00       B   801    				ld ix,sector_buffer
004B3D 11200000            B   802    				ld de,020h
004B41 DD7E00              B   803    fs_cne1			ld a,(ix)
004B44 B7                  B   804    				or a
004B45 28 0D               B   805    				jr z,fs_chnde
004B47 FEE5                B   806    				cp 0e5h
004B49 28 09               B   807    				jr z,fs_chnde
004B4B FE2E                B   808    				cp '.'
004B4D 28 05               B   809    				jr z,fs_chnde
004B4F C1                  B   810    				pop bc
004B50 AF                  B   811    				xor a							004B51 3EC5                B   812    				ld a,0c5h						004B53 C9                  B   813    				ret
                           B   814    			
004B54 DD19                B   815    fs_chnde		add ix,de
004B56 10 E9               B   816    				djnz fs_cne1
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 197


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
004B58 C1                  B   817    				pop bc
004B59 0C                  B   818    				inc c
004B5A 10 CF               B   819    				djnz fs_cne2
                           B   820    			
004B5C CD 52 51 00         B   821    				call get_fat_entry_for_cluster	004B60 D8                  B   822    				ret c
004B61 CD FB 4E 00         B   823    				call fs_compare_hl_fff8
004B65 38 BD               B   824    				jr c,fs_ddecl
                           B   825    			
004B67 CD 9D 52 00         B   826    dir_empty		call restore_sector_lba			004B6B CD AA 52 00         B   827    				call fs_read_sector
004B6F D8                  B   828    				ret c							004B70 2A 80 53 00         B   829    				ld hl,(fs_fname_in_sector_addr)
004B74 36E5                B   830    fs_delco		ld (hl),0e5h					004B76 CD C2 52 00         B   831    				call fs_write_sector
004B7A D8                  B   832    				ret c
                           B   833    			
004B7B E5                  B   834    				push hl
004B7C DDE1                B   835    				pop ix
004B7E DD6E1A              B   836    				ld l,(ix+01ah)
004B81 DD661B              B   837    				ld h,(ix+01bh)
004B84 22 77 53 00         B   838    				ld (fs_working_cluster),hl
004B88 7C                  B   839    				ld a,h							004B89 B5                  B   840    				or l							004B8A C8                  B   841    				ret z							                           B   842    				
004B8B 2A 77 53 00         B   843    clrfatlp		ld hl,(fs_working_cluster)
004B8F CD 52 51 00         B   844    				call get_fat_entry_for_cluster
004B93 D8                  B   845    				ret c
004B94 EB                  B   846    				ex de,hl
                           B   847    				
004B95 2A 77 53 00         B   848    				ld hl,(fs_working_cluster)
004B99 ED53 77 53 00       B   849    				ld (fs_working_cluster),de
004B9E 11000000            B   850    				ld de,0
004BA2 CD 7E 51 00         B   851    				call update_fat_entry_for_clust
004BA6 D8                  B   852    				ret c
                           B   853    				
004BA7 CD FB 4E 00         B   854    				call fs_compare_hl_fff8			004BAB 38 DE               B   855    				jr c,clrfatlp
004BAD AF                  B   856    				xor a
004BAE C9                  B   857    				ret
                           B   858    
                           B   859    
                           B   860    ;----------------------------------------------
                           B   861    
004BAF                     B   862    fs_create_file_command
                           B   863    
                           B   864    ; Note: As per FAT standard, creating a file (0
                           B   865    ; only a directory entry (FAT is only updated w
                           B   866    
004BAF CD 42 50 00         B   867    				call fs_find_filename			004BB3 D8                  B   868    				ret c
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 198


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
004BB4 FEC2                B   869    				cp 0c2h							004BB6 28 04               B   870    				jr z,mfilefnde
004BB8 AF                  B   871    				xor a							004BB9 3EC9                B   872    				ld a,0c9h						004BBB C9                  B   873    				ret
                           B   874    			
004BBC CD 59 4F 00         B   875    mfilefnde		call fs_find_free_dir_entry		004BC0 D8                  B   876    				ret c							004BC1 C0                  B   877    				ret nz							                           B   878    			
004BC2 DDE5                B   879    				push ix							004BC4 D1                  B   880    				pop de
004BC5 21 34 53 00         B   881    				ld hl,fs_sought_filename
004BC9 010B0000            B   882    				ld bc,11
004BCD EDB0                B   883    				ldir
004BCF AF                  B   884    				xor a							004BD0 0615                B   885    				ld b,21
004BD2 12                  B   886    clrfnen			ld (de),a
004BD3 13                  B   887    				inc de
004BD4 10 FC               B   888    				djnz clrfnen
004BD6 DD361821            B   889    				ld (ix+018h),021h				004BDA CD C2 52 00         B   890    				call fs_write_sector			004BDE D8                  B   891    				ret c							004BDF AF                  B   892    				xor a
004BE0 C9                  B   893    				ret								                           B   894    
                           B   895    
                           B   896    ;----------------------------------------------
                           B   897    
004BE1                     B   898    fs_write_bytes_to_file_command
                           B   899    	
                           B   900    ; *********************************************
                           B   901    ; * set up: fs_file_transfer_length (new data),
                           B   902    ; * before calling                             
                           B   903    ; *********************************************
                           B   904    
                           B   905    				
004BE1 ED5B 64 53 00       B   906    				ld de,(fs_file_transfer_length)
004BE6 21000000            B   907    				ld hl,0
004BEA AF                  B   908    				xor a
004BEB ED5A                B   909    				adc hl,de
004BED CA 06 49 00         B   910    				jp z,fs_fliz					                           B   911    				 
004BF1 CD 42 50 00         B   912    				call fs_find_filename			004BF5 D8                  B   913    				ret c							004BF6 FEC2                B   914    				cp 0c2h				
004BF8 C8                  B   915    				ret z							004BF9 DDCB0B66            B   916    				bit 4,(ix+0bh)					004BFD 28 04               B   917    				jr z,fs_oknad					004BFF AF                  B   918    				xor a							004C00 3EC6                B   919    				ld a,0c6h						004C02 C9                  B   920    				ret
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 199


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
                           B   921    
004C03 CD 88 52 00         B   922    fs_oknad		call backup_sector_lba
004C07 DD22 80 53 00       B   923    				ld (fs_fname_in_sector_addr),ix
                           B   924    
004C0C DD311C              B   925    				ld iy,(ix+01ch)					004C0F DD7E1F              B   926    				ld a,(ix+01fh)
004C12 FD22 60 53 00       B   927    				ld (fs_existing_file_length),iy
004C17 32 60 53 00         B   928    				ld (fs_existing_file_length),a
004C1B ED5B 64 53 00       B   929    				ld de,(fs_file_transfer_length)
004C20 FD19                B   930    				add iy,de						004C22 CE00                B   931    				adc a,0
004C24 DD3E1C              B   932    				ld (ix+01ch),iy					004C27 DD771F              B   933    				ld (ix+01fh),a					004C2A 30 04               B   934    				jr nc,nfsizeok
004C2C AF                  B   935    				xor a
004C2D 3EC7                B   936    				ld a,0c7h						004C2F C9                  B   937    				ret
                           B   938    
004C30 11000000            B   939    nfsizeok		ld de,0
004C34 DD5E1A              B   940    				ld e,(ix+01ah)					004C37 DD561B              B   941    				ld d,(ix+01bh)					004C3A ED53 6A 53 00       B   942    				ld (fs_file_working_cluster),de
004C3F CD C2 52 00         B   943    				call fs_write_sector			004C43 D8                  B   944    				ret c
004C44 7A                  B   945    				ld a,d
004C45 B3                  B   946    				or e
004C46 20 35               B   947    				jr nz,apenclch	
                           B   948    				
004C48 CD 08 4F 00         B   949    				call fs_find_free_cluster		004C4C D8                  B   950    				ret c
004C4D C0                  B   951    				ret nz
004C4E 2A 7A 53 00         B   952    				ld hl,(fs_free_cluster)
004C52 22 6A 53 00         B   953    				ld (fs_file_working_cluster),hl
004C56 11FFFF00            B   954    				ld de,0ffffh
004C5A CD 7E 51 00         B   955    				call update_fat_entry_for_clust
004C5E D8                  B   956    				ret c
                           B   957    			
004C5F CD 9D 52 00         B   958    				call restore_sector_lba			004C63 CD AA 52 00         B   959    				call fs_read_sector
004C67 D8                  B   960    				ret c
004C68 DD2A 80 53 00       B   961    				ld ix,(fs_fname_in_sector_addr)
004C6D ED5B 6A 53 00       B   962    				ld de,(fs_file_working_cluster)
004C72 DD731A              B   963    				ld (ix+01ah),e
004C75 DD721B              B   964    				ld (ix+01bh),d
004C78 CD C2 52 00         B   965    				call fs_write_sector			004C7C D8                  B   966    				ret c
                           B   967    				
                           B   968    					
004C7D 2A 6A 53 00         B   969    apenclch		ld hl,(fs_file_working_cluster)
004C81 CD 52 51 00         B   970    				call get_fat_entry_for_cluster
004C85 D8                  B   971    				ret c
004C86 CD FB 4E 00         B   972    				call fs_compare_hl_fff8
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 200


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
004C8A 30 1C               B   973    				jr nc,atlclif
004C8C 22 6A 53 00         B   974    				ld (fs_file_working_cluster),hl
004C90 01000000            B   975    				ld bc,0
004C94 3A 1D 53 00         B   976    				ld a,(fs_cluster_size)
004C98 CB27                B   977    				sla a
004C9A 47                  B   978    				ld b,a
004C9B 2A 60 53 00         B   979    				ld hl,(fs_existing_file_length)
004C9F AF                  B   980    				xor a							004CA0 ED42                B   981    				sbc hl,bc						004CA2 22 60 53 00         B   982    				ld (fs_existing_file_length),hl
004CA6 18 D5               B   983    				jr apenclch
                           B   984    				
004CA8 ED4B 60 53 00       B   985    atlclif			ld bc,(fs_existing_file_length)
004CAD CB38                B   986    				srl b				
004CAF 48                  B   987    				ld c,b							004CB0 3A 1D 53 00         B   988    				ld a,(fs_cluster_size)
004CB4 91                  B   989    				sub c
004CB5 47                  B   990    				ld b,a							004CB6 28 79               B   991    				jr z,fs_sfncl					                           B   992    				
004CB8 2A 6A 53 00         B   993    				ld hl,(fs_file_working_cluster)
004CBC 79                  B   994    				ld a,c
004CBD CD 29 52 00         B   995    				call cluster_and_offset_to_lba
004CC1 CD AA 52 00         B   996    				call fs_read_sector
004CC5 D8                  B   997    				ret c
004CC6 C5                  B   998    				push bc							                           B   999    				
004CC7 11000000            B  1000    				ld de,0
004CCB 3A 60 53 00         B  1001    				ld a,(fs_existing_file_length)
004CCF 5F                  B  1002    				ld e,a
004CD0 3A 61 53 00         B  1003    				ld a,(fs_existing_file_length+1
004CD4 E601                B  1004    				and 1
004CD6 57                  B  1005    				ld d,a							004CD7 21000200            B  1006    				ld hl,512	
004CDB AF                  B  1007    				xor a
004CDC ED52                B  1008    				sbc hl,de						004CDE E5                  B  1009    				push hl
004CDF C1                  B  1010    				pop bc							004CE0 21 1D 65 00         B  1011    				ld hl,sector_buffer
004CE4 19                  B  1012    				add hl,de
004CE5 EB                  B  1013    				ex de,hl						004CE6 7C                  B  1014    				ld a,h			
004CE7 B5                  B  1015    				or l
004CE8 20 04               B  1016    				jr nz,fs_dcsb					004CEA CD 30 50 00         B  1017    fs_dbfil		call fs_clear_sector_buffer
004CEE 2A 6D 53 00         B  1018    fs_dcsb			ld hl,(fs_ez80_address)			004CF2 EDA0                B  1019    fs_cbsb			ldi								004CF4 7C                  B  1020    				ld a,h							004CF5 B5                  B  1021    				or l
004CF6 20 0D               B  1022    				jr nz,fs_srcadok
004CF8 22 6D 53 00         B  1023    				ld (fs_ez80_address),hl
004CFC 3A 6F 53 00         B  1024    				ld a,(fs_ez80_address+2)
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 201


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
004D00 B7                  B  1025    				or a
004D01 CA 22 4A 00         B  1026    				jp z,fs_mem_error
004D05 CD B2 51 00         B  1027    fs_srcadok		call transfer_length_countdown
004D09 28 54               B  1028    				jr z,fs_lbof					004D0B 78                  B  1029    fs_sadok		ld a,b							004D0C B1                  B  1030    				or c
004D0D 20 E3               B  1031    				jr nz,fs_cbsb					                           B  1032    
004D0F 22 6D 53 00         B  1033    				ld (fs_ez80_address),hl			004D13 C1                  B  1034    				pop bc							004D14 79                  B  1035    				ld a,c
004D15 2A 6A 53 00         B  1036    				ld hl,(fs_file_working_cluster)
004D19 CD 29 52 00         B  1037    				call cluster_and_offset_to_lba
004D1D CD C2 52 00         B  1038    				call fs_write_sector			004D21 D8                  B  1039    				ret c							004D22 0C                  B  1040    				inc c							004D23 05                  B  1041    				dec b
004D24 28 0B               B  1042    				jr z,fs_sfncl					004D26 C5                  B  1043    fs_sfns			push bc				
004D27 01000200            B  1044    				ld bc,512						004D2B 11 1D 65 00         B  1045    				ld de,sector_buffer				004D2F 18 B9               B  1046    				jr fs_dbfil						                           B  1047    				
004D31 CD 08 4F 00         B  1048    fs_sfncl		call fs_find_free_cluster		004D35 D8                  B  1049    				ret c							004D36 C0                  B  1050    				ret nz							004D37 2A 6A 53 00         B  1051    				ld hl,(fs_file_working_cluster)
004D3B ED5B 7A 53 00       B  1052    				ld de,(fs_free_cluster)
004D40 CD 7E 51 00         B  1053    				call update_fat_entry_for_clust
004D44 D8                  B  1054    				ret c
004D45 2A 7A 53 00         B  1055    				ld hl,(fs_free_cluster)
004D49 22 6A 53 00         B  1056    				ld (fs_file_working_cluster),hl
004D4D 11FFFF00            B  1057    				ld de,0ffffh
004D51 CD 7E 51 00         B  1058    				call update_fat_entry_for_clust
004D55 D8                  B  1059    				ret c
004D56 3A 1D 53 00         B  1060    				ld a,(fs_cluster_size)
004D5A 47                  B  1061    				ld b,a							004D5B 0E00                B  1062    				ld c,0							004D5D 18 C7               B  1063    				jr fs_sfns						                           B  1064    				
004D5F C1                  B  1065    fs_lbof			pop bc
004D60 79                  B  1066    				ld a,c							004D61 2A 6A 53 00         B  1067    				ld hl,(fs_file_working_cluster)
004D65 CD 29 52 00         B  1068    				call cluster_and_offset_to_lba
004D69 CD C2 52 00         B  1069    				call fs_write_sector	
004D6D D8                  B  1070    				ret c
004D6E AF                  B  1071    				xor a							004D6F C9                  B  1072    				ret
                           B  1073    
                           B  1074    ;----------------------------------------------
                           B  1075    
004D70                     B  1076    fs_erase_file_command
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 202


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
                           B  1077    
                           B  1078    
004D70 CD 42 50 00         B  1079    				call fs_find_filename			004D74 D8                  B  1080    				ret c
004D75 C0                  B  1081    				ret nz
                           B  1082    				
004D76 DDCB0B66            B  1083    				bit 4,(ix+0bh)					004D7A 28 04               B  1084    				jr z,okdelf
004D7C AF                  B  1085    				xor a
004D7D 3EC6                B  1086    				ld a,0c6h						004D7F C9                  B  1087    				ret
                           B  1088    				
004D80 DDE5                B  1089    okdelf			push ix
004D82 E1                  B  1090    				pop hl
004D83 C3 74 4B 00         B  1091    				jp fs_delco						                           B  1092    					
                           B  1093    
                           B  1094    ;----------------------------------------------
                           B  1095    
                           B  1096    
004D87                     B  1097    fs_rename_command
                           B  1098    
004D87 CD 42 50 00         B  1099    				call fs_find_filename			004D8B D8                  B  1100    				ret c							004D8C FEC2                B  1101    				cp 0c2h							004D8E 28 04               B  1102    				jr z,fs_nfnok					004D90 AF                  B  1103    				xor a							004D91 3EC9                B  1104    				ld a,0c9h						004D93 C9                  B  1105    				ret
                           B  1106    			
004D94 21 34 53 00         B  1107    fs_nfnok		ld hl,fs_sought_filename		004D98 11 4C 53 00         B  1108    				ld de,fs_filename_buffer
004D9C 010B0000            B  1109    				ld bc,11
004DA0 EDB0                B  1110    				ldir
004DA2 21 40 53 00         B  1111    				ld hl,fs_alt_filename			004DA6 11 34 53 00         B  1112    				ld de,fs_sought_filename
004DAA 010B0000            B  1113    				ld bc,11
004DAE EDB0                B  1114    				ldir
004DB0 CD 42 50 00         B  1115    				call fs_find_filename			004DB4 D8                  B  1116    				ret c
004DB5 FEC2                B  1117    				cp 0c2h
004DB7 C8                  B  1118    				ret z							                           B  1119    				
004DB8 DDE5                B  1120    				push ix
004DBA D1                  B  1121    				pop de
004DBB 21 4C 53 00         B  1122    				ld hl,fs_filename_buffer	 	004DBF 010B0000            B  1123    				ld bc,11
004DC3 EDB0                B  1124    				ldir							004DC5 CD C2 52 00         B  1125    				call fs_write_sector			                           B  1126    				
004DC9 AF                  B  1127    fs_rndone		xor a
004DCA C9                  B  1128    				ret
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 203


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
                           B  1129    				
                           B  1130    
                           B  1131    ;----------------------------------------------
                           B  1132    
                           B  1133    
004DCB                     B  1134    fs_goto_first_dir_entry
                           B  1135    
004DCB CD 3A 1A 00         B  1136    				call fs_get_dir_cluster
004DCF ED53 83 53 00       B  1137    				ld (fs_dir_entry_cluster),de
004DD4 AF                  B  1138    				xor a
004DD5 32 89 53 00         B  1139    				ld (fs_dir_entry_sector),a		004DD9 11000000            B  1140    				ld de,0
004DDD ED53 86 53 00       B  1141    				ld (fs_dir_entry_line_offset),d
                           B  1142    				
                           B  1143    
                           B  1144    
004DE2                     B  1145    fs_get_dir_entry
                           B  1146    
                           B  1147    ; No input parameters.
                           B  1148    ;
                           B  1149    ; Returns HL    = Location of null terminated f
                           B  1150    ;         IX:IY = Length of file (if applicable
                           B  1151    ;         B     = File flag (1 = directory, 0 =
                           B  1152    ;         A     = Error code
                           B  1153    ;         Carry = Set if hardware error encount
                           B  1154    
                           B  1155    
004DE2 3A 89 53 00         B  1156    				ld a,(fs_dir_entry_sector)		004DE6 4F                  B  1157    				ld c,a
004DE7 2A 83 53 00         B  1158    				ld hl,(fs_dir_entry_cluster)	004DEB CD 29 52 00         B  1159    				call cluster_and_offset_to_lba
                           B  1160    			
004DEF 7C                  B  1161    				ld a,h							004DF0 B5                  B  1162    				or l							004DF1 20 09               B  1163    				jr nz,nr_read					004DF3 2A 27 53 00         B  1164    				ld hl,(fs_root_dir_position)	004DF7 79                  B  1165    				ld a,c
004DF8 CD 6F 52 00         B  1166    				call set_absolute_lba
                           B  1167    				
004DFC CD AA 52 00         B  1168    nr_read			call fs_read_sector				004E00 D8                  B  1169    				ret c							                           B  1170    				
004E01 ED5B 86 53 00       B  1171    				ld de,(fs_dir_entry_line_offset
004E06 DD21 1D 65 00       B  1172    dscan_int_loop	ld ix,sector_buffer
004E0B DD19                B  1173    				add ix,de
004E0D DD7E00              B  1174    ds_int_loop		ld a,(ix)
004E10 B7                  B  1175    				or a							004E11 28 0E               B  1176    				jr z,fs_dir_entry_free		
004E13 FEE5                B  1177    				cp 0e5h							004E15 28 0A               B  1178    				jr z,fs_dir_entry_free	
004E17 FE05                B  1179    				cp 05h							004E19 28 06               B  1180    				jr z,fs_dir_entry_free	
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 204


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
004E1B DDCB0B5E            B  1181    				bit 3,(ix+0bh)					004E1F 28 0D               B  1182    				jr z,fs_dir_entry_in_use		                           B  1183    
004E21                     B  1184    fs_dir_entry_free
                           B  1185    
004E21 EB                  B  1186    				ex de,hl
004E22 11200000            B  1187    				ld de,32
004E26 19                  B  1188    				add hl,de
004E27 EB                  B  1189    				ex de,hl
004E28 CB4A                B  1190    				bit 1,d
004E2A 28 DA               B  1191    				jr z,dscan_int_loop
004E2C 18 54               B  1192    				jr dscan_new_sect
                           B  1193    
004E2E                     B  1194    fs_dir_entry_in_use
                           B  1195    				
004E2E ED53 86 53 00       B  1196    				ld (fs_dir_entry_line_offset),d
004E33 DDE5                B  1197    				push ix
004E35 E1                  B  1198    				pop hl
004E36 CD 32 10 00         B  1199    				call os_clear_output_line
004E3A 0608                B  1200    				ld b,8							004E3C 11 20 60 00         B  1201    				ld de,output_line
004E40 7E                  B  1202    dcopyn			ld a,(hl)
004E41 FE20                B  1203    				cp ' '							004E43 28 02               B  1204    				jr z,digchar
004E45 12                  B  1205    				ld (de),a
004E46 13                  B  1206    				inc de
004E47 23                  B  1207    digchar			inc hl
004E48 10 F6               B  1208    				djnz dcopyn
004E4A 7E                  B  1209    				ld a,(hl)						004E4B FE20                B  1210    				cp ' '							004E4D 28 0A               B  1211    				jr z,dirnoex
004E4F 3E2E                B  1212    				ld a,'.'						004E51 12                  B  1213    				ld (de),a
004E52 13                  B  1214    				inc de	
004E53 01030000            B  1215    				ld bc,3							004E57 EDB0                B  1216    				ldir
004E59 AF                  B  1217    dirnoex			xor a 
004E5A 12                  B  1218    				ld (de),a						                           B  1219    				
004E5B 47                  B  1220    				ld b,a
004E5C DDCB0B66            B  1221    				bit 4,(ix+0bh)					004E60 28 01               B  1222    				jr z,fs_fniaf		
004E62 04                  B  1223    				inc b							004E63 DD171C              B  1224    fs_fniaf		ld de,(ix+01ch)					004E66 DD4E1F              B  1225    				ld c,(ix+01fh)
004E69 21 20 60 00         B  1226    				ld hl,output_line				004E6D AF                  B  1227    				xor a
004E6E C9                  B  1228    				ret
                           B  1229    
                           B  1230    
                           B  1231    
                           B  1232    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 205


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
004E6F                     B  1233    fs_goto_next_dir_entry
                           B  1234    
004E6F 11200000            B  1235    				ld de,32
004E73 2A 86 53 00         B  1236    				ld hl,(fs_dir_entry_line_offset
004E77 19                  B  1237    				add hl,de
004E78 22 86 53 00         B  1238    				ld (fs_dir_entry_line_offset),h
004E7C CB4C                B  1239    				bit 1,h
004E7E CA E2 4D 00         B  1240    				jp z,fs_get_dir_entry
                           B  1241    
004E82 21000000            B  1242    dscan_new_sect	ld hl,0				
004E86 22 86 53 00         B  1243    				ld (fs_dir_entry_line_offset),h
                           B  1244    			
004E8A 21 89 53 00         B  1245    				ld hl,fs_dir_entry_sector
004E8E 34                  B  1246    				inc (hl)						                           B  1247    			
004E8F ED5B 83 53 00       B  1248    				ld de,(fs_dir_entry_cluster)
004E94 7A                  B  1249    				ld a,d
004E95 B3                  B  1250    				or e							004E96 20 0B               B  1251    				jr nz,nonroot2
004E98 3A 2D 53 00         B  1252    				ld a,(fs_root_dir_sectors)
004E9C BE                  B  1253    				cp (hl)
004E9D 28 23               B  1254    				jr z,endofdir			
004E9F C3 E2 4D 00         B  1255    				jp fs_get_dir_entry
                           B  1256    												004EA3 3A 1D 53 00         B  1257    nonroot2		ld a,(fs_cluster_size)		
004EA7 BE                  B  1258    				cp (hl)							004EA8 C2 E2 4D 00         B  1259    				jp nz,fs_get_dir_entry
004EAC 3600                B  1260    				ld (hl),0						004EAE 2A 83 53 00         B  1261    				ld hl,(fs_dir_entry_cluster)
004EB2 CD 52 51 00         B  1262    				call get_fat_entry_for_cluster
004EB6 22 83 53 00         B  1263    				ld (fs_dir_entry_cluster),hl
004EBA CD FB 4E 00         B  1264    				call fs_compare_hl_fff8			004EBE DA E2 4D 00         B  1265    				jp c,fs_get_dir_entry
                           B  1266    	
004EC2 3ED2                B  1267    endofdir		ld a,0d2h
004EC4 B7                  B  1268    				or a							004EC5 C9                  B  1269    				ret	
                           B  1270    				
                           B  1271    ;----------------------------------------------
                           B  1272    
004EC6                     B  1273    fs_get_volume_label
                           B  1274    
                           B  1275    
                           B  1276    ; On return HL = volume label
                           B  1277    
                           B  1278    
004EC6 2A 27 53 00         B  1279    				ld hl,(fs_root_dir_position)
004ECA AF                  B  1280    				xor a
004ECB CD 80 52 00         B  1281    				call set_abs_lba_and_read_secto
004ECF D8                  B  1282    				ret c
004ED0 0E10                B  1283    				ld c,16							004ED2 DD21 1D 65 00       B  1284    				ld ix,sector_buffer
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 206


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
004ED7 DD7E0B              B  1285    find_vl			ld a,(ix+0bh)
004EDA FE08                B  1286    				cp 08h
004EDC 20 11               B  1287    				jr nz,not_label
004EDE DD360B00            B  1288    				ld (ix+0bh),0					004EE2 DDE5                B  1289    				push ix
004EE4 E1                  B  1290    				pop hl
004EE5 E5                  B  1291    				push hl
004EE6 060B                B  1292    				ld b,11
004EE8 CD 0D 12 00         B  1293    				call uppercasify_string
004EEC E1                  B  1294    				pop hl
004EED AF                  B  1295    				xor a
004EEE C9                  B  1296    				ret
                           B  1297    				
004EEF 11200000            B  1298    not_label		ld de,32						004EF3 DD19                B  1299    				add ix,de						004EF5 10 E0               B  1300    				djnz find_vl
004EF7 AF                  B  1301    				xor a
004EF8 3ED4                B  1302    				ld a,0d4h						004EFA C9                  B  1303    				ret		
                           B  1304    
                           B  1305    ;----------------------------------------------
                           B  1306    ; Internal subroutines
                           B  1307    ;----------------------------------------------
                           B  1308    
004EFB                     B  1309    fs_compare_hl_fff8
                           B  1310    
                           B  1311    ;INPUT HL = value to compare with fff8
                           B  1312    ;OUTPUT CARRY set if < $fff8, ZERO FLAG set if 
                           B  1313    	
                           B  1314    	
004EFB E5                  B  1315    				push hl
004EFC D5                  B  1316    				push de
004EFD 11F8FF00            B  1317    				ld de,0fff8h			
004F01 B7                  B  1318    				or a							004F02 52ED52              B  1319    				sbc.s hl,de						004F05 D1                  B  1320    				pop de
004F06 E1                  B  1321    				pop hl
004F07 C9                  B  1322    				ret
                           B  1323    
                           B  1324    ;----------------------------------------------
                           B  1325    
                           B  1326    
004F08                     B  1327    fs_find_free_cluster
                           B  1328    	
004F08 DD210000 00         B  1329    				ld ix,0							004F0D ED5B 21 53 00       B  1330    				ld de,(fs_fat1_position)		004F12 AF                  B  1331    				xor a				
004F13 32 76 53 00         B  1332    fs_ffcl2		ld (fs_working_sector),a	
004F17 D5                  B  1333    				push de
004F18 E1                  B  1334    				pop hl
004F19 3A 76 53 00         B  1335    				ld a,(fs_working_sector)
004F1D CD 80 52 00         B  1336    				call set_abs_lba_and_read_secto
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 207


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
004F21 D8                  B  1337    				ret c
004F22 21 1D 65 00         B  1338    				ld hl,sector_buffer
004F26 0600                B  1339    				ld b,0
004F28 7E                  B  1340    fs_ffcl1		ld a,(hl)						004F29 23                  B  1341    				inc hl
004F2A B6                  B  1342    				or (hl)
004F2B 23                  B  1343    				inc hl
004F2C 28 14               B  1344    				jr z,fs_gotfc
004F2E DD23                B  1345    				inc ix
004F30 10 F6               B  1346    				djnz fs_ffcl1
                           B  1347    				
004F32 2A 2E 53 00         B  1348    				ld hl,(fs_sectors_per_fat)
004F36 3A 76 53 00         B  1349    				ld a,(fs_working_sector)		004F3A 3C                  B  1350    				inc a				
004F3B BD                  B  1351    				cp l		
004F3C 20 D5               B  1352    				jr nz,fs_ffcl2					004F3E 3EC1                B  1353    fs_dfull		ld a,c1h						004F40 B7                  B  1354    				or a							004F41 C9                  B  1355    				ret
                           B  1356    			
004F42 DDE5                B  1357    fs_gotfc		push ix							004F44 E1                  B  1358    				pop hl							004F45 2B                  B  1359    				dec hl							004F46 2B                  B  1360    				dec hl							004F47 ED5B 31 53 00       B  1361    				ld de,(fs_max_data_clusters)
004F4C AF                  B  1362    				xor a
004F4D 52ED52              B  1363    				sbc.s hl,de						004F50 30 EC               B  1364    				jr nc,fs_dfull
                           B  1365    			
004F52 DD22 7A 53 00       B  1366    				ld (fs_free_cluster),ix
004F57 AF                  B  1367    				xor a
004F58 C9                  B  1368    				ret
                           B  1369    	
                           B  1370    	
                           B  1371    ;----------------------------------------------
                           B  1372    	
                           B  1373    	
004F59                     B  1374    fs_find_free_dir_entry
                           B  1375    
                           B  1376    
                           B  1377    ; OUTPUT IX start of 32 byte dir entry in secto
                           B  1378    
                           B  1379    			
004F59 CD 3A 1A 00         B  1380    				call fs_get_dir_cluster			004F5D EB                  B  1381    				ex de,hl
004F5E 22 6A 53 00         B  1382    ffenxtclu		ld (fs_file_working_cluster),hl
004F62 AF                  B  1383    				xor a
004F63 32 76 53 00         B  1384    				ld (fs_working_sector),a
                           B  1385    			
004F67 2A 27 53 00         B  1386    ffenxtsec		ld hl,(fs_root_dir_position)	004F6B 3A 76 53 00         B  1387    				ld a,(fs_working_sector)
004F6F CD 6F 52 00         B  1388    				call set_absolute_lba
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 208


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
                           B  1389    				
004F73 CD 3A 1A 00         B  1390    				call fs_get_dir_cluster			004F77 7A                  B  1391    				ld a,d
004F78 B3                  B  1392    				or e
004F79 28 0C               B  1393    				jr z,at_rootd
004F7B 2A 6A 53 00         B  1394    				ld hl,(fs_file_working_cluster)
004F7F 3A 76 53 00         B  1395    				ld a,(fs_working_sector)
004F83 CD 29 52 00         B  1396    				call cluster_and_offset_to_lba
                           B  1397    				
004F87 CD AA 52 00         B  1398    at_rootd		call fs_read_sector
004F8B D8                  B  1399    				ret c
004F8C 0610                B  1400    				ld b,16							004F8E 11200000            B  1401    				ld de,32
004F92 DD21 1D 65 00       B  1402    				ld ix,sector_buffer
004F97 DD7E00              B  1403    scdirfe			ld a,(ix)						004F9A B7                  B  1404    				or a
004F9B 28 65               B  1405    				jr z,got_fde
004F9D FEE5                B  1406    				cp 0e5h
004F9F 28 61               B  1407    				jr z,got_fde
004FA1 DD19                B  1408    				add ix,de						004FA3 10 F2               B  1409    				djnz scdirfe					                           B  1410    				
004FA5 21 76 53 00         B  1411    				ld hl,fs_working_sector			004FA9 34                  B  1412    				inc (hl)
                           B  1413    				
004FAA CD 3A 1A 00         B  1414    				call fs_get_dir_cluster			004FAE 7A                  B  1415    				ld a,d
004FAF B3                  B  1416    				or e
004FB0 20 0B               B  1417    				jr nz,ffenotroo
004FB2 3A 2D 53 00         B  1418    				ld a,(fs_root_dir_sectors)		004FB6 BE                  B  1419    				cp (hl)							004FB7 20 AE               B  1420    				jr nz,ffenxtsec
004FB9 AF                  B  1421    fenotfnd		xor a							004FBA 3EC3                B  1422    				ld a,0c3h						004FBC C9                  B  1423    				ret
                           B  1424    			
004FBD 3A 1D 53 00         B  1425    ffenotroo		ld a,(fs_cluster_size)			004FC1 BE                  B  1426    				cp (hl)
004FC2 20 A3               B  1427    				jr nz,ffenxtsec
004FC4 2A 6A 53 00         B  1428    				ld hl,(fs_file_working_cluster)
004FC8 CD 52 51 00         B  1429    				call get_fat_entry_for_cluster	004FCC D8                  B  1430    				ret c
004FCD CD FB 4E 00         B  1431    				call fs_compare_hl_fff8			004FD1 38 8B               B  1432    				jr c,ffenxtclu
                           B  1433    			
004FD3 CD 08 4F 00         B  1434    				call fs_find_free_cluster		004FD7 D8                  B  1435    				ret c							004FD8 C0                  B  1436    				ret nz							004FD9 ED5B 7A 53 00       B  1437    				ld de,(fs_free_cluster)
004FDE 2A 6A 53 00         B  1438    				ld hl,(fs_file_working_cluster)
004FE2 CD 7E 51 00         B  1439    				call update_fat_entry_for_clust
004FE6 D8                  B  1440    				ret c
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 209


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
004FE7 EB                  B  1441    				ex de,hl						004FE8 11FFFF00            B  1442    				ld de,0ffffh
004FEC CD 7E 51 00         B  1443    				call update_fat_entry_for_clust
004FF0 D8                  B  1444    				ret c
                           B  1445    			
004FF1 2A 7A 53 00         B  1446    				ld hl,(fs_free_cluster)			004FF5 CD 04 50 00         B  1447    				call fs_clear_cluster			004FF9 D8                  B  1448    				ret c
004FFA 2A 7A 53 00         B  1449    				ld hl,(fs_free_cluster)			004FFE C3 5E 4F 00         B  1450    				jp ffenxtclu					                           B  1451    			
005002 AF                  B  1452    got_fde			xor a
005003 C9                  B  1453    				ret
                           B  1454    					
                           B  1455    
                           B  1456    ;----------------------------------------------
                           B  1457    
005004                     B  1458    fs_clear_cluster
                           B  1459    
                           B  1460    ;INPUT HL = cluster to clear
                           B  1461    
005004 22 77 53 00         B  1462    				ld (fs_working_cluster),hl
                           B  1463    			
005008 CD 30 50 00         B  1464    				call fs_clear_sector_buffer
                           B  1465    					
00500C AF                  B  1466    				xor a				
00500D 32 76 53 00         B  1467    				ld (fs_working_sector),a		005011 3A 76 53 00         B  1468    wipeclulp		ld a,(fs_working_sector)		005015 2A 77 53 00         B  1469    				ld hl,(fs_working_cluster)		005019 CD 29 52 00         B  1470    				call cluster_and_offset_to_lba	00501D CD C2 52 00         B  1471    				call fs_write_sector
005021 D8                  B  1472    				ret c
005022 21 76 53 00         B  1473    				ld hl,fs_working_sector
005026 34                  B  1474    				inc (hl)
005027 3A 1D 53 00         B  1475    				ld a,(fs_cluster_size)
00502B BE                  B  1476    				cp (hl)
00502C 20 E3               B  1477    				jr nz,wipeclulp
00502E AF                  B  1478    				xor a
00502F C9                  B  1479    				ret
                           B  1480    			
                           B  1481    			
005030                     B  1482    fs_clear_sector_buffer
                           B  1483    			
005030 E5                  B  1484    				push hl
005031 C5                  B  1485    				push bc
005032 21 1D 65 00         B  1486    				ld hl,sector_buffer			
005036 01000200            B  1487    				ld bc,512				
00503A AF                  B  1488    				xor a				
00503B CD 4B 15 00         B  1489    				call os_bchl_memfill	
00503F C1                  B  1490    				pop bc
005040 E1                  B  1491    				pop hl
005041 C9                  B  1492    				ret
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 210


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
                           B  1493    				
                           B  1494    
                           B  1495    	
                           B  1496    ;----------------------------------------------
                           B  1497    	
005042                     B  1498    fs_find_filename
                           B  1499    
005042 AF                  B  1500    				xor a
                           B  1501    
005043                     B  1502    fs_search	
                           B  1503    				
005043 32 91 53 00         B  1504    				ld (fs_search_type),a
                           B  1505    			
                           B  1506    ; OUTPUT IX start of 32 byte dir entry
                           B  1507    			
005047 CD 3A 1A 00         B  1508    				call fs_get_dir_cluster
00504B ED53 6A 53 00       B  1509    ffnnxtclu		ld (fs_file_working_cluster),de
005050 AF                  B  1510    				xor a
005051 32 76 53 00         B  1511    				ld (fs_working_sector),a
                           B  1512    			
005055 2A 27 53 00         B  1513    ffnnxtsec		ld hl,(fs_root_dir_position)	005059 3A 76 53 00         B  1514    				ld a,(fs_working_sector)
00505D CD 6F 52 00         B  1515    				call set_absolute_lba
                           B  1516    				
005061 CD 3A 1A 00         B  1517    				call fs_get_dir_cluster			005065 7A                  B  1518    				ld a,d
005066 B3                  B  1519    				or e
005067 28 0C               B  1520    				jr z,at_rootd2
005069 2A 6A 53 00         B  1521    				ld hl,(fs_file_working_cluster)
00506D 3A 76 53 00         B  1522    				ld a,(fs_working_sector)
005071 CD 29 52 00         B  1523    				call cluster_and_offset_to_lba	                           B  1524    				
005075 CD AA 52 00         B  1525    at_rootd2		call fs_read_sector
005079 D8                  B  1526    				ret c
00507A 0E10                B  1527    				ld c,16							00507C DD21 1D 65 00       B  1528    				ld ix,sector_buffer
005081 DDE5                B  1529    ndirentr		push ix
005083 D1                  B  1530    				pop de
005084 3A 91 53 00         B  1531    				ld a,(fs_search_type)
005088 B7                  B  1532    				or a
005089 28 1E               B  1533    				jr z,fs_ststr
                           B  1534    			
00508B DD7E00              B  1535    				ld a,(ix)						00508E FE80                B  1536    				cp 080h							005090 30 35               B  1537    				jr nc,fnnotsame
005092 FE20                B  1538    				cp 020h
005094 38 31               B  1539    				jr c,fnnotsame
005096 ED5B 8E 53 00       B  1540    				ld de,(fs_stash_dir_block)		00509B DD7E1A              B  1541    				ld a,(ix+01ah)
00509E BB                  B  1542    				cp e
00509F 20 26               B  1543    				jr nz,fnnotsame
0050A1 DD7E1B              B  1544    				ld a,(ix+01bh)
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 211


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
0050A4 BA                  B  1545    				cp d
0050A5 28 1E               B  1546    				jr z,fs_found
0050A7 18 1E               B  1547    				jr fnnotsame
                           B  1548    				
0050A9 FD21 34 53 00       B  1549    fs_ststr		ld iy,fs_sought_filename		0050AE 060B                B  1550    				ld b,11							0050B0 1A                  B  1551    cmpfnlp			ld a,(de)						0050B1 CD 19 12 00         B  1552    				call os_uppercasify				0050B5 6F                  B  1553    				ld l,a
0050B6 FD7E00              B  1554    				ld a,(iy)
0050B9 CD 19 12 00         B  1555    				call os_uppercasify
0050BD BD                  B  1556    				cp l				
0050BE 20 07               B  1557    				jr nz,fnnotsame
0050C0 FD23                B  1558    				inc iy
0050C2 13                  B  1559    				inc de
0050C3 10 EB               B  1560    				djnz cmpfnlp
0050C5 AF                  B  1561    fs_found		xor a							0050C6 C9                  B  1562    				ret
                           B  1563    			
0050C7 11200000            B  1564    fnnotsame		ld de,32						0050CB DD19                B  1565    				add ix,de
0050CD 0D                  B  1566    				dec c
0050CE 20 B1               B  1567    				jr nz,ndirentr					                           B  1568    				
0050D0 21 76 53 00         B  1569    				ld hl,fs_working_sector			0050D4 34                  B  1570    				inc (hl)
                           B  1571    				
0050D5 CD 3A 1A 00         B  1572    				call fs_get_dir_cluster			0050D9 7A                  B  1573    				ld a,d
0050DA B3                  B  1574    				or e
0050DB 20 0D               B  1575    				jr nz,notrootdir
0050DD 3A 2D 53 00         B  1576    				ld a,(fs_root_dir_sectors)		0050E1 BE                  B  1577    				cp (hl)							0050E2 C2 55 50 00         B  1578    				jp nz,ffnnxtsec
0050E6 3EC2                B  1579    fnnotfnd		ld a,0c2h						0050E8 B7                  B  1580    				or a
0050E9 C9                  B  1581    				ret
                           B  1582    			
0050EA                     B  1583    notrootdir
                           B  1584    				
0050EA 3A 1D 53 00         B  1585    				ld a,(fs_cluster_size)			0050EE BE                  B  1586    				cp (hl)
0050EF C2 55 50 00         B  1587    				jp nz,ffnnxtsec
                           B  1588    				
0050F3 2A 6A 53 00         B  1589    				ld hl,(fs_file_working_cluster)
0050F7 CD 52 51 00         B  1590    				call get_fat_entry_for_cluster
0050FB D8                  B  1591    				ret c
0050FC CD FB 4E 00         B  1592    				call fs_compare_hl_fff8			005100 30 E4               B  1593    				jr nc,fnnotfnd					005102 EB                  B  1594    				ex de,hl						005103 C3 4B 50 00         B  1595    				jp ffnnxtclu					                           B  1596    				
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 212


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
                           B  1597    
                           B  1598    ;----------------------------------------------
                           B  1599    
005107                     B  1600    fs_hl_to_alt_filename
                           B  1601    
005107 11 40 53 00         B  1602    				ld de,fs_alt_filename
00510B 18 04               B  1603    				jr hltofngo
                           B  1604    
                           B  1605    
00510D                     B  1606    fs_hl_to_filename
                           B  1607    
                           B  1608    ;INPUT: HL = address of filename (null / space 
                           B  1609    ;OUTPUT HL = address of first character after f
                           B  1610    ;        C = number of characters in filename
                           B  1611    
00510D 11 34 53 00         B  1612    				ld de,fs_sought_filename
005111 CD 1C 52 00         B  1613    hltofngo		call fs_clear_filename			005115 D5                  B  1614    				push de			
005116 DDE1                B  1615    				pop ix							                           B  1616    				
005118 0E00                B  1617    				ld c,0
00511A 0608                B  1618    				ld b,8
00511C 7E                  B  1619    csfnlp2			ld a,(hl)						00511D B7                  B  1620    				or a
00511E C8                  B  1621    				ret z							00511F FE20                B  1622    				cp 32
005121 C8                  B  1623    				ret z							005122 FE2F                B  1624    				cp 02fh
005124 C8                  B  1625    				ret z							005125 FE2E                B  1626    				cp '.'
005127 28 16               B  1627    				jr z,dofn_ext					005129 12                  B  1628    				ld (de),a
00512A 13                  B  1629    				inc de
00512B 23                  B  1630    				inc hl
00512C 0C                  B  1631    				inc c							00512D 10 ED               B  1632    				djnz csfnlp2					00512F 7E                  B  1633    find_ext		ld a,(hl)
005130 FE2E                B  1634    				cp '.'							005132 28 0B               B  1635    				jr z,dofn_ext	
005134 FE20                B  1636    				cp ' '							005136 C8                  B  1637    				ret z
005137 FE2F                B  1638    				cp 02fh
005139 C8                  B  1639    				ret z
00513A B7                  B  1640    				or a
00513B C8                  B  1641    				ret z
00513C 23                  B  1642    				inc hl
00513D 18 F0               B  1643    				jr find_ext
                           B  1644    				
00513F 23                  B  1645    dofn_ext		inc hl							005140 0603                B  1646    				ld b,3				
005142 7E                  B  1647    fnextlp			ld a,(hl)						005143 B7                  B  1648    				or a
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 213


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
005144 C8                  B  1649    				ret z							005145 FE20                B  1650    				cp 32
005147 C8                  B  1651    				ret z
005148 DD7708              B  1652    				ld (ix+8),a
00514B DD23                B  1653    				inc ix
00514D 23                  B  1654    				inc hl
00514E 0C                  B  1655    				inc c
00514F 10 F1               B  1656    				djnz fnextlp
005151 C9                  B  1657    				ret
                           B  1658    				
                           B  1659    ;----------------------------------------------
                           B  1660    
                           B  1661    
005152                     B  1662    get_fat_entry_for_cluster
                           B  1663    
                           B  1664    ; INPUT: HL = cluster in question, OUTPUT: HL =
                           B  1665    
005152 C5                  B  1666    				push bc
005153 D5                  B  1667    				push de
005154 01000000            B  1668    				ld bc,0
005158 4D                  B  1669    				ld c,l
005159 7C                  B  1670    				ld a,h
00515A 2A 21 53 00         B  1671    				ld hl,(fs_fat1_position)
00515E CD 80 52 00         B  1672    				call set_abs_lba_and_read_secto
005162 38 17               B  1673    				jr c,hwerr
005164 DDE5                B  1674    				push ix
005166 DD21 1D 65 00       B  1675    				ld ix,sector_buffer
00516B DD09                B  1676    				add ix,bc
00516D DD09                B  1677    				add ix,bc
00516F 21000000            B  1678    				ld hl,0
005173 DD6E00              B  1679    				ld l,(ix)
005176 DD6601              B  1680    				ld h,(ix+1)
005179 DDE1                B  1681    				pop ix
00517B D1                  B  1682    hwerr			pop de
00517C C1                  B  1683    				pop bc
00517D C9                  B  1684    				ret
                           B  1685    
                           B  1686    
                           B  1687    ;----------------------------------------------
                           B  1688    
                           B  1689    
00517E                     B  1690    update_fat_entry_for_cluster
                           B  1691    
                           B  1692    ; INPUT: HL = cluster in question
                           B  1693    ;        DE = new value to put in FAT tables
                           B  1694    			
00517E C5                  B  1695    				push bc
00517F E5                  B  1696    				push hl
005180 01000000            B  1697    				ld bc,0
005184 4D                  B  1698    				ld c,l
005185 7C                  B  1699    				ld a,h
005186 2A 21 53 00         B  1700    				ld hl,(fs_fat1_position)		Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 214


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
00518A CD 9E 51 00         B  1701    				call fat_upd
00518E 38 0B               B  1702    				jr c,fup_end
                           B  1703    			
005190 E1                  B  1704    				pop hl
005191 E5                  B  1705    				push hl
005192 7C                  B  1706    				ld a,h
005193 2A 24 53 00         B  1707    				ld hl,(fs_fat2_position)		005197 CD 9E 51 00         B  1708    				call fat_upd
00519B E1                  B  1709    fup_end			pop hl
00519C C1                  B  1710    				pop bc
00519D C9                  B  1711    				ret
                           B  1712    			
                           B  1713    			
00519E CD 80 52 00         B  1714    fat_upd			call set_abs_lba_and_read_secto
0051A2 38 0D               B  1715    				jr c,ufehwerr
0051A4 21 1D 65 00         B  1716    				ld hl,sector_buffer
0051A8 09                  B  1717    				add hl,bc
0051A9 09                  B  1718    				add hl,bc
0051AA 73                  B  1719    				ld (hl),e
0051AB 23                  B  1720    				inc hl
0051AC 72                  B  1721    				ld (hl),d
0051AD CD C2 52 00         B  1722    				call fs_write_sector
0051B1 C9                  B  1723    ufehwerr		ret
                           B  1724    				
                           B  1725    	
                           B  1726    ;----------------------------------------------
                           B  1727    
0051B2                     B  1728    transfer_length_countdown
                           B  1729    
0051B2 E5                  B  1730    				push hl							0051B3 C5                  B  1731    				push bc
                           B  1732    			
0051B4 0604                B  1733    				ld b,4
0051B6 21 58 53 00         B  1734    				ld hl,fs_file_pointer			0051BA 34                  B  1735    fpinclp			inc (hl)
0051BB 20 03               B  1736    				jr nz,fs_fpino
0051BD 23                  B  1737    				inc hl
0051BE 10 FA               B  1738    				djnz fpinclp
                           B  1739    				
0051C0 2A 64 53 00         B  1740    fs_fpino		ld hl,(fs_file_transfer_length)
0051C4 2B                  B  1741    				dec hl
0051C5 22 64 53 00         B  1742    				ld (fs_file_transfer_length),hl
0051C9 01000000            B  1743    				ld bc,0
0051CD B7                  B  1744    				or a
0051CE ED4A                B  1745    				adc hl,bc						                           B  1746    				
0051D0 C1                  B  1747    				pop bc
0051D1 E1                  B  1748    				pop hl
0051D2 C9                  B  1749    				ret
                           B  1750    
                           B  1751    ;----------------------------------------------
                           B  1752    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 215


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
0051D3                     B  1753    fs_get_current_dir_name
                           B  1754    
                           B  1755    ;returns current dir name - location at HL
                           B  1756    
0051D3 CD 3A 1A 00         B  1757    				call fs_get_dir_cluster			0051D7 7A                  B  1758    				ld a,d
0051D8 B3                  B  1759    				or e
0051D9 20 10               B  1760    				jr nz,fs_dnnr
0051DB 21 DA 5D 00         B  1761    				ld hl,vol_txt+1					0051DF 3A D5 5D 00         B  1762    				ld a,(current_volume)
0051E3 C630                B  1763    				add a,030h
0051E5 32 DD 5D 00         B  1764    				ld (vol_txt+4),a
0051E9 AF                  B  1765    				xor a
0051EA C9                  B  1766    				ret
                           B  1767    					
0051EB ED53 8E 53 00       B  1768    fs_dnnr			ld (fs_stash_dir_block),de
0051F0 CD 8B 48 00         B  1769    				call fs_parent_dir_command		0051F4 D8                  B  1770    				ret c
0051F5 B7                  B  1771    				or a
0051F6 C0                  B  1772    				ret nz
0051F7 3E01                B  1773    				ld a,1
0051F9 CD 43 50 00         B  1774    				call fs_search					0051FD D8                  B  1775    				ret c
0051FE C0                  B  1776    				ret nz
                           B  1777    					
0051FF DDE5                B  1778    fs_gdbn			push ix
005201 E1                  B  1779    				pop hl
005202 060B                B  1780    				ld b,11							005204 7E                  B  1781    ntdirn			ld a,(hl)
005205 FE20                B  1782    				cp ' '
005207 28 03               B  1783    				jr z,rdirfsp
005209 23                  B  1784    				inc hl
00520A 10 F8               B  1785    rdirnsp			djnz ntdirn
                           B  1786    				
00520C 3600                B  1787    rdirfsp			ld (hl),0
00520E DDE5                B  1788    				push ix
005210 ED5B 8E 53 00       B  1789    				ld de,(fs_stash_dir_block)
005215 CD 46 1A 00         B  1790    				call fs_update_dir_cluster		005219 E1                  B  1791    				pop hl	
00521A AF                  B  1792    				xor a							00521B C9                  B  1793    				ret
                           B  1794    
                           B  1795    ;----------------------------------------------
                           B  1796    
00521C                     B  1797    fs_clear_filename
                           B  1798    
00521C D5                  B  1799    				push de							00521D C5                  B  1800    				push bc
00521E 060C                B  1801    				ld b,12
005220 3E20                B  1802    				ld a,' '
005222 12                  B  1803    clrfnlp			ld (de),a
005223 13                  B  1804    				inc de
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 216


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
005224 10 FC               B  1805    				djnz clrfnlp
005226 C1                  B  1806    				pop bc
005227 D1                  B  1807    				pop de
005228 C9                  B  1808    				ret
                           B  1809    				
                           B  1810    ;----------------------------------------------
                           B  1811    
                           B  1812    
005229                     B  1813    cluster_and_offset_to_lba
                           B  1814    
                           B  1815    ; INPUT: HL = cluster, A = sector offset, OUTPU
                           B  1816    
005229 C5                  B  1817    				push bc
00522A D5                  B  1818    				push de
00522B E5                  B  1819    				push hl
00522C DDE5                B  1820    				push ix
                           B  1821    
00522E 2B                  B  1822    				dec hl							00522F 2B                  B  1823    				dec hl							005230 11000000            B  1824    				ld de,0							005234 01000000            B  1825    				ld bc,0
005238 5F                  B  1826    				ld e,a
005239 3A 1D 53 00         B  1827    				ld a,(fs_cluster_size)			00523D CB3F                B  1828    caotllp			srl a
00523F 28 03               B  1829    				jr z,clusdone
005241 29                  B  1830    				add hl,hl						005242 18 F9               B  1831    				jr caotllp
                           B  1832    			
005244 ED4B 2A 53 00       B  1833    clusdone		ld bc,(fs_data_area)			005249 09                  B  1834    				add hl,bc						00524A 19                  B  1835    				add hl,de						                           B  1836    				
00524B E5                  B  1837    add_ptn_offset	push hl							00524C CD 74 1A 00         B  1838    				call fs_calc_volume_offset
005250 DD21 07 5E 00       B  1839    				ld ix,volume_mount_list
005255 DD19                B  1840    				add ix,de
005257 E1                  B  1841    				pop hl
005258 DD0708              B  1842    				ld bc,(ix+08h)					00525B DD7E0B              B  1843    				ld a,(ix+0bh)
00525E 09                  B  1844    				add hl,bc
00525F CE00                B  1845    				adc a,0
005261 22 AC 5F 00         B  1846    				ld (sector_lba0),hl				005265 32 AF 5F 00         B  1847    				ld (sector_lba3),a				                           B  1848    				
005269 DDE1                B  1849    				pop ix
00526B E1                  B  1850    				pop hl
00526C D1                  B  1851    				pop de
00526D C1                  B  1852    				pop bc
00526E C9                  B  1853    				ret
                           B  1854    				
                           B  1855    
                           B  1856    ;----------------------------------------------
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 217


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
                           B  1857    
00526F                     B  1858    set_absolute_lba
                           B  1859    
                           B  1860    ; set A to sector offset, HL to sectors from st
                           B  1861    
00526F C5                  B  1862    				push bc							005270 D5                  B  1863    				push de							005271 E5                  B  1864    				push hl							005272 DDE5                B  1865    				push ix							005274 01000000            B  1866    				ld bc,0
005278 11000000            B  1867    				ld de,0
00527C 5F                  B  1868    				ld e,a
00527D 19                  B  1869    				add hl,de
00527E 18 CB               B  1870    				jr add_ptn_offset		
                           B  1871    				
                           B  1872    
005280                     B  1873    set_abs_lba_and_read_sector
                           B  1874    
005280 CD 6F 52 00         B  1875    				call set_absolute_lba
005284 C3 AA 52 00         B  1876    				jp fs_read_sector
                           B  1877    				
                           B  1878    ;----------------------------------------------
                           B  1879    
                           B  1880    
005288                     B  1881    backup_sector_lba
                           B  1882    
005288 C5                  B  1883    				push bc
005289 D5                  B  1884    				push de
00528A E5                  B  1885    				push hl
00528B 21 AC 5F 00         B  1886    				ld hl,sector_lba0
00528F 11 92 53 00         B  1887    				ld de,fs_backed_up_sector_lba0
005293 01040000            B  1888    lbabur			ld bc,4
005297 EDB0                B  1889    				ldir
005299 E1                  B  1890    				pop hl
00529A D1                  B  1891    				pop de
00529B C1                  B  1892    				pop bc
00529C C9                  B  1893    				ret
                           B  1894    
                           B  1895    
00529D                     B  1896    restore_sector_lba
                           B  1897    
00529D C5                  B  1898    				push bc
00529E D5                  B  1899    				push de
00529F E5                  B  1900    				push hl
0052A0 21 92 53 00         B  1901    				ld hl,fs_backed_up_sector_lba0
0052A4 11 AC 5F 00         B  1902    				ld de,sector_lba0
0052A8 18 E9               B  1903    				jr lbabur	
                           B  1904    					
                           B  1905    ;----------------------------------------------
                           B  1906    
0052AA                     B  1907    fs_read_sector
                           B  1908    			
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 218


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
0052AA C5                  B  1909    				push bc
0052AB D5                  B  1910    				push de
0052AC E5                  B  1911    				push hl
0052AD DDE5                B  1912    				push ix
0052AF FDE5                B  1913    				push iy
0052B1 01040000            B  1914    				ld bc,04h						0052B5 CD D3 52 00         B  1915    				call sector_access_redirect
0052B9 FDE1                B  1916    secaccend		pop iy
0052BB DDE1                B  1917    				pop ix
0052BD E1                  B  1918    				pop hl
0052BE D1                  B  1919    				pop de
0052BF C1                  B  1920    				pop bc
0052C0 3F                  B  1921    				ccf								0052C1 C9                  B  1922    				ret								                           B  1923    
                           B  1924    
0052C2                     B  1925    fs_write_sector	
                           B  1926    				
0052C2 C5                  B  1927    				push bc
0052C3 D5                  B  1928    				push de
0052C4 E5                  B  1929    				push hl
0052C5 DDE5                B  1930    				push ix
0052C7 FDE5                B  1931    				push iy
0052C9 01080000            B  1932    				ld bc,08h						0052CD CD D3 52 00         B  1933    				call sector_access_redirect
0052D1 18 E6               B  1934    				jr secaccend
                           B  1935    
                           B  1936    
                           B  1937    
0052D3                     B  1938    sector_access_redirect
                           B  1939    
                           B  1940    	
0052D3 3A D6 5D 00         B  1941    				ld a,(current_driver)			0052D7 CD 0C 1A 00         B  1942    				call locate_driver_base			0052DB EB                  B  1943    				ex de,hl
0052DC 09                  B  1944    				add hl,bc						0052DD E9                  B  1945    				jp (hl)
                           B  1946    
                           B  1947    ;----------------------------------------------
                           B  1948    	
0052DE                     B  1949    bootsector_stub
                           B  1950    
0052DE EB3C904D 53444F53   B  1951    				db  0EBh,03Ch,090h,04Dh,053h,04
0052E6 352E3000 02004000 
0052EE 02000200 00F8F200   B  1952    				db  002h,000h,002h,000h,000h,0F
0052F6 3F00FF00 00000000 
0052FE 00000000 000029C4   B  1953    				db  000h,000h,000h,000h,000h,00
005306 E636984E 4F204E41 
00530E 4D452020 20204641   B  1954    				db  04Dh,045h,020h,020h,020h,02
005316 54313620 2020C3 
                           B  1955    
                           B  1956    ;----------------------------------------------
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 219


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
                           B  1957    
00531D 00                  B  1958    fs_cluster_size				db 0
00531E 000000              B  1959    fs_bytes_per_cluster		dw24 0
005321 000000              B  1960    fs_fat1_position			dw24 0		; offse
005324 000000              B  1961    fs_fat2_position			dw24 0		; offse
005327 000000              B  1962    fs_root_dir_position		dw24 0		; offse
00532A 000000              B  1963    fs_data_area				dw24 0		; offse
00532D 00                  B  1964    fs_root_dir_sectors			db 0
                           B  1965    
00532E 000000              B  1966    fs_sectors_per_fat			dw24 0
005331 000000              B  1967    fs_max_data_clusters		dw24 0
                           B  1968    
005334 00 00 00 00 00 00   B  1969    fs_sought_filename			blkb 12,0
00533A 00 00 00 00 00 00 
005340 00 00 00 00 00 00   B  1970    fs_alt_filename				blkb 12,0
005346 00 00 00 00 00 00 
00534C 00 00 00 00 00 00   B  1971    fs_filename_buffer			blkb 12,0
005352 00 00 00 00 00 00 
                           B  1972    
005358 00000000            B  1973    fs_file_pointer				dw 0,0		; 32 bi
00535C 00000000            B  1974    fs_file_length				dw 0,0		; 32 bi
005360 00000000            B  1975    fs_existing_file_length 	dw 0,0		; 32 bi
                           B  1976    
005364 000000              B  1977    fs_file_transfer_length		dw24 0		; 24 bi
                           B  1978    
005367 000000              B  1979    fs_file_start_cluster		dw24 0
00536A 000000              B  1980    fs_file_working_cluster		dw24 0
                           B  1981    
00536D 000000              B  1982    fs_ez80_address				dw24 0
005370 000000              B  1983    fs_ez80_working_address		dw24 0
                           B  1984    
005373 000000              B  1985    fs_in_sector_offset			dw24 0
005376 00                  B  1986    fs_working_sector			db 0
                           B  1987    
005377 000000              B  1988    fs_working_cluster			dw24 0
00537A 000000              B  1989    fs_free_cluster				dw24 0
00537D 000000              B  1990    fs_new_file_cluster			dw24 0
                           B  1991    
005380 000000              B  1992    fs_fname_in_sector_addr		dw24 0
                           B  1993    
005383 000000              B  1994    fs_dir_entry_cluster		dw24 0
005386 000000              B  1995    fs_dir_entry_line_offset	dw24 0
005389 00                  B  1996    fs_dir_entry_sector			db 0
                           B  1997    
00538A 00                  B  1998    fs_filepointer_valid		db 0
00538B 000000              B  1999    fs_sector_pos_cnt			dw24 0
                           B  2000    
00538E 000000              B  2001    fs_stash_dir_block	 		dw24 0
                           B  2002    
005391 00                  B  2003    fs_search_type				db 0
                           B  2004    
005392 00000000            B  2005    fs_backed_up_sector_lba0	db 0,0,0,0
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 220


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_fat16_code.asm
                           B  2006    
                           B  2007    ;----------------------------------------------
                           B  2008    
                           A  3097    
                           A  3098    ;----------------------------------------------
                           A  3099    ; OS Data 
                           A  3100    ;----------------------------------------------
                           A  3101    
                           B     0    	include		'prose_data.asm'				                           B     1    ;**************
                           B     2    ;* PROSE DATA *
                           B     3    ;**************
                           B     4    
                           B     5    ;----------------------------------------------
                           B     6    ; kernal routine locations
                           B     7    ;----------------------------------------------
                           B     8    
005396                     B     9    kernal_table
                           B    10    
005396 061800              B    11    	dw24 ext_mount_volumes			;00		
005399 B41700              B    12    	dw24 os_get_device_info			;01		
00539C 6A1600              B    13    	dw24 os_check_volume_format		;02		
00539F 951A00              B    14    	dw24 ext_change_volume			;03		
0053A2 C71700              B    15    	dw24 os_get_volume_info			;04		
0053A5 741600              B    16    	dw24 ext_format					;05		
0053A8 A61600              B    17    	dw24 ext_make_dir				;06		
0053AB B41600              B    18    	dw24 ext_change_dir				;07		
0053AE C21600              B    19    	dw24 os_parent_dir				;08		
0053B1 C81600              B    20    	dw24 os_root_dir				;09		
0053B4 101700              B    21    	dw24 ext_delete_dir				;0a		
0053B7 F91500              B    22    	dw24 ext_find_file				;0b		
0053BA 151600              B    23    	dw24 ext_set_file_pointer		;0c		
0053BD 0E1600              B    24    	dw24 os_set_load_length			;0d		
0053C0 281600              B    25    	dw24 ext_read_bytes_from_file	;0e		
0053C3 CE1600              B    26    	dw24 ext_erase_file				;0f		
0053C6 F61600              B    27    	dw24 ext_rename_file			;10		
0053C9 381600              B    28    	dw24 ext_create_file			;11		
0053CC 4A1600              B    29    	dw24 ext_write_bytes_to_file	;12		
0053CF 631A00              B    30    	dw24 fs_get_total_sectors		;13		
0053D2 DC1600              B    31    	dw24 os_goto_first_dir_entry	;14		 
0053D5 E21600              B    32    	dw24 os_get_dir_entry			;15		
0053D8 E81600              B    33    	dw24 os_goto_next_dir_entry		;16		
0053DB 201700              B    34    	dw24 ext_read_sector			;17		
0053DE 4E1700              B    35    	dw24 ext_write_sector			;18		
0053E1 D11A00              B    36    	dw24 ext_file_sector_list		;19		
0053E4 3A1A00              B    37    	dw24 fs_get_dir_cluster			;1a		
0053E7 461A00              B    38    	dw24 fs_update_dir_cluster		;1b		
0053EA EE1600              B    39    	dw24 os_get_current_dir_name	;1c		
                           B    40    
0053ED B24200              B    41    	dw24 os_wait_key_press			;1d		
0053F0 F94200              B    42    	dw24 os_get_key_press			;1e		
0053F3 3E1500              B    43    	dw24 os_get_key_mod_flags		;1f		
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 221


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
                           B    44    
0053F6 D51700              B    45    	dw24 ext_serial_get_header		;20		
0053F9 DF1700              B    46    	dw24 ext_serial_receive_file	;21		 
0053FC E81700              B    47    	dw24 ext_serial_send_file		;22		 
0053FF F51700              B    48    	dw24 ext_serial_tx				;23		
005402 FC1700              B    49    	dw24 ext_serial_rx				;24		
                           B    50    
005405 1A0F00              B    51    	dw24 ext_print_string			;25		
005408 CA3B00              B    52    	dw24 hwsc_clear_screen			;26		
00540B 9C3F00              B    53    	dw24 hwsc_wait_vrt				;27		
00540E C31300              B    54    	dw24 os_set_cursor_position		;28		
005411 351A00              B    55    	dw24 ext_plot_char				;29		
005414 531500              B    56    	dw24 ext_set_pen				;2a		
005417 601500              B    57    	dw24 ext_background_colours		;2b		
00541A F73D00              B    58    	dw24 hwsc_draw_cursor			;2c		
00541D 5A1500              B    59    	dw24 os_get_pen					;2d		
005420 133C00              B    60    	dw24 hwsc_scroll_up				;2e		
005423 6A3B00              B    61    	dw24 os_set_video_hw_regs		;2f		
005426 441500              B    62    	dw24 os_get_display_size		;30		
005429 8C3E00              B    63    	dw24 hwsc_get_charmap_addr_xy	;31		
00542C E31300              B    64    	dw24 os_get_cursor_position		;32		 
                           B    65    
00542F 391B00              B    66    	dw24 ext_set_envar				;33		
005432 FD1A00              B    67    	dw24 ext_get_envar				;34		
005435 931B00              B    68    	dw24 ext_delete_envar			;35		
                           B    69    
005438 391400              B    70    	dw24 os_set_mouse_window		;36		
00543B 7F1400              B    71    	dw24 os_get_mouse_position		;37		
00543E 561400              B    72    	dw24 os_get_mouse_motion		;38		
                           B    73    
005441 0A4000              B    74    	dw24 hwsc_time_delay			;39		
005444 D71100              B    75    	dw24 ext_compare_strings		;3a		
005447 631000              B    76    	dw24 ext_hexbyte_to_ascii		;3b		
00544A 981000              B    77    	dw24 ext_ascii_to_hexword		;3c		
00544D ED1000              B    78    	dw24 ext_user_input				;3d		
                           B    79    
005450 EF3F00              B    80    	dw24 hwsc_get_version			;3e		
005453 AD1300              B    81    	dw24 os_dont_store_registers	;3f		
005456 EA1B00              B    82    	dw24 os_get_font_info			;40 	
005459 2D4000              B    83    	dw24 hwsc_read_rtc				;41     
00545C 554000              B    84    	dw24 hwsc_write_rtc				;42		 
00545F E41B00              B    85    	dw24 os_get_keymap_location		;43		 
005462 AD3400              B    86    	dw24 os_get_mem_high			;44
                           B    87    	
                           B    88    ;----------------------------------------------
                           B    89    ; Non-packed Text Strings
                           B    90    ;----------------------------------------------
                           B    91    
005465 50524F53 4520666F   B    92    welcome_message			db "PROSE for EZ80P by 
00546D 7220455A 38305020 
005475 62792050 68696C20 
00547D 52757374 6F6E2032 
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 222


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
005485 3031310B 0B 
00548A 53595354 454D2052   B    93    						db "SYSTEM RAM free abo
005492 414D2066 72656520 
00549A 61626F76 653A2024 
0054A2 00 
0054A3 44726976 65733A0B   B    94    storage_txt				db "Drives:",11,0
0054AB 00 
0054AC 434F4D4D 414E4453   B    95    os_dos_cmds_txt			db "COMMANDS",0
0054B4 00 
0054B5 53544152 5455502E   B    96    startup_script_fn		db "STARTUP.SCR",0
0054BD 53435200 
0054C1 2400                B    97    os_hex_prefix_txt		db "$",0
0054C3 4F532056 65727369   B    98    os_version_txt			db "OS Version: $",0	0054CB 6F6E3A20 2400 
0054D1 414D4F45 42412048   B    99    hw_version_txt			db "AMOEBA HW Version: 
0054D9 57205665 7273696F 
0054E1 6E3A2024 00 
0054E6 202F2000            B   100    fwd_slash_txt			db " / ",0
0054EA 4C6F6164 696E672E   B   101    loading_txt				db "Loading..",11,0
0054F2 2E0B00 
0054F5 53617669 6E672E2E   B   102    saving_txt				db "Saving..",11,0
0054FD 0B00 
0054FF 2E657A70 20         B   103    ezp_extension_txt		db ".ezp",32
005504 0B4D6F72 653F0B0B   B   104    os_more_txt				db 11,"More?",11,11,0
00550C 00 
00550D 52656769 73746572   B   105    nmi_freeze_txt			db "Register Dump:"
005515 2044756D 703A 
00551B 0B0B00              B   106    crlfx2_txt				db 11,11,0
00551E 7800                B   107    rep_char_txt			db "x",0
005520 20746F20 00         B   108    to_txt					db " to ",0
005525 4552524F 5200       B   109    error_txt				db "ERROR",0
                           B   110    
                           B   111    ;----------------------------------------------
                           B   112    ; Packed text section
                           B   113    ;----------------------------------------------
                           B   114    
00552B 00444542 5547       B   115    dictionary				db 0,"DEBUG"			005531 002D2D2D 2D2D       B   116    						db 0,"-----"			005537 00494F              B   117    						db 0,"IO"				00553A 002D2D              B   118    						db 0,"--"				00553D 004D4953 43         B   119    						db 0,"MISC"				005542 002D2D2D 2D         B   120    						db 0,"----"				005547 00616464 72         B   121    						db 0,"addr"				00554C 0050524F 5345       B   122    						db 0,"PROSE"			005552 00612062 2063       B   123    						db 0,"a b c"			005558 00416464 72657373   B   124    						db 0,"Address"			005560 00427974 6573       B   125    						db 0,"Bytes"			005566 00457865 63757461   B   126    						db 0,"Executable"		00556E 626C65 
005571 0048756E 74         B   127    						db 0,"Hunt"				005576 0046696C 6C         B   128    						db 0,"Fill"				00557B 00476F74 6F         B   129    						db 0,"Goto"				Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 223


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
                           B   130    						
005580 0053686F 77         B   131    						db 0,"Show"				005585 00435055            B   132    						db 0,"CPU"				005589 00526567 69737465   B   133    						db 0,"Registers"		005591 7273 
005593 004173              B   134    						db 0,"As"				005596 00415343 4949       B   135    						db 0,"ASCII"			00559C 00436C65 6172       B   136    						db 0,"Clear"			0055A2 00536372 65656E     B   137    						db 0,"Screen"			0055A9 00446973 61737365   B   138    						db 0,"Disassemble"		0055B1 6D626C65 
0055B5 00537769 746368     B   139    						db 0,"Switch"			0055BC 00436F70 79         B   140    						db 0,"Copy"				0055C1 00446576 696365     B   141    						db 0,"Device"			0055C8 00436861 6E6765     B   142    						db 0,"Change"			0055CF 00447269 7665       B   143    						db 0,"Drive"			0055D5 00446972            B   144    						db 0,"Dir"				0055D9 002F                B   145    						db 0,"/"				0055DB 00666E              B   146    						db 0,"fn"				                           B   147    						
0055DE 0044656C 657465     B   148    						db 0,"Delete"			0055E5 0046696C 65         B   149    						db 0,"File"				0055EA 00496E66 6F         B   150    						db 0,"Info"				0055EF 00564F4C 783A       B   151    						db 0,"VOLx:"			0055F5 004D616B 65         B   152    						db 0,"Make"				0055FA 0052656D 6F756E74   B   153    						db 0,"Remount"			005602 00537461 7274       B   154    						db 0,"Start"			005608 00576172 6E696E67   B   155    						db 0,"Warning!"			005610 21 
005611 00416C6C            B   156    						db 0,"All"				005615 0052656D 6F7665     B   157    						db 0,"Remove"			00561C 0052656E 616D65     B   158    						db 0,"Rename"			005623 004F72              B   159    						db 0,"Or"				005626 00526563 65697665   B   160    						db 0,"Receive"			00562E 00536176 65         B   161    						db 0,"Save"				005633 00547261 6E736D69   B   162    						db 0,"Transmit"			00563B 74 
00563C 004C6F61 64         B   163    						db 0,"Load"				                           B   164    						
005641 004F532F 4857       B   165    						db 0,"OS/HW"			005647 00566572 73696F6E   B   166    						db 0,"Version"			00564F 005B7065 6E207061   B   167    						db 0,"[pen paper]"		005657 7065725D 
00565B 803A                B   168    						db 80h,":"				00565D 813E                B   169    						db 81h,">"				00565F 002A                B   170    						db 0,"*"				005661 00566F6C 756D6573   B   171    						db 0,"Volumes"			005669 8343                B   172    						db 83h,"C"				00566B 844344              B   173    						db 84h,"CD"				00566E 85434C53            B   174    						db 85h,"CLS"			005672 8650454E            B   175    						db 86h,"PEN"			005676 8744                B   176    						db 87h,"D"				Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 224


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
005678 8844454C            B   177    						db 88h,"DEL"			00567C 89444952            B   178    						db 89h,"DIR"			005680 8A48                B   179    						db 8ah,"H"				005682 8B46                B   180    						db 8bh,"F"				                           B   181    						
005684 004F6E              B   182    						db 0,"On"				005687 8C464F52 4D4154     B   183    						db 8ch,"FORMAT"			00568E 0047                B   184    						db 0,"G"				005690 8D4C42              B   185    						db 8dh,"LB"				005693 8E4D                B   186    						db 8eh,"M"				005695 8F4D4F55 4E54       B   187    						db 8fh,"MOUNT"			00569B 004265              B   188    						db 0,"Be"				00569E 9052                B   189    						db 90h,"R"				0056A0 915244              B   190    						db 91h,"RD"				0056A3 92524E              B   191    						db 92h,"RN"				0056A6 935258              B   192    						db 93h,"RX"				0056A9 945342              B   193    						db 94h,"SB"				0056AC 9554                B   194    						db 95h,"T"				0056AE 965458              B   195    						db 96h,"TX"				0056B1 97564552 53         B   196    						db 97h,"VERS"			0056B6 00577269 7465       B   197    						db 0,"Write"			                           B   198    						
0056BC 004D656D            B   199    						db 0,"Mem"				0056C0 00227478 7422       B   200    						db 0,22h,"txt",22h		0056C6 0057696C 6C         B   201    						db 0,"Will"				0056CB 00526174 65         B   202    						db 0,"Rate"				0056D0 0061                B   203    						db 0,"a"				0056D2 00507265 70         B   204    						db 0,"Prep"				0056D7 984D44              B   205    						db 98h,"MD"				0056DA 00447269 766573     B   206    						db 0,"Drives"			0056E1 006F6C64 666E       B   207    						db 0,"oldfn"			0056E7 006E6577 666E       B   208    						db 0,"newfn"			0056ED 006C656E            B   209    						db 0,"len"				0056F1 00436F6C 6F757273   B   210    						db 0,"Colours"			0056F9 993F                B   211    						db 99h,"?"				0056FB 00436F6D 6D616E64   B   212    						db 0,"Commands"			005703 73 
005704 0020                B   213    						db 0," "				005706 002D                B   214    						db 0,"-"				                           B   215    						
005708 00566F6C 756D65     B   216    						db 0,"Volume"			00570F 0046756C 6C         B   217    						db 0,"Full"				005714 004E6F74            B   218    						db 0,"Not"				005718 00466F75 6E64       B   219    						db 0,"Found"			00571E 004C656E 677468     B   220    						db 0,"Length"			005725 005A6572 6F         B   221    						db 0,"Zero"				00572A 004F7574            B   222    						db 0,"Out"				00572E 004F66              B   223    						db 0,"Of"				005731 0052616E 6765       B   224    						db 0,"Range"			005737 00416C72 65616479   B   225    						db 0,"Already"			00573F 00457869 737473     B   226    						db 0,"Exists"			005746 004174              B   227    						db 0,"At"				Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 225


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
005749 00526F6F 74         B   228    						db 0,"Root"				00574E 004D6973 6D617463   B   229    						db 0,"Mismatch"			005756 68 
005757 00526571 75657374   B   230    						db 0,"Request"			00575F 00446174 61         B   231    						db 0,"Data"				                           B   232    				
005764 00454F46            B   233    						db 0,"EOF"				005768 00416674 6572       B   234    						db 0,"After"			00576E 00556E6B 6E6F776E   B   235    						db 0,"Unknown"			005776 00436F6D 6D616E64   B   236    						db 0,"Command"			00577E 00426164            B   237    						db 0,"Bad"				005782 00486578            B   238    						db 0,"Hex"				005786 004E6F              B   239    						db 0,"No"				005789 0041626F 72746564   B   240    						db 0,"Aborted"			005791 00507265 73656E74   B   241    						db 0,"Present"			005799 00436865 636B7375   B   242    						db 0,"Checksum"			0057A1 6D 
0057A2 004C6F61 646564     B   243    						db 0,"Loaded"			0057A9 00436F6D 6D73       B   244    						db 0,"Comms"			0057AF 00457272 6F72       B   245    						db 0,"Error"			0057B5 00417267 756D656E   B   246    						db 0,"Arguments"		0057BD 7473 
0057BF 004C6F73 74         B   247    						db 0,"Lost"				                           B   248    						
0057C4 00                  B   249    						db 0
0057C5 46415431 36         B   250    fat16_txt				db "FAT16"				                           B   251    
0057CA 00536572 69616C     B   252    						db 0,"Serial"			0057D1 0054696D 65         B   253    						db 0,"Time"				0057D6 00466F6E 74         B   254    						db 0,"Font"				0057DB 00546F6F            B   255    						db 0,"Too"				0057DF 004C6F6E 67         B   256    						db 0,"Long"				0057E4 00446573 74696E61   B   257    						db 0,"Destination"		0057EC 74696F6E 
0057F0 0053656C 65637465   B   258    						db 0,"Selected"			0057F8 64 
0057F9 00496E76 616C6964   B   259    						db 0,"Invalid"			005801 004D6973 73696E67   B   260    						db 0,"Missing"			005809 004F4B              B   261    						db 0,"OK"				00580C 004F53              B   262    						db 0,"OS"				00580F 0050726F 74656374   B   263    						db 0,"Protected"		005817 6564 
005819 0041                B   264    						db 0,"A"				00581B 004973              B   265    						db 0,"Is"				00581E 00456D70 7479       B   266    						db 0,"Empty"			005824 00456E64            B   267    						db 0,"End"				                           B   268    						
005828 0024                B   269    						db 0,"$"
00582A 7878                B   270    hex_byte_txt			db "xx"					                           B   271    						
00582C 00417070 656E64     B   272    						db 0,"Append"			005833 003F                B   273    						db 0,"?"				Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 226


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
005835 0024                B   274    						db 0,"$"				005837 00417761 6974696E   B   275    						db 0,"Awaiting"			00583F 67 
005840 00526563 65697669   B   276    						db 0,"Receiving"		005848 6E67 
00584A 0053656E 64696E67   B   277    						db 0,"Sending"			005852 000B                B   278    						db 0,11					005854 002E2E              B   279    						db 0,".."				005857 004E616D 65         B   280    						db 0,"Name"				00585C 00204279 746573     B   281    						db 0," Bytes"			005863 00507265 7373       B   282    						db 0,"Press"			005869 00416E79            B   283    						db 0,"Any"				00586D 004B6579            B   284    						db 0,"Key"				005871 00456E74 6572       B   285    						db 0,"Enter"			005877 9A455845 43         B   286    						db 9ah,"EXEC"			                           B   287    				
00587C 0052756E            B   288    						db 0,"Run"				005880 00536372 697074     B   289    						db 0,"Script"			005887 00594553            B   290    yes_txt					db 0,"YES" 				00588B 00546F              B   291    						db 0,"To"				00588E 00536574            B   292    						db 0,"Set"				005892 00436F6E 74696E75   B   293    						db 0,"Continue"			00589A 65 
00589B 004E6F6E 65         B   294    						db 0,"None"				0058A0 00447269 766572     B   295    						db 0,"Driver"			0058A7 9B3C                B   296    						db 9bh,"<"				0058A9 004E6577 6572       B   297    						db 0,"Newer"			0058AF 00526571 75697265   B   298    						db 0,"Required"			0058B7 64 
0058B8 00465047 4120636F   B   299    						db 0,"FPGA config"		0058C0 6E666967 
0058C4 00556E63 68616E67   B   300    						db 0,"Unchanged"		0058CC 6564 
0058CE 00202849 6620666E   B   301    						db 0," (If fn = ! recei
0058D6 203D2021 20726563 
0058DE 65697665 20616E64 
0058E6 2072756E 2070726F 
0058EE 6772616D 29 
0058F3 9C50414C 45545445   B   302    						db 9ch,"PALETTE"		0058FB 0070616C 65747465   B   303    						db 0,"palette"			                           B   304    						
005903 9D4D4F55 5345       B   305    						db 9dh,"MOUSE"			005909 00456E61 626C65     B   306    						db 0,"Enable"			005910 004B6579 626F6172   B   307    						db 0,"Keyboard"			005918 64 
005919 00446574 65637465   B   308    						db 0,"Detected"			005921 64 
005922 004D6F75 7365       B   309    						db 0,"Mouse"			005928 00536563 746F72     B   310    						db 0,"Sector"			00592F 00496E63 6F727265   B   311    						db 0,"Incorrect"		005937 6374 
005939 9E564D4F 4445       B   312    						db 9eh,"VMODE"			Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 227


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
00593F 00566964 656F       B   313    						db 0,"Video"			005945 004D6F64 65         B   314    						db 0,"Mode"				00594A 9F464F4E 54         B   315    						db 9fh,"FONT"			00594F 00416E64            B   316    						db 0,"And"				005953 00536176 696E67     B   317    						db 0,"Saving"			00595A 00556E73 7570706F   B   318    						db 0,"Unsupported"		005962 72746564 
005966 A0534554            B   319    						db 0a0h,"SET"			00596A 005B7661 723D7374   B   320    						db 0,"[var=string]"		005972 72696E67 5D 
                           B   321    
005977 00456E76 6172       B   322    						db 0,"Envar"			00597D A1445A              B   323    						db 0a1h,"DZ"			005980 0041444C            B   324    						db 0,"ADL"				005984 005A3830            B   325    						db 0,"Z80"				                           B   326    						
005988 0001                B   327    						db 0,1					                           B   328    
                           B   329    
                           B   330    
                           B   331    
                           B   332    
00598A 2199696A 5F916F92   B   333    save_append_msg			db 021h,099h,069h,06ah,
005992 9700 
005994 2F0A9300            B   334    os_loadaddress_msg 		db 02fh,00ah,093h,0		005998 21649300            B   335    os_filesize_msg			db 021h,064h,093h,0		00599C 94219700            B   336    ser_rec_msg				db 094h,021h,097h,0		0059A0 956F9897 00         B   337    ser_rec2_msg			db 095h,06fh,098h,097h,
0059A5 966F9897 00         B   338    ser_send_msg			db 096h,06fh,098h,097h,
0059AA 9521BBBC 989700     B   339    ser_recsave_msg			db 095h,021h,0bbh,0bch,
0059B1 A77C9097 00         B   340    hw_err_msg				db 0a7h,07ch,090h,097h,
0059B6 607C00              B   341    disk_err_msg			db 060h,07ch,0			0059B9 A1779797 00         B   342    script_aborted_msg		db 0a1h,077h,097h,097h,
0059BE 76B2B397 00         B   343    no_keyboard_msg			db 076h,0b2h,0b3h,097h,
                           B   344    
0059C3 9700                B   345    packed_help1				db 097h,0
0059C5 0100                B   346    							db 001h,0			0059C7 0200                B   347    							db 002h,0			0059C9 3307095F 4F500B00   B   348    							db 033h,007h,009h,0
0059D1 3407515F 4F1400     B   349    							db 034h,007h,051h,0
0059D8 A807095F 4F0B1E17   B   350    							db 0a8h,007h,009h,0
0059E0 00 
                           B   351    
0059E1 37070707 5F195000   B   352    							db 037h,007h,007h,0
0059E9 3B075FC2 1700       B   353    							db 03bh,007h,05fh,0
0059EF C1075FC3 1700       B   354    							db 0c1h,007h,05fh,0
0059F5 3F070754 5F0E5000   B   355    							db 03fh,007h,007h,0
0059FD 42075F0F 0A00       B   356    							db 042h,007h,05fh,0
005A03 3E070709 5F0D5000   B   357    							db 03eh,007h,007h,0
005A0B 44075F10 500B00     B   358    							db 044h,007h,05fh,0
005A12 475F1011 1200       B   359    							db 047h,05fh,010h,0
005A18 4C075F10 50131400   B   360    							db 04ch,007h,05fh,0
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 228


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
                           B   361    	
005A20 9700                B   362    							db 097h,0
005A22 0300                B   363    							db 003h,0			005A24 0400                B   364    							db 004h,0			005A26 38231E1D 5F1B601E   B   365    							db 038h,023h,01eh,0
005A2E 1D00 
005A30 3C1F5F20 2100       B   366    							db 03ch,01fh,05fh,0
005A36 3D5F101D 00         B   367    							db 03dh,05fh,010h,0
005A3B 411A995F 551C00     B   368    							db 041h,01ah,099h,0
005A42 431F075F 2F2100     B   369    							db 043h,01fh,007h,0
005A49 561D5F24 1D00       B   370    							db 056h,01dh,05fh,0
005A4F 455F2557 00         B   371    							db 045h,05fh,025h,0
005A54 481D5F29 1D00       B   372    							db 048h,01dh,05fh,0
005A5A 4958595F 2A2100     B   373    							db 049h,058h,059h,0
005A61 4A1F075F 2C21AD00   B   374    							db 04ah,01fh,007h,0
005A69 4B1F075A 5F2D2100   B   375    							db 04bh,01fh,007h,0
005A71 4D1F075A 5F2E2100   B   376    							db 04dh,01fh,007h,0
005A79 235F1860 00         B   377    							db 023h,05fh,018h,0
                           B   378    
005A7E 9700                B   379    							db 097h,0
005A80 0500                B   380    							db 005h,0			005A82 0600                B   381    							db 006h,0			005A84 395F1516 00         B   382    							db 039h,05fh,015h,0
005A89 9F1F5FA0 A100       B   383    							db 09fh,01fh,05fh,0
005A8F BA1F5F1B 8200       B   384    							db 0bah,01fh,05fh,0
005A95 B05FB1B0 A700       B   385    							db 0b0h,05fh,0b1h,0
005A9B AE095F1B AF00       B   386    							db 0aeh,09h,05fh,01
005AA1 3A325F1B 5B00       B   387    							db 03ah,032h,05fh,0
005AA7 BEBF5FA4 C000       B   388    							db 0beh,0bfh,05fh,0
005AAD 4E5F1030 3100       B   389    							db 04eh,05fh,010h,0
005AB3 B7095F1B B8B900     B   390    							db 0b7h,09h,5fh,01b
005ABA 5C5F105D 00         B   391    							db 05ch,05fh,010h,0
005ABF 9700                B   392    							db 097h,0
005AC1 FF                  B   393    							db 0ffh
                           B   394    
                           B   395    
                           B   396    
                           B   397    
005AC2 4A1D00              B   398    os_cmd_locs					dw24 os_cmd_colon	005AC5 C52B00              B   399    							dw24 os_cmd_gtr		005AC8 AC3400              B   400    							dw24 os_cmd_unused	005ACB F11B00              B   401    							dw24 os_cmd_c		005ACE 5E1C00              B   402    							dw24 os_cmd_cd		005AD1 441D00              B   403    							dw24 os_cmd_cls		005AD4 C73200              B   404    							dw24 os_cmd_pen		005AD7 641D00              B   405    							dw24 os_cmd_d		                           B   406    					
005ADA 622800              B   407    							dw24 os_cmd_del		005ADD 772800              B   408    							dw24 os_cmd_dir		005AE0 F32A00              B   409    							dw24 os_cmd_h		005AE3 732900              B   410    							dw24 os_cmd_f		005AE6 9B2900              B   411    							dw24 os_cmd_format	Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 229


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
005AE9 F92B00              B   412    							dw24 os_cmd_lb		005AEC 882C00              B   413    							dw24 os_cmd_m		005AEF 883100              B   414    							dw24 os_cmd_remount
                           B   415    
005AF2 DF2C00              B   416    							dw24 os_cmd_r		005AF5 102E00              B   417    							dw24 os_cmd_rd		005AF8 1D2E00              B   418    							dw24 os_cmd_rn		005AFB A12E00              B   419    							dw24 os_cmd_rx		005AFE 392E00              B   420    							dw24 os_cmd_sb		005B01 343100              B   421    							dw24 os_cmd_t		005B04 C83000              B   422    							dw24 os_cmd_tx		005B07 943100              B   423    							dw24 os_cmd_vers	                           B   424    							
005B0A D22C00              B   425    							dw24 os_cmd_md		005B0D A12B00              B   426    							dw24 os_cmd_help	005B10 C53100              B   427    							dw24 os_cmd_exec	005B13 C53200              B   428    							dw24 os_cmd_ltn		005B16 E73200              B   429    							dw24 os_cmd_palette
005B19 183300              B   430    							dw24 os_cmd_mouse	005B1C 543300              B   431    							dw24 os_cmd_vmode	005B1F F23300              B   432    							dw24 os_cmd_font	                           B   433    							
005B22 433400              B   434    							dw24 os_cmd_set		005B25 9F3400              B   435    							dw24 os_cmd_dz		                           B   436    							
                           B   437    								
005B28 00                  B   438    packed_msg_list				db 0				                           B   439    		
005B29 606100              B   440    							db 060h,061h,0		005B2C 21626300            B   441    							db 021h,062h,063h,0
005B30 1D6100              B   442    							db 01dh,061h,0		005B33 628C1D00            B   443    							db 062h,08ch,01dh,0
005B37 1D8D628E 00         B   444    							db 01dh,08dh,062h,0
005B3C 628C2100            B   445    							db 062h,08ch,021h,0
005B40 21648D65 00         B   446    							db 021h,064h,08dh,0
005B45 0A666768 00         B   447    							db 00ah,066h,067h,0
005B4A 2199696A 00         B   448    							db 021h,099h,069h,0
005B4F 696B6C00            B   449    							db 069h,06bh,06ch,0
                           B   450    					
005B53 727300              B   451    							db 072h,073h,0		005B56 877500              B   452    							db 087h,075h,0		005B59 76219900            B   453    							db 076h,021h,099h,0
                           B   454    					
005B5D 87B500              B   455    							db 087h,0b5h,0		005B60 797400              B   456    							db 079h,074h,0		005B63 9A7A00              B   457    bytes_loaded_msg			db 09ah,07ah,0		005B66 7B7C00              B   458    							db 07bh,07ch,0		005B69 747D00              B   459    							db 074h,07dh,0		                           B   460    
005B6C 627F00              B   461    format_err_msg				db 062h,07fh,0		                           B   462    
005B6F 816600              B   463    							db 081h,066h,0		Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 230


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
005B72 21998384 00         B   464    							db 021h,099h,083h,0
005B77 76260A00            B   465    							db 076h,026h,00ah,0
005B7B 76216400            B   466    							db 076h,021h,064h,0
005B7F 2D7700              B   467    							db 02dh,077h,0		005B82 2D7C6B85 00         B   468    							db 02dh,07ch,06bh,0
005B87 628C080C 00         B   469    							db 062h,08ch,08h,0c
005B8C A9316708 AA00       B   470    							db 0a9h,031h,067h,0
005B92 768F0A00            B   471    							db 076h,08fh,00ah,0
005B96 76850A00            B   472    							db 076h,085h,00ah,0
                           B   473    					
005B9A 746800              B   474    							db 074h,068h,0		005B9D 887D00              B   475    							db 088h,07dh,0		005BA0 8900                B   476    ok_msg						db 089h,0			                           B   477    					
005BA2 876000              B   478    							db 087h,060h,0		005BA5 1A627800            B   479    							db 01ah,062h,078h,0
                           B   480    					
005BA9 1D626300            B   481    							db 01dh,062h,063h,0
005BAD 7700                B   482    							db 077h,0			                           B   483    					
005BAF 21996D00            B   484    							db 021h,099h,06dh,0
005BB3 8A508B00            B   485    							db 08ah,050h,08bh,0
005BB7 6F71706E 00         B   486    							db 06fh,071h,070h,0
005BBC 763600              B   487    no_vols_msg					db 076h,036h,0		005BBF 97A66300            B   488    none_found_msg				db 097h,0a6h,063h,0
                           B   489    							
005BC3 B62100              B   490    							db 0b6h,021h,0		005BC6 A9316708 AA00       B   491    							db 0a9h,031h,067h,0
005BCC 21AC00              B   492    							db 021h,0ach,0		                           B   493    							
005BCF 766F00              B   494    							db 076h,06fh,0		005BD2 746F00              B   495    							db 074h,06fh,0		005BD5 66676800            B   496    							db 066h,067h,068h,0
005BD9 BD1A00              B   497    							db 0bdh,01ah,0		005BDC 1A62B300            B   498    							db 01ah,062h,0b3h,0
005BE0 1A7C00              B   499    							db 01ah,07ch,0		                           B   500    							
005BE3 FF                  B   501    							db 0ffh				                           B   502    
                           B   503    ;----------------------------------------------
                           B   504    
005BE4                     B   505    kernal_error_code_translation
                           B   506    
005BE4 242D2E14 08110F2A   B   507    					db 24h,2dh,2eh,14h, 08h,11h
005BEC 2F303132 
                           B   508    					
005BF0                     B   509    fs_error_code_translation
                           B   510    
005BF0 00010203 04050607   B   511    					db 00h,01h,02h,03h,04h,05h,
005BF8 08090A0B 0C0D1321 
005C00 22232425 260E0000   B   512    					db 22h,23h,24h,25h,26h,0eh,
                           B   513    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 231


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
                           B   514    
                           B   515    ;----------------------------------------------
                           B   516    ; Scancode to ASCII keymaps
                           B   517    ;----------------------------------------------
                           B   518    
                           C     0    include	'UK_keymap.asm'
005C08                     C     1    keymap:
005C08 00000000 00000000   C     2                    db 000h,000h,000h,000h,000h,000
005C10 00000000 00006000 
005C18 00000000 00713100   C     3                    db 000h,000h,000h,000h,000h,071
005C20 00007A73 61773200 
005C28 00637864 65343300   C     4                    db 000h,063h,078h,064h,065h,034
005C30 00207666 74723500 
005C38 006E6268 67793600   C     5                    db 000h,06Eh,062h,068h,067h,079
005C40 00006D6A 75373800 
005C48 002C6B69 6F303900   C     6                    db 000h,02Ch,06Bh,069h,06Fh,030
005C50 002E2F6C 3B702D00 
005C58 00002700 5B3D0000   C     7                    db 000h,000h,027h,000h,05Bh,03D
005C60 0000005D 00230000 
005C68 005C0000 00000000   C     8                    db 000h,05Ch,000h,000h,000h,000
005C70 00000000 00000000 
005C78 AC000000 00000051   C     9                    db 0ACh,000h,000h,000h,000h,000
005C80 21000000 5A534157 
005C88 22000043 58444524   C    10                    db 022h,000h,000h,043h,058h,044
005C90 A3000020 56465452 
005C98 2500004E 42484759   C    11                    db 025h,000h,000h,04Eh,042h,048
005CA0 5E000000 4D4A5526 
005CA8 2A00003C 4B494F29   C    12                    db 02Ah,000h,000h,03Ch,04Bh,049
005CB0 2800003E 3F4C3A50 
005CB8 5F000000 40007B2B   C    13                    db 05Fh,000h,000h,000h,040h,000
005CC0 00000000 007D007E 
005CC8 0000007C 00000000   C    14                    db 000h,000h,000h,07Ch,000h,000
005CD0 00000000 00000000 
005CD8 00000000 00000000   C    15                    db 000h,000h,000h,000h,000h,000
005CE0 00000000 00000000 
005CE8 00000000 00000000   C    16                    db 000h,000h,000h,000h,000h,000
005CF0 00000000 00000000 
005CF8 00000000 00000000   C    17                    db 000h,000h,000h,000h,000h,000
005D00 00000000 00000000 
005D08 00000000 00000000   C    18                    db 000h,000h,000h,000h,000h,000
005D10 00000000 00000000 
005D18 00000000 00000000   C    19                    db 000h,000h,000h,000h,000h,000
005D20 00000000 00000000 
005D28 00000000 0000       C    20                    db 000h,000h,000h,000h,000h,000
                           B   520    
       00005C08            B   521    unshifted_keymap equ keymap+00h
       00005C6A            B   522    shifted_keymap   equ keymap+62h
       00005CCC            B   523    alted_keymap	 equ keymap+c4h
                           B   524    	
                           B   525    ;----------------------------------------------
                           B   526    
005D2E 00                  B   527    ui_index				db 0				; u
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 232


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
005D2F 00                  B   528    ui_maxchars				db 0				; "
005D30 000000              B   529    ui_string_addr			dw24 0				; "
                           B   530    
                           B   531    ;----------------------------------------------
                           B   532    ; OS Display parameters
                           B   533    ;----------------------------------------------
                           B   534    
005D33 00                  B   535    video_mode				db 0
005D34 0700                B   536    current_pen				dw 07h				; c
005D36 0000                B   537    background_colour		dw 00h				; f
                           B   538    
005D38 00000F00 000F0F0F   B   539    pen_palette				dw 0000h,000fh,0f00h,0f
005D40 F000FF00 F00FFF0F 
005D48 55059909 CC0C710F   B   540    						dw 0555h,0999h,0ccch,0f
005D50 7F00F80D 40088C03 
                           B   541    
005D58 00                  B   542    plotchar_colour			db 0				; c
                           B   543    
005D59 00                  B   544    req_cursor_image		db 0
005D5A 00                  B   545    active_cursor_image		db 0
                           B   546    
005D5B                     B   547    display_parameters							; D
                           B   548    ;-----------------
                           B   549    
005D5B 000000              B   550    window_rows				dw24 0				; i
005D5E 000000              B   551    window_columns			dw24 0				; i
005D61 000000              B   552    window_width_bytes		dw24 0				; i
005D64 000000              B   553    window_height_lines		dw24 0				; i
                           B   554    
005D67 040000 080000       B   555    font_parameters			dw24 4,8,0,0
005D6D 000000 000000 
       00005D67            B   556    font_width_bytes		equ font_parameters+0	       00005D6A            B   557    font_height_lines		equ font_parameters+3
       00005D6D            B   558    font_addr				equ font_parameters+6
       00005D70            B   559    font_length				equ font_parameters+9
                           B   560    
005D73 000000              B   561    video_window_address	dw24 0
005D76 000000              B   562    charmap_address			dw24 0
005D79 000000              B   563    attributes_address		dw24 0
005D7C 000000              B   564    cursor_image_address	dw24 0
005D7F 000000              B   565    total_window_bytes		dw24 0
005D82 000000              B   566    total_charmap_bytes		dw24 0
005D85 000000              B   567    total_row_bytes			dw24 0				; i
005D88 00                  B   568    window_pixel_doubling	db 0
                           B   569    
                           B   570    ;==============================================
                           B   571    ;  Serial Routine Data
                           B   572    ;==============================================
                           B   573    
005D89 000000              B   574    serial_ez80_address		dw24 0
005D8C 000000              B   575    serial_file_length		dw24 0
005D8F 000000              B   576    serial_fn_addr			dw24 0
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 233


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
005D92 00 00 00 00 00 00   B   577    serial_filename			blkb 18,0		
005D98 00 00 00 00 00 00 
005D9E 00 00 00 00 00 00 
005DA4 00                  B   578    serial_fn_length		db 0
005DA5 00                  B   579    serial_timeout			db 0
                           B   580    
005DA6 00 00 00 00 00 00   B   581    serial_fileheader		blkb 20,0
005DAC 00 00 00 00 00 00 
005DB2 00 00 00 00 00 00 
005DB8 00 00 
005DBA 5A383050 2E464845   B   582    serial_header_id		db "Z80P.FHEADER"		005DC2 41444552 
005DC6 00                  B   583    serial_transfer_started	db 0
                           B   584    
005DC7 00                  B   585    anim_wait_count			db 0
                           B   586    
                           B   587    ;==============================================
                           B   588    
005DC8 F3C8                B   589    intellimouse_seq	db 0f3h,200
005DCA F364                B   590    					db 0f3h,100
005DCC F350                B   591    					db 0f3h,80
                           B   592    
005DCE E803                B   593    mouse_settings_seq	db 0e8h,default_resolution
005DD0 E6                  B   594    					db default_scaling
005DD1 F364                B   595    					db 0f3h,default_sample_rate
005DD3 F4                  B   596    					db 0f4h
                           B   597    					
                           B   598    ;----------------------------------------------
                           B   599    ; FILE SYSTEM RELATED VARIABLES
                           B   600    ;----------------------------------------------
                           B   601    
005DD4 00                  B   602    boot_drive			db 0
                           B   603    
005DD5 00                  B   604    current_volume		db 0
                           B   605    	
005DD6 00                  B   606    current_driver		db 0			;normally u
                           B   607    
005DD7 00                  B   608    device_count		db 0			;IE: the nu
                           B   609    
005DD8 00                  B   610    volume_count		db 0
                           B   611    				
005DD9 20564F4C 303A00     B   612    vol_txt				db " VOL0:",0	;space pref
005DE0 44455630 3A00       B   613    dev_txt				db "DEV0:",0
                           B   614    
005DE6 000000              B   615    sector_rd_wr_addr	dw24 0
                           B   616    
                           B   617    ;==============================================
                           B   618    
                           B   619    ; Add storage device drivers here, end with 0
                           B   620    
005DE9 BD3400              B   621    driver_table		dw24 sd_card_driver	;Device
005DEC 000000              B   622    					dw24 0				;last d
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 234


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
                           B   623    
                           B   624    ; Each driver's code should have a header in th
                           B   625    ; ---------------------------------------------
                           B   626    ; $0    = JP to get ID routin
                           B   627    ; $4    = JP to read sector routine
                           B   628    ; $8    = JP to write sector routinee
                           B   629    ; $c    = ASCII name of device type (null termi
                           B   630    ;==============================================
                           B   631    
005DEF                     B   632    volume_dir_clusters
                           B   633    
005DEF 00 00 00 00 00 00   B   634    					blkb max_volumes*3,0
005DF5 00 00 00 00 00 00 
005DFB 00 00 00 00 00 00 
005E01 00 00 00 00 00 00 
                           B   635    	
005E07                     B   636    volume_mount_list
                           B   637    
005E07 00 00 00 00 00 00   B   638    					blkb max_volumes*16,0
005E0D 00 00 00 00 00 00 
005E13 00 00 00 00 00 00 
005E19 00 00 00 00 00 00 
005E1F 00 00 00 00 00 00 
005E25 00 00 00 00 00 00 
005E2B 00 00 00 00 00 00 
005E31 00 00 00 00 00 00 
005E37 00 00 00 00 00 00 
005E3D 00 00 00 00 00 00 
005E43 00 00 00 00 00 00 
005E49 00 00 00 00 00 00 
005E4F 00 00 00 00 00 00 
005E55 00 00 00 00 00 00 
005E5B 00 00 00 00 00 00 
005E61 00 00 00 00 00 00 
005E67 00 00 00 00 00 00 
005E6D 00 00 00 00 00 00 
005E73 00 00 00 00 00 00 
005E79 00 00 00 00 00 00 
005E7F 00 00 00 00 00 00 
005E85 00 00 
                           B   639    
                           B   640    ; Each entry is 16 bytes in the form:
                           B   641    
                           B   642    ; OFFSETS
                           B   643    ; -------
                           B   644    ; $00 - Volume is present (0/1)
                           B   645    ; $01 - Volume's host driver number (1 byte)	                           B   646    ; $02 - [reserved]
                           B   647    ; $03 - [reserved]
                           B   648    ; $04 - Volume's capacity in sectors (3 bytes)
                           B   649    ; $07 - Partition number on host drive (0/1/2/3
                           B   650    ; $08 - Offset in sectors from MBR to partition
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 235


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
                           B   651    ; $0c - [reserved]
                           B   652    ; $0d - [reserved]	
                           B   653    ; $0e - [reserved]
                           B   654    ; $0f - [reserved]
                           B   655    
                           B   656    ;==============================================
                           B   657    
005E87                     B   658    host_device_hardware_info
                           B   659    
005E87 00 00 00 00 00 00   B   660    					blkb 32*4,0
005E8D 00 00 00 00 00 00 
005E93 00 00 00 00 00 00 
005E99 00 00 00 00 00 00 
005E9F 00 00 00 00 00 00 
005EA5 00 00 00 00 00 00 
005EAB 00 00 00 00 00 00 
005EB1 00 00 00 00 00 00 
005EB7 00 00 00 00 00 00 
005EBD 00 00 00 00 00 00 
005EC3 00 00 00 00 00 00 
005EC9 00 00 00 00 00 00 
005ECF 00 00 00 00 00 00 
005ED5 00 00 00 00 00 00 
005EDB 00 00 00 00 00 00 
005EE1 00 00 00 00 00 00 
005EE7 00 00 00 00 00 00 
005EED 00 00 00 00 00 00 
005EF3 00 00 00 00 00 00 
005EF9 00 00 00 00 00 00 
005EFF 00 00 00 00 00 00 
005F05 00 00 
                           B   661    
                           B   662    ; Each entry is 32 bytes..
                           B   663    ;
                           B   664    ; OFFSETS
                           B   665    ; -------
                           B   666    ; $00 - Device driver number
                           B   667    ; $01 - Device's TOTAL capacity in sectors (4 b
                           B   668    ; $05 - Zero terminated hardware name (22 ASCII
                           B   669    ; (remaining bytes to $1F currently unused)
                           B   670    
                           B   671    ;----------------------------------------------
                           B   672    
005F07 000000              B   673    dhwn_temp_pointer		dw24 0
                           B   674    
005F0A 00                  B   675    partition_temp			db 0
005F0B 00                  B   676    vols_on_device_temp		db 0
005F0C 00                  B   677    sys_driver_backup		db 0
005F0D 00                  B   678    os_quiet_mode			db 0
                           B   679    
005F0E 1D6800              B   680    default_load_addr		dw24 os_max_addr
                           B   681    
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 236


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
                           B   682    ;----------------------------------------------
                           B   683    
005F11 00 00 00 00 00 00   B   684    time_data				blkb	7,0
005F17 00 
                           B   685    
005F18 00                  B   686    frozen					db 0
005F19 01                  B   687    first_run				db 1
005F1A 01                  B   688    devices_connected		db 1					                           B   689    
                           B   690    ;----------------------------------------------
                           B   691    
005F1B 1D6800              B   692    sys_ram_high			dw24 os_max_addr
005F1E 000080              B   693    vram_a_high				dw24 vram_a_addr
005F21 0000C0              B   694    vram_b_high				dw24 vram_b_addr
                           B   695    
                           B   696    ;----------------------------------------------
                           B   697    
005F24 00                  B   698    store_a1				db 0		
005F25 000000              B   699    store_bc1				dw24 0
005F28 000000              B   700    store_de1				dw24 0
005F2B 000000              B   701    store_hl1				dw24 0
005F2E 00                  B   702    store_a2				db 0
005F2F 000000              B   703    store_bc2				dw24 0
005F32 000000              B   704    store_de2				dw24 0
005F35 000000              B   705    store_hl2				dw24 0
005F38 000000              B   706    store_ix				dw24 0
005F3B 000000              B   707    store_iy				dw24 0
005F3E 000000              B   708    store_pc				dw24 0		;only relev
005F41 000000              B   709    store_spl				dw24 0
005F44 0000                B   710    store_sps				dw 0
005F46 00                  B   711    store_mbase				db 0
005F47 00                  B   712    store_f	 				db 0
005F48 00                  B   713    store_adl				db 0
                           B   714    
                           B   715    ;----------------------------------------------
005F49                     B   716    os_variables
                           B   717    ;----------------------------------------------
                           B   718    
005F49 00                  B   719    store_registers			db 0
005F4A 000000              B   720    com_start_addr			dw24 0
                           B   721    
005F4D 00 00 00 00 00 00   B   722    temp_string				blkb max_buffer_chars+2
005F53 00 00 00 00 00 00 
005F59 00 00 00 00 00 00 
005F5F 00 00 00 00 00 00 
005F65 00 00 00 00 00 00 
005F6B 00 00 00 00 00 00 
005F71 00 00 00 00 00 00 
005F77 00 00 00 00 00 00 
005F7D 00 00 00 00 00 00 
005F83 00 00 00 00 00 00 
005F89 00 00 00 00 00 00 
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 237


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
005F8F 00 00 00 00 00 00 
005F95 00 00 00 00 00 00 
005F9B 00 00 00 00 
005F9F 00 00 00 00 00 00   B   723    script_fn				blkb 13,0
005FA5 00 00 00 00 00 00 
005FAB 00 
                           B   724    
005FAC 00                  B   725    sector_lba0				db 0			; keep 
005FAD 00                  B   726    sector_lba1				db 0
005FAE 00                  B   727    sector_lba2				db 0
005FAF 00                  B   728    sector_lba3				db 0
                           B   729    
                           B   730    ;----------------------------------------------
                           B   731    
005FB0 000000              B   732    cursor_pos				dw24 0			; 3rd b
                           B   733    
       00005FB0            B   734    cursor_y 				equ cursor_pos
       00005FB1            B   735    cursor_x 				equ cursor_pos+1
                           B   736    						
005FB3 00                  B   737    cursorflashtimer		db 0
005FB4 00                  B   738    cursor_status			db 0
005FB5 00                  B   739    os_linecount			db 0
                           B   740    		
005FB6 000000              B   741    mem_mon_addr			dw24 0
005FB9 000000              B   742    cmdop_start_address		dw24 0
005FBC 000000              B   743    cmdop_end_address		dw24 0
005FBF 000000              B   744    copy_dest_address		dw24 0
005FC2 000000              B   745    hex_address				dw24 0
                           B   746    
005FC5 000000              B   747    find_hexstringascii 	dw24 0
005FC8 000000              B   748    xrr_temp				dw24 0
005FCB 00                  B   749    temphex					db 0
005FCC 00                  B   750    fillbyte				db 0 
005FCD 00                  B   751    ui_im_cache				db 0
                           B   752    
005FCE 00 00 00 00 00 00   B   753    commandstring			blkb max_buffer_chars+2
005FD4 00 00 00 00 00 00 
005FDA 00 00 00 00 00 00 
005FE0 00 00 00 00 00 00 
005FE6 00 00 00 00 00 00 
005FEC 00 00 00 00 00 00 
005FF2 00 00 00 00 00 00 
005FF8 00 00 00 00 00 00 
005FFE 00 00 00 00 00 00 
006004 00 00 00 00 00 00 
00600A 00 00 00 00 00 00 
006010 00 00 00 00 00 00 
006016 00 00 00 00 00 00 
00601C 00 00 00 00 
006020 00 00 00 00 00 00   B   754    output_line				blkb max_buffer_chars+2
006026 00 00 00 00 00 00 
00602C 00 00 00 00 00 00 
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 238


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
006032 00 00 00 00 00 00 
006038 00 00 00 00 00 00 
00603E 00 00 00 00 00 00 
006044 00 00 00 00 00 00 
00604A 00 00 00 00 00 00 
006050 00 00 00 00 00 00 
006056 00 00 00 00 00 00 
00605C 00 00 00 00 00 00 
006062 00 00 00 00 00 00 
006068 00 00 00 00 00 00 
00606E 00 00 00 00 
                           B   755    				
006072 000000              B   756    os_args_loc				dw24 0
006075 000000              B   757    os_args_pos_cache		dw24 0
                           B   758    
006078 000000              B   759    os_dir_block_cache  	dw24 0
00607B 000000              B   760    os_extcmd_jmp_addr		dw24 0
                           B   761    
00607E 00                  B   762    in_script_flag			db 0
00607F 000000              B   763    script_dir				dw24 0
006082 00 00 00 00 00 00   B   764    script_buffer			blkb max_buffer_chars+2
006088 00 00 00 00 00 00 
00608E 00 00 00 00 00 00 
006094 00 00 00 00 00 00 
00609A 00 00 00 00 00 00 
0060A0 00 00 00 00 00 00 
0060A6 00 00 00 00 00 00 
0060AC 00 00 00 00 00 00 
0060B2 00 00 00 00 00 00 
0060B8 00 00 00 00 00 00 
0060BE 00 00 00 00 00 00 
0060C4 00 00 00 00 00 00 
0060CA 00 00 00 00 00 00 
0060D0 00 00 00 00 
0060D4 000000              B   765    script_file_offset		dw24 0
0060D7 000000              B   766    script_buffer_offset	dw24 0
0060DA 000000              B   767    script_orig_dir			dw24 0
                           B   768    
0060DD 0000                B   769    char_to_print			db 0,0	; zero terminat
                           B   770    
                           B   771    ;----------------------------------------------
                           B   772    ; Keyboard buffer and registers
                           B   773    ;----------------------------------------------
                           B   774    
0060DF 00 00 00 00 00 00   B   775    scancode_buffer			blkb 32,0
0060E5 00 00 00 00 00 00 
0060EB 00 00 00 00 00 00 
0060F1 00 00 00 00 00 00 
0060F7 00 00 00 00 00 00 
0060FD 00 00 
                           B   776    
0060FF 00                  B   777    key_buf_wr_idx			db 0
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 239


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
006100 00                  B   778    key_buf_rd_idx			db 0
006101 00                  B   779    key_release_mode		db 0		
006102 00                  B   780    not_currently_used		db 0
006103 00                  B   781    key_mod_flags			db 0
006104 00                  B   782    insert_mode				db 0
006105 00                  B   783    current_scancode		db 0
006106 00                  B   784    current_asciicode		db 0
                           B   785    
                           B   786    ;----------------------------------------------
                           B   787    ; Mouse related registers
                           B   788    ;----------------------------------------------
                           B   789    
006107 00                  B   790    mouse_id				db 0
006108 00                  B   791    mouse_packet_size		db 0
                           B   792    
006109 00 00 00 00         B   793    mouse_packet			blkb 4,0			; t
00610D 00                  B   794    mouse_packet_index		db 0				;
00610E 00                  B   795    mouse_buttons			db 0				;
00610F 000000              B   796    mouse_disp_x			dw24 0				; c
006112 000000              B   797    mouse_disp_y			dw24 0				; c
006115 00                  B   798    mouse_wheel				db 0				; m
006116 00                  B   799    mouse_updated			db 0
                           B   800    
006117 000000              B   801    mouse_window_size_x		dw24 0				; t
00611A 000000              B   802    mouse_window_size_y		dw24 0
00611D 000000              B   803    mouse_abs_x				dw24 0
006120 000000              B   804    mouse_abs_y				dw24 0
006123 000000              B   805    mouse_disp_x_old		dw24 0
006126 000000              B   806    mouse_disp_y_old		dw24 0
006129 000000              B   807    mouse_disp_x_buffer		dw24 0
00612C 000000              B   808    mouse_disp_y_buffer		dw24 0
00612F 00                  B   809    mouse_new_window		db 0
                           B   810    
                           B   811    ;----------------------------------------------
       00005FB0            B   812    first_os_var			equ cursor_y
006130 00                  B   813    last_os_var				db 0
                           B   814    ;----------------------------------------------
                           B   815    
                           B   816    ;==============================================
                           B   817    ; Environment variables
                           B   818    ;==============================================
                           B   819    
006131 4552524F 523D3030   B   820    envar_list				db "ERROR=00",0
006139 00 
00613A FF                  B   821    first_ext_ev_entry		db 0ffh
00613B 00 00 00 00 00 00   B   822    						blkb envar_buffer_size,
006141 00 00 00 00 00 00 
006147 00 00 00 00 00 00 
00614D 00 00 00 00 00 00 
006153 00 00 00 00 00 00 
006159 00 00 00 00 00 00 
00615F 00 00 00 00 00 00 
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 240


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_data.asm
006165 00 00 00 00 00 00 
00616B 00 00 00 00 00 00 
006171 00 00 00 00 00 00 
006177 00 00 00 00 00 00 
00617D 00 00 00 00 00 00 
006183 00 00 00 00 00 00 
006189 00 00 00 00 00 00 
00618F 00 00 00 00 00 00 
006195 00 00 00 00 00 00 
00619B 00 00 00 00 00 00 
0061A1 00 00 00 00 00 00 
0061A7 00 00 00 00 00 00 
0061AD 00 00 00 00 00 00 
0061B3 00 00 00 00 00 00 
0061B9 00 00 00 00 00 00 
0061BF 00 00 00 00 00 00 
0061C5 00 00 00 00 00 00 
0061CB 00 00 00 00 00 00 
0061D1 00 00 00 00 00 00 
0061D7 00 00 00 00 00 00 
0061DD 00 00 00 00 00 00 
0061E3 00 00 00 00 00 00 
0061E9 00 00 00 00 00 00 
0061EF 00 00 00 00 00 00 
0061F5 00 00 00 00 00 00 
0061FB 00 00 00 00 00 00 
006201 00 00 00 00 00 00 
006207 00 00 00 00 00 00 
00620D 00 00 00 00 00 00 
006213 00 00 00 00 00 00 
006219 00 00 00 00 00 00 
00621F 00 00 00 00 00 00 
006225 00 00 00 00 00 00 
00622B 00 00 00 00 00 00 
006231 00 00 00 00 00 00 
006237 00 00 00 00 
                           B   823    
00623B 3A6100              B   824    envar_top_loc			dw24 first_ext_ev_entry
                           B   825    
                           B   826    ;==============================================
                           B   827    
                           B     0    	include		'prose_font_packed.asm'
00623E                     B     1    packed_font_start:
00623E 01010008 183C3C18   B     2                    db 001h,001h,000h,008h,018h,03C
006246 00181800 EEEE6601 
00624E 00056C6C FE6CFE6C   B     3                    db 000h,005h,06Ch,06Ch,0FEh,06C
006256 6C00187E E07C0EFC 
00625E 1800C6CE 1C3870E6   B     4                    db 018h,000h,0C6h,0CEh,01Ch,038
006266 C60078EC EC78EDEE 
00626E 7D000C1C 18010005   B     5                    db 07Dh,000h,00Ch,01Ch,018h,001
006276 18300160 03301800 
00627E 3018010C 03183000   B     6                    db 030h,018h,001h,00Ch,003h,018
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 241


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_font_packed.asm
006286 105438FE 38541000 
00628E 0018187E 18180100   B     7                    db 000h,018h,018h,07Eh,018h,018
006296 07383870 0100037E 
00629E 01000918 18000006   B     8                    db 001h,000h,009h,018h,018h,000
0062A6 0E1C3870 E0007CE6 
0062AE EEFEF6E6 7C003878   B     9                    db 0EEh,0FEh,0F6h,0E6h,07Ch,000
0062B6 0138047C 007CEE0E 
0062BE 7CE0E0FE 00FE0C18   B    10                    db 07Ch,0E0h,0E0h,0FEh,000h,0FE
0062C6 0C0ECE7C 001E3E76 
0062CE E6FF0606 00FEE0FC   B    11                    db 0E6h,0FFh,006h,006h,000h,0FE
0062D6 010E03FC 007EE0FC 
0062DE 01E6037C 00FE060C   B    12                    db 001h,0E6h,003h,07Ch,000h,0FE
0062E6 18013803 007CE6E6 
0062EE 7CE6E67C 007C01CE   B    13                    db 07Ch,0E6h,0E6h,07Ch,000h,07C
0062F6 037E0E7C 01000318 
0062FE 18001818 01000330   B    14                    db 018h,000h,018h,018h,001h,000
006306 30003030 600E1C38 
00630E 70381C0E 0100037E   B    15                    db 070h,038h,01Ch,00Eh,001h,000
006316 007E0100 0370381C 
00631E 0E1C3870 007CEE0E   B    16                    db 00Eh,01Ch,038h,070h,000h,07C
006326 3C380038 007CE601 
00632E EE03E07C 007CE6E6   B    17                    db 0EEh,003h,0E0h,07Ch,000h,07C
006336 FE01E603 00FCE6E6 
00633E FCE6E6FC 007CE601   B    18                    db 0FCh,0E6h,0E6h,0FCh,000h,07C
006346 E003E67C 00FC01E6 
00634E 05FC00FE E0E0F8E0   B    19                    db 005h,0FCh,000h,0FEh,0E0h,0E0
006356 E0FE00FE E0E0F801 
00635E E003007C E6E0EEE6   B    20                    db 0E0h,003h,000h,07Ch,0E6h,0E0
006366 E67C0001 E603FE01 
00636E E603007C 0138057C   B    21                    db 0E6h,003h,000h,07Ch,001h,038
006376 007E011C 04DC7800 
00637E E6ECF8EC 01E60300   B    22                    db 0E6h,0ECh,0F8h,0ECh,001h,0E6
006386 01E006FE 00C6EEFE 
00638E D601C603 00E6F6FE   B    23                    db 0D6h,001h,0C6h,003h,000h,0E6
006396 FEEEE6E6 007C01E6 
00639E 057C00FC 01E603FC   B    24                    db 005h,07Ch,000h,0FCh,001h,0E6
0063A6 E0E0007C 01E603EA 
0063AE EC7600FC 01E603FC   B    25                    db 0ECh,076h,000h,0FCh,001h,0E6
0063B6 E6E6007C EEE07C0E 
0063BE EE7C00FE 01380600   B    26                    db 0EEh,07Ch,000h,0FEh,001h,038
0063C6 01E6067C 0001E605 
0063CE 74380001 C604D6FE   B    27                    db 074h,038h,000h,001h,0C6h,004
0063D6 6C00E6E6 6C3874E6 
0063DE E60001E6 047E06FC   B    28                    db 0E6h,000h,001h,0E6h,004h,07E
0063E6 00FE0E1C 3870E0FE 
0063EE 003C0130 053C00C0   B    29                    db 000h,03Ch,001h,030h,005h,03C
0063F6 E070381C 0E060078 
0063FE 01180578 0010386C   B    30                    db 001h,018h,005h,078h,000h,010
006406 C601000B FE381C01 
00640E 00087C06 7EE67E00   B    31                    db 000h,008h,07Ch,006h,07Eh,0E6
006416 00E0E0FC E6E6FC01 
00641E 00037C01 E0037C00   B    32                    db 000h,003h,07Ch,001h,0E0h,003
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 242


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_font_packed.asm
006426 0006067E E6E67E01 
00642E 00037CE6 FEE07C00   B    33                    db 000h,003h,07Ch,0E6h,0FEh,0E0
006436 003E70FC 01700301 
00643E 00037EE6 E67E067C   B    34                    db 000h,003h,07Eh,0E6h,0E6h,07E
006446 00E0E0FC 01E60300 
00644E 00380078 38387C00   B    35                    db 000h,038h,000h,078h,038h,038
006456 001C0001 1C047800 
00645E E0EEECF8 ECEE0000   B    36                    db 0E0h,0EEh,0ECh,0F8h,0ECh,0EE
006466 78013804 7C010003 
00646E ECFED6C6 C6010003   B    37                    db 0ECh,0FEh,0D6h,0C6h,0C6h,001
006476 FC01E604 0100037C 
00647E 01E6037C 010003FC   B    38                    db 001h,0E6h,003h,07Ch,001h,000
006486 E6E6FCE0 E000007E 
00648E E6E67E06 060000DC   B    39                    db 0E6h,0E6h,07Eh,006h,006h,000
006496 E601E003 0100037E 
00649E F07C1EFC 0000387E   B    40                    db 0F0h,07Ch,01Eh,0FCh,000h,000
0064A6 0138031E 01000301 
0064AE E6047E01 000301E6   B    41                    db 0E6h,004h,07Eh,001h,000h,003
0064B6 036C3801 0003E2EA 
0064BE FE7C3401 0003E67C   B    42                    db 0FEh,07Ch,034h,001h,000h,003
0064C6 387CE601 000301E6 
0064CE 037E0CF8 0000FE1C   B    43                    db 003h,07Eh,00Ch,0F8h,000h,000
0064D6 3870FE00 3C303060 
0064DE 30303C00 01180700   B    44                    db 030h,030h,03Ch,000h,001h,018
0064E6 7818180C 18187800 
0064EE 337ECC01 000501FE   B    45                    db 033h,07Eh,0CCh,001h,000h,005
0064F6 070100FF 01001A1C 
0064FE 3A70FC70 F2BC0100   B    46                    db 03Ah,070h,0FCh,070h,0F2h,0BC
006506 297CC6BA A2BAC67C 
00650E 0100147E 06060100   B    47                    db 001h,000h,014h,07Eh,006h,006
006516 FF0100FF 01009C 
00651D                     B    48    packed_font_end:
                           A  3104    
00651D 00 00 00 00 00 00   A  3105    sector_buffer	blkb 512,0
006523 00 00 00 00 00 00 
006529 00 00 00 00 00 00 
00652F 00 00 00 00 00 00 
006535 00 00 00 00 00 00 
00653B 00 00 00 00 00 00 
006541 00 00 00 00 00 00 
006547 00 00 00 00 00 00 
00654D 00 00 00 00 00 00 
006553 00 00 00 00 00 00 
006559 00 00 00 00 00 00 
00655F 00 00 00 00 00 00 
006565 00 00 00 00 00 00 
00656B 00 00 00 00 00 00 
006571 00 00 00 00 00 00 
006577 00 00 00 00 00 00 
00657D 00 00 00 00 00 00 
006583 00 00 00 00 00 00 
006589 00 00 00 00 00 00 
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 243


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
00658F 00 00 00 00 00 00 
006595 00 00 00 00 00 00 
00659B 00 00 00 00 00 00 
0065A1 00 00 00 00 00 00 
0065A7 00 00 00 00 00 00 
0065AD 00 00 00 00 00 00 
0065B3 00 00 00 00 00 00 
0065B9 00 00 00 00 00 00 
0065BF 00 00 00 00 00 00 
0065C5 00 00 00 00 00 00 
0065CB 00 00 00 00 00 00 
0065D1 00 00 00 00 00 00 
0065D7 00 00 00 00 00 00 
0065DD 00 00 00 00 00 00 
0065E3 00 00 00 00 00 00 
0065E9 00 00 00 00 00 00 
0065EF 00 00 00 00 00 00 
0065F5 00 00 00 00 00 00 
0065FB 00 00 00 00 00 00 
006601 00 00 00 00 00 00 
006607 00 00 00 00 00 00 
00660D 00 00 00 00 00 00 
006613 00 00 00 00 00 00 
006619 00 00 00 00 00 00 
00661F 00 00 00 00 00 00 
006625 00 00 00 00 00 00 
00662B 00 00 00 00 00 00 
006631 00 00 00 00 00 00 
006637 00 00 00 00 00 00 
00663D 00 00 00 00 00 00 
006643 00 00 00 00 00 00 
006649 00 00 00 00 00 00 
00664F 00 00 00 00 00 00 
006655 00 00 00 00 00 00 
00665B 00 00 00 00 00 00 
006661 00 00 00 00 00 00 
006667 00 00 00 00 00 00 
00666D 00 00 00 00 00 00 
006673 00 00 00 00 00 00 
006679 00 00 00 00 00 00 
00667F 00 00 00 00 00 00 
006685 00 00 00 00 00 00 
00668B 00 00 00 00 00 00 
006691 00 00 00 00 00 00 
006697 00 00 00 00 00 00 
00669D 00 00 00 00 00 00 
0066A3 00 00 00 00 00 00 
0066A9 00 00 00 00 00 00 
0066AF 00 00 00 00 00 00 
0066B5 00 00 00 00 00 00 
0066BB 00 00 00 00 00 00 
0066C1 00 00 00 00 00 00 
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 244


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
0066C7 00 00 00 00 00 00 
0066CD 00 00 00 00 00 00 
0066D3 00 00 00 00 00 00 
0066D9 00 00 00 00 00 00 
0066DF 00 00 00 00 00 00 
0066E5 00 00 00 00 00 00 
0066EB 00 00 00 00 00 00 
0066F1 00 00 00 00 00 00 
0066F7 00 00 00 00 00 00 
0066FD 00 00 00 00 00 00 
006703 00 00 00 00 00 00 
006709 00 00 00 00 00 00 
00670F 00 00 00 00 00 00 
006715 00 00 00 00 00 00 
00671B 00 00 
                           A  3106    
00671D 00 00 00 00 00 00   A  3107    scratch_pad		blkb 256,0
006723 00 00 00 00 00 00 
006729 00 00 00 00 00 00 
00672F 00 00 00 00 00 00 
006735 00 00 00 00 00 00 
00673B 00 00 00 00 00 00 
006741 00 00 00 00 00 00 
006747 00 00 00 00 00 00 
00674D 00 00 00 00 00 00 
006753 00 00 00 00 00 00 
006759 00 00 00 00 00 00 
00675F 00 00 00 00 00 00 
006765 00 00 00 00 00 00 
00676B 00 00 00 00 00 00 
006771 00 00 00 00 00 00 
006777 00 00 00 00 00 00 
00677D 00 00 00 00 00 00 
006783 00 00 00 00 00 00 
006789 00 00 00 00 00 00 
00678F 00 00 00 00 00 00 
006795 00 00 00 00 00 00 
00679B 00 00 00 00 00 00 
0067A1 00 00 00 00 00 00 
0067A7 00 00 00 00 00 00 
0067AD 00 00 00 00 00 00 
0067B3 00 00 00 00 00 00 
0067B9 00 00 00 00 00 00 
0067BF 00 00 00 00 00 00 
0067C5 00 00 00 00 00 00 
0067CB 00 00 00 00 00 00 
0067D1 00 00 00 00 00 00 
0067D7 00 00 00 00 00 00 
0067DD 00 00 00 00 00 00 
0067E3 00 00 00 00 00 00 
0067E9 00 00 00 00 00 00 
0067EF 00 00 00 00 00 00 
Zilog eZ80 Macro Assembler Version 4.1 (10060805)06-Jul-11     18:55:52     page: 245


PC     Object              I  Line    Source E:\My_Own_Files\Coding\ez80p\Code\PROSE\src\prose_main.asm
0067F5 00 00 00 00 00 00 
0067FB 00 00 00 00 00 00 
006801 00 00 00 00 00 00 
006807 00 00 00 00 00 00 
00680D 00 00 00 00 00 00 
006813 00 00 00 00 00 00 
006819 00 00 00 00 
                           A  3108    
                           A  3109    ;==============================================
                           A  3110    	
00681D 00                  A  3111    os_max_addr		db 0							                           A  3112    	
                           A  3113    				end		
                           A  3114    ;==============================================
                           A  3115    
                           A  3116    		


Errors: 0
Warnings: 0
Lines Assembled: 12212
